<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corporate Reporting Forensics Lab</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Slate-100 */
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Custom scrollbar for toolbar if needed */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const IconBriefcase = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>;
        const IconChart = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>;
        const IconCheck = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 6 9 17l-5-5"/></svg>;
        const IconX = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>;
        const IconLock = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>;
        const IconUnlock = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>;
        const IconArrowLeft = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>;
        const IconExternalLink = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>;
        const IconDownload = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
        const IconTrash = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>;
        const IconShield = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>;
        const IconEdit = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>;

        // --- Constants & Data ---
        const microsoftCases = [
            { id: 1, title: "Cloud Services (Tech Solutions Inc)", scenario: "Tech Solutions signs a 1-year contract for Azure access ($10k/mo fixed) plus storage on a pay-as-you-go basis ($0.05/GB).", options: [ { id: 'a', text: "Recognize all revenue upfront." }, { id: 'b', text: "Fixed fee ratably; storage as consumed.", correct: true }, { id: 'c', text: "All at end of contract." } ], explanation: "Fixed fee is a standing obligation (over time). Storage is variable/consumption based." },
            { id: 2, title: "Software Licensing (Global Enterprise)", scenario: "Customer buys 500 perpetual Office licenses and a 3-year Microsoft 365 subscription.", options: [ { id: 'a', text: "Perpetual upfront; 365 ratably.", correct: true }, { id: 'b', text: "All recognized upfront." }, { id: 'c', text: "All recognized ratably." } ], explanation: "Perpetual transfers control immediately. Subscriptions are continuous service." },
            { id: 3, title: "Volume Licensing (Multinational Corp)", scenario: "3-year Enterprise Agreement: Windows 11 On-premise licenses + Software Assurance (SA).", options: [ { id: 'a', text: "All at contract start." }, { id: 'b', text: "License upfront; SA ratably.", correct: true }, { id: 'c', text: "SA revenue at end of term." } ], explanation: "License is distinct (upfront). SA is a stand-ready obligation (ratable)." },
            { id: 4, title: "Hardware Bundles", scenario: "Customer buys Surface laptops pre-installed with Windows 11 Pro.", options: [ { id: 'a', text: "Single PO; recognize at delivery.", correct: true }, { id: 'b', text: "Hardware upfront; Software over life." }, { id: 'c', text: "Software deferred." } ], explanation: "Hardware and OS are highly interrelated, creating a single performance obligation." },
            { id: 5, title: "Search Advertising", scenario: "Retailer pays Microsoft per click on Bing Ads.", options: [ { id: 'a', text: "When ad appears." }, { id: 'b', text: "When user clicks.", correct: true }, { id: 'c', text: "When invoice paid." } ], explanation: "Usage-based royalty exception: recognize when the usage (click) occurs." }
        ];

        const FORD_DATA = { begAR: 71414, endAR: 78274, writeOffs: 401, totalRevenue: 165722, consumerPct: 0.75 };
        const FORD_QUIZ = [
            { id: 'q1', q: "Gross Finance Receivables (End of 2023)", a: 78274 },
            { id: 'q2', q: "Net Consumer Finance Receivables", a: 77395, hint: "Gross - Allowance" },
            { id: 'q3', q: "Gross AR from 2021 Sales", a: 11473 },
            { id: 'q4', q: "Bad Debt Expense (2023)", a: 280 },
            { id: 'q5', q: "Write-offs (2023)", a: 401 }
        ];

        const formatNum = (n) => n.toLocaleString();

        // --- Smart Input Component ---
        const SmartInput = ({ id, value, onChange, correctValue, isPct, label, instructorMode, placeholder }) => {
            const [status, setStatus] = useState("neutral"); // neutral, correct, incorrect

            // Effect to re-validate when external value changes (e.g. Auto-fill)
            useEffect(() => {
                if (value) validate(value, false); // Don't trigger onChange, just check status
                else setStatus("neutral");
            }, [value, correctValue]);

            const validate = (valStr, shouldUpdateParent = true) => {
                if (!valStr) {
                    setStatus("neutral");
                    return;
                }

                let expr = valStr.toString().replace(/,/g, '').trim();
                // Handle % -> /100
                expr = expr.replace(/%/g, '/100');

                try {
                    // Safe evaluation allowed characters
                    if (/[^0-9+\-*/.()\s]/.test(expr)) return;

                    const result = new Function('return ' + expr)();
                    const numResult = Number(result);
                    const numCorrect = Number(correctValue);
                    let isValid = false;

                    const tolerance = 0.02; // 2%

                    if (isPct) {
                        // Check both raw decimal (0.067) and integer representation (6.7)
                        const diffDecimal = Math.abs((numResult - numCorrect) / numCorrect);
                        const diffInteger = Math.abs(((numResult / 100) - numCorrect) / numCorrect);
                        if (diffDecimal <= tolerance || diffInteger <= tolerance) isValid = true;
                    } else {
                        const diff = Math.abs((numResult - numCorrect) / numCorrect);
                        if (diff <= tolerance) isValid = true;
                    }

                    setStatus(isValid ? "correct" : "incorrect");
                    
                    if (shouldUpdateParent) {
                        // Pass the calculated number back as string, or keep expression?
                        // Requirement: "When pressing enter... show calculated value"
                        onChange(result.toString()); 
                    }
                } catch (e) {
                    setStatus("incorrect");
                }
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    validate(e.target.value, true);
                    e.target.blur();
                }
            };

            const handleBlur = (e) => {
                validate(e.target.value, true);
            };

            return (
                <div className="w-full relative group">
                    {label && <label className="block text-xs font-bold text-slate-500 mb-1">{label}</label>}
                    <div className="relative">
                        <input
                            type="text"
                            className={`w-full p-2 pr-8 border-2 rounded font-mono transition-colors text-right
                                ${status === 'correct' ? 'border-green-500 bg-green-50 focus:ring-green-200' : ''}
                                ${status === 'incorrect' ? 'border-red-500 bg-red-50 focus:ring-red-200' : ''}
                                ${status === 'neutral' ? 'border-slate-300 focus:border-blue-500 focus:ring-blue-200' : ''}
                                focus:outline-none focus:ring-2`}
                            value={value || ""}
                            onChange={(e) => onChange(e.target.value)} // Just update state, don't validate yet
                            onKeyDown={handleKeyDown}
                            onBlur={handleBlur}
                            placeholder={placeholder || "..."}
                        />
                        <div className="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none">
                            {status === 'correct' && <IconCheck />}
                            {status === 'incorrect' && <IconX />}
                        </div>
                    </div>
                    {/* Instructor Key Display */}
                    {instructorMode && (
                        <div className="mt-1 text-xs font-bold text-purple-700 bg-purple-100 p-1 rounded border border-purple-200 inline-block animate-pulse-once">
                            Key: {isPct ? (correctValue * 100).toFixed(1) + '%' : formatNum(correctValue)}
                        </div>
                    )}
                </div>
            );
        };

        // --- Helper Component: Analysis Block (Updated with SmartInput) ---
        const AnalysisBlock = ({ scenarioName, creditPct, data, isInteractive, userValues, onUpdate, instructorMode }) => {
            const consumerSales = data.totalRevenue * data.consumerPct;
            const calcCreditSales = Math.round(consumerSales * creditPct);
            const calcCashColl = data.begAR + calcCreditSales - data.writeOffs - data.endAR;
            
            const dispCreditSales = isInteractive ? userValues.credit : formatNum(calcCreditSales);
            const dispCashColl = isInteractive ? userValues.cash : formatNum(calcCashColl);

            return (
                <div className={`flex flex-col items-center w-full h-full ${!isInteractive ? 'opacity-90 grayscale-[0.5]' : ''} bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden`}>
                    <div className={`w-full p-4 text-center border-b border-slate-200 ${isInteractive ? 'bg-white' : 'bg-slate-50'}`}>
                         <h3 className="font-bold text-slate-800">{scenarioName}</h3>
                         <div className="text-xs text-slate-500 mt-1">Assumption: {creditPct * 100}% Credit Sales</div>
                    </div>
                    
                    <div className="p-4 w-full flex flex-col items-center flex-grow">
                        {/* Formula Hint */}
                        <div className="w-full mb-6 p-2 bg-slate-50 rounded border border-slate-200 text-center text-[10px] md:text-xs font-mono font-bold text-slate-700">
                            <div className="flex flex-wrap justify-center gap-1">
                                <span className="text-slate-500">{formatNum(data.begAR)}</span>
                                <span>+</span>
                                <span className="text-teal-600">Credit Sales</span>
                                <span>-</span>
                                <span className="text-indigo-600">Cash Coll</span>
                                <span>-</span>
                                <span className="text-red-500">{formatNum(data.writeOffs)}</span>
                                <span>=</span>
                                <span className="text-slate-500">{formatNum(data.endAR)}</span>
                            </div>
                        </div>

                        {/* T-Account Visual */}
                        <div className="w-full max-w-xs relative">
                            <div className="border-b-4 border-slate-800 w-full mb-0"></div>
                            <div className="flex min-h-[14rem] border-x border-b border-slate-200 shadow-sm relative">
                                <div className="w-1/2 border-r-4 border-slate-800 p-2 flex flex-col justify-between bg-white">
                                    <div>
                                        <span className="text-[9px] text-slate-400 uppercase font-bold tracking-wider">Beg Bal</span>
                                        <div className="font-mono text-slate-800 font-bold text-sm">{formatNum(data.begAR)}</div>
                                    </div>
                                    <div className="my-2">
                                        <span className="text-[9px] text-teal-600 uppercase font-bold tracking-wider">Credit Sales</span>
                                        {isInteractive ? (
                                            <SmartInput 
                                                id={`credit-${creditPct}`}
                                                value={userValues.credit}
                                                onChange={(val) => onUpdate('credit', val)}
                                                correctValue={calcCreditSales}
                                                instructorMode={instructorMode}
                                            />
                                        ) : (
                                            <div className="font-mono text-teal-700 font-bold text-sm">{dispCreditSales}</div>
                                        )}
                                    </div>
                                    <div className="pt-2 mt-auto border-t border-slate-100">
                                        <span className="text-[9px] text-slate-400 uppercase font-bold tracking-wider">End Bal</span>
                                        <div className="font-mono text-slate-800 font-bold text-sm">{formatNum(data.endAR)}</div>
                                    </div>
                                </div>
                                <div className="w-1/2 p-2 flex flex-col justify-between text-right bg-white">
                                    <div>
                                        <span className="text-[9px] text-indigo-600 uppercase font-bold tracking-wider">Cash Coll</span>
                                        {isInteractive ? (
                                            <SmartInput 
                                                id={`cash-${creditPct}`}
                                                value={userValues.cash}
                                                onChange={(val) => onUpdate('cash', val)}
                                                correctValue={calcCashColl}
                                                instructorMode={instructorMode}
                                            />
                                        ) : (
                                            <div className="font-mono text-indigo-700 font-bold text-sm">{dispCashColl}</div>
                                        )}
                                    </div>
                                    <div>
                                        <span className="text-[9px] text-slate-400 uppercase font-bold tracking-wider">Write-offs</span>
                                        <div className="font-mono text-red-600 font-bold text-sm">({formatNum(data.writeOffs)})</div>
                                    </div>
                                    <div className="h-6"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Confirmation Modal Component ---
        const ConfirmationModal = ({ isOpen, title, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full fade-in">
                        <h3 className="text-lg font-bold text-slate-800 mb-2">{title}</h3>
                        <p className="text-slate-600 mb-6">{message}</p>
                        <div className="flex justify-end gap-3">
                            <button onClick={onCancel} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg font-medium">Cancel</button>
                            <button onClick={onConfirm} className="px-4 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700">Confirm Clear</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Instructor Toolbar ---
        const InstructorToolbar = ({ isActive, onAutoFill, onClearAll }) => {
            const [hashInput, setHashInput] = useState("");
            const [verifyResult, setVerifyResult] = useState(null);
            const [genName, setGenName] = useState("");
            const [genScore, setGenScore] = useState("");
            const [generatedHash, setGeneratedHash] = useState("");
            const [showTools, setShowTools] = useState(false);
            
            // Clear Modal State
            const [showClearConfirm, setShowClearConfirm] = useState(false);

            if (!isActive) return null;

            const handleVerify = () => {
                try {
                    const jsonStr = atob(hashInput);
                    const data = JSON.parse(jsonStr);
                    // Simple validation logic
                    if (data && data.name && data.timestamp) {
                        setVerifyResult({ valid: true, data });
                    } else {
                        throw new Error("Invalid structure");
                    }
                } catch (e) {
                    setVerifyResult({ valid: false });
                }
            };

            const handleGenerate = () => {
                if (!genName || !genScore) return;
                const data = {
                    name: genName,
                    score: genScore, // Can be text like "Completed 5/5"
                    timestamp: new Date().toLocaleString(),
                    salt: "teacher_secret"
                };
                const hash = btoa(JSON.stringify(data));
                setGeneratedHash(hash);
            };

            const performClear = () => {
                onClearAll();
                setShowClearConfirm(false);
            };

            return (
                <>
                <div className="fixed top-16 left-0 right-0 bg-purple-900 text-white shadow-lg z-30 transition-all transform fade-in">
                    <div className="max-w-6xl mx-auto px-4 h-14 flex items-center justify-between">
                        <div className="flex items-center gap-4">
                            <span className="font-bold flex items-center gap-2 text-purple-200">
                                <IconLock /> Instructor Mode
                            </span>
                            <div className="h-6 w-px bg-purple-700 mx-2"></div>
                            <button onClick={onAutoFill} className="text-xs bg-purple-700 hover:bg-purple-600 px-3 py-1 rounded flex items-center gap-1 transition-colors">
                                <IconCheck /> Auto-Fill All
                            </button>
                            <button onClick={() => setShowClearConfirm(true)} className="text-xs bg-red-900/50 hover:bg-red-800 px-3 py-1 rounded flex items-center gap-1 transition-colors border border-red-800">
                                <IconTrash /> Clear & Exit
                            </button>
                        </div>
                        <button 
                            onClick={() => setShowTools(!showTools)}
                            className={`text-xs px-3 py-1 rounded flex items-center gap-1 transition-colors ${showTools ? 'bg-white text-purple-900' : 'bg-purple-800 hover:bg-purple-700'}`}
                        >
                            <IconShield /> Verification Tools
                        </button>
                    </div>

                    {/* Expandable Verification Tools */}
                    {showTools && (
                        <div className="bg-purple-50 border-b border-purple-200 p-4 text-slate-800 shadow-inner">
                            <div className="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8">
                                {/* Verify Section */}
                                <div className="space-y-2">
                                    <h4 className="text-sm font-bold text-purple-900 uppercase tracking-wider">Verify Student Hash</h4>
                                    <div className="flex gap-2">
                                        <input 
                                            value={hashInput} 
                                            onChange={(e) => setHashInput(e.target.value)}
                                            className="flex-1 text-xs p-2 border border-slate-300 rounded font-mono"
                                            placeholder="Paste verification string here..." 
                                        />
                                        <button onClick={handleVerify} className="bg-purple-700 text-white text-xs px-4 rounded font-bold hover:bg-purple-800">Verify</button>
                                    </div>
                                    {verifyResult && (
                                        <div className={`text-xs p-2 rounded border ${verifyResult.valid ? 'bg-green-100 border-green-300 text-green-800' : 'bg-red-100 border-red-300 text-red-800'}`}>
                                            {verifyResult.valid ? (
                                                <>
                                                    <strong>Verified:</strong> {verifyResult.data.name} | <strong>Score:</strong> {verifyResult.data.score} | <strong>Time:</strong> {verifyResult.data.timestamp}
                                                </>
                                            ) : (
                                                <strong>Invalid or Tampered Hash</strong>
                                            )}
                                        </div>
                                    )}
                                </div>
                                {/* Generate Section */}
                                <div className="space-y-2 border-l border-purple-200 pl-4 md:border-l-0 md:pl-0">
                                    <h4 className="text-sm font-bold text-purple-900 uppercase tracking-wider">Generate Test Hash</h4>
                                    <div className="flex gap-2">
                                        <input value={genName} onChange={(e) => setGenName(e.target.value)} className="w-1/3 text-xs p-2 border border-slate-300 rounded" placeholder="Name" />
                                        <input value={genScore} onChange={(e) => setGenScore(e.target.value)} className="w-1/3 text-xs p-2 border border-slate-300 rounded" placeholder="Score/Note" />
                                        <button onClick={handleGenerate} className="flex-1 bg-slate-700 text-white text-xs rounded font-bold hover:bg-slate-800">Generate</button>
                                    </div>
                                    {generatedHash && (
                                        <div className="bg-white p-2 border rounded text-[10px] break-all font-mono text-slate-500 select-all cursor-pointer" onClick={(e) => document.execCommand('copy')}>
                                            {generatedHash}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
                
                <ConfirmationModal 
                    isOpen={showClearConfirm}
                    title="Clear All & Exit Instructor Mode?"
                    message="This will wipe all answers on the board and return to student view. This action cannot be undone."
                    onConfirm={performClear}
                    onCancel={() => setShowClearConfirm(false)}
                />
                </>
            );
        };

        // --- Component: Revenue Audit (Module 1) ---
        const RevenueAudit = ({ onComplete, instructorMode, savedState, onSaveState }) => {
            const [phase, setPhase] = useState('research'); // 'research' or 'audit'
            const [currentCaseIndex, setCurrentCaseIndex] = useState(0);
            
            // State: Selections { caseId: optionId } and Submission Status
            const [selections, setSelections] = useState(savedState?.selections || {});
            const [isSubmitted, setIsSubmitted] = useState(savedState?.isSubmitted || false);

            const currentCase = microsoftCases[currentCaseIndex];

            // Sync state to parent on every change
            useEffect(() => {
                // Derived state for report compatibility
                const completedCases = Object.keys(selections).map(Number);
                const answers = {};
                Object.entries(selections).forEach(([caseId, optId]) => {
                    const c = microsoftCases.find(mc => mc.id === Number(caseId));
                    const opt = c?.options.find(o => o.id === optId);
                    if (opt) answers[caseId] = opt.text;
                });

                onSaveState({ 
                    selections, 
                    isSubmitted,
                    completedCases,
                    answers
                });
            }, [selections, isSubmitted]);

            // React to external state changes (e.g. from AutoFill)
            useEffect(() => {
                if (savedState?.selections && JSON.stringify(savedState.selections) !== JSON.stringify(selections)) {
                     setSelections(savedState.selections);
                }
                if (savedState?.isSubmitted !== undefined && savedState.isSubmitted !== isSubmitted) {
                    setIsSubmitted(savedState.isSubmitted);
                }
            }, [savedState]);

            // Instructor Mode Auto-fill (Local trigger)
            useEffect(() => {
                if (instructorMode && !isSubmitted && phase === 'audit') {
                    const correctSelections = {};
                    microsoftCases.forEach(c => {
                        const correct = c.options.find(o => o.correct);
                        if (correct) correctSelections[c.id] = correct.id;
                    });
                    setSelections(correctSelections);
                    setIsSubmitted(true);
                }
            }, [instructorMode, phase]);

            const handleOptionClick = (optionId) => {
                if (isSubmitted) return;
                setSelections(prev => ({ ...prev, [currentCase.id]: optionId }));
            };

            const handleNext = () => {
                if (currentCaseIndex < microsoftCases.length - 1) {
                    setCurrentCaseIndex(prev => prev + 1);
                } else {
                    // Submit
                    setIsSubmitted(true);
                }
            };
            
            const handleBack = () => {
                if (currentCaseIndex > 0) setCurrentCaseIndex(prev => prev - 1);
            };

            const calculateScore = () => {
                let score = 0;
                microsoftCases.forEach(c => {
                    const sel = selections[c.id];
                    const corr = c.options.find(o => o.correct);
                    if (sel === corr.id) score++;
                });
                return score;
            };

            if (phase === 'research') {
                return (
                    <div className="max-w-4xl mx-auto p-6 fade-in">
                        <h2 className="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                            <IconBriefcase /> Revenue Recognition Audit
                        </h2>
                        <div className="bg-white p-8 rounded-xl shadow-md border border-slate-200">
                            <div className="mb-8 text-center">
                                <div className="inline-flex items-center justify-center w-16 h-16 bg-teal-100 text-teal-600 rounded-full mb-4">
                                    <IconBriefcase />
                                </div>
                                <h3 className="text-2xl font-bold text-slate-800 mb-2">Step 1: Policy Review</h3>
                                <p className="text-slate-500 max-w-lg mx-auto">
                                    Before auditing specific contracts, you must establish the accounting baseline by reviewing Microsoft's official revenue recognition policy.
                                </p>
                            </div>
                            <div className="bg-slate-50 border border-slate-200 rounded-lg p-6 mb-8">
                                <h4 className="font-bold text-slate-700 mb-2 flex items-center gap-2">
                                    <span className="bg-slate-200 text-slate-700 text-xs px-2 py-1 rounded uppercase">Task</span>
                                    Identify the "Nature of Products and Services"
                                </h4>
                                <p className="text-sm text-slate-600 mb-4">
                                    Access the 10-K and read the <strong>Revenue Recognition</strong> note. Pay close attention to how they distinguish between "Licenses", "Cloud Services", and "Hardware".
                                </p>
                                <a 
                                    href="https://www.sec.gov/ix?doc=/Archives/edgar/data/0000789019/000095017025100235/msft-20250630.htm#fact-identifier-697" 
                                    target="_blank"
                                    className="inline-flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-3 rounded-lg font-bold transition-colors shadow-sm"
                                >
                                    Open Microsoft 10-K (Note 1) <IconExternalLink />
                                </a>
                            </div>
                            <div className="text-center">
                                <button 
                                    onClick={() => setPhase('audit')}
                                    className="px-8 py-3 bg-teal-600 hover:bg-teal-700 text-white font-bold rounded-lg transition-colors shadow-lg animate-pulse-once"
                                >
                                    I have reviewed the policy - Start Audit &rarr;
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // Results View
            if (isSubmitted) {
                const score = calculateScore();
                return (
                    <div className="max-w-4xl mx-auto p-6 fade-in pt-8">
                        <div className="bg-white p-8 rounded-xl shadow-lg border border-slate-200 mb-8 text-center">
                            <h2 className="text-3xl font-bold text-slate-800 mb-2">Audit Submitted</h2>
                            <p className="text-slate-500 mb-6">Here is your performance report.</p>
                            <div className="text-4xl font-extrabold text-slate-800 mb-2">
                                <span className={score === microsoftCases.length ? "text-green-600" : "text-teal-600"}>{score}</span> 
                                <span className="text-slate-300 text-2xl"> / {microsoftCases.length}</span>
                            </div>
                            <div className="text-sm font-bold text-slate-500 uppercase tracking-widest mb-6">Cases Correct</div>
                            
                            <button 
                                onClick={onComplete}
                                className="px-8 py-3 bg-slate-800 text-white rounded-lg font-bold hover:bg-slate-700 transition-colors shadow-md"
                            >
                                Return to Dashboard
                            </button>
                        </div>

                        <div className="space-y-6">
                            {microsoftCases.map((c, idx) => {
                                const userSelId = selections[c.id];
                                const userOpt = c.options.find(o => o.id === userSelId);
                                const correctOpt = c.options.find(o => o.correct);
                                const isCorrect = userSelId === correctOpt.id;

                                return (
                                    <div key={c.id} className={`bg-white p-6 rounded-xl border-l-4 shadow-sm ${isCorrect ? 'border-green-500' : 'border-red-500'}`}>
                                        <div className="flex justify-between items-start mb-3">
                                            <h4 className="font-bold text-slate-800 text-lg flex items-center gap-2">
                                                <span className="text-slate-400 font-mono">#{idx+1}</span> {c.title}
                                            </h4>
                                            {isCorrect 
                                                ? <span className="flex items-center gap-1 text-green-700 bg-green-50 px-3 py-1 rounded-full text-xs font-bold border border-green-200"><IconCheck /> Correct</span> 
                                                : <span className="flex items-center gap-1 text-red-700 bg-red-50 px-3 py-1 rounded-full text-xs font-bold border border-red-200"><IconX /> Incorrect</span>
                                            }
                                        </div>
                                        <p className="text-slate-600 mb-4">{c.scenario}</p>
                                        
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mb-4">
                                            <div className={`p-4 rounded-lg border ${isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                                                <span className="block text-xs font-bold uppercase opacity-60 mb-1">Your Selection</span>
                                                <span className={`font-semibold ${isCorrect ? 'text-green-900' : 'text-red-900'}`}>{userOpt?.text || "No Selection"}</span>
                                            </div>
                                            {!isCorrect && (
                                                <div className="p-4 rounded-lg border bg-slate-50 border-slate-200">
                                                    <span className="block text-xs font-bold uppercase opacity-60 mb-1 text-slate-500">Correct Answer</span>
                                                    <span className="font-semibold text-slate-800">{correctOpt.text}</span>
                                                </div>
                                            )}
                                        </div>
                                        <div className="text-sm text-slate-600 bg-slate-50 p-4 rounded-lg border border-slate-100">
                                            <strong className="text-slate-800 block mb-1">Audit Note:</strong> 
                                            {c.explanation}
                                        </div>
                                    </div>
                                )
                            })}
                        </div>
                    </div>
                );
            }

            const progress = ((currentCaseIndex + 1) / microsoftCases.length) * 100;
            const currentSelection = selections[currentCase.id];

            return (
                <div className="max-w-4xl mx-auto p-6 fade-in pt-8">
                    <div className="mb-8 bg-white p-4 rounded-lg shadow-sm border border-slate-200">
                        <div className="flex justify-between items-center mb-4">
                            <div>
                                <h2 className="text-2xl font-bold text-slate-800">Revenue Recognition Audit</h2>
                                <p className="text-slate-500 text-sm">Case {currentCaseIndex + 1} of {microsoftCases.length}</p>
                            </div>
                             <a 
                                href="https://www.sec.gov/ix?doc=/Archives/edgar/data/0000789019/000095017025100235/msft-20250630.htm#fact-identifier-697" 
                                target="_blank"
                                className="flex items-center gap-2 bg-indigo-50 text-indigo-700 px-3 py-2 rounded-lg font-bold text-sm hover:bg-indigo-100 transition-colors border border-indigo-200"
                            >
                                Reference 10-K <IconExternalLink />
                            </a>
                        </div>
                        <div className="w-full">
                            <div className="h-2 bg-slate-100 rounded-full overflow-hidden">
                                <div className="h-full bg-teal-500 transition-all duration-500" style={{ width: `${progress}%` }}></div>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div className="bg-white p-6 rounded-xl shadow-lg border-l-4 border-teal-500">
                            <div className="flex items-center gap-2 mb-4">
                                <IconBriefcase />
                                <h3 className="text-lg font-bold text-slate-700">Contract Terms</h3>
                            </div>
                            <h4 className="text-xl font-semibold text-slate-900 mb-2">{currentCase.title}</h4>
                            <p className="text-slate-600 leading-relaxed text-lg">{currentCase.scenario}</p>
                        </div>

                        <div className="space-y-4">
                            <h3 className="text-lg font-bold text-slate-700 mb-2">Select the Appropriate Treatment:</h3>
                            {currentCase.options.map((opt) => (
                                <button
                                    key={opt.id}
                                    onClick={() => handleOptionClick(opt.id)}
                                    className={`w-full p-4 text-left rounded-lg border-2 transition-all duration-200 relative
                                        ${currentSelection === opt.id 
                                            ? 'border-teal-600 bg-teal-50 shadow-md ring-1 ring-teal-600' 
                                            : 'border-slate-200 hover:border-teal-300 hover:bg-slate-50'
                                        }
                                        ${instructorMode && opt.correct ? 'ring-2 ring-purple-400 ring-offset-2' : ''}
                                    `}
                                >
                                    <div className="flex items-start gap-3">
                                        <div className={`mt-1 min-w-[20px] h-[20px] rounded-full border flex items-center justify-center transition-colors
                                            ${currentSelection === opt.id 
                                                ? 'bg-teal-600 border-teal-600'
                                                : 'border-slate-400'
                                            }`}>
                                            {currentSelection === opt.id && <span className="text-white text-xs">‚óè</span>}
                                        </div>
                                        <span className={`font-medium ${currentSelection === opt.id ? 'text-teal-900' : 'text-slate-700'}`}>{opt.text}</span>
                                    </div>
                                    {instructorMode && opt.correct && (
                                        <div className="absolute -right-2 -top-2 bg-purple-600 text-white text-[10px] px-2 py-0.5 rounded shadow-sm font-bold">
                                            KEY
                                        </div>
                                    )}
                                </button>
                            ))}

                            <div className="flex gap-4 mt-6">
                                {currentCaseIndex > 0 && (
                                    <button 
                                        onClick={handleBack}
                                        className="flex-1 py-3 border border-slate-300 text-slate-600 font-bold rounded-lg hover:bg-slate-50 transition-colors"
                                    >
                                        Back
                                    </button>
                                )}
                                <button 
                                    onClick={handleNext}
                                    disabled={!currentSelection}
                                    className={`flex-1 py-3 font-bold rounded-lg transition-all shadow-md
                                        ${currentSelection 
                                            ? 'bg-teal-600 hover:bg-teal-700 text-white' 
                                            : 'bg-slate-200 text-slate-400 cursor-not-allowed'}`}
                                >
                                    {currentCaseIndex < microsoftCases.length - 1 ? "Next Case" : "Submit Audit"}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Component: Receivables Forensics (Module 2) ---
        const ReceivablesForensics = ({ instructorMode, savedState, onSaveState }) => {
            const [phase, setPhase] = useState('dataHunt');
            
            const quizAnswers = savedState?.quizAnswers || {};
            const userCredit60 = savedState?.userCredit60 || "";
            const userCash60 = savedState?.userCash60 || "";
            const userCredit30 = savedState?.userCredit30 || "";
            const userCash30 = savedState?.userCash30 || "";

            const updateState = (key, value) => {
                onSaveState({ ...savedState, [key]: value });
            };

            const handleQuizChange = (id, val) => {
                updateState('quizAnswers', { ...quizAnswers, [id]: val });
            };

            // Only used for button logic, actual validation happens in SmartInput
            const canProceedFromHunt = () => {
                // If instructor mode, allow
                if (instructorMode) return true;
                // Otherwise check if all answers roughly match (simplified check as visual feedback is in SmartInput)
                return Object.keys(quizAnswers).length === FORD_QUIZ.length;
            };

            return (
                <div className="max-w-6xl mx-auto p-6 fade-in pb-20 pt-8">
                    <h2 className="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                        <IconChart /> Receivables Reconstruction: Ford FY23
                    </h2>
                    
                    {/* Progress Tabs */}
                    <div className="flex items-center gap-4 mb-8 text-sm font-semibold text-slate-400 border-b border-slate-200 pb-4">
                        <button onClick={() => setPhase('dataHunt')} className={`flex items-center gap-2 hover:text-teal-600 ${phase === 'dataHunt' ? 'text-teal-600' : ''}`}>
                            <span className="w-6 h-6 rounded-full border border-current flex items-center justify-center">1</span> Data Hunt
                        </button>
                        <div className="h-px bg-slate-300 w-8"></div>
                        <button onClick={() => setPhase('baseCase')} className={`flex items-center gap-2 hover:text-teal-600 ${phase === 'baseCase' ? 'text-teal-600' : ''}`}>
                            <span className="w-6 h-6 rounded-full border border-current flex items-center justify-center">2</span> Base Reconstruction
                        </button>
                        <div className="h-px bg-slate-300 w-8"></div>
                        <button onClick={() => setPhase('scenarioB')} className={`flex items-center gap-2 hover:text-teal-600 ${phase === 'scenarioB' ? 'text-teal-600' : ''}`}>
                            <span className="w-6 h-6 rounded-full border border-current flex items-center justify-center">3</span> Impact Analysis
                        </button>
                    </div>

                    {phase === 'dataHunt' && (
                        <div className="bg-white p-8 rounded-xl shadow-md border border-slate-200 fade-in">
                            <div className="flex justify-between items-start mb-6">
                                <div className="max-w-2xl">
                                    <h3 className="text-xl font-bold text-slate-800">Step 1: 10-K Data Extraction</h3>
                                    <div className="mt-3 p-4 bg-blue-50 text-blue-900 text-sm rounded-lg border border-blue-100 leading-relaxed">
                                        <strong className="block mb-1 text-blue-700 flex items-center gap-1"><IconBriefcase /> Audit Instruction</strong>
                                        Enter the values exactly as found in the Ford 10-K (Note 10). Math expressions (e.g., 78274 - 879) are supported.
                                    </div>
                                </div>
                                <a href="https://www.sec.gov/ix?doc=/Archives/edgar/data/37996/000003799624000009/f-20231231.htm" target="_blank" className="flex items-center gap-2 bg-indigo-50 text-indigo-700 px-4 py-2 rounded-lg font-semibold hover:bg-indigo-100 transition-colors shrink-0 ml-4 mt-1">
                                    Open SEC 10-K <IconExternalLink />
                                </a>
                            </div>
                            <div className="grid gap-6 max-w-3xl">
                                {FORD_QUIZ.map((item) => (
                                    <div key={item.id} className="bg-slate-50 p-4 rounded-lg border border-slate-200 flex items-center justify-between gap-4">
                                        <label className="text-slate-700 font-medium w-1/2">{item.q}</label>
                                        <div className="w-1/2">
                                            <SmartInput 
                                                id={item.id}
                                                value={quizAnswers[item.id]}
                                                onChange={(val) => handleQuizChange(item.id, val)}
                                                correctValue={item.a}
                                                instructorMode={instructorMode}
                                                placeholder={item.hint || "Value from 10-K"}
                                            />
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <button onClick={() => setPhase('baseCase')} className="mt-8 px-8 py-3 bg-slate-800 text-white font-bold rounded-lg hover:bg-slate-700 shadow-lg transition-transform active:scale-95">
                                Proceed to Analysis &rarr;
                            </button>
                        </div>
                    )}

                    {phase === 'baseCase' && (
                        <div className="bg-white p-8 rounded-xl shadow-md border border-slate-200 fade-in">
                             <div className="mb-6">
                                <h3 className="text-xl font-bold text-slate-800">Step 2: Base Case Reconstruction</h3>
                                <p className="text-slate-500">Assume <strong>60%</strong> of Consumer Revenue is on credit. Solve for Cash Collections.</p>
                            </div>
                            <div className="flex flex-col items-center">
                                <div className="w-full max-w-2xl">
                                    <AnalysisBlock 
                                        scenarioName="Base Case: 60% Credit Sales"
                                        creditPct={0.60}
                                        data={FORD_DATA}
                                        isInteractive={true}
                                        userValues={{ credit: userCredit60, cash: userCash60 }}
                                        onUpdate={(field, val) => updateState(field === 'credit' ? 'userCredit60' : 'userCash60', val)}
                                        instructorMode={instructorMode}
                                    />
                                </div>
                                <button onClick={() => setPhase('scenarioB')} className="mt-8 px-8 py-3 bg-teal-600 text-white font-bold rounded-lg hover:bg-teal-700 shadow-lg animate-pulse-once">
                                    Proceed to Scenario B &rarr;
                                </button>
                            </div>
                        </div>
                    )}

                    {phase === 'scenarioB' && (
                        <div className="bg-white p-8 rounded-xl shadow-md border border-slate-200 fade-in">
                            <div className="mb-6 text-center">
                                <h3 className="text-xl font-bold text-slate-800">Step 3: Comparative Impact Analysis</h3>
                                <p className="text-slate-500">Solve the <strong>Hypothetical (30%)</strong> scenario to compare against your Base Case.</p>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 relative">
                                <div className="hidden md:block absolute left-1/2 top-0 bottom-0 w-px bg-slate-100 -ml-px"></div>
                                <div className="opacity-75 grayscale-[0.5] pointer-events-none">
                                    <AnalysisBlock 
                                        scenarioName="Base Case (60%)"
                                        creditPct={0.60}
                                        data={FORD_DATA}
                                        isInteractive={false}
                                        userValues={{ credit: userCredit60, cash: userCash60 }}
                                        instructorMode={instructorMode}
                                    />
                                </div>
                                <div>
                                    <AnalysisBlock 
                                        scenarioName="Hypothetical (30%)"
                                        creditPct={0.30}
                                        data={FORD_DATA}
                                        isInteractive={true}
                                        userValues={{ credit: userCredit30, cash: userCash30 }}
                                        onUpdate={(field, val) => updateState(field === 'credit' ? 'userCredit30' : 'userCash30', val)}
                                        instructorMode={instructorMode}
                                    />
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Component: Dashboard (Main Menu) ---
        const Dashboard = ({ setView, onDownload, hasData, studentName, setStudentName }) => {
            return (
                <div className="max-w-4xl mx-auto pt-12 px-6 fade-in mt-6">
                    <div className="text-center mb-16">
                        <h1 className="text-4xl md:text-5xl font-extrabold text-slate-800 mb-4 tracking-tight">
                            Corporate Reporting <span className="text-teal-600">Forensics</span>
                        </h1>
                        <p className="text-xl text-slate-500">Select a module to begin your audit simulation.</p>
                        
                        {/* Student Name & Download */}
                        <div className="mt-8 p-6 bg-slate-100 rounded-xl inline-block border border-slate-200">
                            <label className="block text-sm font-bold text-slate-600 mb-2 text-left">Student Identification</label>
                            <div className="flex flex-col sm:flex-row gap-3">
                                <input 
                                    type="text" 
                                    placeholder="Enter your full name" 
                                    className="px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 w-64"
                                    value={studentName}
                                    onChange={(e) => setStudentName(e.target.value)}
                                />
                                <button
                                    onClick={onDownload}
                                    disabled={!hasData || !studentName.trim()}
                                    className={`inline-flex items-center gap-2 px-6 py-2 rounded-lg font-bold transition-all shadow-md
                                        ${hasData && studentName.trim()
                                            ? 'bg-slate-800 text-white hover:bg-slate-700 hover:-translate-y-1' 
                                            : 'bg-slate-200 text-slate-400 cursor-not-allowed'}`}
                                >
                                    <IconDownload /> Save Work
                                </button>
                            </div>
                            {!studentName.trim() && <p className="text-xs text-red-400 mt-2 text-left">* Name required to save</p>}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        {/* Module Cards (Same as before) */}
                        <div onClick={() => setView('revenue')} className="bg-white p-8 rounded-2xl shadow-xl hover:shadow-2xl transition-all cursor-pointer border border-slate-100 group hover:-translate-y-1">
                            <div className="w-16 h-16 bg-teal-100 rounded-2xl flex items-center justify-center mb-6 text-teal-600 group-hover:bg-teal-600 group-hover:text-white transition-colors">
                                <IconBriefcase />
                            </div>
                            <h2 className="text-2xl font-bold text-slate-800 mb-2">Revenue Recognition</h2>
                            <p className="text-sm text-slate-600">Evaluate 5 complex contracts involving cloud services, software licenses, and hardware bundles.</p>
                            <div className="mt-6 text-teal-600 font-bold flex items-center gap-2 group-hover:translate-x-2 transition-transform">Start Audit &rarr;</div>
                        </div>

                        <div onClick={() => setView('receivables')} className="bg-white p-8 rounded-2xl shadow-xl hover:shadow-2xl transition-all cursor-pointer border border-slate-100 group hover:-translate-y-1">
                            <div className="w-16 h-16 bg-indigo-100 rounded-2xl flex items-center justify-center mb-6 text-indigo-600 group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                                <IconChart />
                            </div>
                            <h2 className="text-2xl font-bold text-slate-800 mb-2">Receivables Forensics</h2>
                            <p className="text-sm text-slate-600">Reconstruct the T-Account for Consumer Finance Receivables using real 10-K data.</p>
                            <div className="mt-6 text-indigo-600 font-bold flex items-center gap-2 group-hover:translate-x-2 transition-transform">Start Investigation &rarr;</div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Auth Modal ---
        const AuthModal = ({ isOpen, onAuth, onClose }) => {
            const [pass, setPass] = useState("");
            const [err, setErr] = useState("");

            if (!isOpen) return null;

            const submit = () => {
                if (pass.toLowerCase() === "teacher") onAuth();
                else setErr("Invalid Password");
            };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm fade-in">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2"><IconLock /> Instructor Access</h3>
                            <button onClick={onClose}><IconX /></button>
                        </div>
                        <input 
                            type="password" 
                            className="w-full p-2 border rounded mb-4" 
                            placeholder="Password" 
                            value={pass}
                            onChange={e => {setPass(e.target.value); setErr("");}}
                            onKeyDown={e => e.key === 'Enter' && submit()}
                        />
                        {err && <p className="text-red-500 text-sm mb-4">{err}</p>}
                        <button onClick={submit} className="w-full bg-slate-800 text-white py-2 rounded font-bold hover:bg-slate-700">Login</button>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [view, setView] = useState('dashboard');
            const [instructorMode, setInstructorMode] = useState(false);
            const [showAuth, setShowAuth] = useState(false);
            const [studentName, setStudentName] = useState("");
            
            const [microsoftState, setMicrosoftState] = useState({ completedCases: [], answers: {}, selections: {}, isSubmitted: false });
            const [fordState, setFordState] = useState({ quizAnswers: {}, userCredit60: "", userCash60: "", userCredit30: "", userCash30: "" });

            const hasData = (microsoftState.completedCases.length > 0) || (Object.keys(fordState.quizAnswers).length > 0);

            // Instructor Actions
            const handleAutoFill = () => {
                // Fill Ford Data
                const newQuiz = {};
                FORD_QUIZ.forEach(q => newQuiz[q.id] = q.a.toString());
                
                const c60 = Math.round((FORD_DATA.totalRevenue * FORD_DATA.consumerPct) * 0.60);
                const cash60 = FORD_DATA.begAR + c60 - FORD_DATA.writeOffs - FORD_DATA.endAR;
                const c30 = Math.round((FORD_DATA.totalRevenue * FORD_DATA.consumerPct) * 0.30);
                const cash30 = FORD_DATA.begAR + c30 - FORD_DATA.writeOffs - FORD_DATA.endAR;

                setFordState({
                    quizAnswers: newQuiz,
                    userCredit60: c60.toString(),
                    userCash60: cash60.toString(),
                    userCredit30: c30.toString(),
                    userCash30: cash30.toString()
                });

                // Fill Microsoft Data
                const allCases = microsoftCases.map(c => c.id);
                const correctSelections = {};
                const correctAnswers = {};
                microsoftCases.forEach(c => {
                    const corr = c.options.find(o => o.correct);
                    if(corr) {
                        correctSelections[c.id] = corr.id;
                        correctAnswers[c.id] = corr.text;
                    }
                });
                
                setMicrosoftState({ 
                    completedCases: allCases, 
                    answers: correctAnswers,
                    selections: correctSelections,
                    isSubmitted: true
                });
            };

            const handleClearAll = () => {
                setMicrosoftState({ completedCases: [], answers: {}, selections: {}, isSubmitted: false });
                setFordState({ quizAnswers: {}, userCredit60: "", userCash60: "", userCredit30: "", userCash30: "" });
                setInstructorMode(false); // Requirement: "Clears all fields AND exits instructor mode"
            };

            const handleDownload = () => {
                const date = new Date().toLocaleDateString();
                const time = new Date().toLocaleTimeString();
                
                // Generate Verification Hash
                const hashPayload = {
                    name: studentName,
                    score: `MSFT: ${microsoftState.completedCases.length}/${microsoftCases.length}, FORD: ${Object.keys(fordState.quizAnswers).length > 0 ? 'Active' : 'Inactive'}`,
                    timestamp: `${date} ${time}`
                };
                const verificationHash = btoa(JSON.stringify(hashPayload));

                let report = `CORPORATE REPORTING FORENSICS LAB - STUDENT REPORT\n`;
                report += `Student: ${studentName}\n`;
                report += `Date: ${date} ${time}\n`;
                report += `Verification Hash: ${verificationHash}\n`;
                report += `=================================================\n\n`;

                report += `MODULE 1: REVENUE RECOGNITION (MICROSOFT)\n`;
                report += `Status: ${microsoftState.completedCases.length} / ${microsoftCases.length} Cases Analyzed\n\n`;

                report += `MODULE 2: RECEIVABLES FORENSICS (FORD)\n`;
                report += `10-K Extraction Data:\n`;
                Object.keys(fordState.quizAnswers).forEach(k => {
                    report += `- ${k}: ${fordState.quizAnswers[k]}\n`;
                });
                report += `\nBase Case (60% Credit): Credit=${fordState.userCredit60}, Cash=${fordState.userCash60}\n`;
                report += `Hypothetical (30% Credit): Credit=${fordState.userCredit30}, Cash=${fordState.userCash30}\n`;

                const blob = new Blob([report], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${studentName.replace(/\s+/g, '_')}_submission.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            return (
                <div className="min-h-screen pb-12 pt-16">
                    {/* Sticky Instructor Toolbar */}
                    <InstructorToolbar 
                        isActive={instructorMode} 
                        onAutoFill={handleAutoFill}
                        onClearAll={handleClearAll}
                    />

                    {/* Main Nav */}
                    <nav className="bg-white border-b border-slate-200 fixed top-0 w-full z-40 h-16">
                        <div className="max-w-6xl mx-auto px-6 h-full flex items-center justify-between">
                            <div 
                                className="font-bold text-slate-800 flex items-center gap-2 cursor-pointer hover:opacity-80"
                                onClick={() => setView('dashboard')}
                            >
                                <div className="bg-slate-800 text-white w-8 h-8 rounded flex items-center justify-center font-serif text-lg">F</div>
                                <span className="hidden sm:inline">Forensics Lab</span>
                            </div>
                            
                            <div className="flex items-center gap-4">
                                {view !== 'dashboard' && (
                                    <button 
                                        onClick={() => setView('dashboard')}
                                        className="text-sm font-medium text-slate-500 hover:text-slate-800 flex items-center gap-1"
                                    >
                                        <IconArrowLeft /> Dashboard
                                    </button>
                                )}
                                <button 
                                    onClick={() => setShowAuth(true)}
                                    className="flex items-center gap-1 text-xs font-bold text-slate-400 hover:text-slate-600 border border-slate-200 px-2 py-1 rounded"
                                >
                                    <IconLock /> Instructor
                                </button>
                            </div>
                        </div>
                    </nav>

                    {/* Main Content */}
                    <main>
                        {view === 'dashboard' && (
                            <Dashboard 
                                setView={setView} 
                                onDownload={handleDownload} 
                                hasData={hasData}
                                studentName={studentName}
                                setStudentName={setStudentName}
                            />
                        )}
                        {view === 'revenue' && (
                            <RevenueAudit 
                                onComplete={() => setView('dashboard')} 
                                instructorMode={instructorMode} 
                                savedState={microsoftState}
                                onSaveState={(newState) => setMicrosoftState(prev => ({ ...prev, ...newState }))}
                            />
                        )}
                        {view === 'receivables' && (
                            <ReceivablesForensics 
                                instructorMode={instructorMode} 
                                savedState={fordState}
                                onSaveState={(newState) => setFordState(prev => ({ ...prev, ...newState }))}
                            />
                        )}
                    </main>

                    {/* Instructor Auth Modal */}
                    <AuthModal isOpen={showAuth} onClose={() => setShowAuth(false)} onAuth={() => { setShowAuth(false); setInstructorMode(true); }} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>