<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçè AAPL 2025 Analyst Hunt</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #F5F5F7;
            --sidebar-bg: #1D1D1F;
            --card-bg: #FFFFFF;
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --accent-blue: #0071E3;
            --accent-blue-hover: #0077ED;
            --accent-green: #34C759;
            --accent-red: #FF3B30;
            --accent-orange: #FF9F0A;
            --border-color: #D2D2D7;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.08);
            --radius-lg: 18px;
            --radius-md: 12px;
            --font-stack: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        
        body { 
            font-family: var(--font-stack); 
            background: var(--bg-color); 
            color: var(--text-primary); 
            height: 100vh;
            overflow: hidden;
        }
        
        /* Layout Grid */
        .app-container { 
            display: grid; 
            grid-template-columns: 320px 1fr; 
            height: 100vh; 
        }

        /* Sidebar Styling */
        aside { 
            background: var(--sidebar-bg); 
            color: white; 
            padding: 40px 24px; 
            display: flex; 
            flex-direction: column; 
            overflow-y: auto;
            position: relative;
            z-index: 10;
            box-shadow: 4px 0 24px rgba(0,0,0,0.1);
        }

        .brand-header {
            margin-bottom: 40px;
            text-align: center;
        }
        
        .brand-logo {
            font-size: 48px;
            margin-bottom: 10px;
            display: block;
            text-shadow: 0 0 20px rgba(255,255,255,0.2);
        }

        h1 { 
            font-size: 24px; 
            font-weight: 700; 
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, #fff 0%, #a1a1aa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle { 
            color: #86868b; 
            font-size: 13px; 
            font-weight: 500; 
            margin-top: 5px;
        }
        
        /* Dashboard Widgets in Sidebar */
        .widget-grid {
            display: grid;
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat-card { 
            background: rgba(255,255,255,0.1); 
            backdrop-filter: blur(10px);
            padding: 20px; 
            border-radius: var(--radius-md); 
            text-align: center; 
            border: 1px solid rgba(255,255,255,0.05);
            transition: transform 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            background: rgba(255,255,255,0.15); 
        }

        .stat-label { 
            color: #86868b; 
            font-size: 11px; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .stat-value { 
            font-size: 32px; 
            font-weight: 700; 
            font-variant-numeric: tabular-nums;
            letter-spacing: -1px;
            position: relative;
            z-index: 2;
        }

        .timer-val { color: var(--accent-orange); }
        .score-val { color: var(--accent-green); }
        
        .total-points {
            font-size: 14px;
            color: rgba(255,255,255,0.4);
            font-weight: 500;
            margin-left: 4px;
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 100px;
            margin-top: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-bar {
            height: 100%;
            background: var(--accent-green);
            width: 0%;
            border-radius: 100px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 10px rgba(52, 199, 89, 0.4);
        }

        /* Sidebar Actions */
        .action-group { margin-top: auto; display: flex; flex-direction: column; gap: 12px; }
        
        button {
            border: none;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .btn-glass {
            background: rgba(255,255,255,0.1);
            color: white;
            padding: 14px;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .btn-glass:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.02);
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
            padding: 16px;
            border-radius: var(--radius-md);
            font-size: 15px;
            font-weight: 600;
            width: 100%;
            box-shadow: 0 4px 12px rgba(0, 113, 227, 0.3);
        }

        .btn-primary:hover {
            background: var(--accent-blue-hover);
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(0, 113, 227, 0.4);
        }
        
        .btn-verify {
            background: var(--text-primary);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
        }

        .btn-teacher {
            background: transparent;
            color: #6e6e73;
            font-size: 12px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .btn-teacher:hover { color: white; }

        /* Main Content Area */
        main { 
            padding: 40px 60px; 
            overflow-y: auto; 
            background: var(--bg-color);
            position: relative;
        }
        
        /* Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 30px;
        }

        .header-title h2 {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .header-title p {
            color: var(--text-secondary);
            margin-top: 5px;
            font-size: 15px;
        }

        .sec-link {
            background: white;
            color: var(--accent-blue);
            padding: 12px 24px;
            border-radius: 100px;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .sec-link:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            background: #fbfbfd;
        }

        /* Notices */
        .notice-banner { 
            background: #FFF4E5; 
            color: #663C00; 
            padding: 16px; 
            border-radius: var(--radius-md); 
            margin-bottom: 30px; 
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            border: 1px solid rgba(255, 159, 10, 0.2);
        }
        
        .badge-pill {
            background: var(--accent-red);
            color: white;
            font-size: 10px;
            font-weight: 800;
            padding: 4px 10px;
            border-radius: 100px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Grid System */
        .challenges-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); 
            gap: 24px; 
            padding-bottom: 60px;
        }
        
        /* Cards */
        .card { 
            background: var(--card-bg); 
            padding: 24px; 
            border-radius: var(--radius-lg); 
            box-shadow: var(--shadow-sm); 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); 
            border: 1px solid transparent; 
            position: relative; 
            display: flex;
            flex-direction: column;
        }
        
        .card:hover { 
            transform: translateY(-4px); 
            box-shadow: var(--shadow-md); 
        }
        
        /* Card States */
        .card.solved { 
            border-color: var(--accent-green); 
            background: #F2FCF4; 
        }
        
        .card.solved .status-icon {
            opacity: 1;
            color: var(--accent-green);
            transform: scale(1);
        }
        
        .card.failed { 
            border-color: var(--accent-red); 
            background: #FFF5F5; 
        }

        .card.failed .status-icon {
            opacity: 1;
            color: var(--accent-red);
            transform: scale(1);
        }

        .status-icon {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 20px;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .q-header { 
            margin-bottom: 20px; 
            padding-right: 30px;
        }
        
        .q-title { 
            font-size: 17px; 
            font-weight: 600; 
            color: var(--text-primary); 
            line-height: 1.4; 
        }
        
        .q-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            font-size: 12px;
        }

        .points-tag { 
            background: #E5E5EA; 
            padding: 4px 12px; 
            border-radius: 100px; 
            font-weight: 700; 
            color: var(--text-primary); 
        }
        
        .attempt-counter { 
            font-weight: 600; 
            color: var(--text-secondary); 
            text-transform: uppercase; 
            letter-spacing: 0.5px;
            font-size: 10px;
        }
        
        .attempt-warning { color: var(--accent-orange); }
        .attempt-critical { color: var(--accent-red); }

        /* Inputs */
        .input-group { margin-bottom: 20px; position: relative; }

        input[type="text"] { 
            width: 100%; 
            padding: 16px; 
            border: 1px solid var(--border-color); 
            border-radius: var(--radius-md); 
            font-size: 16px; 
            font-family: 'SF Mono', 'Menlo', 'Monaco', 'Courier New', monospace; 
            transition: all 0.2s; 
            background: #fff;
            color: var(--text-primary);
        }
        
        input[type="text"]:focus { 
            border-color: var(--accent-blue); 
            box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.15); 
        }
        
        .solved input[type="text"] { 
            border-color: var(--accent-green); 
            color: #15803d; 
            background: white; 
            font-weight: 600;
        }
        
        .failed input[type="text"] { 
            border-color: var(--accent-red); 
            color: var(--accent-red); 
            background: #FFF5F5; 
            text-decoration: line-through; 
        }
        
        .input-helper { 
            font-size: 11px; 
            color: var(--text-secondary); 
            margin-top: 6px; 
            padding-left: 4px;
        }

        /* MCQ */
        .mcq-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
            margin-bottom: 20px;
        }
        
        .mcq-btn { 
            padding: 12px 16px; 
            background: #F2F2F7; 
            border: 1px solid transparent; 
            border-radius: 10px; 
            cursor: pointer; 
            font-size: 13px; 
            color: var(--text-primary); 
            text-align: left; 
            transition: all 0.2s; 
            line-height: 1.3;
        }
        
        .mcq-btn:hover:not(:disabled) { 
            background: #E5E5EA; 
        }
        
        .mcq-btn.correct { 
            background: var(--accent-green); 
            color: white; 
            border-color: var(--accent-green); 
        }
        
        .mcq-btn.wrong { 
            background: var(--accent-red); 
            color: white; 
            border-color: var(--accent-red); 
            opacity: 0.8; 
        }

        /* Hint Box */
        .hint-box { 
            margin-top: auto;
            font-size: 12px; 
            color: var(--text-secondary); 
            background: #F5F5F7; 
            padding: 12px; 
            border-radius: 8px; 
            display: flex; 
            gap: 10px; 
            align-items: flex-start; 
            line-height: 1.4;
        }
        
        .hint-icon { color: var(--accent-blue); }
        
        /* New Insight Box (Hidden until solved) */
        .insight-box {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #E8F2FF;
            border-radius: 12px;
            color: var(--accent-blue);
            font-size: 13px;
            line-height: 1.5;
            border-left: 4px solid var(--accent-blue);
            animation: slideDown 0.4s ease-out;
            font-weight: 500;
        }
        
        .insight-box strong {
            display: block;
            margin-bottom: 4px;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
            opacity: 0.8;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Animations */
        @keyframes shake { 
            0%, 100% { transform: translateX(0); } 
            25% { transform: translateX(-6px); } 
            75% { transform: translateX(6px); } 
        }
        
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }

        /* Modal */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); 
            backdrop-filter: blur(8px);
            align-items: center; 
            justify-content: center; 
            z-index: 1000; 
        }
        
        .modal-content { 
            background: white; 
            padding: 40px; 
            border-radius: 24px; 
            width: 90%; 
            max-width: 800px; 
            box-shadow: 0 40px 80px rgba(0,0,0,0.2); 
            max-height: 90vh; 
            overflow-y: auto; 
            animation: modalPop 0.3s ease-out;
        }

        @keyframes modalPop {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* Table Styles */
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 20px; }
        th { text-align: left; color: var(--text-secondary); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; padding: 16px; border-bottom: 1px solid var(--border-color); background: #fff; position: sticky; top: 0; }
        td { padding: 16px; border-bottom: 1px solid #f5f5f7; color: var(--text-primary); vertical-align: top; font-size: 14px; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: #fbfbfd; }
        
        /* Verify Section */
        .verify-box {
            background: #f9f9f9;
            border: 1px solid #e5e5ea;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
        }
        
        .verify-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            margin-bottom: 10px;
        }
        
        .verify-result {
            display: none;
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid transparent;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .app-container { grid-template-columns: 260px 1fr; }
            .challenges-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .app-container { display: block; height: auto; overflow: auto; }
            aside { height: auto; padding: 30px 20px; }
            main { padding: 30px 20px; height: auto; overflow: visible; }
            .header-title { margin-bottom: 20px; }
            .sec-link { width: 100%; justify-content: center; margin-top: 10px; }
            .section-header { flex-direction: column; align-items: flex-start; }
            .mcq-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <!-- SIDEBAR -->
    <aside>
        <div class="brand-header">
            <span class="brand-logo">üçè</span>
            <h1>10-K Analyst</h1>
            <p class="subtitle">Fiscal Year 2025</p>
        </div>
        
        <div class="widget-grid">
            <div class="stat-card">
                <div class="stat-label">Time Remaining</div>
                <div id="timer" class="stat-value timer-val">45:00</div>
            </div>

            <div class="stat-card">
                <div class="stat-label">Current Score</div>
                <div class="stat-value score-val">
                    <span id="scoreDisplay">0</span>
                    <span id="totalPointsDisplay" class="total-points">/ 0</span>
                </div>
                <div class="progress-container">
                    <div id="progressBar" class="progress-bar"></div>
                </div>
            </div>
        </div>
        
        <div class="action-group">
            <button onclick="openNameModal()" class="btn-glass">
                <i class="fas fa-download"></i> Download Report
            </button>
            <button onclick="resetGame()" class="btn-glass">
                <i class="fas fa-rotate-right"></i> Reset System
            </button>
            <button onclick="openTeacherModal()" class="btn-teacher">
                <i class="fas fa-lock"></i> Instructor Access
            </button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main>
        <!-- Added Image as requested -->
        <img src="image/10-k-nblm.png" style="width: 100%; height: auto; border-radius: var(--radius-lg); margin-bottom: 30px; box-shadow: var(--shadow-sm); object-fit: cover;" alt="Analysis Overview">

        <div class="section-header">
            <div class="header-title">
                <h2>Mission Dashboard</h2>
                <p>Locate 27 critical data points in the Apple Inc. 2025 Annual Report.</p>
            </div>
            <a href="https://www.sec.gov/ix?doc=/Archives/edgar/data/320193/000032019325000079/aapl-20250927.htm" target="_blank" class="sec-link">
                <i class="fas fa-file-invoice-dollar"></i> Open 2025 SEC Filing
            </a>
        </div>

        <div class="notice-banner">
            <span class="badge-pill">Strict Mode</span>
            <span>You have <strong>2 attempts</strong> per data point before the system locks the field. Accuracy is paramount.</span>
        </div>
        
        <div id="gameGrid" class="challenges-grid">
            <!-- Cards injected by JS -->
        </div>
    </main>
</div>

<!-- Name Input Modal -->
<div id="nameModal" class="modal">
    <div class="modal-content" style="max-width: 400px; text-align: center;">
        <i class="fas fa-user-circle" style="font-size: 48px; color: var(--accent-blue); margin-bottom: 20px;"></i>
        <h3 style="margin-bottom: 10px; font-size: 20px;">Analyst Identification</h3>
        <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 14px;">Enter your full name to generate the official performance report.</p>
        
        <input type="text" id="reportNameInput" class="verify-input" style="font-size: 16px; padding: 15px; text-align: center; margin-bottom: 20px;" placeholder="Full Name" autocomplete="off">
        
        <div style="display: flex; gap: 10px;">
            <button onclick="closeNameModal()" class="btn-glass" style="background: #f5f5f7; color: #333; flex: 1;">Cancel</button>
            <button onclick="generateReport()" class="btn-primary" style="flex: 1;">Generate</button>
        </div>
    </div>
</div>

<!-- Teacher Modal -->
<div id="teacherModal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; border-bottom:1px solid #eee; padding-bottom:20px;">
            <h2 style="margin:0; font-size: 24px;">Instructor Dashboard</h2>
            <button onclick="closeTeacherModal()" style="background:none; border:none; font-size:24px; color:#999; cursor:pointer; padding:5px;">&times;</button>
        </div>

        <!-- Auth View -->
        <div id="authView" style="text-align:center; padding: 20px 0;">
            <i class="fas fa-shield-alt" style="font-size: 48px; color: var(--border-color); margin-bottom: 20px;"></i>
            <p style="margin-bottom:20px; color:var(--text-secondary);">Enter the administrative password to unlock the answer key.</p>
            
            <div style="max-width: 300px; margin: 0 auto;">
                <input type="password" id="teacherPass" placeholder="Enter Password" style="text-align:center; margin-bottom: 15px;">
                <button class="btn-primary" onclick="checkTeacherPass()">Access Key</button>
                <div id="authError" style="color:var(--accent-red); margin-top:15px; font-weight:600; display:none; font-size:14px;">
                    <i class="fas fa-exclamation-circle"></i> Access Denied
                </div>
            </div>
        </div>

        <!-- Key View -->
        <div id="keyView" style="display:none;">
            <div style="background:#E8F2FF; padding:15px; border-radius:12px; margin-bottom:20px; color:var(--accent-blue); font-weight:600; display:flex; align-items:center; gap:10px;">
                <i class="fas fa-unlock"></i> Authentication Successful: Master Key Revealed
            </div>
            
            <!-- Instructor Controls -->
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
                <button onclick="fillAllAnswers()" class="btn-primary" style="background: var(--accent-green);">
                    <i class="fas fa-magic"></i> Auto-Fill Board
                </button>
                <button onclick="clearAllAnswers()" class="btn-primary" style="background: var(--accent-red);">
                    <i class="fas fa-trash-alt"></i> Clear Board
                </button>
            </div>

            <div style="overflow-x:auto;">
                <table id="keyTable">
                    <thead>
                        <tr>
                            <th>Inquiry</th>
                            <th>Target Value</th>
                            <th>Reference Path</th>
                        </tr>
                    </thead>
                    <tbody id="keyBody"></tbody>
                </table>
            </div>

            <!-- Verification Tool -->
            <div class="verify-box">
                <h3 style="margin-bottom:10px; font-size:16px;">Verify Report Signature</h3>
                <p style="font-size:12px; color:var(--text-secondary); margin-bottom:10px;">Paste the "Verification Hash" from the bottom of a student report to validate its authenticity.</p>
                <input type="text" id="verifyInput" class="verify-input" placeholder="Paste hash here (e.g. eyJ...)" autocomplete="off">
                <button onclick="verifyHash()" class="btn-verify">Verify Hash</button>
                <div id="verifyResult" class="verify-result"></div>
            </div>
        </div>
    </div>
</div>

<script>
// --- GAME DATA ---
// Organized by 10-K Flow:
// Item 1C (Cyber), Item 5 (Stock), Item 7 (MD&A), Item 8 (Financials - Inc, BS, CF, Notes), Audit
const CHALLENGES = [
    // --- 1. Item 1C: Cybersecurity ---
    { 
        id: 1, 
        type: 'mcq', 
        q: "Item 1C - Cybersecurity Governance: Who has primary oversight responsibility for cybersecurity risks at Apple?", 
        answer: "Board of Directors (Audit & Finance Committee)", 
        options: [
            "Board of Directors (Audit & Finance Committee)",
            "Chief Information Security Officer (CISO) only",
            "External Auditors (Ernst & Young)",
            "The Legal Department"
        ],
        points: 40, 
        hint: "Item 1C. Cybersecurity > Governance section.",
        insight: "Cybersecurity is treated as an enterprise-level risk with formal Board oversight, not just a technical IT function."
    },

    // --- 2. Item 5: Market & Stock ---
    { 
        id: 2, 
        type: 'exact', 
        q: "Item 5 - Stock Performance: Based on the 5-year cumulative return graph, what is the value of a $100 investment in Apple (AAPL) as of September 2025?", 
        exact: ["234", "$234", "234.00"], 
        points: 40, 
        hint: "Item 5: Market for Registrant's Common Equity > Performance Graph > Apple Inc. (2025 column)",
        insight: "$100 growing to $234 in 5 years outperforms many indices. This graph highlights long-term shareholder value creation despite short-term volatility."
    },

    // --- 3. Item 7: MD&A (Performance Drivers) ---
    { 
        id: 3, 
        type: 'mcq', 
        q: "Item 7 - MD&A: What primarily drove the 4% increase in iPhone Net Sales?", 
        answer: "Higher net sales of Pro models", 
        options: ["Higher net sales of Pro models", "Higher unit volumes of SE", "Favorable foreign exchange", "Price increases across all models"],
        points: 50, 
        hint: "MD&A > iPhone Performance (Look for 'Pro models')",
        insight: "Pro models drive the Average Selling Price (ASP) up. This mix shift towards premium devices helps revenue even if unit volume stagnates."
    },
    { 
        id: 4, 
        type: 'mcq', 
        q: "Item 7 - MD&A: What factors primarily drove the 14% growth in Services?", 
        answer: "Advertising, App Store, and Cloud", 
        options: ["Advertising, App Store, and Cloud", "AppleCare+ and Repairs", "Licensing Fees only", "Hardware Bundling"],
        points: 50, 
        hint: "MD&A > Services Performance",
        insight: "Growth in Advertising and Cloud reduces reliance on just App Store commissions, showing a diversifying services portfolio."
    },
    { 
        id: 5, 
        type: 'mcq', 
        q: "Item 7 - Geographic Insight: Which region had the highest YoY growth (+15%) in FY2025 and why?", 
        answer: "Japan; Higher net sales of iPhone, Services and iPad", 
        options: [
            "Japan; Higher net sales of iPhone, Services and iPad",
            "Europe; Favorable foreign exchange rates and Mac sales",
            "Americas; Strong Services performance offsetting iPhone",
            "Greater China; Increased retail footprint expansion"
        ],
        points: 50, 
        hint: "MD&A > Segment Operating Performance > Japan",
        insight: "Japan's growth can be volatile due to currency (Yen), but it remains a loyal high-end market for Apple products."
    },

    // --- 4. Item 8: Financial Statements (Income Statement) ---
    { 
        id: 6, type: 'exact', q: "Income Statement: What was Apple's Total Net Sales (Revenue) for 2025?", exact: ["416161", "416,161"], points: 30, hint: "Income Statement > Top Line",
        insight: "Total Net Sales represents the top-line growth. Compare this to prior years to gauge overall demand for Apple's ecosystem."
    },
    { 
        id: 7, type: 'exact', q: "Revenue Detail: What was the total Net Sales revenue for iPhone?", exact: ["209586", "209,586"], points: 40, hint: "Notes > Segment Info > Products",
        insight: "iPhone remains Apple's largest revenue driver. Watch this trend closely for shifts in consumer hardware cycles."
    },
    { 
        id: 8, type: 'exact', q: "Revenue Detail: What was the total Net Sales revenue for Mac products?", exact: ["33708", "33,708"], points: 40, hint: "Notes > Segment Info > Products Table",
        insight: "Mac revenue fluctuates with product release cycles (M-series chips) and broader PC market trends."
    },
    { 
        id: 9, type: 'exact', q: "Revenue Detail: What was the Net Sales revenue for the Americas segment?", exact: ["178353", "178,353"], points: 50, hint: "Notes > Segment Info > Geo Data",
        insight: "The Americas is typically Apple's largest and most profitable geographic segment."
    },
    { 
        id: 10, type: 'exact', q: "Revenue Detail: What was the Net Sales revenue for the Europe segment?", exact: ["111032", "111,032"], points: 50, hint: "Notes > Segment Info > Geo Data",
        insight: "Europe is a critical market, often impacted by regulatory changes (DMA) and currency fluctuations."
    },
    { 
        id: 11, type: 'exact', q: "Expenses: What was the total Research and Development (R&D) expense in fiscal year 2024?", exact: ["31370", "31,370"], points: 40, hint: "Income Statement > Operating Expenses",
        insight: "R&D investment fuels future innovation (Vision Pro, AI, Silicon). It's a necessary expense for maintaining tech leadership."
    },
    { 
        id: 12, 
        type: 'exact', 
        q: "Tax Dynamics: Calculate the Effective Tax Rate for 2025. Compare it to the 21% U.S. statutory rate (it is likely lower). Enter your calculated percentage (e.g. 12.5).", 
        exact: ["15.6", "15.6%"], 
        points: 50, 
        hint: "Provision ($20,719) √∑ Income Before Taxes ($132,729). See Note on Income Taxes.",
        insight: "Apple's effective rate (15.6%) is lower than the US statutory rate (21%) largely due to foreign earnings taxed at lower rates and R&D credits."
    },
    { 
        id: 13, type: 'exact', q: "Income Statement: What was the Net Income (Bottom Line) for 2025?", exact: ["112010", "112,010"], points: 30, hint: "Income Statement > Bottom Line",
        insight: "Net Income is the 'bottom line' profit. A strong net income indicates operational efficiency after all expenses and taxes."
    },

    // --- 5. Item 8: Financial Statements (Balance Sheet) ---
    { 
        id: 14, type: 'exact', q: "Balance Sheet: What is the Total Assets value?", exact: ["359241", "359,241"], points: 30, hint: "Balance Sheet > Very Bottom",
        insight: "Assets = Liabilities + Equity. This figure shows the immense scale of Apple's resources, including cash, inventory, and property."
    },
    { 
        id: 15, type: 'exact', q: "Balance Sheet: What is the value of Property, Plant and Equipment, net?", exact: ["49834", "49,834"], points: 40, hint: "Balance Sheet > Property, Plant & Equipment",
        insight: "This includes Data Centers, Retail Stores, and Corporate Offices (Apple Park). Note that 'Net' means Gross PPE minus Accumulated Depreciation."
    },
    { 
        id: 16, 
        type: 'mcq', 
        q: "Accounting Concept: What is deducted from Gross PPE to arrive at the 'Net' PPE value shown on the Balance Sheet?", 
        answer: "Accumulated Depreciation", 
        options: ["Accumulated Depreciation", "Amortization of Goodwill", "Inventory Write-downs", "Deferred Revenue"], 
        points: 30, 
        hint: "Check the Property, Plant and Equipment Footnote details.",
        insight: "Net PPE = Gross PPE (Historical Cost) - Accumulated Depreciation. This reflects the remaining book value of the assets." 
    },
    { 
        id: 17, type: 'exact', q: "Balance Sheet: What is the value of Deferred Tax Assets listed under Non-Current Assets?", exact: ["20777", "20,777"], points: 60, hint: "Notes > Consolidated Financial Details > Other Non-Current Assets",
        insight: "Deferred Tax Assets represent future tax relief. They often arise from timing differences in when revenue/expenses are recognized for book vs. tax purposes."
    },
    { 
        id: 18, type: 'exact', q: "Balance Sheet: What is the value of Deferred Revenue listed under Current Liabilities?", exact: ["9055", "9,055"], points: 60, hint: "Balance Sheet > Current Liabilities",
        insight: "Deferred Revenue is cash collected but not yet earned (e.g., AppleCare, Gift Cards). It's a liability that turns into revenue over time."
    },
    { 
        id: 19, type: 'exact', q: "Balance Sheet: What is the amount of Income Taxes Payable listed under Current Liabilities?", exact: ["13016", "13,016"], points: 60, hint: "Notes > Consolidated Financial Details > Other Current Liabilities",
        insight: "This is the actual tax bill due within the next year, which is distinct from the total tax expense on the income statement."
    },
    { 
        id: 20, type: 'exact', q: "Balance Sheet: What is the value of Term Debt listed under Non-Current Liabilities?", exact: ["78328", "78,328"], points: 50, hint: "Balance Sheet > Non-Current Liabilities",
        insight: "Even cash-rich companies use debt for capital efficiency (buybacks/dividends) due to tax benefits of interest payments."
    },

    // --- 6. Item 8: Financial Statements (Cash Flows) ---
    { 
        id: 21, type: 'exact', q: "Cash Flows: What is the total Cash Generated by Operating Activities?", exact: ["111482", "111,482"], points: 50, hint: "Statement of Cash Flows > Operating Section",
        insight: "Operating Cash Flow is crucial. It shows actual cash generated from the core business, often higher than Net Income due to non-cash expenses like depreciation."
    },
    { 
        id: 22, 
        type: 'exact', 
        q: "Cash Flow Efficiency: Calculate the ratio of Operating Cash Flow to Net Income (Round to 3 decimals).", 
        exact: ["0.995", ".995"], 
        points: 50, 
        hint: "Find Total Operating Cash Flow and divide by Net Income (Check Cash Flow Stmt & Income Stmt).",
        insight: "A ratio near 1.0 (or 100%) indicates high earnings quality. It means profits are backed by actual cash, not just accounting adjustments."
    },
    { 
        id: 23, type: 'exact', q: "Cash Flows: What was the total dollar amount used for Repurchases of Common Stock?", exact: ["90711", "90,711"], points: 60, hint: "Cash Flows > Financing (Use positive number)",
        insight: "Apple returns massive capital to shareholders via buybacks, which reduces share count and artificially boosts Earnings Per Share (EPS)."
    },

    // --- 7. Item 8: Notes (Margins) ---
    { 
        id: 24, type: 'exact', q: "Margin Analysis: Calculate or find the Dollar Amount ($) of Gross Margin for the Products segment.", exact: ["112887", "112,887"], points: 50, hint: "Notes > Segment Info > Products Table",
        insight: "Hardware margins are lower due to manufacturing costs (BOM). However, Apple maintains premium margins compared to competitors."
    },
    { 
        id: 25, type: 'exact', q: "Margin Analysis: Calculate or find the Dollar Amount ($) of Gross Margin for the Services segment.", exact: ["82314", "82,314"], points: 60, hint: "Notes > Segment Info (or calculate: Services Sales - Services Cost)",
        insight: "Services typically have much higher margins (often 70%+) than hardware. This segment is key to Apple's long-term profit growth."
    },

    // --- 8. Audit Report ---
    { 
        id: 26, 
        type: 'mcq', 
        q: "Audit: Who is Apple's Independent Registered Public Accounting Firm (Auditor)?", 
        answer: "Ernst & Young LLP", 
        options: ["Deloitte & Touche LLP", "Ernst & Young LLP", "PricewaterhouseCoopers LLP", "KPMG LLP"],
        points: 40, 
        hint: "Report of Independent Registered Public Accounting Firm",
        insight: "Big 4 auditors provide assurance to investors. Auditor tenure is often long-standing for large cap companies to ensure continuity."
    },
    { 
        id: 27, 
        type: 'mcq', 
        q: "Audit: What type of audit opinion was expressed on the financial statements?", 
        answer: "Unqualified (Fairly Presented)", 
        options: ["Unqualified (Fairly Presented)", "Qualified Opinion", "Adverse Opinion", "Disclaimer of Opinion"],
        points: 40, 
        hint: "Look for the phrase 'In our opinion... present fairly'",
        insight: "An 'Unqualified' opinion is the gold standard, meaning the financial statements are clean, fair, and follow GAAP."
    }
];

// --- STATE MANAGEMENT ---
let state = { active: false, score: 0, totalPoints: 0, timeLeft: 45*60, solved: new Set(), attempts: {} };
let timerID;

function init() {
    // Calculate total points
    state.totalPoints = CHALLENGES.reduce((sum, c) => sum + c.points, 0);
    document.getElementById('totalPointsDisplay').innerText = `/ ${state.totalPoints}`;

    const grid = document.getElementById('gameGrid');
    grid.innerHTML = CHALLENGES.map(c => {
        let inputHTML = '';
        state.attempts[c.id] = 0;
        
        if (c.type === 'exact') {
            inputHTML = `
                <div class="input-group">
                    <input type="text" id="input-${c.id}" placeholder="Value..." onkeydown="checkEnter(event, ${c.id})">
                    <div class="input-helper">Enter value exactly as shown (e.g. 150,000)</div>
                </div>
            `;
        } else if (c.type === 'mcq') {
            inputHTML = `<div class="mcq-grid" id="mcq-${c.id}">
                ${c.options.map(opt => `<button class="mcq-btn" onclick="checkMCQ(${c.id}, '${opt}', this)">${opt}</button>`).join('')}
            </div>`;
        }

        return `
        <div class="card" id="card-${c.id}">
            <i class="fas fa-check-circle status-icon"></i>
            <i class="fas fa-times-circle status-icon"></i>
            
            <div class="q-header">
                <div class="q-title">${c.q}</div>
                <div class="q-meta">
                    <span class="points-tag">+${c.points} Pts</span>
                    <span class="attempt-counter" id="attempts-${c.id}">Attempts: 0/2</span>
                </div>
            </div>
            
            ${inputHTML}
            
            <div class="hint-box">
                <i class="fas fa-map-marker-alt hint-icon"></i>
                <span>${c.hint}</span>
            </div>
            
            <div class="insight-box" id="insight-${c.id}">
                <!-- Insight injected here upon solve -->
            </div>
        </div>
        `;
    }).join('');
    
    startGame();
}

function startGame() {
    state.active = true;
    state.score = 0;
    state.timeLeft = 45 * 60;
    state.solved.clear();
    state.attempts = {}; // Reset attempts
    CHALLENGES.forEach(c => state.attempts[c.id] = 0);
    
    updateScoreUI();
    
    document.querySelectorAll('input').forEach(i => { i.value = ''; i.disabled = false; });
    document.querySelectorAll('.mcq-btn').forEach(b => { 
        b.classList.remove('correct', 'wrong'); 
        b.disabled = false; 
    });
    
    // Reset cards and hide insights
    document.querySelectorAll('.card').forEach(c => {
        c.classList.remove('solved', 'failed');
        const counter = document.getElementById(`attempts-${c.id.split('-')[1]}`);
        counter.innerText = "Attempts: 0/2";
        counter.className = "attempt-counter";
        counter.classList.remove('attempt-warning', 'attempt-critical');
        
        // Hide insight box
        const insightBox = c.querySelector('.insight-box');
        if(insightBox) insightBox.style.display = 'none';
    });

    clearInterval(timerID);
    timerID = setInterval(() => {
        state.timeLeft--;
        const m = Math.floor(state.timeLeft / 60);
        const s = (state.timeLeft % 60).toString().padStart(2, '0');
        document.getElementById('timer').innerText = `${m}:${s}`;
        
        if (state.timeLeft <= 300) { // Red timer under 5 mins
            document.getElementById('timer').style.color = 'var(--accent-red)';
        } else {
            document.getElementById('timer').style.color = 'var(--accent-orange)';
        }

        if(state.timeLeft <= 0) endGame();
    }, 1000);
}

function updateScoreUI() {
    document.getElementById('scoreDisplay').innerText = state.score;
    const pct = (state.score / state.totalPoints) * 100;
    document.getElementById('progressBar').style.width = `${pct}%`;
}

function resetGame() {
    if(confirm("Are you sure you want to reset? Current progress will be lost.")) {
        startGame();
    }
}

// --- LOGIC FOR TEXT INPUTS ---
function checkEnter(e, id) {
    if (e.key === 'Enter') checkExact(id, e.target);
}

function checkExact(id, input) {
    if (!state.active || state.solved.has(id)) return;
    if (state.attempts[id] >= 2) return; // Lockout check

    const val = input.value.replace(/[^0-9.]/g, ''); // Allow decimal point
    const q = CHALLENGES.find(c => c.id === id);
    
    if (val === q.exact[0] || (q.exact[1] && val === q.exact[1].replace(/[^0-9.]/g, ''))) {
        markSolved(id, q.points);
        input.disabled = true;
        input.value = q.exact[0]; // Show normalized answer
    } else {
        registerStrike(id, input);
    }
}

// --- LOGIC FOR MCQ INPUTS ---
function checkMCQ(id, selected, btn) {
    if (!state.active || state.solved.has(id)) return;
    if (state.attempts[id] >= 2) return; // Lockout check

    const q = CHALLENGES.find(c => c.id === id);

    if (selected === q.answer) {
        markSolved(id, q.points);
        btn.classList.add('correct');
        const parent = btn.parentElement;
        Array.from(parent.children).forEach(b => b.disabled = true);
    } else {
        btn.classList.add('wrong');
        btn.disabled = true; 
        registerStrike(id, document.getElementById(`card-${id}`));
    }
}

function registerStrike(id, element) {
    state.attempts[id]++;
    const attempts = state.attempts[id];
    const counterEl = document.getElementById(`attempts-${id}`);
    const card = document.getElementById(`card-${id}`);
    
    counterEl.innerText = `Attempts: ${attempts}/2`;
    
    if (attempts === 1) {
        // Warning
        counterEl.classList.add('attempt-warning');
        card.classList.add('shake');
        
        if(element.tagName === 'INPUT') {
            element.style.borderColor = 'var(--accent-orange)';
        }
        
        setTimeout(() => card.classList.remove('shake'), 400);
    } else if (attempts >= 2) {
        // FAIL STATE
        counterEl.classList.remove('attempt-warning');
        counterEl.classList.add('attempt-critical');
        counterEl.innerText = "LOCKED";
        
        card.classList.add('failed');
        
        // Show correct answer
        const q = CHALLENGES.find(c => c.id === id);
        if(q.type === 'exact') {
            const input = document.getElementById(`input-${id}`);
            input.value = `Ans: ${q.exact[0]}`;
            input.disabled = true;
        } else {
            const buttons = document.querySelectorAll(`#mcq-${id} button`);
            buttons.forEach(b => b.disabled = true);
        }
    }
}

function markSolved(id, points) {
    state.solved.add(id);
    state.score += points;
    
    // Animate score
    updateScoreUI();
    const scoreEl = document.getElementById('scoreDisplay');
    scoreEl.style.transform = "scale(1.2)";
    setTimeout(() => scoreEl.style.transform = "scale(1)", 200);

    const card = document.getElementById(`card-${id}`);
    card.classList.add('solved');
    
    // Show Insight
    const q = CHALLENGES.find(c => c.id === id);
    const insightBox = document.getElementById(`insight-${id}`);
    if(q.insight) {
        insightBox.innerHTML = `<strong>Analyst Insight:</strong> ${q.insight}`;
        insightBox.style.display = 'block';
    }
}

function endGame() {
    clearInterval(timerID);
    state.active = false;
    alert(`Mission Complete! Final Score: ${state.score}`);
}

// --- NEW DOWNLOAD REPORT LOGIC (MODAL) ---
function openNameModal() {
    document.getElementById('nameModal').style.display = 'flex';
    document.getElementById('reportNameInput').value = '';
    document.getElementById('reportNameInput').focus();
}

function closeNameModal() {
    document.getElementById('nameModal').style.display = 'none';
}

function generateReport() {
    const name = document.getElementById('reportNameInput').value.trim();

    if (!name) {
        const input = document.getElementById('reportNameInput');
        input.style.borderColor = 'var(--accent-red)';
        input.classList.add('shake');
        setTimeout(() => {
            input.style.borderColor = '#d2d2d7';
            input.classList.remove('shake');
        }, 400);
        return;
    }

    closeNameModal();

    try {
        let report = `APPLE 10-K ANALYST REPORT\n`;
        report += `==========================================\n`;
        report += `Analyst: ${name}\n`;
        report += `Date: ${new Date().toLocaleString()}\n`;
        report += `Final Score: ${state.score} / ${state.totalPoints}\n`;
        report += `Time: ${Math.floor((2700 - state.timeLeft)/60)}m ${(2700 - state.timeLeft)%60}s\n`;
        report += `==========================================\n\n`;
        
        report += `DETAILED BREAKDOWN:\n`;
        CHALLENGES.forEach(c => {
            let status = "Not Attempted";
            if (state.solved.has(c.id)) status = "CORRECT";
            else if (state.attempts[c.id] >= 2) status = "FAILED";
            else if (state.attempts[c.id] > 0) status = "IN PROGRESS";
            
            report += `[${status}] Q${c.id}: ${c.q}\n`;
        });

        // Payload includes: Name, Score, and Timestamp
        const payload = {
            analyst: name,
            score: state.score,
            timestamp: Date.now()
        };
        const hash = btoa(JSON.stringify(payload));

        report += `\nVERIFICATION HASH: ${hash}\n`;
        report += `(Instructors: Copy this hash into the Teacher Dashboard to verify score authenticity)\n`;

        const element = document.createElement("a");
        const file = new Blob([report], {type: 'text/plain'});
        element.href = URL.createObjectURL(file);
        element.download = `AAPL_Report_${name.replace(/[^a-z0-9]/gi, '_')}.txt`;
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
    } catch (e) {
        console.error("Download failed:", e);
        alert("Error generating report. Please check console or try again.");
    }
}

// Download Report Trigger (Old function mapped to new modal)
function downloadReport() {
    openNameModal();
}

// --- TEACHER MODE FUNCTIONS ---
function openTeacherModal() {
    document.getElementById('teacherModal').style.display = 'flex';
    document.getElementById('teacherPass').value = '';
    document.getElementById('authError').style.display = 'none';
    document.getElementById('authView').style.display = 'block';
    document.getElementById('keyView').style.display = 'none';
}

function closeTeacherModal() {
    document.getElementById('teacherModal').style.display = 'none';
}

function checkTeacherPass() {
    const pass = document.getElementById('teacherPass').value;
    if (pass.toLowerCase() === 'teacher') {
        document.getElementById('authView').style.display = 'none';
        document.getElementById('keyView').style.display = 'block';
        renderKey();
    } else {
        const err = document.getElementById('authError');
        err.style.display = 'block';
        err.classList.add('shake');
        setTimeout(() => err.classList.remove('shake'), 400);
    }
}

function fillAllAnswers() {
    CHALLENGES.forEach(c => {
        if (!state.solved.has(c.id)) {
            const card = document.getElementById(`card-${c.id}`);
            card.classList.add('solved');
            card.classList.remove('failed');
            markSolved(c.id, c.points);
            
            if (c.type === 'exact') {
                const input = document.getElementById(`input-${c.id}`);
                input.value = c.exact[0]; // Use first exact answer
                input.disabled = true;
                input.style.borderColor = 'var(--accent-green)';
                input.style.color = 'var(--accent-green)';
            } else if (c.type === 'mcq') {
                const buttons = document.querySelectorAll(`#mcq-${c.id} .mcq-btn`);
                buttons.forEach(b => {
                    b.disabled = true;
                    if (b.innerText === c.answer) b.classList.add('correct');
                    else b.classList.remove('correct', 'wrong');
                });
            }
        }
    });
    alert("Board auto-filled with answer key.");
    closeTeacherModal();
}

function clearAllAnswers() {
    if(confirm("Reset the board to clear all answers? Progress will be lost.")) {
        startGame();
        closeTeacherModal();
    }
}

function renderKey() {
    const tbody = document.getElementById('keyBody');
    tbody.innerHTML = '';
    
    CHALLENGES.forEach(item => {
        const tr = document.createElement('tr');
        let displayAns = item.answer || (item.exact ? item.exact[0] : "N/A");
        
        tr.innerHTML = `
            <td style="font-weight:600; width: 45%;">${item.q}</td>
            <td style="font-family:'SF Mono', monospace; font-weight:700; color:var(--accent-blue);">${displayAns}</td>
            <td style="color:var(--text-secondary); font-style:italic;">${item.hint}</td>
        `;
        tbody.appendChild(tr);
    });
}

// Verification Logic
function verifyHash() {
    const input = document.getElementById('verifyInput').value.trim();
    const resultBox = document.getElementById('verifyResult');

    try {
        const decoded = atob(input);
        const data = JSON.parse(decoded);

        // Validation check
        if(!data.analyst || data.score === undefined || !data.timestamp) throw new Error("Invalid structure");

        const dateStr = new Date(data.timestamp).toLocaleString();
        resultBox.innerHTML = `
            <div style="color:var(--accent-green); font-weight:bold; margin-bottom:5px;">‚úÖ Valid Signature</div>
            <div style="font-size:13px; color:var(--text-secondary); line-height:1.5;">
                <strong>Analyst:</strong> ${data.analyst}<br>
                <strong>True Score:</strong> ${data.score}<br>
                <strong>Generated:</strong> ${dateStr}
            </div>
        `;
        resultBox.style.background = "#F2FCF4";
        resultBox.style.borderColor = "var(--accent-green)";

    } catch (e) {
        resultBox.innerHTML = `<div style="color:var(--accent-red); font-weight:bold;">‚ùå Invalid or Tampered Hash</div>`;
        resultBox.style.background = "#FFF5F5";
        resultBox.style.borderColor = "var(--accent-red)";
    }
    resultBox.style.display = 'block';
}

window.onclick = function(event) {
    const modal = document.getElementById('teacherModal');
    const nameModal = document.getElementById('nameModal');
    if (event.target == modal) {
        closeTeacherModal();
    }
    if (event.target == nameModal) {
        closeNameModal();
    }
}

init();
</script>

</body>
</html>
