<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accounting Simulator: Instructor Edition</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            background-color: #f8fafc; /* slate-50 */
            color: #1e293b; /* slate-800 */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Animation classes */
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .sticky-toolbar {
            position: relative; 
            z-index: 50;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Statement Styles */
        .statement-paper {
            background-color: #ffffff;
            color: #0f172a;
            padding: 3rem;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            margin-bottom: 2rem;
            max-width: 850px;
            margin-left: auto;
            margin-right: auto;
        }
        .statement-header {
            text-align: center;
            margin-bottom: 2rem;
            border-bottom: 3px double #334155;
            padding-bottom: 1.5rem;
        }
        .statement-header h2 { font-size: 1.75rem; font-weight: 800; color: #0f172a; margin-bottom: 0.25rem; }
        .statement-header h3 { font-size: 1.25rem; font-weight: 600; color: #334155; margin-bottom: 0.25rem; }
        .statement-header p { font-size: 0.95rem; color: #64748b; font-style: italic; }
        
        .statement-row {
            display: flex;
            justify-content: space-between;
            padding: 0.6rem 0;
            border-bottom: 1px dotted #cbd5e1;
        }
        .statement-row:last-child { border-bottom: none; }
        
        .statement-row.total {
            font-weight: 800;
            border-top: 2px solid #0f172a;
            border-bottom: 4px double #0f172a;
            padding-top: 0.75rem;
            margin-top: 0.5rem;
            color: #0f172a;
        }
        .statement-row.subtotal {
            font-weight: 600;
            border-top: 1px solid #334155;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            color: #1e293b;
        }
        .statement-sub-header {
            font-weight: 700;
            color: #334155;
            margin-top: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 0.25rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.05em;
        }

        /* Input Styles */
        input:focus, select:focus {
            outline: 2px solid #3b82f6;
            outline-offset: -1px;
        }

        /* Sticky Table Headers Logic */
        .sticky-header-row-1 {
            position: sticky;
            top: 0;
            z-index: 30;
            height: 40px; /* Enforce height */
            box-shadow: 0 1px 0px rgba(226, 232, 240, 1); /* Border simulation */
        }
        .sticky-header-row-2 {
            position: sticky;
            top: 40px; /* Matches row 1 height */
            z-index: 30;
            height: 36px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        /* Corner cell needs highest z-index to stay above both scrolling columns and rows */
        .sticky-corner {
            position: sticky;
            left: 0;
            top: 0;
            z-index: 40 !important;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.05);
        }
        
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICONS ---
        const Icon = ({ name, size = 18, className }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- DATA ---
        const COMPANY_NAME = "Summit Enterprises, Inc.";

        const ACCOUNT_OPTIONS = [
            "", 
            "Accounts Payable", 
            "Accounts Receivable", 
            "Accum. Depr: Equipment", 
            "Accum. Depr: Truck", 
            "Advertising Expense", 
            "Cash", 
            "Common Stock", 
            "Depr. Expense-Equip", 
            "Depr. Expense-Truck", 
            "Equipment", 
            "Fuel Expense", 
            "Insurance Expense", 
            "Prepaid Insurance", 
            "Retained Earnings", 
            "Service Revenue", 
            "Supplies", 
            "Supplies Expense", 
            "Truck", 
            "Unearned Revenue", 
            "Wages Expense"
        ];

        // Correct Answers Config
        const TRANSACTIONS_CONFIG = [
            { 
                id: 1, 
                text: "Apr 1: Roulstone contributed $11,500 cash for stock.", 
                correct: { cash: 11500, noncash: 0, liab: 0, cc: 11500, ec: 0, rev: 0, exp: 0 },
                correctAccounts: { cash: "Cash", noncash: "", liab: "", cc: "Common Stock", ec: "", rev: "", exp: "" }
            },
            { 
                id: 2, 
                text: "Apr 2: Paid $6,100 cash for a used truck.", 
                correct: { cash: -6100, noncash: 6100, liab: 0, cc: 0, ec: 0, rev: 0, exp: 0 },
                correctAccounts: { cash: "Cash", noncash: "Truck", liab: "", rev: "", exp: "" }
            },
            { 
                id: 3, 
                text: "Apr 2: Purchased $6,200 equipment; paid $1,000 cash, rest AP.", 
                correct: { cash: -1000, noncash: 6200, liab: 5200, cc: 0, ec: 0, rev: 0, exp: 0 },
                correctAccounts: { cash: "Cash", noncash: "Equipment", liab: "Accounts Payable", rev: "", exp: "" }
            },
            { 
                id: 4, 
                text: "Apr 3: Paid $2,880 cash for 24-mo insurance.", 
                correct: { cash: -2880, noncash: 2880, liab: 0, cc: 0, ec: 0, rev: 0, exp: 0 },
                correctAccounts: { cash: "Cash", noncash: "Prepaid Insurance", liab: "", rev: "", exp: "" }
            },
            { 
                id: 5, 
                text: "Apr 5: Purchased $1,200 supplies on credit.", 
                correct: { cash: 0, noncash: 1200, liab: 1200, cc: 0, ec: 0, rev: 0, exp: 0 },
                correctAccounts: { cash: "Cash", noncash: "Supplies", liab: "Accounts Payable", rev: "", exp: "" }
            },
            { 
                id: 6, 
                text: "Apr 5: Received $1,800 cash advance for future work.", 
                correct: { cash: 1800, noncash: 0, liab: 1800, cc: 0, ec: 0, rev: 0, exp: 0 },
                correctAccounts: { cash: "Cash", noncash: "", liab: "Unearned Revenue", rev: "", exp: "" }
            },
            { 
                id: 7, 
                text: "Apr 12: Billed customers $5,500 for services.", 
                correct: { cash: 0, noncash: 5500, liab: 0, cc: 0, ec: 5500, rev: 5500, exp: 0 },
                correctAccounts: { cash: "Cash", noncash: "Accounts Receivable", liab: "", ec: "Retained Earnings", rev: "Service Revenue", exp: "" }
            },
            { 
                id: 8, 
                text: "Apr 18: Collected $4,900 from Apr 12 customers.", 
                correct: { cash: 4900, noncash: -4900, liab: 0, cc: 0, ec: 0, rev: 0, exp: 0 },
                correctAccounts: { cash: "Cash", noncash: "Accounts Receivable", liab: "", rev: "", exp: "" }
            },
            { 
                id: 9, 
                text: "Apr 29: Paid $675 cash for fuel.", 
                correct: { cash: -675, noncash: 0, liab: 0, cc: 0, ec: -675, rev: 0, exp: 675 },
                correctAccounts: { cash: "Cash", noncash: "", liab: "", ec: "Retained Earnings", rev: "", exp: "Fuel Expense" }
            },
            { 
                id: 10, 
                text: "Apr 30: Paid $100 cash for advertising.", 
                correct: { cash: -100, noncash: 0, liab: 0, cc: 0, ec: -100, rev: 0, exp: 100 },
                correctAccounts: { cash: "Cash", noncash: "", liab: "", ec: "Retained Earnings", rev: "", exp: "Advertising Expense" }
            },
            { 
                id: 11, 
                text: "Apr 30: Paid $4,500 cash for wages.", 
                correct: { cash: -4500, noncash: 0, liab: 0, cc: 0, ec: -4500, rev: 0, exp: 4500 },
                correctAccounts: { cash: "Cash", noncash: "", liab: "", ec: "Retained Earnings", rev: "", exp: "Wages Expense" }
            },
            { 
                id: 12, 
                text: "Apr 30: Billed customers $4,000 for services.", 
                correct: { cash: 0, noncash: 4000, liab: 0, cc: 0, ec: 4000, rev: 4000, exp: 0 },
                correctAccounts: { cash: "Cash", noncash: "Accounts Receivable", liab: "", ec: "Retained Earnings", rev: "Service Revenue", exp: "" }
            },
            // Adjusting Entries
            { 
                id: 13, 
                text: "Adj: Record insurance expense for the month. (Policy: $2,880 for 24 mo).", 
                correct: { cash: 0, noncash: -120, liab: 0, cc: 0, ec: -120, rev: 0, exp: 120 },
                correctAccounts: { cash: "Cash", noncash: "Prepaid Insurance", liab: "", ec: "Retained Earnings", rev: "", exp: "Insurance Expense" }
            },
            { 
                id: 14, 
                text: "Adj: Supplies count at month-end shows $200 remaining.", 
                correct: { cash: 0, noncash: -1000, liab: 0, cc: 0, ec: -1000, rev: 0, exp: 1000 },
                correctAccounts: { cash: "Cash", noncash: "Supplies", liab: "", ec: "Retained Earnings", rev: "", exp: "Supplies Expense" }
            },
            { 
                id: 15, 
                text: "Adj: Depreciation on Truck is $125.", 
                correct: { cash: 0, noncash: -125, liab: 0, cc: 0, ec: -125, rev: 0, exp: 125 },
                correctAccounts: { cash: "Cash", noncash: "Accum. Depr: Truck", liab: "", ec: "Retained Earnings", rev: "", exp: "Depr. Expense-Truck" }
            },
            { 
                id: 16, 
                text: "Adj: Depreciation on Equipment is $35.", 
                correct: { cash: 0, noncash: -35, liab: 0, cc: 0, ec: -35, rev: 0, exp: 35 },
                correctAccounts: { cash: "Cash", noncash: "Accum. Depr: Equipment", liab: "", ec: "Retained Earnings", rev: "", exp: "Depr. Expense-Equip" }
            },
            { 
                id: 17, 
                text: "Adj: 25% of the work related to the Apr 5 advance has been performed.", 
                correct: { cash: 0, noncash: 0, liab: -450, cc: 0, ec: 450, rev: 450, exp: 0 },
                correctAccounts: { cash: "Cash", noncash: "", liab: "Unearned Revenue", ec: "Retained Earnings", rev: "Service Revenue", exp: "" }
            },
        ];

        const ERROR_SCENARIOS_CONFIG = [
            { 
                id: 'e1', 
                company: 'Blue Ridge Bike Co.', 
                desc: 'Failed to record payment of $8,400 for utilities accrued in prior period.',
                correct: { asset: 'Overstated', liab: 'Overstated', eq: 'No Effect', ni: 'No Effect' }
            },
            { 
                id: 'e2', 
                company: 'Juniper Robotics, Inc.', 
                desc: 'Failed to record purchase of $15,000 equipment by issuing common stock.',
                correct: { asset: 'Understated', liab: 'No Effect', eq: 'Understated', ni: 'No Effect' }
            },
            { 
                id: 'e3', 
                company: 'Orion Consulting, LLC', 
                desc: 'Failed to record receipt of utility bill for $925 (to be paid next month).',
                correct: { asset: 'No Effect', liab: 'Understated', eq: 'Overstated', ni: 'Overstated' }
            }
        ];

        const QUIZ_CONCEPTS_CONFIG = [
            {
                id: 'q1',
                question: "The 'Net Income' calculated in the Income Statement flows directly into which other statement?",
                options: ["Balance Sheet (Assets)", "Statement of Stockholders' Equity", "Statement of Cash Flows (Investing)", "It does not flow anywhere"],
                correct: "Statement of Stockholders' Equity"
            },
            {
                id: 'q2',
                question: "On the Balance Sheet, the 'Total Assets' figure must always equal:",
                options: ["Total Liabilities", "Total Equity", "Total Liabilities + Total Equity", "Cash + Revenue"],
                correct: "Total Liabilities + Total Equity"
            },
            {
                id: 'q3',
                question: "The 'Ending Cash Balance' on the Statement of Cash Flows must match:",
                options: ["Cash on the Balance Sheet", "Net Income on the Income Statement", "Retained Earnings on the Equity Statement", "Total Revenue"],
                correct: "Cash on the Balance Sheet"
            }
        ];

        // --- COMPONENT: SMART INPUT ---
        const SmartInput = ({ 
            value, 
            onChange, 
            correctValue, 
            isPct = false, 
            instructorMode,
            placeholder = "0"
        }) => {
            const [localVal, setLocalVal] = useState(value || "");
            const [isValid, setIsValid] = useState(null);

            useEffect(() => {
                setLocalVal(value === 0 || value ? value : "");
                if (value === "" || value === undefined) setIsValid(null);
                else validate(value);
            }, [value]);

            const validate = (val) => {
                if (val === "" || val === null || val === undefined) {
                    setIsValid(null);
                    return;
                }
                const numVal = parseFloat(val);
                if (isNaN(numVal)) {
                    setIsValid(false);
                    return;
                }
                const target = parseFloat(correctValue);
                if (isNaN(target)) return;

                let valid = false;
                if (Math.abs(numVal - target) < 0.01) valid = true;
                else if (target !== 0 && Math.abs((numVal - target) / target) <= 0.02) valid = true;
                
                if (!valid && isPct) {
                    const altVal = numVal / 100;
                    if (Math.abs(altVal - target) < 0.001) valid = true;
                }
                setIsValid(valid);
            };

            const handleBlur = () => {
                let processedVal = localVal;
                if (typeof localVal === 'string' && localVal.match(/[+\-*\/]/)) {
                    try {
                        const result = Function('"use strict";return (' + localVal.replace(/[^0-9+\-*\/.\(\)]/g, '') + ')')();
                        if (isFinite(result)) {
                            processedVal = parseFloat(result.toFixed(2));
                            onChange(processedVal);
                        }
                    } catch (e) {}
                }
                validate(processedVal);
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') e.target.blur();
            };

            let borderClass = "border-slate-300 focus:border-blue-500 bg-white";
            if (isValid === true) borderClass = "border-green-500 bg-green-50 text-green-700";
            else if (isValid === false) borderClass = "border-red-500 bg-red-50 text-red-700";

            return (
                <div className="relative w-full">
                    <input
                        type="text"
                        className={`w-full px-2 py-1.5 text-right rounded text-sm border outline-none transition-colors shadow-sm ${borderClass}`}
                        value={localVal}
                        onChange={(e) => { setLocalVal(e.target.value); onChange(e.target.value); }}
                        onBlur={handleBlur}
                        onKeyDown={handleKeyDown}
                        placeholder={placeholder}
                    />
                    {isValid === true && (
                        <div className="absolute right-1 top-1.5 text-green-600 pointer-events-none">
                            <Icon name="check" size={14} />
                        </div>
                    )}
                    {instructorMode && correctValue !== 0 && (
                        <div className="mt-1 text-xs font-bold text-center bg-purple-100 text-purple-700 border border-purple-200 rounded py-0.5 fade-in">
                            Key: {correctValue}
                        </div>
                    )}
                </div>
            );
        };

        // --- COMPONENT: SMART SELECT ---
        const SmartSelect = ({ value, onChange, options, correctValue, instructorMode }) => {
            const checkValidity = () => {
                if (value === "") return null;
                if (!correctValue && !value) return null; 
                return value === (correctValue || "");
            };

            const validState = checkValidity();
            
            let className = "w-full mt-1.5 text-xs rounded border p-1.5 outline-none transition-colors cursor-pointer shadow-sm ";
            
            if (validState === true && value) {
                className += "border-green-500 bg-green-50 text-green-700 font-semibold";
            } else if (validState === false) {
                className += "border-red-500 bg-red-50 text-red-700";
            } else {
                className += "border-slate-300 bg-white text-slate-700 hover:border-blue-400";
            }

            return (
                <div className="relative">
                    <select 
                        className={className} 
                        value={value} 
                        onChange={(e) => onChange(e.target.value)}
                    >
                        {options.map(opt => <option key={opt} value={opt}>{opt === "" ? "- Select Account -" : opt}</option>)}
                    </select>
                    {validState === true && value && (
                        <div className="absolute right-5 top-1.5 text-green-600 pointer-events-none">
                            <Icon name="check" size={12} />
                        </div>
                    )}
                    {instructorMode && correctValue && (
                        <div className="mt-1 text-[10px] font-bold text-center bg-purple-100 text-purple-700 border border-purple-200 rounded py-0.5 fade-in">
                            Acc: {correctValue}
                        </div>
                    )}
                </div>
            )
        };

        // --- COMPONENT: APP ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('transactions');
            
            // Initial State Generators
            const getInitialTransactions = () => TRANSACTIONS_CONFIG.map(t => ({
                ...t,
                userValues: { cash: '', noncash: '', liab: '', cc: '', ec: '', rev: '', exp: '' },
                userAccounts: { cash: 'Cash', noncash: '', liab: '', cc: '', ec: '', rev: '', exp: '' }
            }));
            
            const getInitialErrors = () => ERROR_SCENARIOS_CONFIG.map(e => ({
                ...e,
                userSelects: { asset: '', liab: '', eq: '', ni: '' }
            }));

            const [transactions, setTransactions] = useState(getInitialTransactions());
            const [errorScenarios, setErrorScenarios] = useState(getInitialErrors());
            const [quizAnswers, setQuizAnswers] = useState({});
            const [quizTracing, setQuizTracing] = useState({ ni: '', assets: '', re: '', cash_op: '' });

            // Instructor State
            const [showAuthModal, setShowAuthModal] = useState(false);
            const [isInstructor, setIsInstructor] = useState(false);
            const [authError, setAuthError] = useState('');
            const [teacherPass, setTeacherPass] = useState('');
            
            // Modal States
            const [confirmation, setConfirmation] = useState({ isOpen: false, message: '', onConfirm: null });
            const [showDownloadModal, setShowDownloadModal] = useState(false);
            const [studentName, setStudentName] = useState('');
            
            // Instructor Tools State
            const [verifyHash, setVerifyHash] = useState('');
            const [verifyResult, setVerifyResult] = useState(null);
            const [genName, setGenName] = useState('');
            const [genScore, setGenScore] = useState('');
            const [generatedHash, setGeneratedHash] = useState('');

            // --- COMPUTED TOTALS ---
            const totals = useMemo(() => {
                const sums = { cash: 0, noncash: 0, liab: 0, cc: 0, ec: 0, rev: 0, exp: 0, ni: 0 };
                transactions.forEach(t => {
                    const rRev = parseFloat(t.userValues.rev) || 0;
                    const rExp = parseFloat(t.userValues.exp) || 0;
                    const rNI = rRev - rExp;
                    
                    sums.cash += parseFloat(t.userValues.cash) || 0;
                    sums.noncash += parseFloat(t.userValues.noncash) || 0;
                    sums.liab += parseFloat(t.userValues.liab) || 0;
                    sums.cc += parseFloat(t.userValues.cc) || 0;
                    sums.ec += parseFloat(t.userValues.ec) || 0;
                    sums.rev += rRev;
                    sums.exp += rExp;
                    sums.ni += rNI;
                });
                return sums;
            }, [transactions]);

            const isBalanced = useMemo(() => {
                const assets = totals.cash + totals.noncash;
                const claims = totals.liab + totals.cc + totals.ec;
                return Math.abs(assets - claims) < 0.05 && assets !== 0;
            }, [totals]);

            // --- BALANCE SHEET DETAILS ---
            const balanceSheetDetails = useMemo(() => {
                const assets = { "Cash": totals.cash };
                const liabilities = {};

                transactions.forEach(t => {
                    const valNC = parseFloat(t.userValues.noncash);
                    if (valNC && valNC !== 0) {
                        const accountName = t.userAccounts.noncash || "Uncategorized Assets";
                        assets[accountName] = (assets[accountName] || 0) + valNC;
                    }

                    const valLiab = parseFloat(t.userValues.liab);
                    if (valLiab && valLiab !== 0) {
                        const accountName = t.userAccounts.liab || "Uncategorized Liabilities";
                        liabilities[accountName] = (liabilities[accountName] || 0) + valLiab;
                    }
                });

                return { assets, liabilities };
            }, [transactions, totals.cash]);

            // --- CASH FLOW DETAILS ---
            const cashFlowDetails = useMemo(() => {
                let operating = { receipts: 0, payments: 0, total: 0 };
                let investing = { total: 0 };
                let financing = { total: 0 };

                transactions.forEach(t => {
                    const valCash = parseFloat(t.userValues.cash) || 0;
                    if (valCash === 0) return;

                    if (t.id === 1) {
                        financing.total += valCash;
                    } else if (t.id === 2 || t.id === 3) {
                        investing.total += valCash;
                    } else {
                        if (valCash > 0) operating.receipts += valCash;
                        else operating.payments += valCash;
                        operating.total += valCash;
                    }
                });

                return { operating, investing, financing };
            }, [transactions]);

            // --- HANDLERS ---
            const handleTransactionChange = (id, field, value) => {
                setTransactions(prev => prev.map(t => t.id === id ? {
                    ...t,
                    userValues: { ...t.userValues, [field]: value }
                } : t));
            };

            const handleAccountChange = (id, field, value) => {
                setTransactions(prev => prev.map(t => t.id === id ? {
                    ...t,
                    userAccounts: { ...t.userAccounts, [field]: value }
                } : t));
            };

            const handleErrorSelect = (id, field, value) => {
                setErrorScenarios(prev => prev.map(e => e.id === id ? {
                    ...e,
                    userSelects: { ...e.userSelects, [field]: value }
                } : e));
            };

            const handleQuizAnswer = (id, val) => {
                setQuizAnswers(prev => ({ ...prev, [id]: val }));
            };

            const handleTracingChange = (field, val) => {
                setQuizTracing(prev => ({ ...prev, [field]: val }));
            };

            // --- INSTRUCTOR ACTIONS ---
            const attemptLogin = () => {
                if (btoa(teacherPass.toLowerCase()) === 'dHJhbnNhY3Rpb25z') {
                    setIsInstructor(true);
                    setShowAuthModal(false);
                    setAuthError('');
                    setTeacherPass('');
                } else {
                    setAuthError('Incorrect Password');
                }
            };

            const autoFill = () => {
                const filled = transactions.map(t => {
                    let accts = { ...t.userAccounts };
                    
                    if (t.correctAccounts) {
                        if (t.correctAccounts.cash) accts.cash = t.correctAccounts.cash;
                        if (t.correctAccounts.noncash) accts.noncash = t.correctAccounts.noncash;
                        if (t.correctAccounts.liab) accts.liab = t.correctAccounts.liab;
                        if (t.correctAccounts.cc) accts.cc = t.correctAccounts.cc;
                        if (t.correctAccounts.ec) accts.ec = t.correctAccounts.ec;
                        if (t.correctAccounts.rev) accts.rev = t.correctAccounts.rev;
                        if (t.correctAccounts.exp) accts.exp = t.correctAccounts.exp;
                    }

                    return {
                        ...t,
                        userValues: { 
                            cash: t.correct.cash || '', 
                            noncash: t.correct.noncash || '',
                            liab: t.correct.liab || '',
                            cc: t.correct.cc || '',
                            ec: t.correct.ec || '',
                            rev: t.correct.rev || '',
                            exp: t.correct.exp || ''
                        },
                        userAccounts: accts
                    }
                });
                setTransactions(filled);
                const filledErrors = errorScenarios.map(e => ({
                    ...e,
                    userSelects: { ...e.correct }
                }));
                setErrorScenarios(filledErrors);

                const filledQuiz = {};
                QUIZ_CONCEPTS_CONFIG.forEach(q => filledQuiz[q.id] = q.correct);
                setQuizAnswers(filledQuiz);
            };

            const performClear = () => {
                setTransactions(getInitialTransactions());
                setErrorScenarios(getInitialErrors());
                setQuizAnswers({});
                setQuizTracing({ ni: '', assets: '', re: '', cash_op: '' });
                setIsInstructor(false);
                setConfirmation({ isOpen: false, message: '', onConfirm: null });
            };

            const clearAll = () => {
                setConfirmation({
                    isOpen: true,
                    message: "Are you sure you want to clear all student work and exit Instructor Mode?",
                    onConfirm: performClear
                });
            };

            const handleDownloadClick = () => {
                setShowDownloadModal(true);
            };

            const executeDownload = () => {
                try {
                    const name = studentName || "Student";
                    const score = isBalanced ? "Balanced" : "Unbalanced";
                    const payload = JSON.stringify({
                        name: name,
                        score: score,
                        ni: totals.ni,
                        timestamp: new Date().toLocaleString()
                    });
                    
                    const hash = btoa(payload);

                    let quizReport = "";
                    QUIZ_CONCEPTS_CONFIG.forEach(q => {
                        quizReport += `Q: ${q.question}\nA: ${quizAnswers[q.id] || "No Answer"}\n\n`;
                    });
                    quizReport += `Trace NI: ${quizTracing.ni}\nTrace Assets: ${quizTracing.assets}\nTrace RE: ${quizTracing.re}\nTrace Cash Op: ${quizTracing.cash_op}`;

                    const reportContent = `
ACCOUNTING SIMULATION REPORT
Student: ${name}
Date: ${new Date().toLocaleString()}
Status: ${score}

-- TRANSACTION TOTALS --
Cash: ${totals.cash}
Non-Cash Assets: ${totals.noncash}
Liabilities: ${totals.liab}
Contributed Capital: ${totals.cc}
Earned Capital: ${totals.ec}
Revenue: ${totals.rev}
Expenses: ${totals.exp}
Net Income: ${totals.ni}

-- FINANCIAL STATEMENTS SUMMARY --
Total Assets: ${totals.cash + totals.noncash}
Total Liabilities: ${totals.liab}
Total Equity: ${totals.cc + totals.ec}
Net Cash Flow: ${totals.cash}

-- QUIZ RESULTS --
${quizReport}

-- ERROR ANALYSIS SECTION --
${errorScenarios.map(e => `${e.company}: Assets[${e.userSelects.asset}], Liab[${e.userSelects.liab}], Eq[${e.userSelects.eq}], NI[${e.userSelects.ni}]`).join('\n')}

-- VERIFICATION CODE --
${hash}
                    `.trim();

                    const blob = new Blob([reportContent], {type: 'text/plain'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${name.replace(/[^a-z0-9]/gi, '_')}_Accounting_Report.txt`;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        setShowDownloadModal(false);
                        setStudentName('');
                    }, 100);
                } catch(e) {
                    alert("Error downloading report: " + e.message);
                }
            };

            const verifyCode = () => {
                try {
                    const decoded = atob(verifyHash);
                    const json = JSON.parse(decoded);
                    setVerifyResult(json);
                } catch (e) {
                    setVerifyResult({ error: "Invalid Hash Code" });
                }
            };
            
            const generateHash = () => {
                if(!genName || !genScore) return;
                const payload = JSON.stringify({
                    name: genName,
                    score: genScore,
                    timestamp: new Date().toLocaleString(),
                    verified: true
                });
                setGeneratedHash(btoa(payload));
            };

            const formatCurrency = (val) => {
                return (val || 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            };

            const TabButton = ({ id, label, number }) => (
                <button 
                    onClick={() => setActiveTab(id)}
                    className={`flex items-center gap-2 px-6 py-3 rounded-lg font-bold text-lg transition-all shadow-sm ${activeTab === id ? 'bg-blue-600 text-white shadow-lg scale-105' : 'bg-white text-slate-500 hover:bg-slate-50 border border-slate-200 hover:text-blue-500'}`}
                >
                    <span className={`flex items-center justify-center w-6 h-6 rounded-full text-xs ${activeTab === id ? 'bg-white text-blue-600' : 'bg-slate-200 text-slate-500'}`}>{number}</span>
                    {label}
                </button>
            );

            return (
                <div className="min-h-screen pb-20 relative font-sans">
                    {/* Header */}
                    <div className="bg-white border-b border-slate-200 p-4 shadow-sm z-40 relative">
                        <div className="max-w-7xl mx-auto flex justify-between items-center">
                            <h1 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
                                <Icon name="calculator" className="text-blue-600" />
                                Accounting Simulator 
                                <span className="text-slate-400 text-sm font-normal bg-slate-100 px-2 py-0.5 rounded-full">v3.2</span>
                            </h1>
                            <button 
                                onClick={() => setShowAuthModal(true)}
                                className="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded-lg text-white transition-colors shadow-sm"
                            >
                                <Icon name="lock" size={16} />
                                <span className="font-semibold text-sm">Instructor</span>
                            </button>
                        </div>
                    </div>

                    {isInstructor && (
                        <div className="sticky-toolbar bg-white/95 text-slate-800 p-3 backdrop-blur-md border-b-2 border-purple-500 fade-in">
                            <div className="max-w-7xl mx-auto flex flex-wrap justify-between items-center gap-4">
                                <div className="flex items-center gap-2">
                                    <Icon name="shield-check" className="text-purple-600" />
                                    <span className="font-bold text-lg text-purple-900">Instructor Mode Active</span>
                                </div>
                                <div className="flex gap-3">
                                    <button onClick={autoFill} className="bg-blue-100 hover:bg-blue-200 text-blue-800 px-4 py-1.5 rounded-md font-bold transition-colors flex items-center gap-2">
                                        <Icon name="wand-2" size={16} /> Auto-Fill All
                                    </button>
                                    <button onClick={clearAll} className="bg-red-100 hover:bg-red-200 text-red-800 px-4 py-1.5 rounded-md font-bold transition-colors flex items-center gap-2">
                                        <Icon name="trash-2" size={16} /> Clear & Exit
                                    </button>
                                </div>
                            </div>
                            
                            <div className="max-w-7xl mx-auto mt-3 pt-3 border-t border-slate-200 grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                                <div className="flex gap-2 items-center bg-slate-50 p-2 rounded border border-slate-200">
                                    <input 
                                        value={verifyHash} 
                                        onChange={e => setVerifyHash(e.target.value)} 
                                        placeholder="Paste Student Verification Hash..." 
                                        className="bg-white text-slate-800 px-2 py-1 rounded border border-slate-300 flex-1 outline-none focus:border-purple-500"
                                    />
                                    <button onClick={verifyCode} className="bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-white font-medium">Verify</button>
                                    {verifyResult && (
                                        <div className="ml-2 text-xs">
                                            {verifyResult.error ? <span className="text-red-500 font-bold">{verifyResult.error}</span> : 
                                                <span className="text-green-600 font-bold">
                                                    {verifyResult.name} | Score: {verifyResult.score} | {verifyResult.timestamp}
                                                </span>
                                            }
                                        </div>
                                    )}
                                </div>
                                <div className="flex gap-2 items-center bg-slate-50 p-2 rounded border border-slate-200">
                                    <input value={genName} onChange={e => setGenName(e.target.value)} placeholder="Name" className="w-24 bg-white px-2 py-1 rounded border border-slate-300 outline-none focus:border-purple-500" />
                                    <input value={genScore} onChange={e => setGenScore(e.target.value)} placeholder="Score" className="w-16 bg-white px-2 py-1 rounded border border-slate-300 outline-none focus:border-purple-500" />
                                    <button onClick={generateHash} className="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-white text-xs font-medium">Gen Hash</button>
                                    {generatedHash && <span className="ml-2 font-mono text-xs bg-slate-200 px-2 py-1 rounded select-all cursor-pointer text-slate-700 border border-slate-300" onClick={() => navigator.clipboard.writeText(generatedHash)} title="Click to copy">{generatedHash.substring(0,10)}...</span>}
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="max-w-[1600px] mx-auto p-6">
                        <div className="flex justify-center gap-4 mb-8 flex-wrap">
                            <TabButton id="transactions" label="Transaction Analysis" number="1" />
                            <TabButton id="statements" label="Financial Statements" number="2" />
                            <TabButton id="errors" label="Impact of Errors" number="3" />
                            <TabButton id="quiz" label="Articulation Quiz" number="4" />
                        </div>

                        {activeTab === 'transactions' && (
                            <div className="overflow-auto bg-white rounded-xl shadow-lg border border-slate-200 p-1 animate-fade-in max-h-[75vh]">
                                <table className="w-full border-collapse min-w-[1200px]">
                                    <thead>
                                        <tr className="bg-slate-50 text-slate-700 text-sm border-b border-slate-200 h-[40px]">
                                            <th className="p-3 text-left border-r border-slate-200 sticky-corner bg-slate-50" rowSpan="2">Transaction</th>
                                            <th className="sticky-header-row-1 border-r border-slate-200 text-center py-2 bg-blue-50" colSpan="2">ASSETS</th>
                                            <th className="sticky-header-row-1 w-8 text-center font-bold text-slate-400 bg-slate-50">=</th>
                                            <th className="sticky-header-row-1 border-r border-slate-200 text-center py-2 bg-orange-50" colSpan="1">LIABILITIES</th>
                                            <th className="sticky-header-row-1 w-8 text-center font-bold text-slate-400 bg-slate-50">+</th>
                                            <th className="sticky-header-row-1 border-r border-slate-200 text-center py-2 bg-green-50" colSpan="2">EQUITY</th>
                                            <th className="sticky-header-row-1 w-1 bg-slate-200 p-0"></th>
                                            <th className="sticky-header-row-1 border-r border-slate-200 text-center py-2 bg-purple-50" colSpan="3">INCOME STATEMENT</th>
                                        </tr>
                                        <tr className="bg-slate-100 text-xs text-slate-500 font-bold uppercase tracking-wider border-b border-slate-200 h-[36px]">
                                            <th className="sticky-header-row-2 p-2 border-r border-slate-200 w-32 bg-slate-100">Cash</th>
                                            <th className="sticky-header-row-2 p-2 border-r border-slate-200 w-32 bg-slate-100">Non-Cash</th>
                                            <th className="sticky-header-row-2 bg-slate-100"></th>
                                            <th className="sticky-header-row-2 p-2 border-r border-slate-200 w-32 bg-slate-100">Liabilities</th>
                                            <th className="sticky-header-row-2 bg-slate-100"></th>
                                            <th className="sticky-header-row-2 p-2 border-r border-slate-200 w-32 bg-slate-100">Cont. Cap.</th>
                                            <th className="sticky-header-row-2 p-2 border-r border-slate-200 w-32 bg-slate-100">Earned Cap.</th>
                                            <th className="sticky-header-row-2 w-1 bg-slate-200 p-0"></th>
                                            <th className="sticky-header-row-2 p-2 border-r border-slate-200 w-36 bg-slate-100">Revenue</th>
                                            <th className="sticky-header-row-2 p-2 border-r border-slate-200 w-36 bg-slate-100">Expense</th>
                                            <th className="sticky-header-row-2 p-2 border-r border-slate-200 w-24 bg-slate-100">Net Inc</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {transactions.map((t, idx) => (
                                            <tr key={t.id} className="hover:bg-blue-50/30 transition-colors border-b border-slate-100 last:border-0">
                                                <td className="p-3 text-sm text-slate-600 border-r border-slate-200 sticky left-0 bg-white z-10 w-72 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)]">
                                                    <span className="font-bold text-blue-600 mr-2">{t.id}.</span>{t.text}
                                                </td>
                                                
                                                {['cash', 'noncash', 'liab', 'cc', 'ec'].map(field => (
                                                    <React.Fragment key={field}>
                                                        {field === 'liab' && <td className="text-center text-slate-300 font-bold">=</td>}
                                                        {field === 'cc' && <td className="text-center text-slate-300 font-bold">+</td>}
                                                        
                                                        <td className="p-2 border-r border-slate-100">
                                                            <SmartInput 
                                                                value={t.userValues[field]} 
                                                                onChange={(val) => handleTransactionChange(t.id, field, val)}
                                                                correctValue={t.correct[field]}
                                                                instructorMode={isInstructor}
                                                                placeholder="Amount"
                                                            />
                                                            {field !== 'cash' ? (
                                                                <SmartSelect 
                                                                    value={t.userAccounts[field]}
                                                                    onChange={(val) => handleAccountChange(t.id, field, val)}
                                                                    options={ACCOUNT_OPTIONS}
                                                                    correctValue={t.correctAccounts ? t.correctAccounts[field] : ""}
                                                                    instructorMode={isInstructor}
                                                                />
                                                            ) : (
                                                                <div className="mt-1.5 text-[10px] text-slate-400 font-semibold px-1.5 uppercase tracking-wider">
                                                                    Cash
                                                                </div>
                                                            )}
                                                        </td>
                                                    </React.Fragment>
                                                ))}

                                                <td className="w-1 bg-slate-200 p-0"></td>

                                                {['rev', 'exp'].map(field => (
                                                    <td key={field} className="p-2 border-r border-slate-100 bg-purple-50/10">
                                                        <SmartInput 
                                                            value={t.userValues[field]} 
                                                            onChange={(val) => handleTransactionChange(t.id, field, val)}
                                                            correctValue={t.correct[field]}
                                                            instructorMode={isInstructor}
                                                            placeholder="Amount"
                                                        />
                                                        <SmartSelect 
                                                            value={t.userAccounts[field]}
                                                            onChange={(val) => handleAccountChange(t.id, field, val)}
                                                            options={ACCOUNT_OPTIONS}
                                                            correctValue={t.correctAccounts ? t.correctAccounts[field] : ""}
                                                            instructorMode={isInstructor}
                                                        />
                                                    </td>
                                                ))}

                                                <td className="p-2 text-center bg-slate-50">
                                                    <div className={`py-1 px-2 rounded font-bold text-sm ${
                                                        (parseFloat(t.userValues.rev) || 0) - (parseFloat(t.userValues.exp) || 0) !== 0 ? 'text-blue-600 bg-blue-100' : 'text-slate-400'
                                                    }`}>
                                                        {((parseFloat(t.userValues.rev) || 0) - (parseFloat(t.userValues.exp) || 0)) || '-'}
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                    <tfoot>
                                        <tr className={`font-bold text-lg border-t-2 border-slate-300 ${isBalanced ? 'bg-green-50 text-green-700' : 'bg-red-50 text-orange-600'}`}>
                                            <td className="p-4 text-right sticky left-0 z-10 bg-white border-t-2 border-slate-300 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">TOTALS:</td>
                                            <td className="p-4 text-center">{totals.cash}</td>
                                            <td className="p-4 text-center">{totals.noncash}</td>
                                            <td></td>
                                            <td className="p-4 text-center">{totals.liab}</td>
                                            <td></td>
                                            <td className="p-4 text-center">{totals.cc}</td>
                                            <td className="p-4 text-center">{totals.ec}</td>
                                            <td className="w-1 bg-slate-300 p-0"></td>
                                            <td className="p-4 text-center">{totals.rev}</td>
                                            <td className="p-4 text-center">{totals.exp}</td>
                                            <td className="p-4 text-center">{totals.ni}</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        )}

                        {activeTab === 'statements' && (
                            <div className="space-y-12 animate-fade-in">
                                <div className="text-center text-slate-600 mb-8 max-w-2xl mx-auto bg-blue-50 p-4 rounded-lg border border-blue-100">
                                    <p className="text-sm"><strong className="text-blue-700">Note:</strong> These statements link together. Net Income from the Income Statement flows into the Ending Retained Earnings on the Equity Statement.</p>
                                </div>

                                <div className="statement-paper">
                                    <div className="statement-header">
                                        <h2>{COMPANY_NAME}</h2>
                                        <h3>Income Statement</h3>
                                        <p>For the Month Ended April 30</p>
                                    </div>
                                    
                                    <div className="statement-sub-header">Revenues</div>
                                    <div className="statement-row">
                                        <span>Service Revenue</span>
                                        <span>{formatCurrency(totals.rev)}</span>
                                    </div>

                                    <div className="statement-sub-header">Expenses</div>
                                    <div className="statement-row">
                                        <span>Total Expenses</span>
                                        <span>{formatCurrency(totals.exp)}</span>
                                    </div>

                                    <div className="statement-row total">
                                        <span>Net Income</span>
                                        <span>{formatCurrency(totals.ni)}</span>
                                    </div>
                                </div>

                                <div className="statement-paper">
                                    <div className="statement-header">
                                        <h2>{COMPANY_NAME}</h2>
                                        <h3>Statement of Stockholders' Equity</h3>
                                        <p>For the Month Ended April 30</p>
                                    </div>
                                    <table className="w-full text-right">
                                        <thead className="border-b-2 border-slate-800 text-slate-800 text-sm font-bold uppercase">
                                            <tr>
                                                <th className="text-left py-2"></th>
                                                <th className="py-2 px-4">Common Stock</th>
                                                <th className="py-2 px-4">Retained Earnings</th>
                                                <th className="py-2 px-4">Total Equity</th>
                                            </tr>
                                        </thead>
                                        <tbody className="text-slate-800">
                                            <tr className="border-b border-dashed border-slate-300">
                                                <td className="text-left py-3 font-medium">Beginning Balance, Apr 1</td>
                                                <td className="py-3 px-4">$0.00</td>
                                                <td className="py-3 px-4">$0.00</td>
                                                <td className="py-3 px-4">$0.00</td>
                                            </tr>
                                            <tr className="border-b border-dashed border-slate-300">
                                                <td className="text-left py-3 font-medium">Issuance of Stock</td>
                                                <td className="py-3 px-4">{formatCurrency(totals.cc)}</td>
                                                <td className="py-3 px-4">-</td>
                                                <td className="py-3 px-4">{formatCurrency(totals.cc)}</td>
                                            </tr>
                                            <tr className="border-b border-dashed border-slate-300">
                                                <td className="text-left py-3 font-medium">Net Income</td>
                                                <td className="py-3 px-4">-</td>
                                                <td className="py-3 px-4">{formatCurrency(totals.ni)}</td>
                                                <td className="py-3 px-4">{formatCurrency(totals.ni)}</td>
                                            </tr>
                                            <tr className="font-bold border-t-2 border-slate-900 border-b-4 double text-lg bg-slate-50">
                                                <td className="text-left py-4 pl-2">Ending Balance, Apr 30</td>
                                                <td className="py-4 px-4">{formatCurrency(totals.cc)}</td>
                                                <td className="py-4 px-4">{formatCurrency(totals.ni)}</td>
                                                <td className="py-4 px-4">{formatCurrency(totals.cc + totals.ni)}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div className="statement-paper">
                                    <div className="statement-header">
                                        <h2>{COMPANY_NAME}</h2>
                                        <h3>Balance Sheet</h3>
                                        <p>As of April 30</p>
                                    </div>
                                    <div className="grid grid-cols-2 gap-12">
                                        <div>
                                            <h4 className="font-bold text-lg mb-2 text-slate-800 border-b-2 border-slate-800 pb-1">Assets</h4>
                                            <div className="statement-sub-header">Current Assets</div>
                                            <div className="statement-row">
                                                <span>Cash</span>
                                                <span>{formatCurrency(balanceSheetDetails.assets['Cash'])}</span>
                                            </div>
                                            {Object.entries(balanceSheetDetails.assets).map(([name, val]) => {
                                                if(name === 'Cash') return null; 
                                                return (
                                                    <div key={name} className="statement-row">
                                                        <span>{name}</span>
                                                        <span>{formatCurrency(val)}</span>
                                                    </div>
                                                );
                                            })}
                                            <div className="statement-row total mt-8">
                                                <span>Total Assets</span>
                                                <span>{formatCurrency(totals.cash + totals.noncash)}</span>
                                            </div>
                                        </div>
                                        <div>
                                            <h4 className="font-bold text-lg mb-2 text-slate-800 border-b-2 border-slate-800 pb-1">Liabilities</h4>
                                            <div className="statement-sub-header">Current Liabilities</div>
                                            {Object.entries(balanceSheetDetails.liabilities).length === 0 && (
                                                <div className="statement-row italic text-gray-400">No liabilities recorded</div>
                                            )}
                                            {Object.entries(balanceSheetDetails.liabilities).map(([name, val]) => (
                                                <div key={name} className="statement-row">
                                                    <span>{name}</span>
                                                    <span>{formatCurrency(val)}</span>
                                                </div>
                                            ))}
                                            <div className="statement-row subtotal">
                                                <span>Total Liabilities</span>
                                                <span>{formatCurrency(totals.liab)}</span>
                                            </div>

                                            <h4 className="font-bold text-lg mt-8 mb-2 text-slate-800 border-b-2 border-slate-800 pb-1">Stockholders' Equity</h4>
                                            <div className="statement-row">
                                                <span>Common Stock</span>
                                                <span>{formatCurrency(totals.cc)}</span>
                                            </div>
                                            <div className="statement-row">
                                                <span>Retained Earnings</span>
                                                <span>{formatCurrency(totals.ni)}</span>
                                            </div>
                                            <div className="statement-row subtotal">
                                                <span>Total Equity</span>
                                                <span>{formatCurrency(totals.cc + totals.ni)}</span>
                                            </div>
                                            <div className="statement-row total mt-4">
                                                <span>Total Liab. & Equity</span>
                                                <span>{formatCurrency(totals.liab + totals.cc + totals.ni)}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* CASH FLOW STATEMENT */}
                                <div className="statement-paper">
                                    <div className="statement-header">
                                        <h2>{COMPANY_NAME}</h2>
                                        <h3>Statement of Cash Flows</h3>
                                        <p>For the Month Ended April 30</p>
                                    </div>

                                    <div className="statement-sub-header">Cash Flows from Operating Activities</div>
                                    <div className="statement-row">
                                        <span>Cash received from customers</span>
                                        <span>{formatCurrency(cashFlowDetails.operating.receipts)}</span>
                                    </div>
                                    <div className="statement-row">
                                        <span>Cash paid for expenses</span>
                                        <span>{formatCurrency(cashFlowDetails.operating.payments)}</span>
                                    </div>
                                    <div className="statement-row subtotal">
                                        <span>Net cash provided by operating activities</span>
                                        <span>{formatCurrency(cashFlowDetails.operating.total)}</span>
                                    </div>

                                    <div className="statement-sub-header mt-6">Cash Flows from Investing Activities</div>
                                    <div className="statement-row">
                                        <span>Purchase of equipment and assets</span>
                                        <span>{formatCurrency(cashFlowDetails.investing.total)}</span>
                                    </div>
                                    <div className="statement-row subtotal">
                                        <span>Net cash used in investing activities</span>
                                        <span>{formatCurrency(cashFlowDetails.investing.total)}</span>
                                    </div>

                                    <div className="statement-sub-header mt-6">Cash Flows from Financing Activities</div>
                                    <div className="statement-row">
                                        <span>Issuance of common stock</span>
                                        <span>{formatCurrency(cashFlowDetails.financing.total)}</span>
                                    </div>
                                    <div className="statement-row subtotal">
                                        <span>Net cash provided by financing activities</span>
                                        <span>{formatCurrency(cashFlowDetails.financing.total)}</span>
                                    </div>

                                    <div className="statement-row total mt-8">
                                        <span>Net Increase in Cash</span>
                                        <span>{formatCurrency(totals.cash)}</span>
                                    </div>
                                    <div className="statement-row">
                                        <span>Cash Balance, April 1</span>
                                        <span>$0.00</span>
                                    </div>
                                    <div className="statement-row font-bold">
                                        <span>Cash Balance, April 30</span>
                                        <span>{formatCurrency(totals.cash)}</span>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'errors' && (
                            <div className="space-y-6 animate-fade-in max-w-5xl mx-auto">
                                <div className="text-center mb-8">
                                    <h2 className="text-2xl font-bold text-slate-800">Impact of Omitted Errors</h2>
                                    <p className="text-slate-500 mt-2">Analyze the effect on financial reports if these events were <strong>NOT RECORDED</strong>.</p>
                                </div>
                                {errorScenarios.map((scen) => (
                                    <div key={scen.id} className="bg-white p-6 rounded-lg shadow-md border border-slate-200 hover:shadow-lg transition-shadow relative overflow-hidden group">
                                        <div className="absolute top-0 left-0 w-1.5 h-full bg-orange-400 group-hover:bg-orange-500 transition-colors"></div>
                                        <div className="flex flex-col md:flex-row gap-6">
                                            <div className="md:w-1/3 border-r border-slate-100 pr-4 flex flex-col justify-center">
                                                <h3 className="text-lg font-bold text-slate-800 mb-1">{scen.company}</h3>
                                                <p className="text-slate-500 text-sm leading-relaxed">{scen.desc}</p>
                                            </div>
                                            <div className="md:w-2/3 grid grid-cols-4 gap-4">
                                                {['asset', 'liab', 'eq', 'ni'].map((field, i) => {
                                                    const label = ['Assets', 'Liabilities', 'Equity', 'Net Income'][i];
                                                    const val = scen.userSelects[field];
                                                    const correct = scen.correct[field];
                                                    const isCorrect = val === correct;
                                                    return (
                                                        <div key={field} className="flex flex-col gap-1.5">
                                                            <label className="text-[10px] text-slate-400 font-bold uppercase tracking-wider text-center">{label}</label>
                                                            <select 
                                                                className={`w-full bg-slate-50 border ${val && isCorrect ? 'border-green-500 bg-green-50 text-green-700' : val ? 'border-red-500 bg-red-50 text-red-700' : 'border-slate-300 hover:border-blue-400'} rounded p-2 text-sm outline-none transition-colors cursor-pointer`}
                                                                value={val}
                                                                onChange={(e) => handleErrorSelect(scen.id, field, e.target.value)}
                                                            >
                                                                <option value="">- Select -</option>
                                                                <option value="No Effect">No Effect</option>
                                                                <option value="Overstated">Overstated</option>
                                                                <option value="Understated">Understated</option>
                                                            </select>
                                                            {isInstructor && (
                                                                <div className="text-[10px] font-bold text-center text-purple-600 bg-purple-100 rounded py-0.5">
                                                                    Key: {correct}
                                                                </div>
                                                            )}
                                                        </div>
                                                    )
                                                })}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {activeTab === 'quiz' && (
                            <div className="space-y-8 animate-fade-in max-w-4xl mx-auto">
                                <div className="text-center text-slate-800 mb-8">
                                    <h2 className="text-3xl font-bold mb-2">Articulation Quiz</h2>
                                    <p className="text-slate-500">Demonstrate how information flows between financial statements.</p>
                                </div>

                                <div className="bg-white p-8 rounded-xl shadow-lg border border-slate-200">
                                    <h3 className="text-xl font-bold text-blue-600 mb-6 border-b border-slate-100 pb-4 flex items-center gap-3">
                                        <div className="bg-blue-100 p-2 rounded-lg"><Icon name="search" size={24} className="text-blue-600"/></div>
                                        Part 1: Trace the Numbers
                                    </h3>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                        {[
                                            { id: 'ni', label: '1. Net Income (from Income Statement)', correct: totals.ni },
                                            { id: 'assets', label: '2. Total Assets (from Balance Sheet)', correct: totals.cash + totals.noncash },
                                            { id: 're', label: '3. Ending Retained Earnings (from Equity Stmt)', correct: totals.ni },
                                            { id: 'cash_op', label: '4. Net Cash from Operating Activities', correct: cashFlowDetails.operating.total }
                                        ].map(item => (
                                            <div key={item.id} className="bg-slate-50 p-4 rounded-lg border border-slate-200">
                                                <label className="block text-sm font-bold text-slate-700 mb-2">{item.label}</label>
                                                <SmartInput 
                                                    value={quizTracing[item.id]}
                                                    onChange={(val) => handleTracingChange(item.id, val)}
                                                    correctValue={item.correct}
                                                    instructorMode={isInstructor}
                                                    placeholder="Enter value..."
                                                />
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div className="bg-white p-8 rounded-xl shadow-lg border border-slate-200">
                                    <h3 className="text-xl font-bold text-purple-600 mb-6 border-b border-slate-100 pb-4 flex items-center gap-3">
                                        <div className="bg-purple-100 p-2 rounded-lg"><Icon name="brain-circuit" size={24} className="text-purple-600"/></div>
                                        Part 2: Concept Checks
                                    </h3>
                                    <div className="space-y-6">
                                        {QUIZ_CONCEPTS_CONFIG.map((q, idx) => {
                                            const val = quizAnswers[q.id] || "";
                                            const isCorrect = val === q.correct;
                                            return (
                                                <div key={q.id} className="flex flex-col gap-2 p-4 rounded-lg hover:bg-slate-50 transition-colors border border-transparent hover:border-slate-200">
                                                    <label className="text-base font-semibold text-slate-800">{idx + 1}. {q.question}</label>
                                                    <select 
                                                        className={`bg-white border ${val && isCorrect ? 'border-green-500 bg-green-50 text-green-700 font-bold' : val ? 'border-red-500 bg-red-50 text-red-700' : 'border-slate-300'} rounded-lg p-3 outline-none focus:border-blue-500 transition-colors w-full shadow-sm cursor-pointer`}
                                                        value={val}
                                                        onChange={(e) => handleQuizAnswer(q.id, e.target.value)}
                                                    >
                                                        <option value="">-- Select Answer --</option>
                                                        {q.options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                                    </select>
                                                    {isInstructor && (
                                                        <div className="text-xs font-bold text-purple-600 bg-purple-100 rounded py-1 px-3 w-fit">
                                                            Correct Answer: {q.correct}
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="fixed bottom-8 right-8 z-[60]">
                        <button 
                            onClick={handleDownloadClick}
                            className="flex items-center gap-2 bg-slate-900 hover:bg-slate-800 text-white font-bold py-4 px-8 rounded-full shadow-xl transition-transform hover:scale-105 active:scale-95 ring-4 ring-slate-200"
                        >
                            <Icon name="download" /> Download Report
                        </button>
                    </div>

                    {confirmation.isOpen && (
                        <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center z-[110] fade-in backdrop-blur-sm">
                            <div className="bg-white p-6 rounded-xl shadow-2xl w-96 text-center">
                                <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Icon name="alert-triangle" className="text-red-600" />
                                </div>
                                <h3 className="font-bold text-xl mb-2 text-slate-800">Confirm Action</h3>
                                <p className="text-slate-600 mb-6">{confirmation.message}</p>
                                <div className="flex justify-center gap-3">
                                    <button 
                                        onClick={() => setConfirmation({ isOpen: false, message: '', onConfirm: null })} 
                                        className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg font-medium transition-colors"
                                    >Cancel</button>
                                    <button 
                                        onClick={confirmation.onConfirm} 
                                        className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold shadow-lg shadow-red-200 transition-colors"
                                    >Yes, Clear All</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showDownloadModal && (
                        <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center z-[110] fade-in backdrop-blur-sm">
                            <div className="bg-white p-6 rounded-xl shadow-2xl w-96">
                                <h3 className="font-bold text-xl mb-4 text-slate-800 flex items-center gap-2">
                                    <Icon name="file-text" className="text-blue-600" /> Save Report
                                </h3>
                                <div className="mb-6">
                                    <label className="block text-sm font-bold text-slate-700 mb-2">Student Name</label>
                                    <input 
                                        type="text" 
                                        value={studentName}
                                        onChange={(e) => setStudentName(e.target.value)}
                                        className="w-full border border-slate-300 p-3 rounded-lg outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all"
                                        placeholder="Enter your full name..."
                                        autoFocus
                                    />
                                </div>
                                <div className="flex justify-end gap-3">
                                    <button 
                                        onClick={() => setShowDownloadModal(false)} 
                                        className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg font-medium transition-colors"
                                    >Cancel</button>
                                    <button 
                                        onClick={executeDownload} 
                                        className="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold shadow-lg shadow-green-200 flex items-center gap-2 transition-colors"
                                    ><Icon name="download" size={18} /> Save</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showAuthModal && (
                        <div className="fixed inset-0 bg-slate-900/60 flex items-center justify-center z-[100] p-4 backdrop-blur-sm animate-fade-in">
                            <div className="bg-white text-slate-800 p-8 rounded-2xl shadow-2xl max-w-sm w-full relative border border-slate-100">
                                <button onClick={() => setShowAuthModal(false)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition-colors">
                                    <Icon name="x" size={24} />
                                </button>
                                <div className="text-center mb-6">
                                    <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <Icon name="lock" size={32} className="text-slate-700" />
                                    </div>
                                    <h2 className="text-2xl font-bold">Instructor Access</h2>
                                    <p className="text-slate-500 text-sm mt-1">Enter password to unlock teacher tools.</p>
                                </div>
                                <input 
                                    type="password" 
                                    className="w-full border border-slate-300 rounded-lg p-3 mb-4 outline-none focus:border-blue-600 focus:ring-2 focus:ring-blue-100 transition-all"
                                    placeholder="Password"
                                    value={teacherPass}
                                    onChange={e => setTeacherPass(e.target.value)}
                                    onKeyDown={e => e.key === 'Enter' && attemptLogin()}
                                    autoFocus
                                />
                                {authError && <p className="text-red-600 text-sm mb-4 text-center bg-red-50 p-2 rounded-lg font-medium border border-red-100">{authError}</p>}
                                <button 
                                    onClick={attemptLogin}
                                    className="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-3.5 rounded-lg transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"
                                >Unlock Dashboard</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
