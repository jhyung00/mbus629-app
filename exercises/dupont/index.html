<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DuPont Forensics - Corporate Detective Game</title>
    <style>
        :root {
            --color-primary: #3180CD;
            --color-success: #2B8A3E;
            --color-warning: #D97706;
            --color-danger: #C00F2F;
            --color-bg: #F5F5F3;
            --color-surface: #FFFFFF;
            --color-text: #133252;
            --color-text-light: #626C71;
            --color-border: #E5E5E1;
            --color-instructor: #6f42c1; /* Purple for instructor mode */
            --color-hint: #805ad5; /* Purple for hints */
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            padding-bottom: 80px; /* Space for fixed footer */
            padding-top: 20px; /* Default top padding */
        }

        body.instructor-active {
            padding-top: 80px; /* Space for sticky toolbar */
        }

        .container { max-width: 1200px; margin: 0 auto; }

        /* HEADER */
        header {
            text-align: center;
            margin-bottom: 40px;
            background: linear-gradient(135deg, #133252 0%, #2B8A3E 100%);
            color: white;
            padding: 40px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
        }

        h1 { margin: 0; font-size: 32px; font-weight: 600; }

        .subtitle {
            font-size: 18px;
            opacity: 0.95;
            margin-top: 10px;
        }

        .score-badge-header {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
            margin-top: 10px;
            font-weight: bold;
            font-size: 16px;
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        /* Instructor Header Button */
        .header-teacher-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.4);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
            z-index: 10;
        }

        .header-teacher-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* STICKY INSTRUCTOR TOOLBAR */
        .instructor-toolbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 70px;
            background-color: var(--color-instructor);
            color: white;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 2000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .instructor-toolbar.visible {
            display: flex;
        }

        .instructor-title {
            font-weight: bold;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .instructor-controls {
            display: flex;
            gap: 10px;
        }

        .btn-toolbar {
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-autofill {
            background: #fff;
            color: var(--color-instructor);
        }

        .btn-autofill:hover {
            background: #f0f0f0;
        }

        .btn-clear {
            background: rgba(0,0,0,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-clear:hover {
            background: rgba(0,0,0,0.4);
        }

        /* GAME GRID */
        .game-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Increased min-width slightly */
            gap: 20px;
            margin-bottom: 40px;
        }

        .company-card {
            background: white;
            border: 2px solid var(--color-border);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            position: relative;
        }

        .company-card:hover {
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            transform: translateY(-4px);
            border-color: var(--color-primary);
        }

        .company-card.correct {
            border-color: var(--color-success);
            background-color: #ECFEF3;
            box-shadow: 0 0 0 3px rgba(43, 138, 62, 0.1);
        }

        .company-card.incorrect {
            border-color: var(--color-danger);
            background-color: #FEF2F0;
            box-shadow: 0 0 0 3px rgba(192, 21, 47, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--color-border);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-text);
        }

        .roe-badge {
            background: var(--color-primary);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }
        
        /* Negative ROE styling */
        .roe-badge.negative {
            background: var(--color-danger);
        }

        .metrics {
            display: grid;
            gap: 12px;
            margin: 15px 0;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #F9F9F7;
            border-radius: 6px;
            font-size: 14px;
        }

        .metric-label {
            color: var(--color-text-light);
            font-weight: 500;
        }

        .metric-value {
            font-weight: 600;
            color: var(--color-text);
            font-size: 16px;
        }
        
        .metric-value.negative {
            color: var(--color-danger);
        }

        .clues {
            display: grid;
            gap: 10px;
            margin: 15px 0;
        }

        .clue {
            display: flex;
            gap: 12px;
            padding: 10px;
            background: #F9F9F7;
            border-radius: 6px;
            font-size: 13px;
            align-items: flex-start;
        }

        .clue-icon {
            color: var(--color-primary);
            font-weight: 600;
            flex-shrink: 0;
        }

        /* HINT SYSTEM */
        .hint-section {
            margin-top: 15px;
            border-top: 1px dashed var(--color-border);
            padding-top: 10px;
        }

        .btn-hint {
            background: none;
            border: 1px dashed var(--color-hint);
            color: var(--color-hint);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
            font-weight: 600;
        }

        .btn-hint:hover {
            background: #f3e8fd;
        }

        .hint-text {
            display: none;
            margin-top: 8px;
            font-size: 13px;
            color: var(--color-hint);
            background: #f3e8fd;
            padding: 8px;
            border-radius: 4px;
            font-style: italic;
        }

        .hint-text.visible {
            display: block;
        }

        /* INSTRUCTOR KEY DISPLAY */
        .instructor-key-display {
            display: none;
            margin-top: 10px;
            padding: 8px;
            background-color: #f3e8fd;
            border: 2px solid var(--color-instructor);
            color: var(--color-instructor);
            border-radius: 6px;
            font-weight: bold;
            text-align: center;
            font-size: 14px;
        }

        .instructor-key-display.visible {
            display: block;
        }

        .button-group {
            display: flex;
            gap: 6px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .guess-button {
            flex: 1 1 30%; /* Allow buttons to take up roughly 1/3 space */
            padding: 10px 4px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            background: white;
            color: var(--color-text);
            border: 1px solid var(--color-border);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .guess-button:hover {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .guess-button.selected {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .feedback {
            margin-top: 12px;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            display: none;
        }

        .feedback.show { display: block; }

        .feedback.correct {
            background: #ECFEF3;
            color: var(--color-success);
            border-left: 3px solid var(--color-success);
        }

        .feedback.incorrect {
            background: #FEF2F0;
            color: var(--color-danger);
            border-left: 3px solid var(--color-danger);
        }

        /* SECTIONS & TASKS */
        .section {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .section-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--color-border);
        }

        .tasks {
            display: grid;
            gap: 15px;
        }

        .task-item {
            padding: 15px;
            background: #F9F9F7;
            border-radius: 6px;
            border-left: 3px solid var(--color-primary);
        }

        .task-question {
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 10px;
        }

        .task-answer {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            color: var(--color-success);
            font-size: 13px;
            border-left: 3px solid var(--color-success);
        }

        .task-answer.show { display: block; }

        .toggle-answer {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
        }

        .toggle-answer:hover { background: #1E5BA8; }

        .answer-key {
            margin-top: 20px;
            padding: 15px;
            background: #F0F9F5;
            border-radius: 6px;
            border-left: 3px solid var(--color-success);
        }

        .answer-key-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            font-size: 14px;
        }

        .answer-key-item:last-child { border-bottom: none; }

        .company-name { font-weight: 600; color: var(--color-text); }
        .real-company { color: var(--color-success); font-weight: 600; }
        
        .risk-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .risk-high { background: #FEF2F0; color: var(--color-danger); }
        .risk-medium { background: #FEF5E6; color: var(--color-warning); }
        .risk-low { background: #ECFEF3; color: var(--color-success); }

        .footer {
            text-align: center;
            color: var(--color-text-light);
            font-size: 13px;
            margin-top: 40px;
            padding: 20px;
        }

        /* SUBMISSION & SCORE */
        .submit-answers-container {
            text-align: center;
            padding: 20px;
            background: #F0F4F8;
            border-radius: 10px;
            margin: 30px 0;
            display: none;
        }

        .submit-answers-container.show { display: block; }

        .submit-button {
            background: var(--color-success);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .submit-button:hover:not(:disabled) {
            background: #1B6B2F;
            transform: scale(1.05);
        }

        .submit-button:disabled {
            background: #AAA;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .waiting-message {
            text-align: center;
            padding: 20px;
            background: #FEF5E6;
            border-radius: 10px;
            border: 2px solid var(--color-warning);
            color: var(--color-warning);
            font-weight: 600;
            display: none;
        }

        .waiting-message.show { display: block; }

        .score-display {
            text-align: center;
            padding: 20px;
            background: #F0F4F8;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        .score-display.show { display: block; }

        .score-number {
            font-size: 48px;
            font-weight: 600;
            color: var(--color-primary);
            margin: 10px 0;
        }
        
        /* Floating Action Bar (Original - kept for download btn) */
        .action-bar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .action-btn {
            background: #133252;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .action-btn:hover { background: #1E5BA8; transform: translateY(-2px); }
        /* Teacher button in action bar hidden in favor of header button, but download remains */
        .action-btn.download { background: #2B8A3E; display: none; } 

        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 3000; backdrop-filter: blur(4px); }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; position: relative; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; border: none; background: none; color: #666; }
        
        .auth-view { text-align: center; padding: 20px; }
        .auth-input { padding: 10px; border: 2px solid #ddd; border-radius: 6px; width: 200px; margin-right: 10px; }
        .error-msg { color: #C00F2F; margin-top: 10px; display: none; font-weight: bold; }

        /* Custom Confirmation Modal */
        .confirm-modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .confirm-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .btn-confirm-yes {
            background: var(--color-danger);
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-confirm-no {
            background: #e0e0e0;
            color: #333;
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            h1 { font-size: 24px; }
            .section { padding: 20px; }
            .guess-button { font-size: 11px; padding: 8px 4px; }
            .action-bar { flex-direction: column; bottom: 10px; right: 10px; align-items: flex-end; }
            .header-teacher-btn { top: 10px; right: 10px; padding: 6px 12px; font-size: 12px; }
            .instructor-toolbar { flex-direction: column; height: auto; padding: 10px; gap: 10px; }
            body.instructor-active { padding-top: 110px; }
        }
    </style>
</head>
<body>

    <!-- INSTRUCTOR TOOLBAR -->
    <div class="instructor-toolbar" id="instructorToolbar">
        <div class="instructor-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
            Instructor Mode Active
        </div>
        <div class="instructor-controls">
            <button class="btn-toolbar btn-autofill" onclick="autoFillAll()">‚ö° Auto-Fill All</button>
            <button class="btn-toolbar btn-clear" onclick="requestClear()">‚úï Clear & Exit</button>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>üîç DuPont Forensics</h1>
            <p class="subtitle">Corporate Detective Game: Identify 6 Mystery Companies Using ROE Decomposition</p>
            
            <div class="score-badge-header">
                Current Points: <span id="headerScore">100</span>
            </div>

            <!-- Header Instructor Button with Robust SVG -->
            <button class="header-teacher-btn" onclick="openTeacherModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
                Instructor Access
            </button>
        </header>

        <div class="section">
            <h2 class="section-title">üìã How to Play</h2>
            <p><strong>6 companies with different business models and DuPont drivers.</strong></p>
            <p>Analyze Profit Margin, Asset Turnover, and Financial Leverage for each mystery company. Match each one to the real business using only the ratios and clues.</p>
            <p><strong>Points System:</strong> You start with <strong>100 points</strong>. Each time you reveal a hint, 10 points are deducted. Can you solve it with a perfect score?</p>
        </div>

        <div class="game-grid" id="gameGrid"></div>

        <div class="submit-answers-container" id="submitContainer">
            <p><strong>‚úì You've made all 6 guesses!</strong></p>
            <button class="submit-button" onclick="submitAnswers()">Submit My Answers</button>
        </div>

        <div class="waiting-message" id="waitingMessage">
            ‚è≥ Submitting answers... Reflect on your choices.
        </div>

        <div class="score-display" id="scoreDisplay">
            <h3>Your Results</h3>
            <div class="score-number" id="scoreNumber">0/6 Correct</div>
            <div style="font-size: 24px; color: var(--color-text); margin-bottom: 10px;">Final Score: <span id="finalScoreDisplay">100</span>/100</div>
            <p id="scoreText"></p>
        </div>

        <div class="section">
            <h2 class="section-title">üéØ Student Tasks</h2>
            <div class="tasks" id="tasksSection"></div>
        </div>

        <div class="footer">
            <p>Based on real financials from: Intel, Coca‚ÄëCola, Costco, Meta, ConocoPhillips, and JPMorgan Chase</p>
        </div>
    </div>

    <!-- Floating Action Bar -->
    <div class="action-bar">
        <button class="action-btn download" id="downloadBtn" onclick="downloadReport()">üì• Download Report</button>
        <!-- Teacher button moved to Header, but logic preserved for potential fallback/preference -->
    </div>

    <!-- Teacher Auth Modal -->
    <div id="teacherModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeTeacherModal()">&times;</button>
            <h2 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">Instructor Access</h2>
            
            <div id="authView" class="auth-view">
                <p>Enter instructor password:</p>
                <input type="password" id="teacherPass" class="auth-input" placeholder="Password">
                <button class="submit-button" style="font-size:14px; padding:10px 20px;" onclick="checkTeacherPass()">Unlock</button>
                <div id="authError" class="error-msg">Incorrect Password</div>
            </div>

            <!-- Note: Key now shown in Instructor Mode on main screen, but keeping a simple list here too -->
            <div id="keyView" style="display:none;">
                <div style="background:#f3e8fd; color:#6f42c1; padding:15px; border-radius:6px; margin-bottom:15px; font-weight:bold; text-align:center;">
                    üîì Instructor Mode Unlocked
                </div>
                <p>Instructor mode is now active. Sticky toolbar enabled. Correct answers are visible below each card.</p>
                <div class="answer-key" style="margin-top:10px;">
                    <!-- Key content populated by JS -->
                </div>
                <button class="action-btn" style="background:#626C71; margin-top:20px; width:100%; justify-content:center;" onclick="revealToStudents()">üì¢ Reveal Answers to Students (Permanent)</button>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Modal for Clear & Exit -->
    <div id="confirmModal" class="modal">
        <div class="confirm-modal-content">
            <h3 style="color: var(--color-danger); margin-top: 0;">‚ö†Ô∏è Clear & Exit Instructor Mode?</h3>
            <p>This will clear all guesses, reset the game state, and lock instructor access.</p>
            <div class="confirm-buttons">
                <button class="btn-confirm-no" onclick="closeConfirmModal()">Cancel</button>
                <button class="btn-confirm-yes" onclick="performClear()">Yes, Clear All</button>
            </div>
        </div>
    </div>

    <script>
        const gameData = {
            companies: [
                {
                    id: "A",
                    name: "Mystery Company A",
                    pm: -0.5,
                    at: 0.26,
                    fl: 2.85,
                    roe: -0.37,
                    clues: [
                        "Dupont Profile: Capital Intensive / Distressed.",
                        "Lowest Asset Turnover in the group (0.26x). Massive fixed assets (factories) weighing down efficiency.",
                        "Currently showing negative ROE as it undergoes a massive strategic pivot and restructuring."
                    ],
                    hint: "Once the dominant leader in CPUs. Famous for the 'bong' sound in its commercials. Currently building foundries in Arizona and Ohio.",
                    risk: "high",
                    real: "Intel Corporation",
                    why: "Negative ROE driven by negative margins (-0.5%) and extremely low asset turnover (0.26x) due to heavy Fab investments."
                },
                {
                    id: "B",
                    name: "Mystery Company B",
                    pm: 24.0,
                    at: 0.7,
                    fl: 2.7,
                    roe: 38.0,
                    clues: [
                        "Dupont Profile: High Margin / Low Turnover.",
                        "Generates high returns through pricing power and profitability, not speed of sales.",
                        "Requires significant assets to generate revenue, resulting in turnover below 1.0x."
                    ],
                    hint: "Invented by John Pemberton in 1886. Its red and white logo is recognized by 94% of the world's population.",
                    risk: "medium",
                    real: "The Coca-Cola Company",
                    why: "High ROE is driven mainly by strong margins and brand power, supported by moderate leverage."
                },
                {
                    id: "C",
                    name: "Mystery Company C",
                    pm: 3.0,
                    at: 3.8,
                    fl: 3.7,
                    roe: 41.0,
                    clues: [
                        "Dupont Profile: Maximum Turnover / Minimum Margin.",
                        "The most extreme 'Volume' play: Margin is the lowest, but Turnover is the highest.",
                        "Heavily reliant on selling inventory as fast as possible to sustain ROE."
                    ],
                    hint: "Requires a paid membership to enter. Famous for its $1.50 hot dog combo which hasn't changed price since 1985.",
                    risk: "medium",
                    real: "Costco Wholesale",
                    why: "ROE is driven by extreme asset turnover and modest leverage rather than high margins."
                },
                {
                    id: "D",
                    name: "Mystery Company D",
                    pm: 30.08,
                    at: 0.63,
                    fl: 1.61,
                    roe: 30.24,
                    clues: [
                        "Dupont Profile: High Margin / Low Leverage.",
                        "Generates massive ROE (~30%) primarily through pure Profit Margin, not leverage or turnover.",
                        "Asset Turnover is low (<1.0) due to large intangible assets/infrastructure, but margins are elite."
                    ],
                    hint: "Founded in a dorm room. Formerly known as Facebook. Now investing heavily in the Metaverse and AI.",
                    risk: "medium",
                    real: "Meta Platforms Inc.",
                    why: "A classic Tech/Software profile: Massive margins (30%+) drive the returns, with very low financial leverage."
                },
                {
                    id: "E",
                    name: "Mystery Company E",
                    pm: 19.5,
                    at: 0.72,
                    fl: 1.85,
                    roe: 26.0,
                    clues: [
                        "Dupont Profile: High Margin / Asset Heavy.",
                        "Similar turnover to Company B, but with lower leverage.",
                        "High margins compensate for the large asset base required to generate sales."
                    ],
                    hint: "Result of a 2002 merger. A pure-play oil and gas producer with operations from the Permian Basin to Alaska.",
                    risk: "high",
                    real: "ConocoPhillips",
                    why: "ROE is driven by high margins during boom cycles, though asset turnover is low (capital intensive)."
                },
                {
                    id: "F",
                    name: "Mystery Company F",
                    pm: 32.0,
                    at: 0.04,
                    fl: 12.0,
                    roe: 15.0,
                    clues: [
                        "Dupont Profile: Extreme Leverage.",
                        "Mathematical outlier: Asset Turnover is practically zero.",
                        "Relies entirely on massive Financial Leverage (>10x) and high margins to generate ROE."
                    ],
                    hint: "The largest bank in the United States. Its history dates back to 1799 and includes heritage from Chase Manhattan and Bank One.",
                    risk: "high",
                    real: "JPMorgan Chase",
                    why: "A Global Bank profile: High margins, tiny asset turnover (assets = loans), and massive leverage (assets/equity) defined by deposits."
                }
            ],
            tasks: [
                {
                    // Target: Company A (Intel)
                    question: "Which company is suffering from a 'Capital Intensity Trap'? Massive assets (Fab plants) resulting in very low turnover (0.26x), combined with negative margins?",
                    hint: "Think Semiconductors and heavy manufacturing investment.",
                    answer: "Company A (Intel). The 0.26x turnover reflects massive investments in factories (Foundries) that aren't yet generating sufficient sales, dragging ROE negative."
                },
                {
                    // Target: Company B (Coke)
                    question: "Which company depends MOST on brand power and pricing to generate ROE?",
                    hint: "High margins, not especially high turnover.",
                    answer: "Company B (Coca-Cola). Its ROE is primarily driven by strong margins supported by global brand recognition."
                },
                {
                    // Target: Company C (Costco)
                    question: "Which company is the most extreme 'volume-driven' example, operating on the thinnest margins with the highest asset turnover?",
                    hint: "Razor thin margins, membership model.",
                    answer: "Company C (Costco). With ~3% margins and 3.8x turnover, the model relies entirely on rapid sales velocity."
                },
                {
                    // Target: Company D (Meta)
                    question: "Which company generates ~30% ROE purely through massive profit margins (30%) despite having asset turnover < 1.0, typical of a software/ad-tech business?",
                    hint: "Think digital ads and social networks.",
                    answer: "Company D (Meta). Unlike retailers (high turnover) or banks (high leverage), Meta relies on elite 30% margins to drive its returns."
                },
                {
                    // Target: Company E (ConocoPhillips/Energy)
                    question: "Which company operates in a highly cyclical industry where profit margins can swing wildly based on global commodity prices?",
                    hint: "Think energy sector and oil prices.",
                    answer: "Company E (ConocoPhillips). As an upstream E&P(Exploration and Production) company, its profitability is directly tied to the market price of oil."
                },
                {
                    // Target: Company F (JPM/Bank)
                    question: "Which company operates with a Financial Leverage ratio that is 3x-4x higher than everyone else, yet is considered normal for its industry?",
                    hint: "Think about how banks fund their loans (deposits are liabilities).",
                    answer: "Company F (JPMorgan Chase). With 12x leverage, it uses deposits (liabilities) to fund loans (assets). This structure is unique to banking."
                }
            ]
        };

        const realCompanies = [
            "Intel Corporation",
            "The Coca-Cola Company",
            "Costco Wholesale",
            "Meta Platforms Inc.",
            "ConocoPhillips",
            "JPMorgan Chase"
        ];
        
        // Human-readable names for buttons
        const buttonLabels = ["Intel", "Coca-Cola", "Costco", "Meta", "ConocoPhillips", "JPMorgan"];
        
        // Tickers for logic mapping (must match order of realCompanies)
        const tickers = ["INTC", "KO", "COST", "META", "COP", "JPM"];

        let userGuesses = {};
        let answersSubmitted = false;
        let answersReleased = false;   
        let correctCount = 0;
        let instructorMode = false;
        
        // New scoring logic
        let currentPoints = 100;
        let revealedHints = new Set(); // Track which hints opened

        function initGame() {
            userGuesses = {};
            answersSubmitted = false;
            answersReleased = false;
            correctCount = 0;
            currentPoints = 100;
            revealedHints = new Set();
            
            document.getElementById("submitContainer").classList.remove("show");
            document.getElementById("waitingMessage").classList.remove("show");
            document.getElementById("scoreDisplay").classList.remove("show");
            document.getElementById("downloadBtn").style.display = "none";
            updateScoreDisplay();
            
            renderCompanyCards();
            renderTasks();
            populateTeacherKey();
        }

        function updateScoreDisplay() {
            document.getElementById("headerScore").innerText = currentPoints;
        }

        function renderCompanyCards() {
            const grid = document.getElementById("gameGrid");
            grid.innerHTML = gameData.companies.map(company => `
                <div class="company-card" id="card-${company.id}">
                    <div class="card-header">
                        <div class="card-title">${company.name}</div>
                        <div class="roe-badge ${company.roe < 0 ? 'negative' : ''}">${company.roe.toFixed(2)}% ROE</div>
                    </div>
                    <div class="metrics">
                        <div class="metric">
                            <span class="metric-label">Profit Margin:</span>
                            <span class="metric-value ${company.pm < 0 ? 'negative' : ''}">${company.pm.toFixed(2)}%</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Asset Turnover:</span>
                            <span class="metric-value">${company.at.toFixed(2)}x</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Financial Leverage:</span>
                            <span class="metric-value">${company.fl.toFixed(2)}x</span>
                        </div>
                    </div>
                    <div class="clues">
                        ${company.clues.map(clue => `
                            <div class="clue">
                                <span class="clue-icon">‚Ä¢</span>
                                <span>${clue}</span>
                            </div>
                        `).join("")}
                    </div>
                    
                    <div class="hint-section">
                        <button class="btn-hint" id="btn-hint-${company.id}" onclick="unlockHint('${company.id}')">
                            üîí Unlock History Hint (-10 pts)
                        </button>
                        <div class="hint-text" id="hint-text-${company.id}">
                            ${company.hint}
                        </div>
                    </div>

                    <div class="button-group">
                        ${realCompanies.map((name, idx) => `
                            <button class="guess-button guess-btn-${company.id}" title="${name}" onclick="makeGuess('${company.id}', '${name}', this)">
                                ${buttonLabels[idx]}
                            </button>
                        `).join("")}
                    </div>
                    
                    <!-- INSTRUCTOR KEY AREA -->
                    <div class="instructor-key-display ${instructorMode ? 'visible' : ''}" id="key-${company.id}">
                        Key: ${company.real}
                    </div>

                    <div class="feedback" id="feedback-${company.id}"></div>
                </div>
            `).join("");
        }
        
        function unlockHint(companyId) {
            if (answersSubmitted || answersReleased) return; // Lock if game over
            if (revealedHints.has(companyId)) return; // Already revealed

            revealedHints.add(companyId);
            currentPoints -= 10;
            updateScoreDisplay();

            // UI Updates
            const btn = document.getElementById(`btn-hint-${companyId}`);
            const text = document.getElementById(`hint-text-${companyId}`);
            
            btn.style.display = 'none';
            text.classList.add('visible');
        }

        function makeGuess(companyId, guessedCompany, buttonEl) {
            // In instructor mode, we might want to allow changing even if submitted, but for game logic consistency:
            if (answersSubmitted && !instructorMode) return; 

            userGuesses[companyId] = guessedCompany;

            const buttons = document.querySelectorAll(`#card-${companyId} .guess-button`);
            buttons.forEach(btn => btn.classList.remove("selected"));

            buttonEl.classList.add("selected");

            checkIfAllGuessed();
        }

        function checkIfAllGuessed() {
            const allGuessed = Object.keys(userGuesses).length === gameData.companies.length;
            // Only show submit if not already submitted
            if (!answersSubmitted) {
                document.getElementById("submitContainer").classList.toggle("show", allGuessed);
            }
        }

        function submitAnswers() {
            answersSubmitted = true;
            document.getElementById("submitContainer").classList.remove("show");
            document.getElementById("waitingMessage").classList.add("show");
            document.querySelectorAll(".guess-button").forEach(btn => btn.disabled = true);
            // Disable hint buttons too
            document.querySelectorAll(".btn-hint").forEach(btn => btn.disabled = true);
            
            document.getElementById("downloadBtn").style.display = "flex";
        }

        function renderTasks() {
            const section = document.getElementById("tasksSection");
            section.innerHTML = gameData.tasks.map((task, idx) => `
                <div class="task-item">
                    <div class="task-question">Task ${idx + 1}: ${task.question}</div>

                    <div style="margin-bottom:8px; font-size:12px; color:#626C71;">
                        Your answer:
                    </div>
                    <textarea
                        id="task-input-${idx}"
                        rows="2"
                        style="width:100%; padding:6px; border-radius:4px; border:1px solid var(--color-border); font-size:13px;"
                        placeholder="Type your reasoning or answer here..."
                    ></textarea>

                    <button class="toggle-answer" style="margin-top:8px;" onclick="toggleAnswer(${idx})">
                        Show Model Answer
                    </button>

                    <div class="task-answer" id="answer-${idx}">
                        <strong>Model Answer:</strong> ${task.answer}
                    </div>
                </div>
            `).join("");
        }

        function toggleAnswer(idx) {
            // Instructor can always see answers
            if (!answersReleased && !instructorMode) {
                alert("Model answers will be available after your instructor releases them.");
                return;
            }
            document.getElementById(`answer-${idx}`).classList.toggle("show");
        }

        // --- INSTRUCTOR FUNCTIONS ---

        function openTeacherModal() {
            if(instructorMode) {
                // If already active, just show modal menu or nothing? 
                // Let's allow re-opening the menu
            }
            document.getElementById('teacherModal').style.display = 'flex';
            
            if(!instructorMode) {
                document.getElementById('teacherPass').value = '';
                document.getElementById('authView').style.display = 'block';
                document.getElementById('keyView').style.display = 'none';
            } else {
                document.getElementById('authView').style.display = 'none';
                document.getElementById('keyView').style.display = 'block';
            }
        }

        function closeTeacherModal() {
            document.getElementById('teacherModal').style.display = 'none';
        }

        function checkTeacherPass() {
            const pass = document.getElementById('teacherPass').value;
            // "ZHVwb250NA==" is the hidden code for "dupont4"
            if(btoa(pass) === 'ZHVwb250NA==') { 
                activateInstructorMode();
            } else {
                document.getElementById('authError').style.display = 'block';
            }
        }

        function activateInstructorMode() {
            instructorMode = true;
            document.getElementById('authView').style.display = 'none';
            document.getElementById('keyView').style.display = 'block';
            
            // Show sticky toolbar
            document.getElementById('instructorToolbar').classList.add('visible');
            document.body.classList.add('instructor-active');

            // Show inline keys
            document.querySelectorAll('.instructor-key-display').forEach(el => el.classList.add('visible'));

            closeTeacherModal();
        }

        function autoFillAll() {
            // Populate all guesses
            gameData.companies.forEach(company => {
                userGuesses[company.id] = company.real;
                
                // Visually select the button
                // Find button with specific text
                const buttons = document.querySelectorAll(`#card-${company.id} .guess-button`);
                buttons.forEach(btn => {
                    const btnText = btn.innerText.trim();
                    // Match human label
                    const realIndex = realCompanies.indexOf(company.real);
                    const targetLabel = buttonLabels[realIndex];
                    
                    if(btnText === targetLabel) {
                        btn.click(); // Trigger click logic
                    }
                });
            });
            
            // Ensure inputs are enabled if they were disabled
            document.querySelectorAll(".guess-button").forEach(btn => btn.disabled = false);
        }

        // --- CLEAR & EXIT CONFIRMATION ---

        function requestClear() {
            document.getElementById('confirmModal').style.display = 'flex';
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
        }

        function performClear() {
            // Reset everything
            instructorMode = false;
            document.getElementById('instructorToolbar').classList.remove('visible');
            document.body.classList.remove('instructor-active');
            
            // Hide inline keys
            document.querySelectorAll('.instructor-key-display').forEach(el => el.classList.remove('visible'));

            // Re-init game
            initGame();
            closeConfirmModal();
        }


        // --- ORIGINAL ADMIN FUNCTIONS ---

        function populateTeacherKey() {
            const keyContainer = document.querySelector('#keyView .answer-key');
            keyContainer.innerHTML = `
                <h3>Answer Key & Strategic Analysis</h3>
                <div style="margin: 15px 0;">
                    ${gameData.companies.map(c => `
                        <div class="answer-key-item">
                            <span class="company-name">${c.name}</span>
                            <span class="real-company">${c.real}</span>
                            <span class="risk-badge risk-${c.risk}">Risk: ${c.risk.toUpperCase()}</span>
                        </div>
                        <div style="font-size:12px; color:#666; margin-bottom:5px; padding-left:10px;"><em>${c.why}</em></div>
                    `).join("")}
                </div>
            `;
        }

        function revealToStudents() {
            if(confirm("Are you sure? This will reveal correct answers on the main screen for all students.")) {
                releaseAnswers();
                closeTeacherModal();
            }
        }

        function releaseAnswers() {
            if(!answersSubmitted) {
                answersSubmitted = true;
                document.getElementById("submitContainer").classList.remove("show");
                document.querySelectorAll(".guess-button").forEach(btn => btn.disabled = true);
                document.getElementById("downloadBtn").style.display = "flex";
            }

            answersReleased = true;
            document.getElementById("waitingMessage").classList.remove("show");

            correctCount = Object.keys(userGuesses).filter(id => {
                const company = gameData.companies.find(c => c.id === id);
                return userGuesses[id] === company.real;
            }).length;
            
            const scoreDisplay = document.getElementById("scoreDisplay");
            document.getElementById("scoreNumber").textContent = `${correctCount}/${gameData.companies.length} Correct`;
            document.getElementById("finalScoreDisplay").textContent = currentPoints;
            
            let message = "";
            if (correctCount === gameData.companies.length) message = "Perfect match!";
            else if (correctCount >= gameData.companies.length - 2) message = "Great job!";
            else message = "Use the analysis below to refine your intuition.";
            
            document.getElementById("scoreText").textContent = message;

            scoreDisplay.classList.add("show");

            gameData.companies.forEach(company => {
                const card = document.getElementById(`card-${company.id}`);
                const feedback = document.getElementById(`feedback-${company.id}`);
                const isCorrect = userGuesses[company.id] === company.real;

                card.classList.toggle("correct", isCorrect);
                card.classList.toggle("incorrect", !isCorrect);
                feedback.classList.add("show");
                feedback.innerHTML = isCorrect
                    ? `‚úì Correct! ${company.real} ‚Äì ${company.why}`
                    : `‚úó Incorrect. The answer is <strong>${company.real}</strong>.`;
                feedback.classList.toggle("correct", isCorrect);
                feedback.classList.toggle("incorrect", !isCorrect);
            });
        }

        function downloadReport() {
            const name = prompt("Please enter your name for the report:", "Student Name");
            if(!name) return;

            let report = `DUPONT FORENSICS - SUBMISSION REPORT\n`;
            report += `==========================================\n`;
            report += `Student Name: ${name}\n`;
            report += `Date: ${new Date().toLocaleString()}\n`;
            report += `Correct Guesses: ${correctCount}/${gameData.companies.length}\n`;
            report += `Points Score: ${currentPoints}/100\n`;
            report += `Hints Used: ${revealedHints.size}\n`;
            report += `==========================================\n\n`;

            report += `[COMPANY IDENTIFICATION]\n`;
            gameData.companies.forEach(c => {
                const guess = userGuesses[c.id] || "No Guess";
                const status = answersReleased ? (guess === c.real ? "CORRECT" : "INCORRECT") : "SUBMITTED";
                report += `${c.name}: Guessed [${guess}] - ${status}\n`;
            });

            report += `\n[REFLECTION TASKS]\n`;
            gameData.tasks.forEach((t, i) => {
                const ans = document.getElementById(`task-input-${i}`).value || "(No answer provided)";
                report += `Q${i+1}: ${t.question}\nAnswer: ${ans.replace(/\n/g, " ")}\n\n`;
            });

            report += `VERIFICATION CODE: ${btoa(name + correctCount + currentPoints + Date.now()).slice(0, 16).toUpperCase()}\n`;

            const blob = new Blob([report], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Dupont_Report_${name.replace(/[^a-z0-9]/gi, '_')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        initGame();
    </script>
</body>
</html>
