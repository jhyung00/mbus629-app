<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DuPont Disaggregation Analysis v3</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        .input-correct { @apply bg-green-50 border-green-500 text-green-700; }
        .input-incorrect { @apply bg-white border-gray-300; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .clickable-cell {
            cursor: pointer;
            transition: all 0.1s ease;
            user-select: none;
        }
        .clickable-cell:hover {
            background-color: #dbeafe;
            color: #1e40af;
            font-weight: 700;
            box-shadow: inset 0 0 0 1px #3b82f6;
        }
        .clickable-cell:active { background-color: #93c5fd; }
        
        .active-input-ring {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
            border-color: #3b82f6;
        }

        .toggle-btn { transition: all 0.2s; }
        .toggle-op { background-color: #dcfce7; color: #166534; border-color: #86efac; }
        .toggle-nonop { background-color: #f3f4f6; color: #4b5563; border-color: #d1d5db; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }

        .tab-active { border-bottom: 2px solid #2563eb; color: #1e40af; font-weight: 600; }
        .tab-inactive { border-bottom: 2px solid transparent; color: #64748b; }
        .tab-inactive:hover { color: #334155; }

        /* Prevent text selection while resizing */
        .resizing { cursor: col-resize; user-select: none; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen overflow-hidden" oncontextmenu="return false">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- UTILS ---
        const d = (s) => { try { return atob(s); } catch(e) { return ""; } };

        // --- ICONS ---
        const Icons = {
            Database: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            ChevronDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"/></svg>,
            HelpCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>,
            Info: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>,
            Lock: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Unlock: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Briefcase: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
            Menu: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Chart: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>,
            Pen: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
            FileSpreadsheet: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></svg>
        };

        // --- DATA SETS ---

        const DATA_SETS = {
            ITW: {
                name: "Illinois Tool Works (ITW)",
                currency: "$ Millions",
                CASE_DATA: {
                    bs: {
                        title: "Balance Sheet (ITW)",
                        headers: ["Item", "Dec 31, 2022", "Dec 31, 2021"],
                        rows: [
                            ["Total Current Assets", "6,270", "6,374"],
                            ["Net Plant & Equipment", "1,848", "1,809"],
                            ["Goodwill & Intangibles", "5,632", "5,937"],
                            ["Deferred Income Taxes", "494", "552"],
                            ["Other Assets", "1,178", "1,405"],
                            ["Total Assets", "15,422", "16,077"],
                            ["", "", ""],
                            ["Total Current Liabilities", "4,460", "3,470"],
                            ["Long-Term Debt", "6,173", "6,909"],
                            ["Deferred Income Taxes (Liab)", "484", "654"],
                            ["Other Noncurrent Liabs", "1,216", "1,418"],
                            ["Total Liabilities", "12,333", "12,451"],
                            ["Total Equity", "3,089", "3,626"]
                        ]
                    },
                    is: {
                        title: "Income Statement (ITW)",
                        headers: ["Item", "2022", "2021"],
                        rows: [
                            ["Operating Revenue", "15,932", "14,455"],
                            ["Cost of Revenue", "9,429", "8,489"],
                            ["Gross Profit", "6,503", "5,966"],
                            ["Selling, Admin & R&D", "2,579", "2,356"],
                            ["Amortization & Impairment", "134", "133"],
                            ["Operating Income", "3,790", "3,477"],
                            ["Interest Expense", "203", "202"],
                            ["Other (income) expense", "(255)", "(51)"],
                            ["Income Before Taxes", "3,842", "3,326"],
                            ["Income Taxes", "808", "632"],
                            ["Net Income", "3,034", "2,694"]
                        ]
                    },
                    supp: {
                        title: "Supplemental Info (ITW)",
                        headers: ["Item", "2022", "2021"],
                        rows: [
                            ["Tax Rate", "22%", "22%"],
                            ["Non-Operating Items (Pre-tax)", "(52)", "151"],
                            ["Tax Shield (22%)", "(11)", "33"],
                            ["Average Equity", "3,358", "3,404"],
                            ["Average NOA", "10,543", "9,826"], 
                            ["Average Total Assets", "?", "15,845"]
                        ]
                    }
                },
                CLASSIFICATION_ITEMS: [
                    { id: "cash", label: "Cash and equivalents", val22: 708, val21: 1527, type: "asset", correct: "non-op" },
                    { id: "ar", label: "Trade receivables", val22: 3171, val21: 2840, type: "asset", correct: "op" },
                    { id: "inv", label: "Inventories", val22: 2054, val21: 1694, type: "asset", correct: "op" },
                    { id: "pre", label: "Prepaid expenses & other", val22: 329, val21: 313, type: "asset", correct: "op" },
                    { id: "hfs", label: "Assets held for sale", val22: 8, val21: 0, type: "asset", correct: "non-op" },
                    { id: "ppe", label: "Net plant and equipment", val22: 1848, val21: 1809, type: "asset", correct: "op" },
                    { id: "good", label: "Goodwill", val22: 4864, val21: 4965, type: "asset", correct: "op" },
                    { id: "int", label: "Intangible assets", val22: 768, val21: 972, type: "asset", correct: "op" },
                    { id: "dta", label: "Deferred income taxes (Asset)", val22: 494, val21: 552, type: "asset", correct: "op" },
                    { id: "other_a", label: "Other assets", val22: 1178, val21: 1405, type: "asset", correct: "op" },
                    { id: "st_debt", label: "Short-term debt", val22: 1590, val21: 778, type: "liab", correct: "non-op" },
                    { id: "ap", label: "Accounts payable", val22: 594, val21: 585, type: "liab", correct: "op" },
                    { id: "lease_st", label: "Lease liabs (Current)", val22: 55, val21: 61, type: "liab", correct: "non-op" },
                    { id: "acc", label: "Accrued expenses", val22: 1673, val21: 1587, type: "liab", correct: "op" },
                    { id: "div", label: "Cash dividends payable", val22: 400, val21: 382, type: "liab", correct: "non-op" },
                    { id: "tax_st", label: "Income taxes payable", val22: 147, val21: 77, type: "liab", correct: "op" },
                    { id: "hfs_l", label: "Liabilities held for sale", val22: 1, val21: 0, type: "liab", correct: "non-op" },
                    { id: "lt_debt", label: "Long-term debt", val22: 6173, val21: 6909, type: "liab", correct: "non-op" },
                    { id: "dtl", label: "Deferred income taxes (Liab)", val22: 484, val21: 654, type: "liab", correct: "op" },
                    { id: "tax_lt", label: "Noncurrent income taxes", val22: 273, val21: 365, type: "liab", correct: "op" },
                    { id: "lease_lt", label: "Lease liabs (Long-term)", val22: 131, val21: 133, type: "liab", correct: "non-op" },
                    { id: "other_l", label: "Other liabilities", val22: 812, val21: 920, type: "liab", correct: "op" },
                ],
                _DATA_MATRIX: {
                    "avg_ta_2022": "MTU3NDkuNQ==",
                    "roe_2022": "OTAuMzk=", "roe_2021": "NzkuMTc=",
                    "roa_2022": "MTkuMjY=", "roa_2021": "MTcuMDA=",
                    "fl_2022": "NC42OQ==", "fl_2021": "NC42NQ==",
                    "ncir_2022": "MS4wMDAz", "ncir_2021": "MS4wMDAz",
                    "pm_2022": "MTkuMDQ=", "pm_2021": "MTguNjQ=",
                    "at_2022": "MS4wMQ==", "at_2021": "MC45MQ==",
                    "avg_noa_2022": "MTA1NDM=", "avg_noa_2021": "OTgyNg==",
                    "nopat_m2": "Mjk5Mw==",
                    "rnoa_2022": "MjguMzk=", "rnoa_2021": "MjguNjI=",
                    "nopm_2022": "MTguNzk=", "nopm_2021": "MTkuNDU=",
                    "noat_2022": "MS41MTEy", "noat_2021": "MS40NzEy"
                },
                _INTERPRETATION: {
                    q1: "ROE (90.4%) is significantly driven by Financial Leverage (4.69). While ROA (19.3%) is healthy, the multiplier effect of debt pushes ROE to very high levels.",
                    q2: "RNOA (28.4%) is decomposed into NOPM (18.8%) and NOAT (1.51). Compared to the standard ROA, RNOA provides a clearer picture of operating efficiency by removing non-operating assets (like excess cash) and liabilities.",
                    q3: "Net Operating Asset Turnover (NOAT) is 1.51, which is higher than Total Asset Turnover (AT) of 1.01. This indicates that the core operating assets are generating revenue more efficiently than the total asset base, which includes non-operating assets."
                }
            },
            PH: {
                name: "Parker Hannifin (PH)",
                currency: "$ Thousands",
                CASE_DATA: {
                    bs: {
                        title: "Balance Sheet (PH)",
                        headers: ["Item", "Jun 30, 2022", "Jun 30, 2021"],
                        rows: [
                            ["Total Current Assets", "12,046,644", "5,616,750"],
                            ["Net PPE", "2,122,758", "2,266,476"],
                            ["Goodwill", "7,740,082", "8,059,687"],
                            ["Intangible Assets", "3,135,817", "3,519,797"],
                            ["Other Assets", "898,642", "878,490"],
                            ["Total Assets", "25,943,943", "20,341,200"],
                            ["", "", ""],
                            ["Total Current Liabilities", "5,859,318", "3,096,503"],
                            ["Long-term Debt", "9,755,825", "6,582,053"],
                            ["Pensions", "639,939", "1,055,638"],
                            ["Deferred Income Taxes", "307,044", "553,981"],
                            ["Other Liabilities", "521,897", "639,355"],
                            ["Total Liabilities", "17,084,023", "11,927,530"],
                            ["Total Equity", "8,859,920", "8,413,670"]
                        ]
                    },
                    is: {
                        title: "Income Statement (PH)",
                        headers: ["Item", "2022", "2021"],
                        rows: [
                            ["Net Sales", "15,861,608", "14,347,640"],
                            ["Cost of Sales", "11,387,267", "10,449,680"],
                            ["Gross Profit", "4,474,341", "3,897,960"],
                            ["SG&A Expenses", "1,627,116", "1,527,302"],
                            ["Gain on disposal of assets", "(7,121)", "(109,332)"],
                            ["Operating Income", "2,854,346", "2,479,990"],
                            ["Interest Expense", "255,252", "250,036"],
                            ["Loss on forward contracts", "1,015,426", "0"],
                            ["Other expense (income), net", "(30,558)", "(17,003)"],
                            ["Income Before Taxes", "1,614,226", "2,246,957"],
                            ["Income Taxes", "298,040", "500,096"],
                            ["Net Income", "1,316,186", "1,746,861"],
                            ["Less: Noncontrolling interest", "581", "761"],
                            ["Net Income Attributable to Common", "1,315,605", "1,746,100"]
                        ]
                    },
                    supp: {
                        title: "Supplemental Info (PH)",
                        headers: ["Item", "2022", "2021"],
                        rows: [
                            ["Tax Rate", "22%", "22%"],
                            ["Non-Operating Items (Pre-tax)", "1,240,120", "233,033"],
                            ["Tax Shield (22%)", "272,826", "51,267"],
                            ["Average Equity", "8,636,795", "7,327,720"],
                            ["Average NOA", "15,920,399", "13,168,717"],
                            ["Average Total Assets", "?", "20,114,477"]
                        ]
                    }
                },
                CLASSIFICATION_ITEMS: [
                    { id: "cash", label: "Cash and equivalents", val22: 535799, val21: 733117, type: "asset", correct: "non-op" },
                    { id: "mkt", label: "Marketable securities", val22: 27862, val21: 39116, type: "asset", correct: "non-op" },
                    { id: "ar", label: "Trade receivables", val22: 2341504, val21: 2183594, type: "asset", correct: "op" },
                    { id: "notes_r", label: "Non-trade notes rec", val22: 543757, val21: 326315, type: "asset", correct: "non-op" },
                    { id: "inv", label: "Inventories", val22: 2214553, val21: 2090642, type: "asset", correct: "op" },
                    { id: "pre", label: "Prepaid expenses & other", val22: 6383169, val21: 243966, type: "asset", correct: "op" },
                    { id: "ppe", label: "Net PPE", val22: 2122758, val21: 2266476, type: "asset", correct: "op" },
                    { id: "def_a", label: "Deferred income taxes (A)", val22: 110585, val21: 104251, type: "asset", correct: "op" },
                    { id: "invest", label: "Investments/Other", val22: 788057, val21: 774239, type: "asset", correct: "non-op" },
                    { id: "int", label: "Intangibles", val22: 3135817, val21: 3519797, type: "asset", correct: "op" },
                    { id: "good", label: "Goodwill", val22: 7740082, val21: 8059687, type: "asset", correct: "op" },
                    { id: "notes_pay", label: "Notes payable", val22: 1724310, val21: 2824, type: "liab", correct: "non-op" },
                    { id: "ap", label: "Accounts payable", val22: 1731925, val21: 1667878, type: "liab", correct: "op" },
                    { id: "acc_pay", label: "Accrued payrolls", val22: 470132, val21: 507027, type: "liab", correct: "op" },
                    { id: "acc_tax", label: "Accrued taxes", val22: 250292, val21: 236384, type: "liab", correct: "op" },
                    { id: "lease_cur", label: "Lease liabs (Current)", val22: 36023, val21: 40193, type: "liab", correct: "non-op" },
                    { id: "other_acc", label: "Other accrued liabs", val22: 1646636, val21: 642197, type: "liab", correct: "op" },
                    { id: "lt_debt", label: "Long-term debt", val22: 9755825, val21: 6582053, type: "liab", correct: "non-op" },
                    { id: "pension", label: "Pensions", val22: 639939, val21: 1055638, type: "liab", correct: "op" },
                    { id: "def_liab", label: "Deferred income taxes", val22: 307044, val21: 553981, type: "liab", correct: "op" },
                    { id: "lease_lt", label: "Lease liabs (Long-term)", val22: 100337, val21: 93904, type: "liab", correct: "non-op" },
                    { id: "other_l", label: "Other liabilities", val22: 421560, val21: 545451, type: "liab", correct: "op" }
                ],
                _DATA_MATRIX: {
                    "avg_ta_2022": "MjMxNDI1NzEuNQ==",
                    "roe_2022": "MTUuMjY=", "roe_2021": "MjMuODg=",
                    "roa_2022": "NS42OQ==", "roa_2021": "OC42OA==",
                    "fl_2022": "Mi42OA==", "fl_2021": "Mi43NA==",
                    "ncir_2022": "MS4wMDEx", "ncir_2021": "MS4wMDE2",
                    "pm_2022": "OC4zMA==", "pm_2021": "MTIuMTg=",
                    "at_2022": "MC42OQ==", "at_2021": "MC43MQ==",
                    "avg_noa_2022": "MTU5MjAzOTk=", "avg_noa_2021": "MTMxNjg3MTc=",
                    "nopat_m2": "MjI4MzQ4MA==",
                    "rnoa_2022": "MTQuMzQ=", "rnoa_2021": "MTQuNjU=",
                    "nopm_2022": "MTQuNDA=", "nopm_2021": "MTMuNDQ=",
                    "noat_2022": "MC45OTYz", 
                    "noat_2021": "MS4wODk1"
                },
                _INTERPRETATION: {
                    q1: "ROE (15.3%) is driven by Financial Leverage (2.68). However, compared to ROA (5.7%), the leverage effect is positive but less dramatic than ITW's, indicating a more moderate debt structure.",
                    q2: "RNOA (14.3%) is decomposed into NOPM (14.4%) and NOAT (1.00). The operating return is significantly higher than the overall ROA (5.7%), highlighting that the core business is more profitable than the aggregate view suggests.",
                    q3: "Net Operating Asset Turnover (NOAT) is 1.00, compared to Total Asset Turnover (AT) of 0.69. This difference shows that operating assets are turning over sales much more efficiently than the total asset base."
                }
            }
        };

        const HINT_DATA = {
            roe: { title: "Return on Equity", def: "Net Income / Average Stockholders' Equity" },
            dupont: { 
                title: "DuPont Disaggregation", 
                def: (
                    <span>
                        ROE = ROA × FL × NCIR
                        <br/><br/>
                        <span className="block text-slate-600 font-mono text-[11px] mb-1">ROA = Net Income / Average Total Assets</span>
                        <span className="block text-slate-600 font-mono text-[11px]">FL = Average Total Assets / Average Total Equity</span>
                    </span>
                )
            },
            roa: { title: "Return on Assets", def: "Net Income / Average Total Assets" },
            fl: { title: "Financial Leverage", def: "Avg Total Assets / Avg Stockholders' Equity" },
            ncir: { title: "NCIR", def: "Net Income / Net Income Attributable to Parent" },
            roa_decomp: { title: "ROA Decomposition", def: "Profit Margin × Asset Turnover" },
            rnoa: { title: "RNOA", def: "NOPAT / Average Net Operating Assets (NOA)" },
            rnoa_decomp: { title: "RNOA Decomposition", def: "RNOA = NOPAT / Net Revenue × Net Revenue / Avg. NOA = NOPM % x NOAT" }
        };

        // --- COMPONENTS ---

        const HintBox = ({ id }) => {
            const [isOpen, setIsOpen] = useState(false);
            const data = HINT_DATA[id];
            if(!data) return null;
            return (
                <div className="mt-1 text-xs">
                    <button onClick={() => setIsOpen(!isOpen)} className="flex items-center gap-1 text-blue-600 hover:text-blue-800 font-medium">
                        <Icons.Info /> {isOpen ? "Hide Hint" : "Show Hint"}
                    </button>
                    {isOpen && (
                        <div className="mt-1 p-2 bg-blue-50 border border-blue-200 rounded text-slate-700 animate-fade-in">
                            <p className="font-bold text-blue-900">{data.title}</p>
                            <div className="mt-1">{data.def}</div>
                        </div>
                    )}
                </div>
            );
        };

        const SmartInput = ({ id, value, onChange, correctValue, placeholder, activeInput, setActiveInput, teacherMode, isPercentage, readOnly }) => {
            const isActive = activeInput === id;
            const [error, setError] = useState(null);
            
            // Decoded correct value for internal checks
            const decodedCorrect = useMemo(() => d(correctValue), [correctValue]);

            const calculateValue = (inputVal) => {
                if (!inputVal) return { valid: true, result: inputVal };
                try {
                    // Remove commas first
                    let expr = inputVal.toString().replace(/,/g, '');

                    // Handle percentages: convert "22%" or "22.5 %" to "(22/100)"
                    expr = expr.replace(/(\d+(\.\d+)?)\s*%/g, '($1/100)');

                    // Pre-process: replace multiple dashes (--) with +
                    let cleanExpr = expr.replace(/[^\d\.\+\-\*\/\(\)]/g, '');
                    cleanExpr = cleanExpr.replace(/--/g, '+'); 
                    
                    if (!cleanExpr) return { valid: false, msg: "Invalid input" };
                    // eslint-disable-next-line no-eval
                    const result = eval(cleanExpr);
                    if (!isFinite(result) || isNaN(result)) return { valid: false, msg: "Error" };
                    return { valid: true, result: result };
                } catch (e) {
                    return { valid: false, msg: "Syntax Error" };
                }
            };

            const isCorrect = useMemo(() => {
                if (!value || !decodedCorrect) return false;
                const { valid, result } = calculateValue(value);
                if (!valid) return false;
                const correctNum = parseFloat(decodedCorrect.replace(/,/g, ''));
                const valNum = parseFloat(result);
                
                let matches = false;
                const relativeTolerance = 0.005; // 0.5%

                // Direct Match
                if (correctNum !== 0) {
                     if (Math.abs((valNum - correctNum) / correctNum) < relativeTolerance) matches = true;
                } else {
                     if (Math.abs(valNum) < 0.001) matches = true;
                }

                // Percent Decimal Match
                if (!matches && isPercentage) {
                    const scaledVal = valNum * 100;
                     if (correctNum !== 0) {
                         if (Math.abs((scaledVal - correctNum) / correctNum) < relativeTolerance) matches = true;
                     }
                }
                
                return matches;

            }, [value, decodedCorrect, isPercentage]);

            const handleCommit = () => {
                if (readOnly) return;
                
                if (!value || value.toString().trim() === '') {
                    onChange(id, value);
                    return;
                }

                setError(null);
                const { valid, result, msg } = calculateValue(value);
                if (!valid) {
                    setError(msg);
                    return;
                }
                
                const numVal = Number(result);
                let finalVal = result;
                const correctNum = parseFloat(decodedCorrect.replace(/,/g, ''));
                
                // Formatting
                if (isPercentage) {
                      if (Math.abs(numVal - correctNum) > Math.abs((numVal * 100) - correctNum)) {
                           finalVal = (numVal * 100).toFixed(2);
                      } else {
                           finalVal = numVal.toFixed(2);
                      }
                } else {
                    if (Number.isInteger(numVal)) {
                        finalVal = numVal.toString();
                    } else {
                        finalVal = parseFloat(numVal.toFixed(4)).toString();
                    }
                }
                onChange(id, finalVal.toString());
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    handleCommit();
                    e.target.blur();
                }
            };

            return (
                <div className="relative w-full">
                    <input
                        id={id}
                        type="text"
                        value={readOnly ? decodedCorrect : (value || '')}
                        onChange={readOnly ? undefined : (e) => { setError(null); onChange(id, e.target.value); }}
                        onFocus={readOnly ? undefined : () => setActiveInput(id)}
                        onBlur={readOnly ? undefined : handleCommit}
                        onKeyDown={readOnly ? undefined : handleKeyDown}
                        readOnly={readOnly}
                        className={`w-full p-2 text-base sm:text-sm text-right border rounded font-mono transition-all outline-none ${
                            readOnly ? 'bg-gray-100 text-gray-600 border-gray-300' :
                            error ? 'border-red-500 bg-red-50' :
                            isActive ? 'active-input-ring z-10 border-blue-500' : 
                            'border-gray-300'
                        } ${!readOnly && isCorrect ? 'bg-green-50 text-green-800 border-green-400 font-bold' : ''}`}
                        placeholder={placeholder}
                    />
                    {!readOnly && isCorrect && <div className="absolute left-2 top-2 text-green-600 pointer-events-none"><Icons.Check /></div>}
                    {error && <div className="absolute left-2 top-2 text-red-500 text-xs pointer-events-none font-bold">!</div>}
                    {teacherMode && !isCorrect && !readOnly && <div className="absolute -top-5 right-0 text-[10px] bg-yellow-100 text-yellow-800 px-1 rounded shadow z-20 whitespace-nowrap">Correct: {decodedCorrect}</div>}
                </div>
            );
        };

        const ReferenceTable = ({ title, data, onValueClick }) => {
            const [isOpen, setIsOpen] = useState(true);
            return (
                <div className="bg-white border border-slate-200 rounded-lg shadow-sm mb-4 overflow-hidden">
                    <button onClick={() => setIsOpen(!isOpen)} className="w-full flex items-center justify-between p-3 bg-slate-50 hover:bg-slate-100 transition text-sm font-bold text-slate-700">
                        <span className="flex items-center gap-2"><Icons.Database /> {title}</span>
                        <div className={`transition-transform ${isOpen ? 'rotate-180' : ''}`}><Icons.ChevronDown /></div>
                    </button>
                    {isOpen && (
                        <div className="overflow-x-auto">
                            <table className="w-full text-xs text-left">
                                <thead className="bg-slate-100 text-slate-500">
                                    <tr>{data.headers.map((h, i) => <th key={i} className={`p-2 border-b ${i>0?'text-right':''}`}>{h}</th>)}</tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {data.rows.map((row, i) => (
                                        <tr key={i} className="hover:bg-blue-50/30">
                                            <td className="p-2 font-medium text-slate-700">{row[0]}</td>
                                            {row.slice(1).map((cell, j) => (
                                                <td key={j} onMouseDown={(e) => { e.preventDefault(); if(cell !== '?' && cell !== 'Calculate') onValueClick(cell); }} className={`p-2 text-right font-mono text-slate-600 ${cell !== '?' && cell !== 'Calculate' ? 'clickable-cell' : 'cursor-default text-slate-400'}`} title="Click to insert">{cell}</td>
                                            ))}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        const ClassificationTable = ({ items, selections, onToggle, teacherMode }) => {
            const totals = useMemo(() => {
                let res = { opA22: 0, opA21: 0, noA22: 0, noA21: 0, opL22: 0, opL21: 0, noL22: 0, noL21: 0 };
                items.forEach(item => {
                    const type = selections[item.id] || "op";
                    if(item.type === 'asset') {
                        if(type === 'op') { res.opA22 += item.val22; res.opA21 += item.val21; }
                        else { res.noA22 += item.val22; res.noA21 += item.val21; }
                    } else {
                        if(type === 'op') { res.opL22 += item.val22; res.opL21 += item.val21; }
                        else { res.noL22 += item.val22; res.noL21 += item.val21; }
                    }
                });
                return res;
            }, [items, selections]);

            const noa22 = totals.opA22 - totals.opL22;
            const noa21 = totals.opA21 - totals.opL21;

            return (
                <div className="bg-white rounded border border-slate-200 overflow-hidden mb-6">
                    <div className="bg-slate-50 p-3 border-b text-sm font-bold text-slate-700 flex justify-between items-center">
                        <span>Classification</span>
                        <span className="text-[10px] sm:text-xs font-normal text-slate-500">2022 & 2021</span>
                    </div>
                    
                    <div className="overflow-x-auto">
                        <div className="min-w-[600px] grid grid-cols-12 gap-0 text-xs">
                            <div className="col-span-4 p-2 font-bold text-slate-500 border-b bg-slate-50/50 sticky left-0">Item</div>
                            <div className="col-span-2 p-2 font-bold text-slate-500 border-b text-right">2022</div>
                            <div className="col-span-2 p-2 font-bold text-slate-500 border-b text-right">2021</div>
                            <div className="col-span-4 p-2 font-bold text-slate-500 border-b text-center">Type</div>
                            
                            {items.map(item => {
                                const isOp = (selections[item.id] || 'op') === 'op';
                                return (
                                    <React.Fragment key={item.id}>
                                        <div className="col-span-4 p-2 border-b flex items-center font-medium text-slate-700 bg-white sticky left-0 border-r md:border-r-0">{item.label}</div>
                                        <div className="col-span-2 p-2 border-b text-right font-mono bg-white">{item.val22.toLocaleString()}</div>
                                        <div className="col-span-2 p-2 border-b text-right font-mono text-slate-500 bg-white">{item.val21.toLocaleString()}</div>
                                        <div className="col-span-4 p-1 border-b flex justify-center items-center bg-white">
                                            <button onClick={() => onToggle(item.id)} className={`px-2 sm:px-3 py-1 rounded-full text-[10px] font-bold border toggle-btn whitespace-nowrap ${isOp ? 'toggle-op' : 'toggle-nonop'}`}>
                                                {isOp ? 'Operating' : 'Non-Op'}
                                            </button>
                                            {teacherMode && item.correct !== (selections[item.id] || 'op') && <span className="text-red-500 ml-1">●</span>}
                                        </div>
                                    </React.Fragment>
                                );
                            })}
                        </div>
                    </div>
                    <div className="p-4 bg-slate-50 border-t">
                        <div className="grid grid-cols-2 gap-2 sm:gap-4 text-sm mb-4">
                            <div className="font-bold text-slate-500 text-right text-xs sm:text-sm">Metric</div>
                            <div className="font-bold text-slate-700 text-right text-xs sm:text-sm">2022 Total</div>
                            <div className="font-bold text-slate-700 text-right text-xs sm:text-sm">2021 Total</div>
                            
                            <div className="text-right text-blue-800 text-xs sm:text-sm font-semibold">Net Operating Assets (NOA)</div>
                            <div className="text-right font-mono font-bold text-blue-900 bg-blue-50 rounded px-2 text-xs sm:text-sm">{noa22.toLocaleString()}</div>
                            <div className="text-right font-mono font-bold text-blue-900 bg-blue-50 rounded px-2 text-xs sm:text-sm">{noa21.toLocaleString()}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [selectedCase, setSelectedCase] = useState("PH");
            const [inputs, setInputs] = useState({ PH: {}, ITW: {} });
            const [selections, setSelections] = useState({ PH: {}, ITW: {} });
            const [activeInput, setActiveInput] = useState(null);
            const [teacherMode, setTeacherMode] = useState(false);
            const [showLogin, setShowLogin] = useState(false);
            const [showNamePrompt, setShowNamePrompt] = useState(false);
            const [studentName, setStudentName] = useState("");
            const [password, setPassword] = useState("");
            const [activeTab, setActiveTab] = useState("analysis"); // analysis | interpretation
            
            // Sidebar Resizing State
            const [sidebarWidth, setSidebarWidth] = useState(30); 
            const [isResizing, setIsResizing] = useState(false);
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

            const currentData = DATA_SETS[selectedCase];
            const currentInputs = inputs[selectedCase];
            const currentSelections = selections[selectedCase];

            useEffect(() => {
                const initPH = {}; DATA_SETS.PH.CLASSIFICATION_ITEMS.forEach(i => initPH[i.id] = 'op');
                const initITW = {}; DATA_SETS.ITW.CLASSIFICATION_ITEMS.forEach(i => initITW[i.id] = 'op');
                setSelections({ PH: initPH, ITW: initITW });
            }, []);
            
            useEffect(() => {
                const handleMouseMove = (e) => {
                    if (!isResizing) return;
                    const newWidth = (e.clientX / window.innerWidth) * 100;
                    if (newWidth > 20 && newWidth < 50) setSidebarWidth(newWidth); 
                };
                const handleMouseUp = () => setIsResizing(false);

                if (isResizing) {
                    window.addEventListener('mousemove', handleMouseMove);
                    window.addEventListener('mouseup', handleMouseUp);
                    document.body.classList.add('resizing');
                } else {
                    document.body.classList.remove('resizing');
                }
                return () => {
                    window.removeEventListener('mousemove', handleMouseMove);
                    window.removeEventListener('mouseup', handleMouseUp);
                    document.body.classList.remove('resizing');
                };
            }, [isResizing]);

            const handleInputChange = (id, val) => {
                setInputs(prev => ({
                    ...prev,
                    [selectedCase]: { ...prev[selectedCase], [id]: val }
                }));
            };

            const handleToggle = (id) => {
                setSelections(prev => ({
                    ...prev,
                    [selectedCase]: {
                        ...prev[selectedCase],
                        [id]: prev[selectedCase][id] === 'op' ? 'non-op' : 'op'
                    }
                }));
            };

            const handleValueClick = (val) => {
                if (!activeInput) return;
                let cleanVal = val.replace(/,/g, '');
                if (cleanVal.includes('(')) cleanVal = '-' + cleanVal.replace(/[()]/g, '');
                setInputs(prev => {
                    const currentVal = prev[selectedCase][activeInput] || "";
                    const operators = ['+', '-', '*', '/', '('];
                    const lastChar = currentVal.trim().slice(-1);
                    const newVal = (currentVal === "" || operators.includes(lastChar)) 
                        ? currentVal + cleanVal 
                        : cleanVal;
                    
                    return {
                        ...prev,
                        [selectedCase]: { ...prev[selectedCase], [activeInput]: newVal }
                    };
                });
                setTimeout(() => document.getElementById(activeInput)?.focus(), 0);
                if (window.innerWidth < 768) setMobileMenuOpen(false);
            };

            const generateDownload = () => {
                const text = `DuPont Analysis - ${selectedCase}\nStudent: ${studentName}\n\nAnswers:\n${JSON.stringify(inputs[selectedCase], null, 2)}`;
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `${studentName.replace(/\s+/g,'_')}_${selectedCase}_Analysis.txt`;
                a.click();
                setShowNamePrompt(false);
            };

            const toggleTeacher = () => teacherMode ? setTeacherMode(false) : setShowLogin(true);
            
            const checkPassword = () => { 
                if(btoa(password) === 'ZHVwb250NQ==') { 
                    setTeacherMode(true); 
                    setShowLogin(false); 
                    setPassword(''); 
                } else {
                    alert("Incorrect Code"); 
                }
            };
            
            const autoFill = () => {
                if(teacherMode) {
                    const currentKeys = Object.keys(inputs[selectedCase]);
                    if (currentKeys.length > 5) {
                        setInputs(prev => ({ ...prev, [selectedCase]: {} }));
                        const defaultSels = {}; 
                        currentData.CLASSIFICATION_ITEMS.forEach(i => defaultSels[i.id] = 'op');
                        setSelections(prev => ({ ...prev, [selectedCase]: defaultSels }));
                    } else {
                        const decodedAnswers = {};
                        Object.keys(currentData._DATA_MATRIX).forEach(k => {
                            decodedAnswers[k] = d(currentData._DATA_MATRIX[k]);
                        });
                        setInputs(prev => ({ ...prev, [selectedCase]: decodedAnswers }));
                        const correctSels = {};
                        currentData.CLASSIFICATION_ITEMS.forEach(i => correctSels[i.id] = i.correct);
                        setSelections(prev => ({ ...prev, [selectedCase]: correctSels }));
                    }
                }
            };

            return (
                <div className="flex h-screen overflow-hidden bg-slate-100 relative">
                    
                    {/* Mobile Overlay */}
                    {mobileMenuOpen && (
                        <div className="fixed inset-0 bg-black/50 z-30 md:hidden" onClick={() => setMobileMenuOpen(false)}></div>
                    )}

                    {/* Sidebar Drawer */}
                    <div 
                        style={{ width: window.innerWidth >= 768 ? `${sidebarWidth}%` : '85%' }}
                        className={`fixed inset-y-0 left-0 z-40 bg-white border-r border-slate-200 overflow-y-auto custom-scrollbar flex flex-col shadow-xl transition-transform duration-300 transform 
                            ${mobileMenuOpen ? 'translate-x-0' : '-translate-x-full'} 
                            md:translate-x-0 md:relative md:flex md:shadow-none md:z-10
                        `}
                    >
                        <div className="p-4 bg-slate-900 text-white sticky top-0 z-20 shadow">
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="font-bold text-lg flex items-center gap-2"><Icons.Briefcase /> Reference Data</h2>
                                <button className="md:hidden text-slate-300" onClick={() => setMobileMenuOpen(false)}><Icons.X /></button>
                            </div>
                            
                            <div className="mb-4 bg-slate-800 p-2 rounded border border-slate-700">
                                <label className="text-[10px] text-slate-400 uppercase font-bold tracking-wider block mb-1">Select Case Study</label>
                                <select 
                                    value={selectedCase} 
                                    onChange={(e) => setSelectedCase(e.target.value)}
                                    className="w-full bg-slate-700 hover:bg-slate-600 text-white text-base sm:text-sm p-2 rounded outline-none border border-slate-600 transition-colors font-bold"
                                >
                                    <option value="PH">Parker Hannifin (PH)</option>
                                    <option value="ITW">Illinois Tool Works (ITW)</option>
                                </select>
                            </div>

                            <a 
                                href="data/DuPont_Analysis.xlsx" 
                                download="DuPont_Analysis.xlsx"
                                className="w-full py-2 bg-green-700 hover:bg-green-600 text-white text-xs font-bold rounded flex items-center justify-center gap-2 mb-4 transition-colors border border-green-600 decoration-none"
                            >
                                <Icons.FileSpreadsheet /> Download Data (Excel)
                            </a>

                            <p className="text-xs text-slate-400">Click numbers to insert into calculations. {currentData.currency}.</p>
                        </div>
                        <div className="p-4 space-y-2 pb-20 md:pb-4">
                            <ReferenceTable title="Balance Sheet" data={currentData.CASE_DATA.bs} onValueClick={handleValueClick} />
                            <ReferenceTable title="Income Statement" data={currentData.CASE_DATA.is} onValueClick={handleValueClick} />
                            <ReferenceTable title="Supplemental Info" data={currentData.CASE_DATA.supp} onValueClick={handleValueClick} />
                        </div>
                    </div>

                    {/* Resizer Handle */}
                    <div
                        className="hidden md:block w-1 hover:w-2 bg-slate-200 hover:bg-blue-400 cursor-col-resize transition-all z-20 flex-shrink-0"
                        onMouseDown={() => setIsResizing(true)}
                    />

                    {/* Main Content */}
                    <div className="flex-1 flex flex-col h-full overflow-hidden w-full relative">
                        
                        {/* Header Bar */}
                        <div className="bg-white border-b border-slate-200 p-3 md:p-4 flex items-center justify-between shrink-0 sticky top-0 z-20 shadow-sm">
                             <div className="flex items-center">
                                 <button onClick={() => setMobileMenuOpen(true)} className="md:hidden text-slate-700 mr-3 p-1 rounded hover:bg-slate-100">
                                    <Icons.Menu />
                                 </button>
                                 <div>
                                     <h1 className="text-lg md:text-xl font-bold text-slate-800 leading-tight">DuPont Disaggregation</h1>
                                     <p className="text-xs text-slate-500 hidden sm:block">{currentData.name} - 2022 Analysis</p>
                                 </div>
                             </div>
                             <div className="flex gap-2 items-center">
                                <button onClick={() => setShowNamePrompt(true)} className="p-2 md:px-4 md:py-2 bg-blue-600 text-white rounded text-sm font-bold flex items-center gap-2 hover:bg-blue-700 transition">
                                    <Icons.Download /> <span className="hidden sm:inline">Save Work</span>
                                </button>
                                {teacherMode && (
                                    <button 
                                        onClick={autoFill} 
                                        className={`px-3 py-1 rounded text-xs font-bold transition hidden sm:block ${Object.keys(currentInputs).length > 5 ? 'bg-red-100 text-red-700 hover:bg-red-200' : 'bg-green-100 text-green-700 hover:bg-green-200'}`}
                                    >
                                        {Object.keys(currentInputs).length > 5 ? 'Clear All' : 'Auto-Fill'}
                                    </button>
                                )}
                                <button onClick={toggleTeacher} className={`p-2 transition-opacity ${teacherMode ? 'text-green-600 opacity-100' : 'text-slate-400 opacity-20 hover:opacity-100'}`}>
                                    {teacherMode ? <Icons.Unlock /> : <Icons.Lock />}
                                </button>
                             </div>
                        </div>

                        {/* Tabs */}
                        <div className="bg-white px-4 border-b border-slate-200 flex gap-6 sticky top-[60px] z-10">
                            <button 
                                onClick={() => setActiveTab('analysis')}
                                className={`py-3 text-sm flex items-center gap-2 transition-colors ${activeTab === 'analysis' ? 'tab-active' : 'tab-inactive'}`}
                            >
                                <Icons.Chart /> Quantitative Analysis
                            </button>
                            <button 
                                onClick={() => setActiveTab('interpretation')}
                                className={`py-3 text-sm flex items-center gap-2 transition-colors ${activeTab === 'interpretation' ? 'tab-active' : 'tab-inactive'}`}
                            >
                                <Icons.Pen /> Interpretation
                            </button>
                        </div>

                        <div className="flex-1 overflow-y-auto custom-scrollbar bg-slate-50 p-4 md:p-8">
                             <div className="max-w-4xl mx-auto space-y-6">
                                
                                {activeTab === 'analysis' ? (
                                    <>
                                        {/* 1. Prelim */}
                                        <div className="bg-white rounded shadow-sm border p-4 sm:p-6">
                                            <div className="flex justify-between items-start"><h3 className="font-bold text-base sm:text-lg text-slate-800">1. Data Preparation</h3></div>
                                            <p className="text-xs text-slate-500 mb-4">Calculate missing average values needed for subsequent steps.</p>
                                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 mb-1">Average Total Assets (2022)</label>
                                                    <SmartInput id="avg_ta_2022" value={currentInputs.avg_ta_2022} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={currentData._DATA_MATRIX.avg_ta_2022} teacherMode={teacherMode} placeholder="Calculate Average" />
                                                </div>
                                            </div>
                                        </div>

                                        {/* 2. ROE */}
                                        <div className="bg-white rounded shadow-sm border p-4 sm:p-6">
                                            <div className="flex justify-between items-start"><h3 className="font-bold text-base sm:text-lg text-slate-800">2. Return on Equity (ROE)</h3><HintBox id="roe"/></div>
                                            <div className="grid grid-cols-3 gap-2 sm:gap-4 mt-2">
                                                <div></div><div className="text-center font-bold text-slate-500 text-xs sm:text-sm">2022</div><div className="text-center font-bold text-slate-500 text-xs sm:text-sm">2021</div>
                                                <div className="font-medium text-xs sm:text-sm flex items-center">ROE (%)</div>
                                                <SmartInput id="roe_2022" value={currentInputs.roe_2022} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={currentData._DATA_MATRIX.roe_2022} teacherMode={teacherMode} placeholder="%" isPercentage={true} />
                                                <SmartInput id="roe_2021" value={currentInputs.roe_2021} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={currentData._DATA_MATRIX.roe_2021} teacherMode={teacherMode} placeholder="%" isPercentage={true} />
                                            </div>
                                        </div>

                                        {/* 3. DuPont */}
                                        <div className="bg-white rounded shadow-sm border p-4 sm:p-6">
                                            <div className="flex justify-between items-start"><h3 className="font-bold text-base sm:text-lg text-slate-800">3. DuPont Disaggregation</h3><HintBox id="dupont"/></div>
                                            <div className="grid grid-cols-3 gap-2 sm:gap-4 mt-2">
                                                <div className="font-medium text-xs sm:text-sm flex items-center">ROA (%)</div>
                                                <SmartInput id="roa_2022" value={currentInputs.roa_2022} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={currentData._DATA_MATRIX.roa_2022} teacherMode={teacherMode} placeholder="%" isPercentage={true} />
                                                <SmartInput id="roa_2021" value={currentInputs.roa_2021} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={currentData._DATA_MATRIX.roa_2021} teacherMode={teacherMode} placeholder="%" isPercentage={true} />
                                                
                                                <div className="font-medium text-xs sm:text-sm flex items-center">Fin. Lev</div>
                                                <SmartInput id="fl_2022" value={currentInputs.fl_2022} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={currentData._DATA_MATRIX.fl_2022} teacherMode={teacherMode} placeholder="x" />
                                                <SmartInput id="fl_2021" value={currentInputs.fl_2021} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={currentData._DATA_MATRIX.fl_2021} teacherMode={teacherMode} placeholder="x" />
                                                
                                                <div className="font-medium text-xs sm:text-sm flex items-center">NCIR</div>
                                                <SmartInput id="ncir_2022" value={currentInputs.ncir_2022} correctValue={currentData._DATA_MATRIX.ncir_2022} readOnly={true} teacherMode={teacherMode} />
                                                <SmartInput id="ncir_2021" value={currentInputs.ncir_2021} correctValue={currentData._DATA_MATRIX.ncir_2021} readOnly={true} teacherMode={teacherMode} />
                                            </div>
                                        </div>

                                        {/* 4. ROA Decomp */}
                                        <div className="bg-white rounded shadow-sm border p-4 sm:p-6">
                                            <div className="flex justify-between items-start"><h3 className="font-bold text-base sm:text-lg text-slate-800">4. ROA Decomposition</h3><HintBox id="roa_decomp"/></div>
                                            <div className="grid grid-cols-3 gap-2 sm:gap-4 mt-2">
                                                <div className="font-medium text-xs sm:text-sm flex items-center">PM (%)</div>
                                                <SmartInput id="pm_2022" value={currentInputs.pm_2022} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={currentData._DATA_MATRIX.pm_2022} teacherMode={teacherMode} placeholder="%" isPercentage={true} />
                                                <SmartInput id="pm_2021" value={currentInputs.pm_2021} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={currentData._DATA_MATRIX.pm_2021} teacherMode={teacherMode} placeholder="%" isPercentage={true} />
                                                
                                                <div className="font-medium text-xs sm:text-sm flex items-center">Asset T/O</div>
                                                <SmartInput id="at_2022" value={currentInputs.at_2022} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={currentData._DATA_MATRIX.at_2022} teacherMode={teacherMode} placeholder="x" />
                                                <SmartInput id="at_2021" value={currentInputs.at_2021} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={currentData._DATA_MATRIX.at_2021} teacherMode={teacherMode} placeholder="x" />
                                            </div>
                                        </div>

                                        {/* 4a. Classify */}
                                        <div className="bg-white rounded shadow-sm border p-4 sm:p-6">
                                            <h3 className="font-bold text-base sm:text-lg text-slate-800 mb-2">4a. Classify & Calculate NOA</h3>
                                            <p className="text-xs sm:text-sm text-slate-500 mb-4">Classify items to calculate NOA. Treat all "Other" items as Operating items.</p>
                                            <ClassificationTable 
                                                items={currentData.CLASSIFICATION_ITEMS} 
                                                selections={currentSelections} 
                                                onToggle={handleToggle} 
                                                teacherMode={teacherMode} 
                                            />
                                            <div className="p-4 bg-slate-50 border-t border-slate-200 rounded-b">
                                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6 pt-2">
                                                    <div>
                                                        <label className="text-xs font-bold text-slate-600 block mb-1">Calculate Average NOA</label>
                                                        <SmartInput id="avg_noa_2022" value={currentInputs.avg_noa_2022} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={currentData._DATA_MATRIX.avg_noa_2022} teacherMode={teacherMode} placeholder="(NOA22+NOA21)/2" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* 4b. NOPAT */}
                                        <div className="bg-white rounded shadow-sm border p-4 sm:p-6">
                                            <h3 className="font-bold text-base sm:text-lg text-slate-800 mb-4">4b. NOPAT Derivation (2022)</h3>
                                            <div className="space-y-6">
                                                <div className="bg-slate-50 p-3 sm:p-4 rounded border">
                                                    <h4 className="font-bold text-xs sm:text-sm text-slate-700 mb-2">Operating Income Approach</h4>
                                                    <div className="text-[10px] sm:text-xs text-slate-500 mb-2 font-mono">
                                                        Formula: Operating Income - Tax on Operating Profit <br/>
                                                        <span className="text-[9px] text-slate-400">where Tax on Operating Profit = Tax Expense + Tax Shield</span>
                                                    </div>
                                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-4">
                                                        <div className="text-xs sm:text-sm">NOPAT Calculation</div>
                                                        <SmartInput id="nopat_m2" value={currentInputs.nopat_m2} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={currentData._DATA_MATRIX.nopat_m2} teacherMode={teacherMode} placeholder="$" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* 5. RNOA Decomp */}
                                        <div className="bg-white rounded shadow-sm border p-4 sm:p-6 mb-6">
                                            <div className="flex justify-between items-start"><h3 className="font-bold text-base sm:text-lg text-slate-800">5. RNOA Decomposition</h3><HintBox id="rnoa_decomp"/></div>
                                            
                                            <div className="grid grid-cols-3 gap-2 sm:gap-4 mt-4">
                                                <div className="font-medium text-xs sm:text-sm flex items-center">RNOA (%)</div>
                                                <SmartInput id="rnoa_2022" value={currentInputs.rnoa_2022} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={currentData._DATA_MATRIX.rnoa_2022} teacherMode={teacherMode} placeholder="%" isPercentage={true} />
                                                <SmartInput id="rnoa_2021" value={currentInputs.rnoa_2021} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={currentData._DATA_MATRIX.rnoa_2021} teacherMode={teacherMode} placeholder="%" isPercentage={true} />

                                                <div className="font-medium text-xs sm:text-sm flex items-center">NOPM (%)</div>
                                                <SmartInput id="nopm_2022" value={currentInputs.nopm_2022} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={currentData._DATA_MATRIX.nopm_2022} teacherMode={teacherMode} placeholder="%" isPercentage={true} />
                                                <SmartInput id="nopm_2021" value={currentInputs.nopm_2021} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={currentData._DATA_MATRIX.nopm_2021} teacherMode={teacherMode} placeholder="%" isPercentage={true} />
                                                
                                                <div className="font-medium text-xs sm:text-sm flex items-center">NOAT</div>
                                                <SmartInput id="noat_2022" value={currentInputs.noat_2022} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={currentData._DATA_MATRIX.noat_2022} teacherMode={teacherMode} placeholder="x" />
                                                <SmartInput id="noat_2021" value={currentInputs.noat_2021} onChange={handleInputChange} activeInput={activeInput} setActiveInput={setActiveInput} correctValue={currentData._DATA_MATRIX.noat_2021} teacherMode={teacherMode} placeholder="x" />
                                            </div>
                                        </div>
                                    </>
                                ) : (
                                    /* INTERPRETATION TAB */
                                    <div className="space-y-6">
                                        <div className="bg-white rounded shadow-sm border p-4 sm:p-6">
                                            <h3 className="font-bold text-lg text-slate-800 mb-2">Interpretation & Analysis</h3>
                                            <p className="text-sm text-slate-600 mb-6">Answer the following questions based on your calculated ratios.</p>

                                            <div className="space-y-6">
                                                <div className="bg-slate-50 p-4 rounded border">
                                                    <h4 className="font-bold text-sm text-slate-800 mb-2">1. DuPont Analysis of ROE</h4>
                                                    <p className="text-xs text-slate-600 mb-3">Decompose the ROE (2022) into Profit Margin, Asset Turnover, and Financial Leverage. Which component is the strongest driver of ROE?</p>
                                                    <textarea 
                                                        className="w-full p-3 text-sm border rounded focus:ring-2 ring-blue-500 outline-none" 
                                                        rows="3" 
                                                        placeholder="Write your analysis here..."
                                                        value={currentInputs.q1 || ""}
                                                        onChange={(e) => handleInputChange('q1', e.target.value)}
                                                    ></textarea>
                                                    {teacherMode && currentData._INTERPRETATION && (
                                                        <div className="mt-3 p-3 bg-green-50 border border-green-200 rounded text-sm text-green-800 animate-fade-in">
                                                            <strong className="block mb-1 text-green-900">Teacher's Key:</strong>
                                                            {currentData._INTERPRETATION.q1}
                                                        </div>
                                                    )}
                                                </div>

                                                <div className="bg-slate-50 p-4 rounded border">
                                                    <h4 className="font-bold text-sm text-slate-800 mb-2">2. RNOA Drivers</h4>
                                                    <p className="text-xs text-slate-600 mb-3">Decompose RNOA (2022) into Net Operating Profit Margin (NOPM) and Net Operating Asset Turnover (NOAT). How does this compare to the standard ROA decomposition?</p>
                                                    <textarea 
                                                        className="w-full p-3 text-sm border rounded focus:ring-2 ring-blue-500 outline-none" 
                                                        rows="3" 
                                                        placeholder="Write your analysis here..."
                                                        value={currentInputs.q2 || ""}
                                                        onChange={(e) => handleInputChange('q2', e.target.value)}
                                                    ></textarea>
                                                    {teacherMode && currentData._INTERPRETATION && (
                                                        <div className="mt-3 p-3 bg-green-50 border border-green-200 rounded text-sm text-green-800 animate-fade-in">
                                                            <strong className="block mb-1 text-green-900">Teacher's Key:</strong>
                                                            {currentData._INTERPRETATION.q2}
                                                        </div>
                                                    )}
                                                </div>

                                                <div className="bg-slate-50 p-4 rounded border">
                                                    <h4 className="font-bold text-sm text-slate-800 mb-2">3. Operating vs. Total Efficiency</h4>
                                                    <p className="text-xs text-slate-600 mb-3">Compare the Net Operating Asset Turnover (NOAT) with the Total Asset Turnover (AT). What does the difference suggest about the efficiency of the company's operating assets versus its total asset base?</p>
                                                    <textarea 
                                                        className="w-full p-3 text-sm border rounded focus:ring-2 ring-blue-500 outline-none" 
                                                        rows="3" 
                                                        placeholder="Write your analysis here..."
                                                        value={currentInputs.q3 || ""}
                                                        onChange={(e) => handleInputChange('q3', e.target.value)}
                                                    ></textarea>
                                                    {teacherMode && currentData._INTERPRETATION && (
                                                        <div className="mt-3 p-3 bg-green-50 border border-green-200 rounded text-sm text-green-800 animate-fade-in">
                                                            <strong className="block mb-1 text-green-900">Teacher's Key:</strong>
                                                            {currentData._INTERPRETATION.q3}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {showNamePrompt && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 animate-fade-in backdrop-blur-sm p-4">
                            <div className="bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-sm">
                                <h3 className="text-xl font-bold text-slate-800 mb-4 text-center">Save Your Work</h3>
                                <input type="text" value={studentName} onChange={(e) => setStudentName(e.target.value)} placeholder="Your Full Name" className="w-full p-3 border border-slate-300 rounded-lg mb-4 text-center text-base" autoFocus />
                                <div className="flex flex-col gap-2">
                                    <button onClick={() => studentName.trim() ? generateDownload() : alert("Name required")} className="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">Download Answers</button>
                                    <button onClick={() => setShowNamePrompt(false)} className="w-full py-2 text-slate-500 hover:bg-slate-50 rounded-lg">Cancel</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showLogin && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 backdrop-blur-sm p-4">
                            <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-xs">
                                <h3 className="font-bold text-lg mb-4">Instructor Code</h3>
                                <input type="password" className="w-full border p-2 rounded mb-4 text-base" value={password} onChange={(e) => setPassword(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && checkPassword()} autoFocus />
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setShowLogin(false)} className="px-3 py-1 text-slate-500">Cancel</button>
                                    <button onClick={checkPassword} className="px-3 py-1 bg-blue-600 text-white rounded">Access</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
