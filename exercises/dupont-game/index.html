<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE SPREAD - Educational Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        
        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: #000;
            color: #fff;
            user-select: none;
            -webkit-user-select: none;
        }

        /* Marquee Animation */
        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        .animate-marquee {
            display: inline-block;
            white-space: nowrap;
            animation: marquee 20s linear infinite;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #000; 
        }
        ::-webkit-scrollbar-thumb {
            background: #333; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #db2777; 
        }

        /* Preview Ghosting Animation */
        .ghost-value {
            animation: pulse-ghost 1.5s infinite;
        }
        @keyframes pulse-ghost {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            TrendingUp, 
            TrendingDown, 
            DollarSign, 
            Activity, 
            AlertTriangle, 
            Skull, 
            Trophy, 
            Users, 
            ArrowRight, 
            ShieldAlert, 
            BarChart3, 
            Briefcase, 
            Landmark, 
            Wallet, 
            Send, 
            CheckCircle, 
            XCircle,
            Lock,
            RotateCcw,
            Eye,
            Calculator
        } from 'https://esm.sh/lucide-react@0.263.1';

        // --- CONFIGURATION ---
        const LEADERBOARD_URL = "https://script.google.com/macros/s/AKfycbz6fuOTfmtJx5pFeFQS_qTwrSkpaiIqaRB7ipqKsRejjZzXJv8f3-qYuxyvFMX6LNY/exec" 

        // --- DETERMINISTIC GAME DATA ---
        const FIXED_RATES = [0.04, 0.042, 0.065, 0.07, 0.07, 0.065, 0.06, 0.055, 0.05, 0.02];
        const FIXED_MARKET = [1.0, 1.1, 0.95, 0.95, 1.05, 0.85, 0.9, 0.8, 0.75, 0.6];

        const INITIAL_STATE = {
            cash: 50,
            debt: 100,
            operatingAssets: 200,
            equity: 150, 
            turn: 1,
            maxTurns: 10,
            history: [],
            isEliminated: false,
            eliminationReason: null,
            gameWon: false,
        };

        const SCENARIOS = [
            {
                id: 1,
                title: "The AI Pivot",
                description: "Omega Tech is lagging in AI. Engineers demand a massive compute cluster to train 'OmegaLLM'. It's expensive but necessary for future growth.",
                impact: "Massive NOA increase. RNOA will drop initially (lower Asset Turnover) before potential rebound.",
                company: "Internal Strategy",
                choices: [
                { 
                    label: "Issue Bonds to Build (Leverage Up)", 
                    cost: 100, 
                    assetGain: 120, 
                    revenueImpact: 1.4, 
                    risk: "high",
                    type: "debt",
                    rnoaEffect: "ðŸ“‰ Dip (Asset Bloat)",
                    nonOpEffect: "ðŸ“ˆ High Leverage (FLEV â†‘)" 
                },
                { 
                    label: "Partner with Cloud Provider (OpEx)", 
                    cost: 30, 
                    assetGain: 10, 
                    revenueImpact: 1.1, 
                    risk: "low",
                    type: "cash",
                    rnoaEffect: "âž¡ï¸ Stable (Low Asset Impact)",
                    nonOpEffect: "âž¡ï¸ Neutral" 
                }
                ]
            },
            {
                id: 2,
                title: "Supply Chain Fracture",
                description: "A geopolitical crisis in Asia has halted chip shipments. Competitors are out of stock. You can secure a strategic stockpile at a premium.",
                impact: "Increases NOA (Inventory). RNOA suffers (lower Turnover) unless margins expand significantly.",
                company: "Global Logistics",
                choices: [
                { 
                    label: "Corner the Market (Buy Inventory)", 
                    cost: 40, 
                    assetGain: 40, 
                    revenueImpact: 1.2, 
                    risk: "med",
                    type: "cash",
                    rnoaEffect: "ðŸ“‰ Lower Turnover",
                    nonOpEffect: "âž¡ï¸ Neutral"
                },
                { 
                    label: "Wait it out (Conserve Cash)", 
                    cost: 0, 
                    assetGain: -10, 
                    revenueImpact: 0.9, 
                    risk: "high",
                    type: "hold",
                    rnoaEffect: "ðŸ“‰ Drop (Revenue Loss)",
                    nonOpEffect: "âž¡ï¸ Neutral"
                }
                ]
            },
            {
                id: 3,
                title: "The Inflation Spike",
                description: "CPI hits 8%. The Fed responds aggressively. Interest rates on your variable debt are about to jump.",
                impact: "Increases Net Borrowing Cost. Directly reduces Spread and Non-Operating Return.",
                company: "Macro Economy",
                choices: [
                { 
                    label: "Deleverage Now (Pay Debt)", 
                    cost: 60, 
                    assetGain: -20, 
                    revenueImpact: 0.95, 
                    risk: "low",
                    type: "repay",
                    rnoaEffect: "ðŸ“ˆ Rise (Asset Lean)",
                    nonOpEffect: "ðŸ“‰ Lower Leverage (FLEV â†“)" 
                },
                { 
                    label: "Hedge with Derivatives", 
                    cost: 10, 
                    assetGain: 0, 
                    revenueImpact: 1.0, 
                    debtDetails: { amount: 0, rateDelta: -0.015 }, 
                    risk: "med",
                    type: "debt_only",
                    rnoaEffect: "âž¡ï¸ Neutral",
                    nonOpEffect: "ðŸ›¡ï¸ Protects Spread"
                }
                ]
            },
            {
                id: 4,
                title: "Antitrust Litigation",
                description: "Regulators sue Omega Tech for monopolistic app store practices. They demand a breakup or a massive fine.",
                impact: "Equity hit increases Leverage (FLEV). No gain to RNOA, increasing risk to Non-Operating Return.",
                company: "Legal Dept",
                choices: [
                { 
                    label: "Settle Immediately", 
                    cost: 30, 
                    assetGain: 0, 
                    revenueImpact: 1.0, 
                    risk: "safe",
                    type: "cash",
                    rnoaEffect: "âž¡ï¸ Neutral",
                    nonOpEffect: "âš ï¸ Equity Drop (FLEV â†‘)" 
                },
                { 
                    label: "Fight to the Death", 
                    cost: 5, 
                    assetGain: 0, 
                    revenueImpact: 1.0, 
                    randomOutcome: true, 
                    risk: "extreme",
                    type: "gamble",
                    rnoaEffect: "âž¡ï¸ Neutral",
                    nonOpEffect: "ðŸŽ² Volatile Equity"
                }
                ]
            },
            {
                id: 5,
                title: "Distressed Competitor",
                description: "Your rival 'AlphaCorp' is insolvent. Their IP and user base are for sale for pennies on the dollar.",
                impact: "Increases NOA cheaply. High potential to boost RNOA via improved Asset Turnover.",
                company: "M&A Opportunity",
                choices: [
                { 
                    label: "Acquire (Leveraged Buyout)", 
                    cost: 80, 
                    assetGain: 150, 
                    revenueImpact: 1.3, 
                    risk: "high",
                    type: "debt",
                    rnoaEffect: "ðŸ“ˆ High Potential (Turnover)",
                    nonOpEffect: "ðŸ“ˆ Max Leverage (High Risk)"
                },
                { 
                    label: "Pass", 
                    cost: 0, 
                    assetGain: 0, 
                    revenueImpact: 1.0, 
                    risk: "safe",
                    type: "hold",
                    rnoaEffect: "âž¡ï¸ Neutral",
                    nonOpEffect: "âž¡ï¸ Neutral"
                }
                ]
            },
            {
                id: 6,
                title: "Data Breach Scandal",
                description: "Hackers leaked user data. Advertisers are pulling out. Revenue efficiency is dropping.",
                impact: "Lower Efficiency reduces NOPAT. Direct negative impact on RNOA.",
                company: "Security Crisis",
                choices: [
                { 
                    label: "Massive PR & Security Overhaul", 
                    cost: 50, 
                    assetGain: 10, 
                    revenueImpact: 1.1, 
                    risk: "med",
                    type: "cash",
                    rnoaEffect: "ðŸ”„ Recovery (Long Term)",
                    nonOpEffect: "âž¡ï¸ Neutral"
                },
                { 
                    label: "Cover Up & Deny", 
                    cost: 5, 
                    assetGain: 0, 
                    revenueImpact: 0.8, 
                    risk: "high",
                    type: "hold",
                    rnoaEffect: "ðŸ“‰ Collapse (Revenue)",
                    nonOpEffect: "âž¡ï¸ Neutral" 
                }
                ]
            },
            {
                id: 7,
                title: "The Talent War",
                description: "Startups are poaching your best engineers. You need to raise salaries by 40% to retain talent.",
                impact: "Higher expenses reduce Margin. Direct negative impact on RNOA.",
                company: "HR Dept",
                choices: [
                { 
                    label: "Raise Salaries (Hit Margins)", 
                    cost: 20, 
                    assetGain: 0, 
                    revenueImpact: 1.05, 
                    risk: "safe",
                    type: "cash",
                    rnoaEffect: "ðŸ“‰ Margin Squeeze",
                    nonOpEffect: "âž¡ï¸ Neutral" 
                },
                { 
                    label: "Automate (CapEx instead of OpEx)", 
                    cost: 60, 
                    assetGain: 60, 
                    revenueImpact: 1.1, 
                    risk: "high",
                    type: "debt",
                    rnoaEffect: "ðŸ“‰ Asset Bloat",
                    nonOpEffect: "ðŸ“ˆ Leverage Increase" 
                }
                ]
            },
            {
                id: 8,
                title: "Currency Crash",
                description: "The dollar strengthens rapidly. Your overseas assets are worth 20% less in reporting currency.",
                impact: "Write-down lowers NOA. RNOA may artificially rise (denominator effect), but Equity drops.",
                company: "Treasury",
                choices: [
                { 
                    label: "Absorb the Loss", 
                    cost: 0, 
                    assetGain: -40, 
                    revenueImpact: 1.0, 
                    risk: "med",
                    type: "hold",
                    rnoaEffect: "ðŸ“ˆ Artificial Rise (NOA â†“)",
                    nonOpEffect: "âš ï¸ Equity Hit (FLEV â†‘)" 
                },
                { 
                    label: "Repatriate Cash (Tax Hit)", 
                    cost: 15, 
                    assetGain: 0, 
                    revenueImpact: 1.0, 
                    debtDetails: { amount: -20, rateDelta: 0 }, 
                    risk: "low",
                    type: "debt_only",
                    rnoaEffect: "âž¡ï¸ Neutral",
                    nonOpEffect: "ðŸ“‰ Lower Debt" 
                }
                ]
            },
            {
                id: 9,
                title: "Product Recall",
                description: "Your flagship device battery is exploding. Total recall required.",
                impact: "Inventory loss lowers NOA. Lower sales crush NOPAT. RNOA likely falls.",
                company: "Operations",
                choices: [
                { 
                    label: "Full Refund & Replace", 
                    cost: 60, 
                    assetGain: -20, 
                    revenueImpact: 1.0, 
                    risk: "high",
                    type: "cash",
                    rnoaEffect: "ðŸ“‰ Drop (Margin & Turnover)",
                    nonOpEffect: "âž¡ï¸ Neutral" 
                },
                { 
                    label: "Software Fix Patch", 
                    cost: 5, 
                    assetGain: 0, 
                    revenueImpact: 0.9, 
                    risk: "med",
                    type: "cash",
                    rnoaEffect: "ðŸ“‰ Slow Decay",
                    nonOpEffect: "âž¡ï¸ Neutral" 
                }
                ]
            },
            {
                id: 10,
                title: "Global Recession",
                description: "Demand is crashing worldwide. Cash is king. Survival is the only metric.",
                impact: "Revenue crash destroys NOPAT and RNOA. Non-Operating Return turns negative (Leverage penalty).",
                company: "Macro End-Game",
                choices: [
                { 
                    label: "Liquidation Mode (Sell Assets)", 
                    cost: 0, 
                    assetGain: -80, 
                    revenueImpact: 0.8, 
                    debtDetails: { amount: -50, rateDelta: 0 }, 
                    risk: "safe",
                    type: "debt_only",
                    rnoaEffect: "âš ï¸ Volatile",
                    nonOpEffect: "ðŸ“‰ De-Leverage (Safety)" 
                },
                { 
                    label: "Hold the Line", 
                    cost: 20, 
                    assetGain: 0, 
                    revenueImpact: 0.7, 
                    risk: "extreme", 
                    type: "cash",
                    rnoaEffect: "ðŸ“‰ Massive Drop",
                    nonOpEffect: "âš ï¸ High Leverage Risk" 
                }
                ]
            }
        ];

        // --- Helper Functions ---

        const calculateDupont = (state, baseRate = 0.05, marketCondition = 1.0) => {
            const NOA = state.operatingAssets;
            const NFO = state.debt;
            const Equity = state.equity; 
            const efficiency = 0.5 * marketCondition; 
            const Revenue = NOA * efficiency;
            const margin = 0.20; 
            const NOPAT = Revenue * margin; 
            const RNOA = NOA > 0 ? NOPAT / NOA : 0;
            const leverageRatio = Equity > 0 ? NFO / Equity : 100;
            const riskPremium = Math.max(0, (leverageRatio - 1) * 0.02); 
            const NBC = baseRate + riskPremium;
            const Spread = RNOA - NBC;
            const NonOperatingReturn = Spread * (Equity > 0 ? NFO / Equity : 0);
            const ROE = RNOA + NonOperatingReturn;

            return { NOA, NFO, Equity, NOPAT, RNOA, NBC, Spread, NonOperatingReturn, ROE, Revenue, leverageRatio, efficiency };
        };

        const getFundingLabel = (type) => {
            switch(type) {
                case 'cash': return 'Cash Reserves';
                case 'debt': return 'New Debt Issuance';
                case 'repay': return 'Debt Repayment';
                case 'debt_only': return 'Financial Structuring'; 
                case 'hold': return 'No Funding Needed';
                case 'gamble': return 'Legal Contingency Fund';
                default: return 'General Capital';
            }
        };

        const getFundingIcon = (type) => {
            switch(type) {
                case 'cash': return <Wallet size={14} className="text-green-400"/>;
                case 'debt': return <Landmark size={14} className="text-orange-400"/>;
                default: return <DollarSign size={14}/>;
            }
        }

        // --- Components ---

        const Card = ({ children, className = "" }) => (
            <div className={`bg-gray-900 border border-gray-700 rounded-lg p-4 shadow-xl ${className}`}>
                {children}
            </div>
        );

        // Modified Metric to support "Preview" Mode
        const Metric = ({ label, value, sub, color = "text-white", warning = false, previewValue = null }) => {
            // Determine if we are in preview mode for this specific metric
            const isPreview = previewValue !== null && previewValue !== undefined;
            
            // Format numbers for display if they are strings/numbers
            const displayValue = value; 
            const displayPreview = previewValue;

            // Determine delta color
            let deltaColor = "text-gray-400";
            let arrow = "";
            
            if (isPreview) {
                // Parse numbers to compare
                const valNum = parseFloat(value.replace(/[^0-9.-]+/g,""));
                const prevNum = parseFloat(previewValue.replace(/[^0-9.-]+/g,""));
                
                if (!isNaN(valNum) && !isNaN(prevNum)) {
                    if (prevNum > valNum) {
                        deltaColor = "text-green-400";
                        arrow = "â–²";
                    } else if (prevNum < valNum) {
                        deltaColor = "text-red-400";
                        arrow = "â–¼";
                    } else {
                        deltaColor = "text-gray-500";
                        arrow = "â€”";
                    }
                }
            }

            return (
                <div className="flex flex-col relative">
                    <span className="text-xs uppercase tracking-widest text-gray-500 font-bold">{label}</span>
                    <div className="flex items-center gap-2">
                        <span className={`text-2xl font-mono font-bold ${warning ? 'text-red-500 animate-pulse' : color} ${isPreview ? 'opacity-40' : 'opacity-100'} transition-all`}>
                            {displayValue}
                        </span>
                        
                        {/* Preview Overlay */}
                        {isPreview && (
                            <span className={`absolute left-0 top-6 text-2xl font-mono font-bold ghost-value ${deltaColor} bg-black/80 px-1 rounded`}>
                                {displayPreview}
                            </span>
                        )}
                    </div>

                    {isPreview ? (
                         <span className={`text-xs font-bold ${deltaColor} flex items-center gap-1`}>
                            {arrow} Projected
                         </span>
                    ) : (
                        sub && <span className="text-xs text-gray-400">{sub}</span>
                    )}
                </div>
            );
        };

        const ProgressBar = ({ value, max, label, color = "bg-pink-600", previewValue = null }) => {
            const width = Math.min((Math.abs(value)/max)*100, 100);
            const previewWidth = previewValue !== null ? Math.min((Math.abs(previewValue)/max)*100, 100) : null;

            return (
                <div className="w-full mb-2 relative">
                    {label && (
                        <div className="flex justify-between text-xs mb-1">
                        <span className="text-gray-400">{label}</span>
                        <span className="text-gray-400">{value.toFixed(1)}/{max}</span>
                        </div>
                    )}
                    <div className="h-2 w-full bg-gray-800 rounded-full overflow-hidden relative">
                        {/* Current Value Bar */}
                        <div 
                            className={`h-full ${color} transition-all duration-500 absolute top-0 left-0 ${previewWidth !== null ? 'opacity-30' : 'opacity-100'}`} 
                            style={{ width: `${width}%` }}
                        />
                        {/* Preview Value Bar (Ghost) */}
                        {previewWidth !== null && (
                            <div 
                                className={`h-full ${color} transition-all duration-300 absolute top-0 left-0 ghost-value`} 
                                style={{ width: `${previewWidth}%` }}
                            />
                        )}
                    </div>
                </div>
            );
        };

        // Component to show the math changing
        const ImpactAnalysis = ({ current, projected }) => {
            if (!projected) return null;

            const renderDiff = (label, currentVal, projectedVal, isPercentage = false, inverse = false) => {
                const diff = projectedVal - currentVal;
                const isPositive = diff > 0.001;
                const isNegative = diff < -0.001;
                const isNeutral = !isPositive && !isNegative;

                // Color logic: Usually higher is better (Green), unless 'inverse' (like Debt Cost) where lower is better
                let colorClass = "text-gray-500";
                if (isPositive) colorClass = inverse ? "text-red-400" : "text-green-400";
                if (isNegative) colorClass = inverse ? "text-green-400" : "text-red-400";
                
                const fmt = (n) => isPercentage ? (n*100).toFixed(2) + '%' : n.toFixed(1);

                return (
                    <div className="flex justify-between items-center text-xs py-1 border-b border-gray-800 last:border-0">
                        <span className="text-gray-400">{label}</span>
                        <div className="flex items-center gap-2">
                             <span className="text-gray-600 line-through decoration-pink-500/50">{fmt(currentVal)}</span>
                             <ArrowRight size={10} className="text-gray-600"/>
                             <span className={`font-bold ${colorClass}`}>{fmt(projectedVal)}</span>
                        </div>
                    </div>
                );
            };

            return (
                <div className="bg-gray-900 border border-gray-700 rounded-lg p-3 mt-4 animate-in fade-in slide-in-from-bottom-2">
                    <div className="flex items-center gap-2 mb-2 pb-2 border-b border-gray-700">
                        <Calculator size={14} className="text-pink-500"/>
                        <span className="text-xs font-bold uppercase text-white tracking-widest">Projection Analysis</span>
                    </div>
                    
                    <div className="space-y-1">
                        {renderDiff("Operating Assets (NOA)", current.NOA, projected.NOA)}
                        {renderDiff("Net Debt (NFO)", current.NFO, projected.NFO, false, true)}
                        {renderDiff("Asset Efficiency", current.efficiency, projected.efficiency, true)}
                        {renderDiff("RNOA (Operating)", current.RNOA, projected.RNOA, true)}
                        {renderDiff("Borrowing Cost (NBC)", current.NBC, projected.NBC, true, true)}
                        {renderDiff("Equity Multiplier (FLEV)", current.leverageRatio, projected.leverageRatio, false)}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [gameState, setGameState] = useState("menu"); 
            const [playerState, setPlayerState] = useState(INITIAL_STATE);
            const [historyStack, setHistoryStack] = useState([]); // STACK FOR UNDO
            const [playerName, setPlayerName] = useState("");
            
            // Market state
            const [marketRate, setMarketRate] = useState(FIXED_RATES[0]);
            const [marketCondition, setMarketCondition] = useState(FIXED_MARKET[0]);
            
            const [currentScenario, setCurrentScenario] = useState(null);
            const [logs, setLogs] = useState([]);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [submitStatus, setSubmitStatus] = useState(null);

            // Preview State
            const [hoveredChoice, setHoveredChoice] = useState(null);

            // Disable Right Click for Security
            useEffect(() => {
                const handleContextMenu = (e) => {
                    e.preventDefault();
                    return false;
                };
                document.addEventListener("contextmenu", handleContextMenu);
                return () => document.removeEventListener("contextmenu", handleContextMenu);
            }, []);

            // --- CALCULATIONS ---

            // Current Real Metrics
            const metrics = useMemo(() => {
                return calculateDupont(playerState, marketRate, marketCondition);
            }, [playerState, marketRate, marketCondition]);

            // Projected Metrics (Ghost State)
            const projectedMetrics = useMemo(() => {
                if (!hoveredChoice) return null;

                // 1. Create a deep copy of state to simulate change
                let simState = { ...playerState };
                const choice = hoveredChoice;

                // 2. Apply Logic (Mirrors handleDecision)
                if (choice.type === "cash") {
                    simState.cash -= choice.cost;
                    simState.operatingAssets += choice.assetGain;
                } else if (choice.type === "debt") {
                    // Net effect: Debt increases, Assets increase (Cash neutral: +Debt, -Cost)
                    simState.debt += choice.cost;
                    simState.operatingAssets += choice.assetGain;
                } else if (choice.type === "repay") {
                    simState.cash -= choice.cost;
                    simState.debt -= choice.cost;
                    simState.operatingAssets += choice.assetGain; 
                } else if (choice.type === "debt_only") {
                    simState.debt += choice.debtDetails.amount;
                    simState.cash += choice.debtDetails.amount; 
                }
                
                // Note: For "Gamble", we can't perfectly predict random, 
                // so we show the "Safe" path or Average outcome for the preview.
                if (choice.type === "gamble") {
                     simState.cash -= choice.cost;
                     // Show worst case in preview for safety? Or average? Let's show neutral/current to imply uncertainty.
                }

                // 3. Apply Revenue Impact 
                let simEfficiency = marketCondition;
                if (choice.revenueImpact) {
                    simEfficiency = simEfficiency * choice.revenueImpact;
                }
                
                // 4. Adjust rate 
                let simRate = marketRate;
                if (choice.type === 'debt_only' && choice.debtDetails?.rateDelta) {
                    simRate += choice.debtDetails.rateDelta;
                }

                // 5. Calculate Immediate Metric Shift
                const pMetrics = calculateDupont(simState, simRate, simEfficiency);
                
                // 6. Calculate Net Income Impact (to show Equity shift)
                const netIncome = pMetrics.NOPAT - (pMetrics.NFO * pMetrics.NBC);
                simState.equity += netIncome; // Add income to equity for the projection

                // Re-calculate final metrics with new equity
                return calculateDupont(simState, simRate, simEfficiency);

            }, [hoveredChoice, playerState, marketRate, marketCondition]);


            // --- ACTIONS ---

            const startGame = () => {
                if (!playerName) return;
                setPlayerState(INITIAL_STATE);
                setHistoryStack([]); // Clear history
                setGameState("playing");
                setSubmitStatus(null);
                setLogs(["Game Started. Role: CFO of Omega Tech."]);
                nextTurn(1);
            };

            const undoTurn = () => {
                if (historyStack.length === 0) return;

                // Pop the last state
                const previousEntry = historyStack[historyStack.length - 1];
                const newStack = historyStack.slice(0, -1);
                
                // Restore State
                setPlayerState(previousEntry.state);
                setLogs(previousEntry.logs);
                setHistoryStack(newStack);

                // Recalculate Environment (Market Rates/Scenario) based on the restored Turn
                nextTurn(previousEntry.state.turn);
            };

            const submitToLeaderboard = async (status) => {
                if(!LEADERBOARD_URL || LEADERBOARD_URL.includes("PASTE_YOUR")) {
                    alert("Leaderboard URL not configured in code.");
                    return;
                }
                setIsSubmitting(true);
                const payload = {
                    name: playerName,
                    status: status, 
                    equity: playerState.equity.toFixed(2),
                    roe: (metrics.ROE * 100).toFixed(2) + "%",
                    turn: playerState.turn
                };
                try {
                    await fetch(LEADERBOARD_URL, {
                        method: "POST",
                        mode: "no-cors", 
                        headers: { "Content-Type": "text/plain" },
                        body: JSON.stringify(payload),
                    });
                    setSubmitStatus('success');
                } catch (error) {
                    console.error("Submission error", error);
                    setSubmitStatus('error');
                } finally {
                    setIsSubmitting(false);
                }
            };

            const nextTurn = (turnNum) => {
                if (turnNum > 10) {
                    setGameState("win");
                    return;
                }
                const scenarioIdx = (turnNum - 1) % SCENARIOS.length;
                setCurrentScenario(SCENARIOS[scenarioIdx]);

                const arrayIndex = turnNum - 1; 
                if (arrayIndex < FIXED_RATES.length) {
                    setMarketRate(FIXED_RATES[arrayIndex]);
                    setMarketCondition(FIXED_MARKET[arrayIndex]);
                }
            };

            const handleDecision = (choice) => {
                // 1. SAVE HISTORY FOR UNDO
                setHistoryStack(prev => [...prev, {
                    state: JSON.parse(JSON.stringify(playerState)),
                    logs: [...logs]
                }]);

                // 2. PROCESS TURN
                let newState = { ...playerState };
                let logMsg = `Turn ${newState.turn}: Selected ${choice.label}.`;
                
                if (choice.type === "cash") {
                    if (newState.cash < choice.cost) {
                        setLogs(prev => [`Insufficient Cash for ${choice.label}!`, ...prev]);
                        // Remove the history entry we just added because move failed
                        setHistoryStack(prev => prev.slice(0, -1));
                        return; 
                    }
                    newState.cash -= choice.cost;
                    newState.operatingAssets += choice.assetGain;
                } else if (choice.type === "debt") {
                    newState.cash += choice.cost; 
                    newState.debt += choice.cost;
                    newState.cash -= choice.cost;
                    newState.operatingAssets += choice.assetGain;
                } else if (choice.type === "repay") {
                    newState.cash -= choice.cost;
                    newState.debt -= choice.cost;
                    newState.operatingAssets += choice.assetGain; 
                } else if (choice.type === "debt_only") {
                    newState.debt += choice.debtDetails.amount;
                    newState.cash += choice.debtDetails.amount; 
                } else if (choice.type === "gamble") {
                    newState.cash -= choice.cost;
                    if (Math.random() > 0.5) {
                        logMsg += " SUCCESS! Case Dismissed.";
                        newState.equity += 20; 
                    } else {
                        logMsg += " FAILURE. Massive fine levied.";
                        newState.cash -= 60;
                        newState.equity -= 60;
                    }
                }

                let currentEfficiency = marketCondition;
                if (choice.revenueImpact) {
                    currentEfficiency = currentEfficiency * choice.revenueImpact;
                }
                
                let effectiveRate = marketRate;
                if (choice.type === 'debt_only' && choice.debtDetails?.rateDelta) {
                    effectiveRate += choice.debtDetails.rateDelta;
                }

                const periodMetrics = calculateDupont(newState, effectiveRate, currentEfficiency);
                const netIncome = periodMetrics.NOPAT - (periodMetrics.NFO * periodMetrics.NBC);
                
                newState.cash += netIncome;
                newState.equity += netIncome; 

                if (newState.equity <= 0) {
                    setGameState("eliminated");
                    setPlayerState({ ...newState, eliminationReason: "INSOLVENCY (Equity < 0)" });
                    return;
                }
                if (newState.cash < 0) {
                    logMsg += " Cash negative! Forced asset sale.";
                    newState.operatingAssets -= 50;
                    newState.cash += 40; 
                    if (newState.operatingAssets < 0) {
                        setGameState("eliminated");
                        setPlayerState({ ...newState, eliminationReason: "BANKRUPTCY (No Assets)" });
                        return;
                    }
                }
                
                newState.turn += 1;
                newState.history.push({
                    turn: newState.turn - 1,
                    roe: periodMetrics.ROE,
                    spread: periodMetrics.Spread,
                    equity: newState.equity
                });
                
                setPlayerState(newState);
                setLogs(prev => [logMsg, ...prev]);
                nextTurn(newState.turn);
                setHoveredChoice(null); // Clear preview
            };

            // --- VIEWS ---

            if (gameState === "menu") {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-4 relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-pink-600 to-green-500"></div>
                        <div className="absolute -left-20 top-20 w-64 h-64 bg-pink-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse"></div>
                        <div className="absolute -right-20 bottom-20 w-64 h-64 bg-green-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse"></div>

                        <div className="max-w-md w-full z-10 text-center space-y-8">
                            <div className="flex justify-center mb-6">
                                <div className="relative">
                                    <ShieldAlert size={80} className="text-pink-600" />
                                    <DollarSign size={32} className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-white" />
                                </div>
                            </div>
                        
                        <div>
                            <h1 className="text-5xl font-black tracking-tighter mb-2">THE SPREAD</h1>
                            <p className="text-gray-400 text-sm uppercase tracking-widest">Dupont Survival Simulator (EDU)</p>
                        </div>

                        <div className="bg-gray-900 border border-gray-800 p-6 rounded-xl text-left space-y-4 shadow-2xl">
                            <h2 className="text-xl font-bold text-pink-500 flex items-center gap-2 mb-2">
                            <AlertTriangle size={20}/> WAIVER FORM
                            </h2>
                            <div className="bg-black/50 p-2 mb-4 rounded border border-gray-700 flex items-center gap-2">
                                <Briefcase size={16} className="text-blue-400"/>
                                <span className="text-sm font-bold text-gray-200">ROLE ASSIGNED: CFO, OMEGA TECH</span>
                            </div>
                            <p className="text-sm text-gray-300">
                            I, the undersigned, agree to participate in The Spread. I understand that:
                            </p>
                            <ul className="text-sm text-gray-400 list-disc list-inside space-y-1">
                            <li>My goal is to maximize <span className="text-green-400 font-bold">ROE</span>.</li>
                            <li>I must maintain a positive <span className="text-white font-bold">Spread</span>.</li>
                            <li>If my Equity hits zero, I am <span className="text-pink-500 font-bold">ELIMINATED</span>.</li>
                            </ul>
                            
                            <input 
                            type="text" 
                            placeholder="Enter Player Name (e.g. Player 456)" 
                            className="w-full bg-black border border-gray-700 p-3 rounded text-white focus:outline-none focus:border-pink-500 transition-colors mt-4"
                            value={playerName}
                            onChange={(e) => setPlayerName(e.target.value)}
                            />
                        </div>

                        <button 
                            onClick={startGame}
                            disabled={!playerName}
                            className={`w-full py-4 text-xl font-bold uppercase tracking-widest transition-all duration-300 transform hover:scale-105 ${
                            playerName 
                            ? "bg-gradient-to-r from-pink-600 to-pink-700 text-white shadow-[0_0_20px_rgba(219,39,119,0.5)]" 
                            : "bg-gray-800 text-gray-500 cursor-not-allowed"
                            }`}
                        >
                            Join Game
                        </button>
                        </div>
                    </div>
                );
            }

            if (gameState === "eliminated") {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-4">
                        <Skull size={100} className="text-pink-600 mb-6 animate-bounce" />
                        <h1 className="text-6xl font-black text-pink-600 mb-2">ELIMINATED</h1>
                        <p className="text-2xl text-gray-400 mb-8">Player: {playerName}</p>
                        
                        <div className="bg-gray-900 p-6 rounded border border-red-900 max-w-md w-full text-center">
                            <h3 className="text-red-500 font-bold uppercase mb-2">Cause of Death</h3>
                            <p className="text-xl">{playerState.eliminationReason}</p>
                            <div className="mt-4 pt-4 border-t border-gray-800 grid grid-cols-2 gap-4">
                                <Metric label="Final Equity" value={playerState.equity.toFixed(1)} color="text-red-400" />
                                <Metric label="Last Spread" value={(playerState.history[playerState.history.length-1]?.spread * 100).toFixed(2) + "%"} color="text-gray-400" />
                            </div>
                            
                            <div className="mt-6 pt-4 border-t border-gray-800">
                                {!submitStatus ? (
                                    <button 
                                        onClick={() => submitToLeaderboard("Eliminated")}
                                        disabled={isSubmitting}
                                        className="w-full py-3 bg-gray-800 hover:bg-gray-700 flex items-center justify-center gap-2 text-white rounded transition-colors"
                                    >
                                        {isSubmitting ? "Sending..." : <><Send size={16}/> Submit Final Score</>}
                                    </button>
                                ) : (
                                    <div className="flex items-center justify-center gap-2 text-green-400 py-2">
                                        <CheckCircle size={18} /> Score Submitted
                                    </div>
                                )}
                            </div>
                        </div>

                        <button 
                            onClick={() => setGameState("menu")}
                            className="mt-8 px-8 py-3 bg-gray-800 hover:bg-gray-700 text-white rounded uppercase tracking-widest transition-colors"
                        >
                            Try Again
                        </button>
                    </div>
                );
            }

            if (gameState === "win") {
                const finalEquity = playerState.equity.toFixed(1);
                const avgRoe = (playerState.history.reduce((a, b) => a + b.roe, 0) / playerState.history.length * 100).toFixed(1);
                
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-4">
                        <Trophy size={80} className="text-yellow-400 mb-6 animate-pulse" />
                        <h1 className="text-5xl font-black text-white mb-2">SURVIVOR</h1>
                        <p className="text-green-400 text-xl mb-8">You mastered the Spread.</p>
                        
                        <div className="grid grid-cols-2 gap-4 w-full max-w-md mb-8">
                            <Card className="text-center bg-black border-yellow-600">
                                <div className="text-gray-400 text-xs uppercase">Final Equity</div>
                                <div className="text-3xl text-yellow-400 font-bold">${finalEquity}M</div>
                            </Card>
                            <Card className="text-center bg-black border-green-600">
                                <div className="text-gray-400 text-xs uppercase">Avg ROE</div>
                                <div className="text-3xl text-green-400 font-bold">{avgRoe}%</div>
                            </Card>
                        </div>

                        <div className="w-full max-w-md mb-8">
                            {!submitStatus ? (
                                <button 
                                    onClick={() => submitToLeaderboard("Survivor")}
                                    disabled={isSubmitting}
                                    className="w-full py-4 bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 text-white font-bold rounded shadow-lg flex items-center justify-center gap-2 transform transition-transform hover:scale-105"
                                >
                                    {isSubmitting ? "Transmitting..." : <><Send size={20}/> Submit to Class Leaderboard</>}
                                </button>
                            ) : (
                                <div className="w-full py-4 bg-gray-800 border border-green-500 text-green-400 font-bold rounded flex items-center justify-center gap-2">
                                    <CheckCircle size={20} /> Data Transmitted Successfully
                                </div>
                            )}
                        </div>

                        <button 
                            onClick={() => setGameState("menu")}
                            className="mt-8 px-8 py-3 bg-green-600 hover:bg-green-700 text-white rounded uppercase tracking-widest shadow-lg"
                        >
                            Play Again
                        </button>
                    </div>
                );
            }

            const isDanger = metrics.Spread < 0;
            const isCritical = metrics.Equity < 50;

            return (
                <div className="min-h-screen flex flex-col md:flex-row">
                    {/* LEFT: DASHBOARD */}
                    <div className="w-full md:w-1/3 p-4 md:p-6 bg-black border-b md:border-r border-gray-800 flex flex-col gap-6 overflow-y-auto">
                        
                        {/* Header */}
                        <div className="flex justify-between items-center">
                            <div>
                                <h2 className="text-pink-600 font-black text-xl tracking-tighter">CFO: {playerName}</h2>
                                <span className="text-xs text-gray-500">TURN {playerState.turn} / {playerState.maxTurns}</span>
                            </div>
                            
                            <div className="flex gap-2">
                                <button 
                                    onClick={undoTurn} 
                                    disabled={historyStack.length === 0}
                                    className={`p-2 rounded border transition-colors flex items-center gap-1 ${historyStack.length === 0 ? 'border-gray-800 text-gray-700 cursor-not-allowed' : 'border-blue-700 text-blue-400 hover:bg-blue-900/50'}`}
                                    title="Undo Last Decision"
                                >
                                    <RotateCcw size={16} /> 
                                    <span className="text-xs font-bold hidden md:inline">UNDO</span>
                                </button>
                                <div className="bg-gray-900 px-3 py-1 rounded border border-gray-700 flex items-center gap-2">
                                    <div className={`w-2 h-2 rounded-full ${isDanger ? 'bg-red-500 animate-pulse' : 'bg-green-500'}`}></div>
                                    <span className="text-xs font-bold">{isDanger ? "NEG SPREAD" : "STABLE"}</span>
                                </div>
                            </div>
                        </div>

                        {/* Primary Metrics */}
                        <div className="grid grid-cols-2 gap-4">
                            <Card className="border-pink-900/50 bg-pink-900/10">
                                <Metric 
                                    label="ROE (Goal)" 
                                    value={`${(metrics.ROE * 100).toFixed(2)}%`} 
                                    previewValue={projectedMetrics ? `${(projectedMetrics.ROE * 100).toFixed(2)}%` : null}
                                    color={metrics.ROE > 0.15 ? "text-pink-400" : "text-white"}
                                />
                            </Card>
                            <Card className="border-green-900/50 bg-green-900/10">
                                <Metric 
                                    label="Equity (Life)" 
                                    value={`$${metrics.Equity.toFixed(1)}M`} 
                                    previewValue={projectedMetrics ? `$${projectedMetrics.Equity.toFixed(1)}M` : null}
                                    color={metrics.Equity < 50 ? "text-red-500" : "text-green-400"}
                                    warning={isCritical}
                                />
                            </Card>
                        </div>

                        {/* The Dupont Tree Visualization */}
                        <div className="space-y-4">
                            <div className="bg-gray-900 p-2 rounded mb-2 text-center border border-gray-700">
                            <span className="text-[10px] text-gray-500 uppercase tracking-widest">Dupont Identity</span>
                            <div className="flex justify-center items-center gap-2 text-sm font-bold mt-1">
                                <span className="text-pink-400">ROE</span>
                                <span className="text-gray-500">=</span>
                                <span className="text-blue-400">RNOA</span>
                                <span className="text-gray-500">+</span>
                                <span className="text-green-400">Non-Op Return</span>
                            </div>
                            </div>
                            
                            {/* RNOA Section */}
                            <div className="space-y-1">
                                <div className="flex justify-between items-end">
                                    <span className="text-sm text-blue-300">RNOA (Operating)</span>
                                    <div className="flex flex-col items-end">
                                        <span className="text-xl font-bold text-blue-400">{(metrics.RNOA * 100).toFixed(2)}%</span>
                                    </div>
                                </div>
                                
                                <ProgressBar 
                                    value={metrics.RNOA * 100} 
                                    previewValue={projectedMetrics ? projectedMetrics.RNOA * 100 : null}
                                    max={20} 
                                    label="" 
                                    color="bg-blue-500" 
                                />
                            </div>

                            {/* Non-Operating Return Section */}
                            <div className="space-y-1 mt-4">
                                <div className="flex justify-between items-end">
                                    <span className="text-sm text-green-300">Non-Operating Return</span>
                                    <span className={`text-xl font-bold ${metrics.NonOperatingReturn > 0 ? 'text-green-400' : 'text-red-500'}`}>
                                        {(metrics.NonOperatingReturn * 100).toFixed(2)}%
                                    </span>
                                </div>
                                <div className="flex justify-between text-xs text-gray-500 mb-1">
                                    <span>FLEV: {metrics.leverageRatio.toFixed(2)}x</span>
                                    <span>Spread: {(metrics.Spread * 100).toFixed(2)}%</span>
                                </div>
                                <ProgressBar 
                                    value={metrics.NonOperatingReturn * 100} 
                                    previewValue={projectedMetrics ? projectedMetrics.NonOperatingReturn * 100 : null}
                                    max={10} 
                                    label="" 
                                    color={metrics.NonOperatingReturn > 0 ? "bg-green-500" : "bg-red-500"} 
                                />
                            </div>
                        </div>

                         {/* DYNAMIC IMPACT ANALYSIS */}
                         <ImpactAnalysis current={metrics} projected={projectedMetrics} />

                        {/* Resources */}
                        <div className="grid grid-cols-2 gap-4 mt-auto">
                            <div className="flex items-center gap-2 text-sm text-gray-400">
                                <DollarSign size={16} /> Cash: ${playerState.cash.toFixed(1)}
                            </div>
                            <div className="flex items-center gap-2 text-sm text-gray-400">
                                <BarChart3 size={16} /> Assets: ${playerState.operatingAssets.toFixed(1)}
                            </div>
                        </div>
                    </div>

                    {/* RIGHT: GAMEPLAY AREA */}
                    <div className="w-full md:w-2/3 p-4 md:p-8 flex flex-col relative">
                        
                        {/* Market News Ticker */}
                        <div className="absolute top-0 left-0 w-full bg-pink-900/20 border-b border-pink-900/50 p-2 overflow-hidden flex z-10">
                            <div className="animate-marquee text-pink-400 text-xs font-bold tracking-widest">
                                MARKET UPDATE: INTEREST RATES {(marketRate * 100).toFixed(2)}% /// SECTOR DEMAND: {(marketCondition * 100).toFixed(0)}% /// SURVIVE THE SPREAD /// DO NOT INSOLVE
                            </div>
                        </div>

                        {/* Scenario Card */}
                        <div className="mt-8 flex-grow flex flex-col justify-center max-w-2xl mx-auto w-full">
                            <div className="mb-6">
                                <h3 className="text-pink-500 font-bold uppercase tracking-widest mb-1 flex items-center gap-2">
                                    <Activity size={18}/> Current Scenario
                                </h3>
                                <h2 className="text-3xl font-bold text-white mb-2">{currentScenario?.title}</h2>
                                <div className="flex items-center gap-2 mb-4 text-xs font-bold text-gray-500 uppercase tracking-wider">
                                    <Briefcase size={12} /> Source: {currentScenario?.company}
                                </div>
                                <p className="text-gray-300 text-lg leading-relaxed border-l-4 border-pink-600 pl-4 bg-gray-900/50 py-2">
                                    {currentScenario?.description}
                                </p>
                                <div className="mt-2 text-sm text-blue-400 font-bold flex items-center gap-2">
                                    <TrendingUp size={14}/> Impact: {currentScenario?.impact}
                                </div>
                            </div>

                            {/* Decisions */}
                            <div className="grid gap-4">
                                {currentScenario?.choices.map((choice, idx) => (
                                    <button
                                        key={idx}
                                        onMouseEnter={() => setHoveredChoice(choice)}
                                        onMouseLeave={() => setHoveredChoice(null)}
                                        onClick={() => handleDecision(choice)}
                                        className="group relative overflow-hidden bg-gray-900 border border-gray-700 hover:border-pink-500 p-6 rounded-xl text-left transition-all duration-300 hover:transform hover:translate-x-1 hover:shadow-[0_0_15px_rgba(236,72,153,0.3)]"
                                    >
                                        <div className="flex justify-between items-start mb-2">
                                            <span className="font-bold text-lg text-white group-hover:text-pink-400 transition-colors">
                                                {choice.label}
                                            </span>
                                            <span className={`text-xs px-2 py-1 rounded uppercase font-bold ${
                                                choice.risk === 'high' ? 'bg-red-900 text-red-300' :
                                                choice.risk === 'safe' ? 'bg-green-900 text-green-300' :
                                                choice.risk === 'extreme' ? 'bg-purple-900 text-purple-300' :
                                                'bg-yellow-900 text-yellow-300'
                                            }`}>
                                                {choice.risk} Risk
                                            </span>
                                        </div>
                                        <div className="flex gap-4 text-xs text-gray-500 font-mono items-center">
                                            <span>COST: ${choice.cost}M</span>
                                            <span>ASSETS: {choice.assetGain > 0 ? '+' : ''}{choice.assetGain}M</span>
                                            
                                            <div className="flex items-center gap-1 ml-auto border-l border-gray-700 pl-4">
                                                {getFundingIcon(choice.type)}
                                                <span className={choice.type === 'debt' ? 'text-orange-300' : choice.type === 'cash' ? 'text-green-300' : 'text-gray-400'}>
                                                    {getFundingLabel(choice.type)}
                                                </span>
                                            </div>
                                        </div>

                                        {/* PROJECTED IMPACTS */}
                                        <div className="mt-3 pt-3 border-t border-gray-800 grid grid-cols-2 gap-4">
                                        <div className="flex flex-col">
                                            <span className="text-[10px] uppercase text-gray-500 font-bold mb-1">RNOA Impact</span>
                                            <span className="text-xs font-bold text-blue-300">{choice.rnoaEffect}</span>
                                        </div>
                                        <div className="flex flex-col">
                                            <span className="text-[10px] uppercase text-gray-500 font-bold mb-1">Non-Op Impact</span>
                                            <span className="text-xs font-bold text-green-300">{choice.nonOpEffect}</span>
                                        </div>
                                        </div>

                                        <div className="absolute right-4 bottom-4 opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1 text-pink-500 text-xs font-bold">
                                            <Eye size={12} /> PREVIEW
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Action Log */}
                        <div className="mt-8 h-32 overflow-y-auto bg-black border border-gray-800 rounded p-4 font-mono text-xs text-gray-400">
                            {logs.map((log, i) => (
                                <div key={i} className="mb-1 border-b border-gray-900 pb-1">
                                    <span className="text-pink-800 mr-2">[{new Date().toLocaleTimeString()}]</span>
                                    {log}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>