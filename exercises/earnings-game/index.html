<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE EARNINGS TRAP | CFO EDITION</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@500;600;700&family=Playfair+Display:wght@700;900&family=Orbitron:wght@900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #050505;
            --panel-bg: #111111;
            --neon-blue: #00f3ff;
            --neon-green: #00ff41;
            --neon-red: #ff003c;
            --neon-gold: #ffd700;
            --paper: #f0f0e0;
        }
        body {
            font-family: 'Rajdhani', sans-serif;
            background-color: var(--bg-dark);
            color: #ccc;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .font-cyber { font-family: 'Orbitron', sans-serif; }
        .font-mono { font-family: 'Share Tech Mono', monospace; }
        .font-paper { font-family: 'Playfair Display', serif; }

        /* SCROLLBARS */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* LANDING PAGE */
        .skyline-bg {
            background-image: 
                linear-gradient(to bottom, rgba(5,5,5,0.3), rgba(5,5,5,1)),
                url('https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
        }

        /* LAYOUT UTILS */
        .panel-header {
            padding: 10px 14px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            font-weight: 700;
            font-size: 0.85rem;
            letter-spacing: 0.05em;
            color: #888;
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* TACTICS UI */
        .tactic-card {
            background: #0f0f0f;
            border-bottom: 1px solid #222;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        .tactic-card:hover { background: #181818; }
        .tactic-card.active {
            background: #1a1a1a;
            border-left: 3px solid var(--neon-blue);
        }
        .tag {
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .tag-fraud { color: var(--neon-red); border: 1px solid rgba(255, 0, 60, 0.3); background: rgba(255, 0, 60, 0.05); }
        .tag-gray { color: var(--neon-gold); border: 1px solid rgba(255, 215, 0, 0.3); background: rgba(255, 215, 0, 0.05); }
        .tag-ops { color: #888; border: 1px solid #444; background: #222; }
        .tag-safe { color: var(--neon-green); border: 1px solid rgba(0, 255, 65, 0.3); background: rgba(0, 255, 65, 0.05); }

        /* FINANCIAL TABLE */
        .fin-table td { padding: 6px 12px; font-family: 'Share Tech Mono', monospace; font-size: 0.95rem; }
        .fin-row-main { border-bottom: 1px solid #222; }
        .val-changed { color: var(--neon-blue); font-weight: bold; }
        .pro-forma-box {
            background: linear-gradient(45deg, rgba(255,215,0,0.05) 0%, transparent 100%);
            border: 1px dashed #444;
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
        }

        /* CHAT & AVATARS */
        .chat-bubble {
            margin-bottom: 10px;
            padding: 10px;
            background: #161616;
            border-radius: 0 8px 8px 8px;
            border-left: 2px solid #333;
            font-size: 0.85rem;
            line-height: 1.5;
            position: relative;
        }
        .avatar-circle {
            width: 32px; height: 32px;
            border-radius: 50%;
            background: #222;
            border: 1px solid #444;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        /* NEWS MODAL (Paper Style) */
        .newspaper-modal {
            background-color: var(--paper); /* #f0f0e0 */
            color: #000000;
            box-shadow: 0 0 60px rgba(0,0,0,0.9);
            border: 4px double #222;
            font-family: 'Playfair Display', serif;
            transform: rotate(1deg);
        }
        .newspaper-modal:hover { transform: rotate(0deg); transition: transform 0.3s; }

        /* TICKER ANIMATION */
        @keyframes ticker {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        .ticker-wrap {
            overflow: hidden;
            white-space: nowrap;
            background: #000;
            border-top: 1px solid #333;
        }
        .ticker-move {
            display: inline-block;
            animation: ticker 60s linear infinite; /* Slower 60s */
            padding-left: 100%;
        }
        .ticker-item {
            display: inline-block;
            padding: 0 2rem;
            font-family: 'Share Tech Mono', monospace;
            color: #999;
            font-size: 0.9rem;
            font-weight: 700; /* Bolded */
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 60, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 0, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 60, 0); }
        }
        .animate-risk { animation: pulse-red 2s infinite; }
        
        .modal-enter { animation: modalIn 0.3s ease-out forwards; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="flex flex-col text-sm">

    <!-- LANDING PAGE -->
    <section id="landing-page" class="absolute inset-0 z-[100] skyline-bg flex flex-col items-center justify-center p-6">
        <div class="bg-black/95 backdrop-blur-xl p-10 md:p-16 rounded-sm max-w-5xl w-full border border-gray-700 text-center shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-600 via-purple-600 to-red-600"></div>
            
            <h1 class="text-6xl md:text-8xl font-cyber font-black text-white mb-2 tracking-tighter">
                THE EARNINGS <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-purple-500">TRAP</span>
            </h1>
            <p class="text-xl md:text-2xl text-gray-500 font-mono tracking-[0.2em] mb-12 uppercase">Financial Engineering Simulator v3.3</p>
            
            <div class="grid md:grid-cols-3 gap-8 text-left mb-12 max-w-4xl mx-auto">
                <div class="p-6 bg-[#111] border border-gray-800 hover:border-blue-500 transition duration-300 group">
                    <div class="text-3xl mb-4 group-hover:scale-110 transition duration-300">üëî</div>
                    <h3 class="text-white font-bold text-lg mb-2 font-mono">THE MANDATE</h3>
                    <p class="text-gray-400 text-sm leading-relaxed">Analysts demand growth. If GAAP numbers don't work, use "Non-GAAP" magic. Just don't get caught.</p>
                </div>
                <div class="p-6 bg-[#111] border border-gray-800 hover:border-yellow-500 transition duration-300 group">
                    <div class="text-3xl mb-4 group-hover:scale-110 transition duration-300">üìâ</div>
                    <h3 class="text-white font-bold text-lg mb-2 font-mono">THE GRAY ZONE</h3>
                    <p class="text-gray-400 text-sm leading-relaxed">Use levers like Overproduction, Channel Stuffing, and Restructuring. Legal? Mostly. Ethical? Rarely.</p>
                </div>
                <div class="p-6 bg-[#111] border border-gray-800 hover:border-red-500 transition duration-300 group">
                    <div class="text-3xl mb-4 group-hover:scale-110 transition duration-300">‚öñÔ∏è</div>
                    <h3 class="text-white font-bold text-lg mb-2 font-mono">THE AUDIT</h3>
                    <p class="text-gray-400 text-sm leading-relaxed">Survive 6 quarters. Keep Audit Risk low. If risk spikes, the SEC investigates and it's Game Over.</p>
                </div>
            </div>

            <button onclick="game.startGame()" class="group relative px-16 py-6 bg-white text-black font-black font-cyber text-2xl tracking-widest hover:bg-gray-200 transition-all shadow-[0_0_40px_rgba(255,255,255,0.3)]">
                ENTER BOARDROOM
            </button>
        </div>
    </section>

    <!-- HEADER -->
    <header class="h-16 bg-[#080808] border-b border-gray-800 flex items-center justify-between px-6 shrink-0 z-20">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-blue-900/30 border border-blue-500/50 rounded flex items-center justify-center text-xl">üë®‚Äçüíº</div>
            <div>
                <div class="font-bold text-white tracking-widest leading-none">CFO OFFICE</div>
                <div class="text-[10px] text-gray-500 font-mono mt-1">STATUS: <span class="text-green-500">ACTIVE</span></div>
            </div>
        </div>
        
        <div class="flex gap-12 font-mono">
            <div class="text-center">
                <div class="text-[10px] text-gray-600 uppercase">Stock Price</div>
                <div id="stock-price" class="text-xl text-white font-bold">$25.00</div>
            </div>
            <div class="text-center">
                <div class="text-[10px] text-gray-600 uppercase">Audit Risk</div>
                <div id="risk-display" class="text-xl text-gray-500 font-bold">0%</div>
            </div>
            <div class="text-center">
                <div class="text-[10px] text-gray-600 uppercase">Quarter</div>
                <div class="text-xl text-blue-500 font-bold">Q<span id="qtr-disp">1</span></div>
            </div>
        </div>

        <button id="btn-file" class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-sm text-sm font-bold font-mono tracking-widest transition shadow-[0_0_15px_rgba(37,99,235,0.4)] disabled:opacity-30 disabled:cursor-not-allowed">
            FILE EARNINGS
        </button>
    </header>

    <!-- MAIN DASHBOARD -->
    <main class="flex-1 grid grid-cols-12 gap-0 overflow-hidden">

        <!-- LEVERS PANEL -->
        <div class="col-span-12 md:col-span-3 border-r border-gray-800 bg-[#0a0a0a] flex flex-col overflow-hidden">
            <div class="panel-header">
                <span>Financial Levers</span>
                <span class="text-[10px] text-gray-600">ADJUSTMENTS</span>
            </div>
            <div id="tactics-list" class="flex-1 overflow-y-auto pb-4">
                <!-- Injected JS -->
            </div>
        </div>

        <!-- FINANCIALS PANEL -->
        <div class="col-span-12 md:col-span-6 bg-black flex flex-col overflow-hidden relative border-r border-gray-800">
            <div class="panel-header justify-center bg-[#050505]">
                <span class="text-gray-400 mr-2">ANALYST CONSENSUS:</span>
                <span class="text-lg font-mono text-yellow-500 font-bold">$<span id="target-eps">1.00</span></span>
            </div>

            <div class="flex-1 overflow-y-auto p-8 flex flex-col items-center">
                <div class="w-full max-w-xl bg-[#080808] border border-gray-800 p-6 shadow-2xl relative">
                    <div class="absolute inset-0 pointer-events-none opacity-5" 
                         style="background-image: linear-gradient(#444 1px, transparent 1px), linear-gradient(90deg, #444 1px, transparent 1px); background-size: 20px 20px;">
                    </div>

                    <h3 class="text-center text-gray-500 font-paper italic mb-6 text-lg">Pro Forma Statement of Operations</h3>

                    <table class="w-full text-left relative z-10 fin-table">
                        <thead>
                            <tr class="text-gray-600 border-b border-gray-700 text-xs uppercase tracking-wider">
                                <th class="pb-3 pl-2">Line Item ($M)</th>
                                <th class="pb-3 text-right">Actual</th>
                                <th class="pb-3 text-right">Adj.</th>
                                <th class="pb-3 text-right text-white">Reported</th>
                            </tr>
                        </thead>
                        <tbody id="fin-body">
                            <!-- Injected JS -->
                        </tbody>
                        <tfoot class="border-t-2 border-gray-700">
                            <tr><td colspan="4" class="h-4"></td></tr>
                            <tr>
                                <td class="font-bold text-gray-300 pl-2">Net Income (GAAP)</td>
                                <td class="text-right text-gray-600" id="val-ni-real">0</td>
                                <td class="text-right text-blue-500" id="val-ni-adj">-</td>
                                <td class="text-right text-white font-bold" id="val-ni-rep">0</td>
                            </tr>
                            <tr class="text-lg">
                                <td class="font-bold text-gray-400 pl-2 pt-2">GAAP EPS</td>
                                <td class="text-right text-gray-600 pt-2" id="val-eps-real">0.00</td>
                                <td class="text-right text-blue-500 pt-2" id="val-eps-adj">-</td>
                                <td class="text-right text-gray-400 font-bold pt-2" id="val-eps-rep">0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <!-- Pro Forma Injection -->
                    <div id="pro-forma-section" class="mt-6 transition-all duration-300">
                        <div class="pro-forma-box flex justify-between items-center bg-yellow-900/10 border-yellow-700/30">
                            <div>
                                <div class="text-yellow-500 font-bold text-xs uppercase tracking-wider">Non-GAAP Adjusted EPS</div>
                                <div class="text-[10px] text-gray-500 font-mono">*Excl. SBC, Restructuring, One-time items</div>
                            </div>
                            <div class="text-3xl font-bold text-yellow-400 font-mono" id="val-eps-pro">0.00</div>
                        </div>
                    </div>
                </div>
                
                <div id="gap-display" class="mt-6 font-mono text-sm px-4 py-2 bg-[#111] border border-gray-800 rounded text-red-500">
                    FORECAST MISSING TARGET
                </div>
            </div>
        </div>

        <!-- ADVISOR PANEL -->
        <div class="col-span-12 md:col-span-3 bg-[#0a0a0a] flex flex-col overflow-hidden">
            <div class="panel-header">
                <span>Encrypted Channel</span>
                <span class="text-green-500 animate-pulse">‚óè SECURE</span>
            </div>
            
            <div id="chat-log" class="flex-1 overflow-y-auto p-4 flex flex-col">
                <!-- Injected JS -->
            </div>

            <div class="h-1/3 border-t border-gray-800 bg-[#080808] p-4 overflow-y-auto">
                <div class="text-[10px] text-gray-500 uppercase font-bold mb-2">Selected Strategy</div>
                <h4 id="detail-title" class="text-white font-bold mb-1">...</h4>
                <p id="detail-desc" class="text-gray-400 text-xs leading-relaxed">Hover over a lever on the left to analyze its impact on Financial Statements.</p>
            </div>
        </div>
    </main>

    <!-- TICKER FOOTER -->
    <footer class="h-8 bg-black border-t border-gray-800 shrink-0 z-30 flex items-center">
        <div class="ticker-wrap">
            <div class="ticker-move">
                <span class="ticker-item">NYSE: EARN <span class="text-green-500">‚ñ≤ 1.2%</span></span>
                <span class="ticker-item">NASDAQ: TECH <span class="text-red-500">‚ñº 0.4%</span></span>
                <span class="ticker-item text-yellow-500">BREAKING: SEC announces new crackdown on revenue recognition...</span>
                <span class="ticker-item">DJIA: 34,200 <span class="text-green-500">‚ñ≤ 0.1%</span></span>
                <span class="ticker-item text-blue-400">ANALYST NOTE: "Quality of earnings is deteriorating across the sector."</span>
            </div>
        </div>
    </footer>

    <!-- MODALS (News, Outcome) -->
    <!-- News Modal: Paper Style -->
    <div id="modal-news" class="fixed inset-0 bg-black/80 z-[200] flex items-center justify-center hidden p-4 modal-enter">
        <div class="newspaper-modal max-w-2xl w-full p-8 md:p-12 relative overflow-hidden rounded-sm">
            
            <div class="border-b-4 border-black mb-6 pb-2 text-center">
                <h1 class="text-5xl md:text-6xl font-black uppercase tracking-tight text-black leading-none">THE STREET JOURNAL</h1>
                <div class="flex justify-between text-xs font-bold uppercase border-t-2 border-black pt-2 font-mono text-gray-800 mt-2">
                    <span>DIGITAL WIRE</span>
                    <span>VOL.<span id="news-vol">104</span> // LATE ED.</span>
                </div>
            </div>
            
            <h2 id="news-headline" class="text-3xl font-bold mb-6 font-paper leading-tight text-black uppercase tracking-normal">HEADLINE</h2>
            
            <div class="text-base font-serif text-gray-900 text-justify mb-8 leading-relaxed">
                <p id="news-body" class="mb-4 font-medium">Text goes here.</p>
                <div class="p-4 bg-white border-l-4 border-black text-xs text-black shadow-sm">
                    <strong class="block mb-1 uppercase tracking-wider font-sans font-bold">Analyst Consensus:</strong>
                    <span id="news-note" class="italic font-serif text-sm">"..."</span>
                </div>
            </div>

            <button onclick="game.closeNews()" class="w-full bg-black text-white font-bold py-4 uppercase tracking-[0.2em] hover:bg-gray-800 transition text-xs font-mono shadow-lg">
                ACKNOWLEDGE
            </button>
        </div>
    </div>

    <!-- Outcome Modal -->
    <div id="modal-outcome" class="fixed inset-0 bg-black/95 z-[210] flex items-center justify-center hidden">
        <div class="bg-gray-900 border border-gray-700 p-8 rounded-lg max-w-md w-full text-center shadow-2xl modal-enter">
            <div id="outcome-icon" class="text-6xl mb-4"></div>
            <h2 id="outcome-title" class="text-3xl font-bold text-white mb-2"></h2>
            <p id="outcome-msg" class="text-gray-400 mb-8 text-sm font-mono leading-relaxed"></p>
            <button onclick="game.nextTurn()" class="bg-white text-black font-bold py-3 px-8 rounded-sm hover:bg-gray-200 uppercase tracking-widest text-xs">Next Quarter</button>
        </div>
    </div>

    <script>
        const TACTICS = [
            {
                id: 'overproduction',
                name: 'Overproduction',
                tag: 'Operational',
                tagClass: 'tag-ops',
                risk: 5,
                desc: "Produce more units than needed. Spreads fixed overhead across more units, lowering COGS per unit (Absorption Costing). Boosts Gross Margin now, risks write-downs later.",
                effect: { rev: 0, cogs: -8, opex: 0, special: 0, addBack: 0 },
                chat: { char: 'shark', text: "Run the factories 24/7. Lower the unit cost. We'll stuff the warehouse and worry about selling it next year." }
            },
            {
                id: 'channel_stuffing',
                name: 'Channel Stuffing',
                tag: 'Aggressive',
                tagClass: 'tag-gray',
                risk: 15,
                desc: "Offer deep discounts to distributors to take product early. Pulls future revenue into current quarter.",
                effect: { rev: 15, cogs: 5, opex: 0, special: 0, addBack: 0 },
                chat: { char: 'shark', text: "Call the distributors. Tell them if they take Q2 inventory now, we give them 10% off. Book the revenue today." }
            },
            {
                id: 'bill_hold',
                name: 'Bill & Hold',
                tag: 'Gray Area',
                tagClass: 'tag-gray',
                risk: 20,
                desc: "Bill customers for goods but keep them in your warehouse. High audit risk unless specific criteria are met.",
                effect: { rev: 12, cogs: 4, opex: 0, special: 0, addBack: 0 },
                chat: { char: 'elena', text: "Be careful. Unless the customer requested this delay in writing with a fixed delivery date, the SEC calls this fraud." }
            },
            {
                id: 'extend_life',
                name: 'Extend Useful Life',
                tag: 'Accounting',
                tagClass: 'tag-safe',
                risk: 5,
                desc: "Adjust depreciation schedule (e.g., from 5 to 8 years). Lowers depreciation expense instantly. Completely legal change of estimate.",
                effect: { rev: 0, cogs: 0, opex: -6, special: 0, addBack: 0 },
                chat: { char: 'elena', text: "We can justify this. Our equipment is lasting longer than expected. It's a valid change in estimate." }
            },
            {
                id: 'stock_comp',
                name: 'Adjust Stock Comp',
                tag: 'Non-GAAP',
                tagClass: 'tag-safe',
                risk: 2,
                desc: "Stock-Based Compensation is a real cost, but you can exclude it from 'Adjusted Earnings'. Analysts often accept this.",
                effect: { rev: 0, cogs: 0, opex: 0, special: 0, addBack: 5 }, // Adds back to Pro Forma
                chat: { char: 'shark', text: "Exclude the stock options from the earnings call number. 'Pro Forma' is all that matters to the street." }
            },
            {
                id: 'restructuring',
                name: 'Restructuring Charge',
                tag: 'Strategic',
                tagClass: 'tag-ops',
                risk: 10,
                desc: "Take a large 'one-time' charge for layoffs/closings. GAAP earnings tank, but you add it back to Non-GAAP earnings, making them look clean.",
                effect: { rev: 0, cogs: 0, opex: 0, special: -15, addBack: 15 },
                chat: { char: 'shark', text: "Announce a 'Transformation Plan'. Take a huge charge now. Analysts will ignore it as 'non-recurring'." }
            },
            {
                id: 'slash_rnd',
                name: 'Slash R&D',
                tag: 'Operational',
                tagClass: 'tag-ops',
                risk: 0,
                desc: "Cut research spending. immense short-term savings, destroys long-term value.",
                effect: { rev: 0, cogs: 0, opex: -8, special: 0, addBack: 0 },
                chat: { char: 'elena', text: "Cutting R&D is safe legally, but we are eating our seed corn. Innovation will stall." }
            },
            {
                id: 'cookie_jar',
                name: 'Cookie Jar Reserves',
                tag: 'Aggressive',
                tagClass: 'tag-gray',
                risk: 12,
                desc: "Release excess reserves from previous quarters to boost income.",
                effect: { rev: 0, cogs: -4, opex: -2, special: 0, addBack: 0 },
                chat: { char: 'elena', text: "Releasing reserves when we don't need to is manipulation. The auditor will ask questions." }
            },
            {
                id: 'big_bath',
                name: 'Big Bath',
                tag: 'Strategic',
                tagClass: 'tag-ops',
                risk: 8,
                desc: "Write down EVERYTHING assets, inventory, goodwill. Massive loss now, but guarantees easy profits for next 2 years.",
                effect: { rev: 0, cogs: 0, opex: 0, special: -40, addBack: 40 },
                chat: { char: 'shark', text: "Kitchen Sink time. Write it all down. We'll blame the 'macro environment' and look like heroes next quarter." }
            },
            {
                id: 'spe_debt',
                name: 'SPE Transfer',
                tag: 'FRAUD',
                tagClass: 'tag-fraud',
                risk: 40,
                desc: "Hide debt/expenses in an off-balance sheet entity. Illegal.",
                effect: { rev: 0, cogs: 0, opex: -15, special: 0, addBack: 0 },
                chat: { char: 'shark', text: "Move the losses to the SPE. The balance sheet has to look perfect for the debt covenants." }
            }
        ];

        const CHARACTERS = {
            shark: { name: "Gordon", role: "Hedge Fund", avatar: "ü¶à", color: "text-green-400" },
            elena: { name: "Elena", role: "Audit Chair", avatar: "‚öñÔ∏è", color: "text-red-400" },
            viper: { name: "Viper", role: "Short Seller", avatar: "üêç", color: "text-yellow-400" }
        };

        const NEWS_HEADLINES = [
            { 
                title: "Street Sets High Bar", 
                body: "Consensus estimates are firm at $1.00 EPS. 'Execute or leave,' says influential analyst.", 
                note: "Stock price highly sensitive to miss." 
            },
            { 
                title: "Supply Chain Crunch", 
                body: "Component shortages are driving up costs. Gross margins are under attack.", 
                note: "COGS pressure +10%", 
                effect: { cogs: 10 } 
            },
            { 
                title: "Competitor 'Restructures'", 
                body: "Rival firm announces massive layoffs and one-time charges to 'streamline'. Investors cheer the move.", 
                note: "Window open for 'Big Bath' or Restructuring.",
            },
            { 
                title: "SEC Focus: Revenue Rec", 
                body: "The SEC is cracking down on 'Bill and Hold' arrangements. Auditors are double-checking shipping docs.", 
                note: "Aggressive revenue tactics carry 2x Risk.", 
                effect: { riskMult: 2.0 } 
            },
            { 
                title: "Bull Market Euphoria", 
                body: "Investors are ignoring GAAP numbers and focusing purely on 'Adjusted Growth'.", 
                note: "Non-GAAP adjustments highly effective.", 
            },
            { 
                title: "Inventory Bloat", 
                body: "Channel checks show unsold inventory piling up at distributors.", 
                note: "Channel Stuffing effectiveness reduced.", 
            }
        ];

        class GameEngine {
            constructor() {
                this.qtr = 1;
                this.stock = 25.00;
                this.risk = 0;
                this.activeTactics = new Set();
                
                this.base = {
                    rev: 120,
                    cogs: 70,
                    opex: 35,
                    shares: 10
                };
                
                this.targetEPS = 1.00;
            }

            startGame() {
                document.getElementById('landing-page').style.display = 'none';
                this.initUI();
                this.startTurn();
            }

            initUI() {
                const list = document.getElementById('tactics-list');
                list.innerHTML = '';
                TACTICS.forEach(t => {
                    const el = document.createElement('div');
                    el.className = 'tactic-card';
                    el.onclick = () => this.toggleTactic(t.id);
                    el.onmouseenter = () => this.showDetail(t);
                    el.id = `btn-${t.id}`;
                    
                    el.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold text-gray-300 text-xs">${t.name}</span>
                            <span class="tag ${t.tagClass}">${t.tag}</span>
                        </div>
                        <div class="text-[10px] text-gray-600">Risk: ${t.risk}%</div>
                    `;
                    list.appendChild(el);
                });

                document.getElementById('btn-file').onclick = () => this.endTurn();
            }

            showDetail(t) {
                document.getElementById('detail-title').innerText = t.name;
                document.getElementById('detail-desc').innerText = t.desc;
                if(t.tag === 'FRAUD') document.getElementById('detail-title').className = 'text-red-500 font-bold mb-1';
                else document.getElementById('detail-title').className = 'text-white font-bold mb-1';
            }

            startTurn() {
                this.activeTactics.clear();
                this.updateTacticsUI();
                
                const news = NEWS_HEADLINES[(this.qtr - 1) % NEWS_HEADLINES.length];
                
                document.getElementById('news-headline').innerText = news.title;
                document.getElementById('news-body').innerText = news.body;
                document.getElementById('news-note').innerText = news.note;
                document.getElementById('modal-news').classList.remove('hidden');

                if(news.effect?.cogs) this.base.cogs += news.effect.cogs;
                
                this.calc();
            }

            closeNews() {
                document.getElementById('modal-news').classList.add('hidden');
                if(this.qtr === 1) {
                    this.addChat('shark', "Target is $1.00. We're at $0.80 organic. You have 10 levers. Use them.");
                    setTimeout(() => this.addChat('elena', "Keep it legal. I don't want to go to prison for a quarterly bonus."), 1000);
                }
            }

            toggleTactic(id) {
                if(this.activeTactics.has(id)) {
                    this.activeTactics.delete(id);
                } else {
                    this.activeTactics.add(id);
                    const t = TACTICS.find(x => x.id === id);
                    if(t.chat) this.addChat(t.chat.char, t.chat.text);
                }
                this.updateTacticsUI();
                this.calc();
            }

            updateTacticsUI() {
                document.querySelectorAll('.tactic-card').forEach(el => {
                    const id = el.id.replace('btn-', '');
                    if(this.activeTactics.has(id)) el.classList.add('active');
                    else el.classList.remove('active');
                });
            }

            addChat(charId, text) {
                const c = CHARACTERS[charId];
                const box = document.getElementById('chat-log');
                const div = document.createElement('div');
                div.className = 'chat-bubble';
                div.innerHTML = `
                    <div class="flex items-center gap-2 mb-1">
                        <div class="avatar-circle">${c.avatar}</div>
                        <span class="font-bold text-xs ${c.color}">${c.name}</span>
                    </div>
                    <div class="text-gray-300">${text}</div>
                `;
                box.appendChild(div);
                box.scrollTop = box.scrollHeight;
            }

            calc() {
                let adj = { rev:0, cogs:0, opex:0, special:0, addBack:0 };
                let turnRisk = 0;
                
                this.activeTactics.forEach(id => {
                    const t = TACTICS.find(x => x.id === id);
                    adj.rev += t.effect.rev;
                    adj.cogs += t.effect.cogs;
                    adj.opex += t.effect.opex;
                    adj.special += t.effect.special;
                    adj.addBack += t.effect.addBack;
                    turnRisk += t.risk;
                });

                const b = this.base;
                
                // Real GAAP
                const realOpInc = b.rev - b.cogs - b.opex;
                const realNet = realOpInc * 0.8; 
                const realEPS = realNet / b.shares;

                // Reported GAAP
                const repRev = b.rev + adj.rev;
                const repCogs = b.cogs + adj.cogs;
                const repOpex = b.opex + adj.opex;
                const repOpInc = repRev - repCogs - repOpex;
                // GAAP Net Income includes Special Items (Charges)
                const repNet = (repOpInc + adj.special) * 0.8; 
                const repEPS = repNet / b.shares;

                // Pro Forma (Non-GAAP)
                // Adds back 'addBack' items (like Restructuring, Stock Comp)
                // Note: adj.special is negative (a cost). addBack cancels it out or adds purely theoretical exclusions.
                // Simple logic: ProFormaNet = RepNet + (AddBacks * 0.8) assuming tax effect, or raw? Usually tax effected.
                // Let's assume AddBacks are pre-tax, so we tax effect them.
                const proFormaNet = repNet + (adj.addBack * 0.8);
                const proFormaEPS = proFormaNet / b.shares;

                this.currentMetric = (Math.abs(adj.addBack) > 0) ? proFormaEPS : repEPS;

                // Render Table
                const tbody = document.getElementById('fin-body');
                tbody.innerHTML = `
                    <tr class="fin-row-main"><td class="text-gray-400 pl-2">Revenue</td><td class="text-right text-gray-600">${b.rev}</td><td class="text-right ${adj.rev?'val-changed text-blue-500':''}">${adj.rev||'-'}</td><td class="text-right text-white font-bold">${repRev}</td></tr>
                    <tr class="fin-row-main"><td class="text-gray-400 pl-2">COGS</td><td class="text-right text-gray-600">${b.cogs}</td><td class="text-right ${adj.cogs?'val-changed text-blue-500':''}">${adj.cogs||'-'}</td><td class="text-right text-white font-bold">${repCogs}</td></tr>
                    <tr class="fin-row-main"><td class="text-gray-400 pl-2">Op. Expenses</td><td class="text-right text-gray-600">${b.opex}</td><td class="text-right ${adj.opex?'val-changed text-blue-500':''}">${adj.opex||'-'}</td><td class="text-right text-white font-bold">${repOpex}</td></tr>
                    ${adj.special !== 0 ? `<tr class="fin-row-main bg-red-900/10"><td class="text-red-400 pl-2 font-bold">Special Charges</td><td class="text-right">-</td><td class="text-right text-red-500">${adj.special}</td><td class="text-right text-red-400">${adj.special}</td></tr>` : ''}
                `;

                document.getElementById('val-ni-real').innerText = realNet.toFixed(1);
                document.getElementById('val-ni-rep').innerText = repNet.toFixed(1);
                document.getElementById('val-eps-real').innerText = realEPS.toFixed(2);
                document.getElementById('val-eps-rep').innerText = repEPS.toFixed(2);
                document.getElementById('val-eps-pro').innerText = proFormaEPS.toFixed(2);

                const gap = this.currentMetric - this.targetEPS;
                const gapEl = document.getElementById('gap-display');
                
                // Varied Messages
                const failPrefixes = ["PROJECTED MISS", "BELOW CONSENSUS", "GAP TO TARGET", "FORECAST SHORTFALL"];
                const passPrefixes = ["TARGET SECURED", "CONSENSUS BEAT", "ABOVE EXPECTATIONS", "FORECAST BEAT"];
                const randFail = failPrefixes[Math.floor(Math.random() * failPrefixes.length)];
                const randPass = passPrefixes[Math.floor(Math.random() * passPrefixes.length)];

                if(gap >= -0.01) {
                    gapEl.innerHTML = `<strong>${randPass}</strong><br>PROJ: $${this.currentMetric.toFixed(2)} vs TGT: $${this.targetEPS.toFixed(2)}`;
                    gapEl.className = "mt-6 font-mono text-sm px-4 py-3 bg-[#111] border border-green-800 rounded text-green-500 animate-pulse text-center shadow-[0_0_10px_rgba(34,197,94,0.2)]";
                    document.getElementById('btn-file').disabled = false;
                    document.getElementById('btn-file').classList.remove('opacity-30', 'cursor-not-allowed');
                } else {
                    gapEl.innerHTML = `<strong>${randFail}</strong><br>PROJ: $${this.currentMetric.toFixed(2)} vs TGT: $${this.targetEPS.toFixed(2)}`;
                    gapEl.className = "mt-6 font-mono text-sm px-4 py-3 bg-[#111] border border-red-900 rounded text-red-500 text-center shadow-[0_0_10px_rgba(239,68,68,0.2)]";
                    document.getElementById('btn-file').disabled = false; // Allow filing even if missing
                    document.getElementById('btn-file').classList.remove('opacity-30', 'cursor-not-allowed');
                }

                const totalRisk = this.risk + turnRisk;
                document.getElementById('risk-display').innerText = totalRisk + "%";
                if(totalRisk > 40) document.getElementById('risk-display').classList.add('text-red-500', 'animate-risk');
            }

            endTurn() {
                let turnRisk = 0;
                this.activeTactics.forEach(id => turnRisk += TACTICS.find(x => x.id === id).risk);
                this.risk += turnRisk;

                // Game Over Check: Reduced chance. 
                // Only trigger if risk > 50% and bad luck roll
                if(this.risk > 50 && Math.random() * 100 < (this.risk - 20)) {
                    this.gameOver("SEC RAID", "üëÆ‚Äç‚ôÇÔ∏è", "The Audit Committee found significant irregularities. The SEC has launched a formal investigation.");
                    return;
                }
                
                const winTitles = ["CONSENSUS BEAT", "STREET IMPRESSED", "SOLID QUARTER", "TARGET SMASHED"];
                const winMsgs = [
                    "Stock jumps 10%. Analysts praise your 'Operational Efficiency'.",
                    "Investors cheer the growth story. The Board votes to increase your bonus.",
                    "Short sellers are scrambling to cover. Stock is up 12% in after-hours.",
                    "A clean beat. Jim Cramer calls you a 'Wizard of Finance'."
                ];

                const lossTitles = ["EARNINGS MISS", "DISAPPOINTING RESULTS", "QUARTERLY FAIL", "STREET SHOCKED"];
                const lossMsgs = [
                    "Stock drops 15%. Investors question the growth story.",
                    "Analysts downgrade the stock. 'Management has lost credibility.'",
                    "The Board is furious. The stock is down 20% pre-market.",
                    "Missed by pennies, punished by dollars. Market cap sheds $500M."
                ];

                // Randomize
                const rWin = Math.floor(Math.random() * winTitles.length);
                const rLoss = Math.floor(Math.random() * lossTitles.length);

                if(this.currentMetric >= this.targetEPS - 0.01) {
                    this.stock *= 1.1;
                    this.showOutcome(winTitles[rWin], "üìà", winMsgs[rWin]);
                } else {
                    this.stock *= 0.85;
                    this.showOutcome(lossTitles[rLoss], "üìâ", lossMsgs[rLoss]);
                }
            }

            showOutcome(title, icon, msg) {
                document.getElementById('outcome-title').innerText = title;
                document.getElementById('outcome-icon').innerText = icon;
                document.getElementById('outcome-msg').innerText = msg;
                document.getElementById('modal-outcome').classList.remove('hidden');
            }

            nextTurn() {
                this.qtr++;
                if (this.qtr > 6) {
                    this.gameOver("SURVIVED", "üèôÔ∏è", "You survived 6 quarters in the hot seat. You retire wealthy, but at what cost to your soul?");
                    return;
                }
                document.getElementById('modal-outcome').classList.add('hidden');
                document.getElementById('qtr-disp').innerText = this.qtr;
                document.getElementById('stock-price').innerText = `$${this.stock.toFixed(2)}`;
                
                // Difficulty Scaling
                this.base.rev *= 1.05; 
                this.base.cogs *= 1.06; // Costs rising faster than rev
                this.base.opex *= 1.02;
                this.targetEPS *= 1.10; // Analysts demand more
                
                this.startTurn();
            }

            gameOver(title, icon, msg) {
                this.showOutcome(title, icon, msg);
                document.querySelector('#modal-outcome button').innerText = "GAME OVER";
                document.querySelector('#modal-outcome button').onclick = () => location.reload();
            }
        }

        window.game = new GameEngine();

    </script>
</body>
</html>