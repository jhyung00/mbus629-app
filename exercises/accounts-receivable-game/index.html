<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Receivables Room ‚Äî Revenue Under Interrogation</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: light; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .card { box-shadow: 0 10px 30px rgba(2,6,23,.08); transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .card:hover { transform: translateY(-2px); box-shadow: 0 15px 35px rgba(2,6,23,.12); }
    .btn { transition: all 0.1s ease; }
    .btn:active { transform: scale(0.95); }
    canvas { width: 100% !important; height: 240px !important; }

    /* Animation for Score Pop */
    @keyframes floatUp {
      0% { opacity: 1; transform: translateY(0) scale(1); }
      100% { opacity: 0; transform: translateY(-40px) scale(1.2); }
    }
    .score-pop {
      position: absolute;
      font-weight: 900;
      color: #059669;
      pointer-events: none;
      animation: floatUp 1.5s ease-out forwards;
      z-index: 100;
      text-shadow: 0 2px 4px rgba(255,255,255,0.8);
      white-space: nowrap;
    }
    
    /* Selection States */
    .btn-selected {
      background-color: #4f46e5 !important;
      color: white !important;
      border-color: #4f46e5 !important;
    }
    .btn-risk-selected {
      background-color: #0f172a !important;
      color: white !important;
      border-color: #0f172a !important;
    }

    /* Feedback States (Applied after locking) */
    .answer-correct {
      background-color: #ecfdf5 !important; /* emerald-50 */
      border-color: #10b981 !important;     /* emerald-500 */
      color: #064e3b !important;            /* emerald-900 */
    }
    .answer-wrong {
      background-color: #fff1f2 !important; /* rose-50 */
      border-color: #f43f5e !important;     /* rose-500 */
      color: #881337 !important;            /* rose-900 */
      opacity: 0.7;
    }
    .tag-correct {
      background-color: #10b981 !important; /* emerald-500 */
      color: white !important;
      border-color: #059669 !important;
      box-shadow: 0 0 0 2px #d1fae5;
    }
    .tag-missed {
      border-style: dashed !important;
      border-color: #10b981 !important;
      color: #059669 !important;
      background-color: #ecfdf5 !important;
    }
    
    /* Reveal Animation */
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .feedback-reveal {
      animation: slideIn 0.4s ease-out forwards;
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 font-sans selection:bg-indigo-100">
  <!-- Header -->
  <header class="sticky top-0 z-20 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="absolute inset-x-0 top-0 h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-gradient-to-br from-slate-900 to-slate-700 text-white grid place-items-center font-black shadow-lg text-lg">RR</div>
        <div>
          <div class="font-extrabold leading-tight text-slate-800">The Receivables Room</div>
          <div class="text-xs text-slate-500 font-medium -mt-0.5">Analyst Toolkit Game</div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="btnReset" class="btn px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm font-bold text-slate-600">Reset</button>
        <button id="btnHow" class="btn px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-white text-sm font-bold shadow-md">How to Play</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-12 gap-6 relative">
    <!-- LEFT: Setup + Leaderboard -->
    <section class="lg:col-span-4 space-y-6">
      <div class="card rounded-3xl bg-white border border-slate-200 p-5 relative overflow-hidden">
        <div class="flex items-start justify-between gap-3 relative z-10">
          <div>
            <h2 class="font-extrabold text-lg flex items-center gap-2">üïµÔ∏è‚Äç‚ôÄÔ∏è Teams</h2>
            <p class="text-sm text-slate-600">Who is investigating?</p>
          </div>
          <span class="text-xs px-2 py-1 rounded-full bg-indigo-50 text-indigo-700 border border-indigo-100 mono font-bold" id="gameMeta">Round 0 / 6</span>
        </div>

        <div class="mt-4 grid grid-cols-1 gap-2 relative z-10">
          <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">New Team</label>
          <div class="flex gap-2">
            <input id="teamName" class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., The Allowance Avengers" />
            <button id="btnAddTeam" class="btn px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-bold shadow-md shadow-emerald-200">Add</button>
          </div>

          <div class="flex gap-2 mt-4">
            <button id="btnStart" class="btn w-full px-3 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-extrabold shadow-lg shadow-indigo-200 transition-all disabled:opacity-50 disabled:shadow-none">Start Game</button>
            <button id="btnNext" class="btn w-full px-3 py-3 rounded-xl bg-slate-800 hover:bg-slate-700 text-white text-sm font-extrabold shadow-lg shadow-slate-200 transition-all disabled:opacity-50 disabled:shadow-none" disabled>Next Case ‚û°Ô∏è</button>
          </div>
        </div>
      </div>

      <div class="card rounded-3xl bg-white border border-slate-200 p-5 relative">
        <div class="flex items-start justify-between items-center">
          <div>
            <h2 class="font-extrabold text-lg flex items-center gap-2">üèÜ Leaderboard</h2>
          </div>
          <button id="btnExport" class="btn px-3 py-2 rounded-xl border border-emerald-200 bg-emerald-50 hover:bg-emerald-100 text-emerald-700 text-sm font-bold transition-colors">Save</button>
        </div>

        <div id="leaderboard" class="mt-4 space-y-2 min-h-[100px]"></div>

        <div class="mt-4 p-3 rounded-2xl bg-slate-50 border border-slate-100 text-xs text-slate-600">
          <div class="font-bold text-slate-800 mb-1">Scoring Rules</div>
          <div class="grid grid-cols-2 gap-x-2 gap-y-1">
            <span>‚úÖ Answer:</span> <span class="mono font-bold text-indigo-600">+100</span>
            <span>üß† Reason:</span> <span class="mono font-bold text-indigo-600">+10</span>
            <span>‚ö†Ô∏è Risk:</span> <span class="mono font-bold text-indigo-600">0‚Äì40</span>
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT: Case Board -->
    <section class="lg:col-span-8 space-y-6">
      <div class="card rounded-3xl bg-white border border-slate-200 p-6 relative">
        <!-- Decoration -->
        <div class="absolute -top-6 -right-6 w-32 h-32 bg-yellow-400/10 rounded-full blur-2xl pointer-events-none"></div>

        <div class="flex items-start justify-between gap-4 relative">
          <div>
            <div class="text-xs font-bold text-indigo-500 tracking-widest uppercase mb-1">CONFIDENTIAL CASE FILE</div>
            <h1 id="caseTitle" class="font-extrabold text-3xl text-slate-900 leading-tight">Add a team to begin.</h1>
            <p id="casePrompt" class="text-base text-slate-600 mt-2 font-medium">Get ready to analyze the data.</p>
          </div>
          <div class="text-right shrink-0">
            <div class="text-xs text-slate-400 font-bold uppercase tracking-wider">Difficulty</div>
            <div id="caseDifficulty" class="inline-flex mt-1 items-center gap-1 px-3 py-1 rounded-full bg-slate-100 text-slate-600 text-sm font-black border border-slate-200">‚Äî</div>
          </div>
        </div>

        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-5">
          <!-- Footnote & Flag -->
          <div class="rounded-3xl border border-slate-100 bg-slate-50/50 p-5 flex flex-col h-full">
            <div class="flex items-center justify-between mb-2">
              <div class="font-extrabold text-slate-800 flex items-center gap-2">üìù Notes</div>
              <span class="text-xs px-2 py-0.5 rounded-md bg-white border border-slate-200 text-slate-500 font-medium" id="caseLens">Lens: ‚Äî</span>
            </div>
            <p id="caseFootnote" class="text-sm text-slate-600 leading-relaxed italic mb-4 flex-grow">‚Äî</p>

            <div class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm">
              <div class="flex items-center justify-between mb-2">
                <div class="text-xs font-bold text-slate-400 uppercase tracking-wider">Red-Flag Meter</div>
                <div id="flagLabel" class="text-xs font-black text-slate-800">‚Äî</div>
              </div>
              <div class="h-4 rounded-full bg-slate-100 inner-shadow overflow-hidden relative">
                <div id="flagBar" class="h-full w-0 bg-gradient-to-r from-yellow-400 to-rose-500 transition-all duration-1000 ease-out rounded-full"></div>
              </div>
              <div class="text-xs text-slate-500 mt-2 leading-tight" id="flagExplain">‚Äî</div>
            </div>
          </div>

          <!-- Chart -->
          <div class="rounded-3xl border border-slate-100 bg-white p-5 shadow-sm">
            <div class="font-extrabold text-slate-800 mb-1 flex items-center gap-2">üìä Trend</div>
            <div class="mt-2">
              <canvas id="chart"></canvas>
            </div>
          </div>
        </div>

        <!-- Data Table -->
        <div class="mt-6">
          <div class="flex items-center justify-between gap-3 mb-3">
            <div>
              <div class="font-extrabold text-slate-800 flex items-center gap-2">üóÑÔ∏è Dataset</div>
            </div>
            <button id="btnCopyCase" class="btn px-3 py-1.5 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-xs font-bold text-slate-600 flex items-center gap-1">
              <span>üìã</span> Copy CSV
            </button>
          </div>

          <div class="overflow-hidden border border-slate-200 rounded-2xl shadow-sm">
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead id="dataHead" class="bg-slate-50"></thead>
                <tbody id="dataBody" class="bg-white divide-y divide-slate-100"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Interaction Area -->
      <div class="card rounded-3xl bg-white border border-slate-200 p-6 relative transition-colors duration-500" id="interactionCard">
        <div class="flex items-center justify-between gap-3 mb-4">
          <div>
            <h2 class="font-extrabold text-xl text-slate-800">Your Call</h2>
            <p class="text-sm text-slate-500" id="interactionSub">Select answer, tags, and risk level.</p>
          </div>
          <button id="btnLock" class="btn px-6 py-3 rounded-2xl bg-slate-900 hover:bg-slate-800 text-white text-sm font-extrabold shadow-lg shadow-slate-300 disabled:opacity-50 disabled:shadow-none flex items-center gap-2" disabled>
            üîí Lock & Score
          </button>
        </div>

        <!-- Feedback Section (Hidden by default) -->
        <div id="feedbackArea" class="hidden mb-6 p-4 rounded-2xl bg-indigo-50 border border-indigo-100 feedback-reveal">
          <div class="flex items-start gap-3">
            <div class="text-2xl mt-1">üí°</div>
            <div>
              <h3 class="font-bold text-indigo-900 text-lg">Case Resolution</h3>
              <p id="feedbackText" class="text-indigo-800 text-sm leading-relaxed mt-1"></p>
            </div>
          </div>
        </div>

        <div id="answerArea" class="grid grid-cols-1 md:grid-cols-2 gap-5 opacity-50 pointer-events-none transition-opacity duration-300">
          <!-- Answer Choices -->
          <div class="space-y-3">
             <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">1. Select Answer</div>
             <div id="answerChoices" class="space-y-2"></div>
          </div>

          <!-- Reasoning & Risk -->
          <div class="flex flex-col gap-5">
            <div>
              <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">2. Reasoning (Pick up to 3)</div>
              <div id="tagChoices" class="flex flex-wrap gap-2"></div>
            </div>

            <div class="pt-4 border-t border-slate-100">
              <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">3. Risk Assessment</div>
              <div id="riskChoices" class="flex gap-2 flex-wrap"></div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
    <div class="max-w-2xl w-full rounded-3xl bg-white shadow-2xl p-6 transform transition-all scale-100">
      <div class="flex items-start justify-between gap-3 mb-4">
        <div>
          <div class="text-xs font-bold text-indigo-500 uppercase tracking-widest">TUTORIAL</div>
          <div class="font-extrabold text-2xl text-slate-900">How to Play</div>
        </div>
        <button id="btnClose" class="btn p-2 rounded-full hover:bg-slate-100 text-slate-400 hover:text-slate-600">‚úï</button>
      </div>
      <div class="space-y-4 text-slate-600">
        <div class="flex gap-3">
          <div class="h-8 w-8 rounded-full bg-indigo-100 text-indigo-600 font-bold grid place-items-center shrink-0">1</div>
          <p>Add teams (or play solo!).</p>
        </div>
        <div class="flex gap-3">
          <div class="h-8 w-8 rounded-full bg-indigo-100 text-indigo-600 font-bold grid place-items-center shrink-0">2</div>
          <p>Review the case file. Look for red flags in the footnotes and data trends.</p>
        </div>
        <div class="flex gap-3">
          <div class="h-8 w-8 rounded-full bg-indigo-100 text-indigo-600 font-bold grid place-items-center shrink-0">3</div>
          <p>Make your call: pick the correct answer, back it up with reasoning tags, and assess the risk level.</p>
        </div>
      </div>
      <div class="mt-6 p-4 rounded-2xl bg-emerald-50 text-emerald-800 text-sm font-medium border border-emerald-100">
        ‚ú® New: Instant Feedback! When you lock your answer, the game will reveal the correct choice, the ideal risk level, and the reasoning behind the solution.
      </div>
    </div>
  </div>

  <script>
    /***********************
     * Minimal chart helper
     ***********************/
    const ChartMini = (() => {
      function drawLine(ctx, labels, series, opts = {}) {
        const W = ctx.canvas.width, H = ctx.canvas.height;
        ctx.clearRect(0,0,W,H);
        const pad = 38, innerW = W - pad*2, innerH = H - pad*2;
        const vals = series.map(d => d.value);
        let min = Math.min(...vals), max = Math.max(...vals);
        if (min === max) { min -= 1; max += 1; }
        const y = v => pad + innerH * (1 - (v - min) / (max - min));
        const x = i => pad + innerW * (i / Math.max(1, series.length - 1));

        // Grid
        ctx.beginPath();
        ctx.strokeStyle = "rgba(15,23,42,.06)";
        ctx.lineWidth = 1;
        for (let k=0;k<=4;k++){
          const yy = pad + innerH*(k/4);
          ctx.moveTo(pad, yy); ctx.lineTo(pad+innerW, yy);
        }
        ctx.stroke();

        // Line
        ctx.strokeStyle = "#6366f1"; // Indigo-500
        ctx.lineWidth = 4;
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
        ctx.beginPath();
        series.forEach((d,i)=>{
          const xx = x(i), yy = y(d.value);
          if(i===0) ctx.moveTo(xx,yy); else ctx.lineTo(xx,yy);
        });
        ctx.stroke();

        // Area under line (Gradient)
        const grad = ctx.createLinearGradient(0, pad, 0, pad+innerH);
        grad.addColorStop(0, "rgba(99, 102, 241, 0.2)");
        grad.addColorStop(1, "rgba(99, 102, 241, 0)");
        ctx.fillStyle = grad;
        ctx.beginPath();
        series.forEach((d,i)=>{
          const xx = x(i), yy = y(d.value);
          if(i===0) ctx.moveTo(xx,yy); else ctx.lineTo(xx,yy);
        });
        ctx.lineTo(pad+innerW, pad+innerH);
        ctx.lineTo(pad, pad+innerH);
        ctx.fill();

        // Points
        ctx.fillStyle = "#fff";
        ctx.strokeStyle = "#4f46e5";
        ctx.lineWidth = 2;
        series.forEach((d,i)=>{
          const xx = x(i), yy = y(d.value);
          ctx.beginPath(); ctx.arc(xx,yy,5,0,Math.PI*2); ctx.fill(); ctx.stroke();
        });

        // Labels
        ctx.fillStyle = "#64748b";
        ctx.font = "bold 11px sans-serif";
        labels.forEach((lab,i)=>{
          const xx = x(i);
          ctx.fillText(lab, Math.max(2, xx-10), pad+innerH+20);
        });
      }

      function fitCanvas(canvas){
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = Math.floor(rect.width * dpr);
        canvas.height = Math.floor(rect.height * dpr);
        const ctx = canvas.getContext("2d");
        ctx.scale(dpr,dpr);
        return ctx;
      }
      return { drawLine, fitCanvas };
    })();

    /***********************
     * Case bank
     ***********************/
    const CASE_BANK = [
      {
        id: "RR-5STEP",
        lens: "Revenue Recognition",
        difficulty: "Warm-up",
        title: "Case 1 ‚Äî Timing of Revenue",
        prompt: "Which contract should recognize revenue OVER TIME?",
        footnote: "Note: Revenue is recognized when control transfers. Contract A is a standard retail shipment. Contract B is a monthly security monitoring service.",
        data: [
          { Contract: "A: Retail Goods", Performance: "Single delivery", Billing: "At shipment", Returns: "Est. 2%" },
          { Contract: "B: Security Svc", Performance: "Continuous 24/7", Billing: "Monthly", Returns: "N/A" }
        ],
        chart: { title: "Revenue pattern (illustrative)", labels: ["M1","M2","M3","M4","M5"], series: [10,10,10,10,10] },
        answers: [
          { key:"A", text:"Contract A (Retail Goods)" },
          { key:"B", text:"Contract B (Security Service)" }
        ],
        correctAnswerKey: "B",
        tags: [
          { key:"control", text:"Customer receives benefit as performed (Continuous)" },
          { key:"series", text:"Distinct service periods (Series guidance)" },
          { key:"point", text:"Control transfers at a specific point in time" }
        ],
        correctTags: ["control","series"],
        riskStrength: 20,
        flagExplain: "Low Risk. The service nature is clear. Timing risk is higher when 'percentage of completion' is based on estimates. Correct is B."
      },
      {
        id: "RR-CONTRACTASSET",
        lens: "Revenue Recognition",
        difficulty: "Medium",
        title: "Case 2 ‚Äî The Unbilled Asset",
        prompt: "Contract Assets are rising faster than Revenue. What is the most likely cause?",
        footnote: "Refresher: Contract Assets = Revenue recognized but NOT yet billed. Accounts Receivable = Billed and unconditional right to cash.",
        data: [
          { Year: 2021, Revenue: 100, AccountsReceivable: 10.0, ContractAssets: 9.5 },
          { Year: 2022, Revenue: 102, AccountsReceivable: 9.1, ContractAssets: 11.5 },
          { Year: 2023, Revenue: 103, AccountsReceivable: 8.8, ContractAssets: 14.2 }
        ],
        chart: { title:"Contract Assets ($M)", labels:["21","22","23"], seriesFrom:"ContractAssets" },
        answers: [
          { key:"A", text:"Customers are paying their bills faster" },
          { key:"B", text:"Aggressive recognition ahead of billing milestones" },
          { key:"C", text:"Allowance for doubtful accounts is increasing" }
        ],
        correctAnswerKey: "B",
        tags: [
          { key:"unbilled", text:"Revenue recorded before invoicing rights exist" },
          { key:"timing", text:"Aggressive timing (pull-forward of revenue)" },
          { key:"credit", text:"Collections issue (Customers refusing to pay)" }
        ],
        correctTags: ["unbilled","timing"],
        riskStrength: 60,
        flagExplain: "High Signal. Growing unbilled revenue relative to sales suggests the company is recognizing revenue well before they can legally invoice. Correct is B."
      },
      {
        id: "RR-ALLOWANCES",
        lens: "Revenue Quality",
        difficulty: "Medium",
        title: "Case 3 ‚Äî Shrinking Allowances",
        prompt: "Are allowances for returns/discounts likely understated or overstated in 2022?",
        footnote: "Formula: Net Sales = Gross Sales - Allowances. If you underestimate allowances, you artificially inflate Net Sales today.",
        data: [
          { Year: 2021, GrossSales: 500, Additions: 52, ActualReturns: 50, ReserveBalance: 16 },
          { Year: 2022, GrossSales: 520, Additions: 50, ActualReturns: 60, ReserveBalance: 6 }
        ],
        chart: { title:"Reserve Balance ($M)", labels:["21","22"], seriesFrom:"ReserveBalance" },
        answers: [
          { key:"A", text:"Understated (Net Sales artificially high)" },
          { key:"B", text:"Overstated (Net Sales artificially low)" },
          { key:"C", text:"Appropriate based on volume" }
        ],
        correctAnswerKey: "A",
        tags: [
          { key:"enddrop", text:"Reserve balance collapsed despite higher sales" },
          { key:"actualgt", text:"Actual returns exceeded the new provisions" },
          { key:"pressure", text:"Conservative accounting practice" }
        ],
        correctTags: ["enddrop","actualgt"],
        riskStrength: 55,
        flagExplain: "Medium-High. The reserve cushion is nearly gone (dropped to 6) while actual returns are rising. This boosts current earnings unsustainably. Correct is A."
      },
      {
        id: "RR-DEFERRED",
        lens: "Deferred Revenue",
        difficulty: "Medium",
        title: "Case 4 ‚Äî The Booking Slowdown",
        prompt: "Deferred Revenue growth has stalled. What does this signal for the future?",
        footnote: "Context: For subscription SaaS companies, Deferred Revenue is a leading indicator. It represents cash collected for future service.",
        data: [
          { Year: 2019, DeferredRev: 900, Growth: "20%" },
          { Year: 2020, DeferredRev: 1090, Growth: "21%" },
          { Year: 2021, DeferredRev: 1180, Growth: "8%" },
          { Year: 2022, DeferredRev: 1210, Growth: "2%" }
        ],
        chart: { title:"Deferred Revenue ($M)", labels:["19","20","21","22"], seriesFrom:"DeferredRev" },
        answers: [
          { key:"A", text:"Future revenue growth will likely decelerate" },
          { key:"B", text:"Current revenue is overstated due to refunds" },
          { key:"C", text:"Company is switching to cash-basis accounting" }
        ],
        correctAnswerKey: "A",
        tags: [
          { key:"prepay", text:"New bookings/prepayments have slowed down" },
          { key:"lead", text:"Deferred Revenue acts as a 'backlog' indicator" },
          { key:"timing", text:"Credit quality degradation" }
        ],
        correctTags: ["prepay","lead"],
        riskStrength: 40,
        flagExplain: "Medium Signal. While not accounting fraud, it's a vital business health warning. The 'fuel tank' for future revenue is emptying. Correct is A."
      },
      {
        id: "AR-AGING",
        lens: "Credit Quality (A/R)",
        difficulty: "Hard",
        title: "Case 5 ‚Äî The Aging Bucket Estimate",
        prompt: "Which allowance matrix represents a realistic view of non-collection risk?",
        footnote: "Rule of Thumb: The older a receivable gets, the less likely it is to be collected. Rates should increase progressively.",
        data: [
          { Bucket: "Current", Amount: 50000 },
          { Bucket: "1‚Äì60 days", Amount: 30000 },
          { Bucket: "61‚Äì90 days", Amount: 15000 },
          { Bucket: "90+ days", Amount: 5000 }
        ],
        chart: { title:"A/R Amount by Age", labels:["Cur","1‚Äì60","61‚Äì90","90+"], series: [50,30,15,5] },
        answers: [
          { key:"A", text:"Rates: 2%, 5%, 15%, 50% (Progressive)" },
          { key:"B", text:"Rates: 2%, 2%, 2%, 2% (Flat)" },
          { key:"C", text:"Rates: 0% for all (Optimistic)" }
        ],
        correctAnswerKey: "A",
        tags: [
          { key:"progressive", text:"Non-collection risk rises significantly with age" },
          { key:"judgment", text:"Management judgment applied correctly" },
          { key:"signal", text:"Flat rates ignore credit deterioration" }
        ],
        correctTags: ["progressive","signal"],
        riskStrength: 70,
        flagExplain: "High Risk area. Companies often apply flat low rates to old buckets to minimize Bad Debt Expense. Correct is A."
      },
      {
        id: "AR-ADJUST",
        lens: "Analyst Adjustment",
        difficulty: "Boss Round",
        title: "Case 6 ‚Äî The Cookie Jar?",
        prompt: "Compare the reported allowance to the historical average. What is the impact?",
        footnote: "Analyst Check: Calculate the 3-year average loss rate. If the current rate is lower without justification, earnings are boosted.",
        data: [
          { Year: 2021, GrossAR: 110, ReportedAllow: 5.0, Rate: "4.5%" },
          { Year: 2022, GrossAR: 112, ReportedAllow: 4.0, Rate: "3.6%" },
          { Year: 2023, GrossAR: 114, ReportedAllow: 3.0, Rate: "2.6%" }
        ],
        chart: { title:"Reported Allowance Rate %", labels:["21","22","23"], series: [4.5, 3.6, 2.6] },
        answers: [
          { key:"A", text:"Under-reserved (Earnings inflated)" },
          { key:"B", text:"Over-reserved (Earnings depressed)" },
          { key:"C", text:"Neutral impact" }
        ],
        correctAnswerKey: "A",
        tags: [
          { key:"decline", text:"Reserve rate is declining while A/R grows" },
          { key:"boost", text:"Reducing the reserve creates 'paper profit'" },
          { key:"yardstick", text:"Historical average suggests higher reserve needed" }
        ],
        correctTags: ["decline","boost","yardstick"],
        riskStrength: 65,
        flagExplain: "High Signal. This is a classic 'Cookie Jar' usage‚Äîdraining the reserve to meet EPS targets. Correct is A."
      }
    ];

    /***********************
     * State
     ***********************/
    const state = {
      teams: [],
      roundIndex: -1,
      activeTeamId: null,
      selectionsByTeam: {},
      scoredRounds: new Set(),
    };
    
    const AVATARS = ["ü¶ä", "ü¶Å", "üê∏", "üêô", "ü¶Ñ", "ü§ñ", "üëΩ", "ü¶â", "üêØ", "üêº"];

    /***********************
     * DOM
     ***********************/
    const el = (id) => document.getElementById(id);

    const leaderboardEl = el("leaderboard");
    const gameMetaEl = el("gameMeta");
    const btnAddTeam = el("btnAddTeam");
    const btnStart = el("btnStart");
    const btnNext = el("btnNext");
    const btnLock = el("btnLock");
    const btnReset = el("btnReset");
    const btnHow = el("btnHow");
    const btnClose = el("btnClose");
    const modal = el("modal");
    const btnExport = el("btnExport");
    const btnCopyCase = el("btnCopyCase");

    const caseTitle = el("caseTitle");
    const casePrompt = el("casePrompt");
    const caseDifficulty = el("caseDifficulty");
    const caseFootnote = el("caseFootnote");
    const caseLens = el("caseLens");
    const dataHead = el("dataHead");
    const dataBody = el("dataBody");
    const answerArea = el("answerArea");
    const interactionCard = el("interactionCard");
    const interactionSub = el("interactionSub");
    const feedbackArea = el("feedbackArea");
    const feedbackText = el("feedbackText");
    const answerChoices = el("answerChoices");
    const tagChoices = el("tagChoices");
    const riskChoices = el("riskChoices");
    const flagBar = el("flagBar");
    const flagLabel = el("flagLabel");
    const flagExplain = el("flagExplain");
    const teamNameInput = el("teamName");
    const canvas = el("chart");
    let ctx = null;

    /***********************
     * Helpers
     ***********************/
    const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);

    function setEnabled(node, on){
      node.disabled = !on;
      node.classList.toggle("opacity-50", !on);
      node.classList.toggle("cursor-not-allowed", !on);
    }

    function roundMeta(){
      const total = CASE_BANK.length;
      const r = Math.max(0, state.roundIndex + 1);
      gameMetaEl.textContent = `Round ${r} / ${total}`;
    }

    function currentCase(){
      if (state.roundIndex < 0) return null;
      return CASE_BANK[state.roundIndex];
    }

    function renderLeaderboard(){
      leaderboardEl.innerHTML = "";
      const sorted = [...state.teams].sort((a,b)=>b.score - a.score);

      sorted.forEach(team => {
        const active = team.id === state.activeTeamId;
        const row = document.createElement("button");
        row.className = `w-full text-left rounded-2xl border px-3 py-3 flex items-center justify-between gap-3 transition-all overflow-visible
          ${active ? "border-indigo-400 bg-indigo-50 shadow-md transform scale-[1.02]" : "border-slate-100 bg-white hover:bg-slate-50"}`;
        
        row.id = `team-row-${team.id}`;
        
        row.onclick = () => { 
          state.activeTeamId = team.id; 
          ensureSelection(team.id); 
          renderLeaderboard(); 
          syncUIFromSelection(); 
        };

        const left = document.createElement("div");
        left.className = "flex items-center gap-3";
        left.innerHTML = `
          <div class="text-2xl">${team.avatar}</div>
          <div>
            <div class="font-bold text-slate-800 text-sm">${escapeHtml(team.name)}</div>
            ${active ? '<div class="text-[10px] font-bold text-indigo-600 uppercase tracking-wider">Playing Now</div>' : ''}
          </div>
        `;

        const right = document.createElement("div");
        right.className = "text-right";
        right.innerHTML = `
          <div class="mono font-black text-lg text-slate-900">${team.score}</div>
          <div class="text-[10px] text-slate-400 uppercase font-bold">pts</div>
        `;

        row.appendChild(left);
        row.appendChild(right);
        leaderboardEl.appendChild(row);
      });

      if (!state.activeTeamId && state.teams.length){
        state.activeTeamId = state.teams[0].id;
      }
    }

    function ensureSelection(teamId){
      if (!state.selectionsByTeam[teamId]) {
        state.selectionsByTeam[teamId] = { answerKey: null, tags: new Set(), risk: null };
      }
    }

    function clearSelectionsForNewRound(){
      state.selectionsByTeam = {};
      state.scoredRounds = new Set();
      if (state.activeTeamId) ensureSelection(state.activeTeamId);
    }

    function escapeHtml(str){
      return (str ?? "").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    }

    function getIdealRisk(strength){
      return strength >= 65 ? "High" : strength >= 40 ? "Med" : "Low";
    }

    function renderCase(){
      const c = currentCase();
      if (!c) return;

      // Reset Feedback UI
      feedbackArea.classList.add("hidden");
      interactionSub.textContent = "Select answer, tags, and risk level.";
      
      // Re-enable inputs if they were disabled by lock
      answerArea.querySelectorAll("button, input").forEach(el => el.disabled = false);

      caseTitle.textContent = c.title;
      casePrompt.textContent = c.prompt;
      caseDifficulty.textContent = c.difficulty;
      caseLens.textContent = `Lens: ${c.lens}`;
      caseFootnote.textContent = c.footnote;

      const strength = c.riskStrength;
      flagBar.style.width = Math.max(5, Math.min(100, strength)) + "%";
      flagBar.className = `h-full transition-all duration-1000 ease-out rounded-full ${strength > 60 ? 'bg-rose-500' : strength > 35 ? 'bg-yellow-400' : 'bg-emerald-400'}`;
      
      flagLabel.textContent = strength >= 65 ? "HIGH" : strength >= 40 ? "MEDIUM" : "LOW";
      flagExplain.textContent = c.flagExplain;

      renderTable(c.data);
      renderChart(c);
      renderAnswerUI(c);

      answerArea.classList.remove("opacity-50","pointer-events-none");
      btnLock.disabled = false;
      roundMeta();
    }

    function renderTable(rows){
      const cols = Object.keys(rows[0] || {});
      dataHead.innerHTML = `<tr>${cols.map(h=>`<th class="px-4 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">${escapeHtml(h)}</th>`).join("")}</tr>`;
      dataBody.innerHTML = rows.map(r => `
        <tr class="hover:bg-slate-50 transition-colors">
          ${cols.map(k=>`<td class="px-4 py-3 text-sm text-slate-700 font-mono">${escapeHtml(r[k])}</td>`).join("")}
        </tr>
      `).join("");
    }

    function renderChart(c){
      if (!ctx) ctx = ChartMini.fitCanvas(canvas);
      let labels = c.chart.labels;
      let series = [];
      if (c.chart.series) {
        series = c.chart.series.map(v => ({ value: v }));
      } else if (c.chart.seriesFrom) {
        const key = c.chart.seriesFrom;
        series = c.data.map(d => ({ value: Number(d[key] || 0) }));
      }
      ctx = ChartMini.fitCanvas(canvas);
      ChartMini.drawLine(ctx, labels, series);
    }

    function renderAnswerUI(c){
      answerChoices.innerHTML = "";
      c.answers.forEach(a => {
        const row = document.createElement("label");
        row.className = "flex items-center gap-3 p-4 rounded-xl border border-slate-200 bg-white hover:bg-indigo-50 hover:border-indigo-200 cursor-pointer transition-all group";
        // ID used for feedback targeting
        row.dataset.key = a.key;
        
        row.innerHTML = `
          <div class="relative flex items-center">
            <input type="radio" name="answer" value="${a.key}" class="peer h-5 w-5 border-2 border-slate-300 text-indigo-600 focus:ring-indigo-500" />
          </div>
          <div class="flex-1">
            <div class="font-bold text-slate-800 group-hover:text-indigo-900">${a.key}</div>
            <div class="text-sm text-slate-600">${escapeHtml(a.text)}</div>
          </div>
        `;
        row.querySelector("input").onchange = (e) => {
          const teamId = state.activeTeamId;
          if (!teamId) return;
          ensureSelection(teamId);
          state.selectionsByTeam[teamId].answerKey = e.target.value;
          syncUIFromSelection();
        };
        answerChoices.appendChild(row);
      });

      tagChoices.innerHTML = "";
      c.tags.forEach(t => {
        const chip = document.createElement("button");
        chip.type = "button";
        chip.className = "btn px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-xs font-semibold text-slate-600 transition-colors text-left";
        chip.textContent = t.text;
        chip.dataset.key = t.key;
        chip.onclick = () => {
          const teamId = state.activeTeamId;
          if (!teamId) return;
          ensureSelection(teamId);
          const set = state.selectionsByTeam[teamId].tags;
          if (set.has(t.key)) set.delete(t.key); else {
            if (set.size >= 3) return; 
            set.add(t.key);
          }
          syncUIFromSelection();
        };
        tagChoices.appendChild(chip);
      });

      const risks = [
        { key:"Low",  text:"Low Risk",  color:"bg-emerald-500" },
        { key:"Med",  text:"Medium Risk", color:"bg-yellow-500" },
        { key:"High", text:"High Risk", color:"bg-rose-500" }
      ];
      riskChoices.innerHTML = "";
      risks.forEach(r => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "btn px-4 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-sm font-bold text-slate-600 transition-colors";
        b.textContent = r.text;
        b.onclick = () => {
          const teamId = state.activeTeamId;
          if (!teamId) return;
          ensureSelection(teamId);
          state.selectionsByTeam[teamId].risk = r.key;
          syncUIFromSelection();
        };
        b.dataset.risk = r.key;
        riskChoices.appendChild(b);
      });
      syncUIFromSelection();
    }

    function syncUIFromSelection(){
      const c = currentCase();
      if (!c) return;
      const teamId = state.activeTeamId;
      if (!teamId) return;

      ensureSelection(teamId);
      const sel = state.selectionsByTeam[teamId];

      // Highlight selected answer container
      document.querySelectorAll('input[name="answer"]').forEach(r => {
        const isChecked = (r.value === sel.answerKey);
        r.checked = isChecked;
        const container = r.closest('label');
        if(isChecked) {
           container.classList.add('border-indigo-600', 'bg-indigo-50');
           container.classList.remove('border-slate-200', 'bg-white');
        } else {
           container.classList.remove('border-indigo-600', 'bg-indigo-50');
           container.classList.add('border-slate-200', 'bg-white');
        }
      });

      // Highlight selected tags
      [...tagChoices.children].forEach(chip => {
        const on = sel.tags.has(chip.dataset.key);
        if (on) {
          chip.classList.add('btn-selected'); 
          chip.classList.remove('bg-white', 'text-slate-600', 'border-slate-200');
        } else {
          chip.classList.remove('btn-selected');
          chip.classList.add('bg-white', 'text-slate-600', 'border-slate-200');
        }
      });

      // Highlight selected risk
      [...riskChoices.children].forEach(btn => {
        const on = (btn.dataset.risk === sel.risk);
        if (on) {
          btn.classList.add('btn-risk-selected');
          btn.classList.remove('bg-white', 'text-slate-600');
        } else {
          btn.classList.remove('btn-risk-selected');
          btn.classList.add('bg-white', 'text-slate-600');
        }
      });
    }

    function showScoreAnimation(teamId, points) {
      const row = document.getElementById(`team-row-${teamId}`);
      if (!row) return;

      const rect = row.getBoundingClientRect();
      const pop = document.createElement("div");
      pop.className = "score-pop text-2xl font-black";
      pop.textContent = `+${points}`;
      pop.style.left = (row.offsetWidth / 2) + "px";
      pop.style.top = "5px";
      
      row.appendChild(pop);
      
      setTimeout(() => {
        if (pop.parentNode) pop.parentNode.removeChild(pop);
      }, 1500);
    }

    function scoreSelection(teamId){
      const c = currentCase();
      const sel = state.selectionsByTeam[teamId];
      if (!c || !sel) return 0;
      const key = `${state.roundIndex}|${teamId}`;
      if (state.scoredRounds.has(key)) return 0;

      let pts = 0;
      if (sel.answerKey === c.correctAnswerKey) pts += 100;

      const correctTagSet = new Set(c.correctTags);
      sel.tags.forEach(t => { if (correctTagSet.has(t)) pts += 10; });

      const ideal = getIdealRisk(c.riskStrength);
      if (sel.risk){
        if (sel.risk === ideal) pts += (ideal==="High" ? 40 : ideal==="Med" ? 25 : 10);
        else if ((sel.risk==="Med" && ideal!=="Med") || (ideal==="Med" && sel.risk!=="Med")) pts += 8;
      }

      const team = state.teams.find(t=>t.id===teamId);
      if (team) {
        team.score += pts;
      }
      state.scoredRounds.add(key);
      return pts;
    }

    function revealResults(teamId) {
      const c = currentCase();
      const sel = state.selectionsByTeam[teamId];
      if (!c || !sel) return;

      // 1. Show Explanation Block
      feedbackArea.classList.remove("hidden");
      interactionSub.textContent = "Scores locked. Review the solution below.";
      feedbackText.textContent = c.flagExplain;

      // 2. Highlight Answers
      // Disable inputs
      document.querySelectorAll('input[name="answer"]').forEach(i => i.disabled = true);
      
      const answerLabels = answerChoices.children;
      for (let label of answerLabels) {
        const key = label.dataset.key;
        label.classList.remove('hover:bg-indigo-50', 'hover:border-indigo-200', 'cursor-pointer', 'bg-white', 'bg-indigo-50', 'border-indigo-600', 'border-slate-200');
        
        if (key === c.correctAnswerKey) {
          label.classList.add('answer-correct');
          // Add checkmark icon
          const div = document.createElement("div");
          div.className = "absolute -right-2 -top-2 bg-emerald-500 text-white rounded-full p-1 shadow-sm";
          div.innerHTML = `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>`;
          label.appendChild(div);
        } else if (key === sel.answerKey && key !== c.correctAnswerKey) {
          label.classList.add('answer-wrong');
        } else {
          label.classList.add('opacity-40', 'bg-slate-50', 'border-slate-100');
        }
      }

      // 3. Highlight Tags
      const correctTagSet = new Set(c.correctTags);
      const tags = tagChoices.children;
      for (let btn of tags) {
        btn.disabled = true;
        const key = btn.dataset.key;
        const isSelected = sel.tags.has(key);
        const isCorrect = correctTagSet.has(key);

        btn.classList.remove('btn-selected', 'bg-white', 'text-slate-600', 'border-slate-200', 'hover:bg-slate-50');

        if (isCorrect) {
          // Highlight correct tags in green (even if missed)
          if (isSelected) {
            btn.classList.add('tag-correct');
          } else {
            btn.classList.add('tag-missed');
          }
        } else if (isSelected && !isCorrect) {
          // Wrong selection
          btn.classList.add('bg-rose-100', 'text-rose-700', 'border-rose-200', 'opacity-70');
        } else {
          // Irrelevant
          btn.classList.add('opacity-30', 'bg-slate-50');
        }
      }

      // 4. Highlight Risk
      const idealRisk = getIdealRisk(c.riskStrength);
      const riskBtns = riskChoices.children;
      for (let btn of riskBtns) {
        btn.disabled = true;
        const riskKey = btn.dataset.risk;
        const isSelected = (sel.risk === riskKey);
        
        btn.classList.remove('btn-risk-selected', 'bg-white', 'text-slate-600', 'hover:bg-slate-50');

        if (riskKey === idealRisk) {
          btn.classList.add('bg-slate-800', 'text-white', 'ring-2', 'ring-emerald-400', 'ring-offset-2');
        } else if (isSelected && riskKey !== idealRisk) {
          btn.classList.add('bg-slate-200', 'text-slate-400', 'line-through');
        } else {
          btn.classList.add('opacity-30', 'bg-slate-50');
        }
      }
    }

    function toCSV(rows){
      const cols = Object.keys(rows[0] || {});
      const esc = v => `"${String(v ?? "").replaceAll('"','""')}"`;
      const lines = [
        cols.map(esc).join(","),
        ...rows.map(r => cols.map(k=>esc(r[k])).join(","))
      ];
      return lines.join("\n");
    }

    /***********************
     * Events
     ***********************/
    btnHow.onclick = () => { modal.classList.remove("hidden"); modal.classList.add("flex"); };
    btnClose.onclick = () => { modal.classList.add("hidden"); modal.classList.remove("flex"); };
    modal.onclick = (e) => { if (e.target === modal) { modal.classList.add("hidden"); modal.classList.remove("flex"); } };

    btnAddTeam.onclick = () => {
      const name = (teamNameInput.value || "").trim();
      if (!name) return;
      const av = AVATARS[Math.floor(Math.random() * AVATARS.length)];
      state.teams.push({ id: uid(), name, avatar: av, score: 0 });
      teamNameInput.value = "";
      if (!state.activeTeamId) state.activeTeamId = state.teams[state.teams.length-1].id;
      renderLeaderboard();
      setEnabled(btnStart, state.teams.length >= 1);
    };

    btnStart.onclick = () => {
      if (state.teams.length < 1) return;
      state.roundIndex = 0;
      clearSelectionsForNewRound();
      renderLeaderboard();
      renderCase();
      setEnabled(btnNext, true);
      setEnabled(btnLock, true);
      setEnabled(btnStart, false);
      setEnabled(btnAddTeam, false);
      teamNameInput.disabled = true;
    };

    btnNext.onclick = () => {
      if (state.roundIndex < 0) return;
      if (state.roundIndex >= CASE_BANK.length - 1) {
        caseTitle.textContent = "üéâ Game Over ‚Äî Final Scores";
        casePrompt.textContent = "Check the leaderboard to see who won!";
        feedbackArea.classList.add("hidden");
        answerArea.classList.add("hidden");
        setEnabled(btnNext, false);
        return;
      }
      state.roundIndex += 1;
      clearSelectionsForNewRound();
      renderCase();
      renderLeaderboard();
      syncUIFromSelection();
    };

    btnLock.onclick = () => {
      const teamId = state.activeTeamId;
      if (!teamId) return;
      ensureSelection(teamId);
      const sel = state.selectionsByTeam[teamId];
      if (!sel.answerKey) { alert("‚ö†Ô∏è Please select an answer first."); return; }

      // 1. Calculate Score
      const gained = scoreSelection(teamId);
      
      // 2. Render Leaderboard
      renderLeaderboard(); 

      // 3. Trigger Animation
      requestAnimationFrame(() => {
        showScoreAnimation(teamId, gained);
      });

      // 4. Reveal Visual Feedback (NEW)
      revealResults(teamId);
      btnLock.disabled = true;
    };

    btnReset.onclick = () => {
      if (!confirm("Reset the whole game?")) return;
      state.teams = [];
      state.roundIndex = -1;
      state.activeTeamId = null;
      state.selectionsByTeam = {};
      state.scoredRounds = new Set();
      renderLeaderboard();
      renderCase();
      roundMeta();
      setEnabled(btnStart, false);
      setEnabled(btnNext, false);
      setEnabled(btnLock, false);
      setEnabled(btnAddTeam, true);
      teamNameInput.disabled = false;
      answerArea.classList.remove("hidden");
      
      // Reset texts
      caseTitle.textContent = "Add a team to begin.";
      casePrompt.textContent = "Get ready to analyze the data.";
    };
    
    // Stored script URL to prevent hardcoding issues
    const googleScriptUrl = "https://script.google.com/macros/s/AKfycbxNX7FoRk0gUz9mJkPIlB4cIEqQP2xZ_6MK9BTUHt__5gtpx2dCWk6AUXVh0-XWM3zo/exec";

    btnExport.onclick = () => {
      const payload = { roundIndex: state.roundIndex, teams: state.teams };
      const btn = btnExport;
      const originalText = btn.innerText;
      btn.innerText = "Sending...";
      btn.disabled = true;

      fetch(googleScriptUrl, {
        method: "POST", mode: "no-cors", 
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      })
      .then(() => { alert("‚úÖ Request Sent!"); })
      .catch((err) => { 
        console.error(err); 
        alert("‚ùå Error sending data.");
      })
      .finally(() => { btn.innerText = originalText; btn.disabled = false; });
    };

    btnCopyCase.onclick = async () => {
      const c = currentCase();
      if (!c) return;
      const csv = toCSV(c.data);
      try { await navigator.clipboard.writeText(csv); alert("Dataset copied!"); } catch { alert("Clipboard blocked."); }
    };

    window.addEventListener("resize", () => { if (currentCase()) renderChart(currentCase()); });

    /***********************
     * Init
     ***********************/
    renderLeaderboard();
    renderCase();
    roundMeta();
    setEnabled(btnStart, false);
    setEnabled(btnNext, false);
    setEnabled(btnLock, false);
  </script>
</body>
</html>