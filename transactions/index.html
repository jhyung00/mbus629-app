<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accounting Simulator: Instructor Edition</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            background-color: #1a1a2e;
            color: #e2e8f0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Animation classes */
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .sticky-toolbar {
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        /* Statement Styles */
        .statement-paper {
            background-color: #fff;
            color: #1e293b;
            padding: 2rem;
            border-radius: 4px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-bottom: 2rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        .statement-header {
            text-align: center;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #334155;
            padding-bottom: 1rem;
        }
        .statement-header h2 { font-size: 1.5rem; font-weight: 800; color: #0f172a; }
        .statement-header h3 { font-size: 1.1rem; font-weight: 600; color: #475569; }
        .statement-header p { font-size: 0.9rem; color: #64748b; italic; }
        
        .statement-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px dashed #e2e8f0;
        }
        .statement-row.total {
            font-weight: 800;
            border-top: 2px solid #0f172a;
            border-bottom: 4px double #0f172a;
            padding-top: 0.75rem;
            margin-top: 0.5rem;
        }
        .statement-row.subtotal {
            font-weight: 600;
            border-top: 1px solid #334155;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
        }
        .statement-sub-header {
            font-weight: 700;
            color: #475569;
            margin-top: 1rem;
            border-bottom: 1px solid #cbd5e1;
            padding-bottom: 0.25rem;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICONS ---
        const Icon = ({ name, size = 16, className }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- DATA ---
        const COMPANY_NAME = "Summit Enterprises, Inc.";

        const ACCOUNT_OPTIONS = [
            "", "Cash", "Accounts Receivable", "Prepaid Insurance", "Supplies", 
            "Truck", "Equipment", "Accum. Depr: Truck", "Accum. Depr: Equipment",
            "Accounts Payable", "Unearned Revenue", "Common Stock", "Retained Earnings",
            "Service Revenue", "Wages Expense", "Advertising Expense", "Fuel Expense", 
            "Insurance Expense", "Supplies Expense", "Depr. Expense-Truck", "Depr. Expense-Equip"
        ];

        // Correct Answers Config
        const TRANSACTIONS_CONFIG = [
            { id: 1, text: "Apr 1: Roulstone contributed $11,500 cash for stock.", correct: { cash: 11500, noncash: 0, liab: 0, cc: 11500, ec: 0, rev: 0, exp: 0 } },
            { id: 2, text: "Apr 2: Paid $6,100 cash for a used truck.", correct: { cash: -6100, noncash: 6100, liab: 0, cc: 0, ec: 0, rev: 0, exp: 0 } },
            { id: 3, text: "Apr 2: Purchased $6,200 equipment; paid $1,000 cash, rest AP.", correct: { cash: -1000, noncash: 6200, liab: 5200, cc: 0, ec: 0, rev: 0, exp: 0 } },
            { id: 4, text: "Apr 3: Paid $2,880 cash for 24-mo insurance.", correct: { cash: -2880, noncash: 2880, liab: 0, cc: 0, ec: 0, rev: 0, exp: 0 } },
            { id: 5, text: "Apr 5: Purchased $1,200 supplies on credit.", correct: { cash: 0, noncash: 1200, liab: 1200, cc: 0, ec: 0, rev: 0, exp: 0 } },
            { id: 6, text: "Apr 5: Received $1,800 cash advance for future work.", correct: { cash: 1800, noncash: 0, liab: 1800, cc: 0, ec: 0, rev: 0, exp: 0 } },
            { id: 7, text: "Apr 12: Billed customers $5,500 for services.", correct: { cash: 0, noncash: 5500, liab: 0, cc: 0, ec: 0, rev: 5500, exp: 0 } },
            { id: 8, text: "Apr 18: Collected $4,900 from Apr 12 customers.", correct: { cash: 4900, noncash: -4900, liab: 0, cc: 0, ec: 0, rev: 0, exp: 0 } },
            { id: 9, text: "Apr 29: Paid $675 cash for fuel.", correct: { cash: -675, noncash: 0, liab: 0, cc: 0, ec: 0, rev: 0, exp: 675 } },
            { id: 10, text: "Apr 30: Paid $100 cash for advertising.", correct: { cash: -100, noncash: 0, liab: 0, cc: 0, ec: 0, rev: 0, exp: 100 } },
            { id: 11, text: "Apr 30: Paid $4,500 cash for wages.", correct: { cash: -4500, noncash: 0, liab: 0, cc: 0, ec: 0, rev: 0, exp: 4500 } },
            { id: 12, text: "Apr 30: Billed customers $4,000 for services.", correct: { cash: 0, noncash: 4000, liab: 0, cc: 0, ec: 0, rev: 4000, exp: 0 } },
            // Adjusting Entries
            { id: 13, text: "Adj: Record insurance expense for the month. (Policy: $2,880 for 24 mo).", correct: { cash: 0, noncash: -120, liab: 0, cc: 0, ec: 0, rev: 0, exp: 120 } },
            { id: 14, text: "Adj: Supplies count at month-end shows $200 remaining.", correct: { cash: 0, noncash: -1000, liab: 0, cc: 0, ec: 0, rev: 0, exp: 1000 } },
            { id: 15, text: "Adj: Depreciation on Truck is $125.", correct: { cash: 0, noncash: -125, liab: 0, cc: 0, ec: 0, rev: 0, exp: 125 } },
            { id: 16, text: "Adj: Depreciation on Equipment is $35.", correct: { cash: 0, noncash: -35, liab: 0, cc: 0, ec: 0, rev: 0, exp: 35 } },
            { id: 17, text: "Adj: 25% of the work related to the Apr 5 advance has been performed.", correct: { cash: 0, noncash: 0, liab: -450, cc: 0, ec: 0, rev: 450, exp: 0 } },
        ];

        const ERROR_SCENARIOS_CONFIG = [
            { 
                id: 'e1', 
                company: 'Blue Ridge Bike Co.', 
                desc: 'Failed to record payment of $8,400 for utilities accrued in prior period.',
                correct: { asset: 'Overstated', liab: 'Overstated', eq: 'No Effect', ni: 'No Effect' }
            },
            { 
                id: 'e2', 
                company: 'Juniper Robotics, Inc.', 
                desc: 'Failed to record purchase of $15,000 equipment by issuing common stock.',
                correct: { asset: 'Understated', liab: 'No Effect', eq: 'Understated', ni: 'No Effect' }
            },
            { 
                id: 'e3', 
                company: 'Orion Consulting, LLC', 
                desc: 'Failed to record receipt of utility bill for $925 (to be paid next month).',
                correct: { asset: 'No Effect', liab: 'Understated', eq: 'Overstated', ni: 'Overstated' }
            }
        ];

        const QUIZ_CONCEPTS_CONFIG = [
            {
                id: 'q1',
                question: "The 'Net Income' calculated in the Income Statement flows directly into which other statement?",
                options: ["Balance Sheet (Assets)", "Statement of Stockholders' Equity", "Statement of Cash Flows (Investing)", "It does not flow anywhere"],
                correct: "Statement of Stockholders' Equity"
            },
            {
                id: 'q2',
                question: "On the Balance Sheet, the 'Total Assets' figure must always equal:",
                options: ["Total Liabilities", "Total Equity", "Total Liabilities + Total Equity", "Cash + Revenue"],
                correct: "Total Liabilities + Total Equity"
            },
            {
                id: 'q3',
                question: "The 'Ending Cash Balance' on the Statement of Cash Flows must match:",
                options: ["Cash on the Balance Sheet", "Net Income on the Income Statement", "Retained Earnings on the Equity Statement", "Total Revenue"],
                correct: "Cash on the Balance Sheet"
            }
        ];

        // --- COMPONENT: SMART INPUT ---
        const SmartInput = ({ 
            value, 
            onChange, 
            correctValue, 
            isPct = false, 
            instructorMode,
            placeholder = "0"
        }) => {
            const [localVal, setLocalVal] = useState(value || "");
            const [isValid, setIsValid] = useState(null);

            useEffect(() => {
                setLocalVal(value === 0 || value ? value : "");
                if (value === "" || value === undefined) setIsValid(null);
                else validate(value);
            }, [value]);

            const validate = (val) => {
                if (val === "" || val === null || val === undefined) {
                    setIsValid(null);
                    return;
                }
                const numVal = parseFloat(val);
                if (isNaN(numVal)) {
                    setIsValid(false);
                    return;
                }
                const target = parseFloat(correctValue);
                if (isNaN(target)) return;

                let valid = false;
                if (Math.abs(numVal - target) < 0.01) valid = true;
                else if (target !== 0 && Math.abs((numVal - target) / target) <= 0.02) valid = true;
                
                if (!valid && isPct) {
                    const altVal = numVal / 100;
                    if (Math.abs(altVal - target) < 0.001) valid = true;
                }
                setIsValid(valid);
            };

            const handleBlur = () => {
                let processedVal = localVal;
                if (typeof localVal === 'string' && localVal.match(/[+\-*\/]/)) {
                    try {
                        const result = Function('"use strict";return (' + localVal.replace(/[^0-9+\-*\/.\(\)]/g, '') + ')')();
                        if (isFinite(result)) {
                            processedVal = parseFloat(result.toFixed(2));
                            onChange(processedVal);
                        }
                    } catch (e) {}
                }
                validate(processedVal);
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') e.target.blur();
            };

            let borderClass = "border-slate-600 focus:border-blue-500";
            if (isValid === true) borderClass = "border-green-500 bg-green-900/20";
            else if (isValid === false) borderClass = "border-red-500 bg-red-900/20";

            return (
                <div className="relative w-full">
                    <input
                        type="text"
                        className={`w-full px-2 py-1 text-right rounded bg-[#16213e] text-white border outline-none transition-colors ${borderClass}`}
                        value={localVal}
                        onChange={(e) => { setLocalVal(e.target.value); onChange(e.target.value); }}
                        onBlur={handleBlur}
                        onKeyDown={handleKeyDown}
                        placeholder={placeholder}
                    />
                    {isValid === true && (
                        <div className="absolute right-1 top-1.5 text-green-500 pointer-events-none">
                            <Icon name="check" size={12} />
                        </div>
                    )}
                    {instructorMode && (
                        <div className="mt-1 text-xs font-bold text-center bg-purple-900/50 text-purple-200 border border-purple-500/30 rounded py-0.5 fade-in">
                            Key: {correctValue}
                        </div>
                    )}
                </div>
            );
        };

        // --- COMPONENT: APP ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('transactions');
            
            // Initial State Generators
            const getInitialTransactions = () => TRANSACTIONS_CONFIG.map(t => ({
                ...t,
                userValues: { cash: '', noncash: '', liab: '', cc: '', ec: '', rev: '', exp: '' },
                userAccounts: { cash: '', noncash: '', liab: '', cc: '', ec: '', rev: '', exp: '' }
            }));
            
            const getInitialErrors = () => ERROR_SCENARIOS_CONFIG.map(e => ({
                ...e,
                userSelects: { asset: '', liab: '', eq: '', ni: '' }
            }));

            const [transactions, setTransactions] = useState(getInitialTransactions());
            const [errorScenarios, setErrorScenarios] = useState(getInitialErrors());
            const [quizAnswers, setQuizAnswers] = useState({});
            const [quizTracing, setQuizTracing] = useState({ ni: '', assets: '', re: '', cash_op: '' });

            // Instructor State
            const [showAuthModal, setShowAuthModal] = useState(false);
            const [isInstructor, setIsInstructor] = useState(false);
            const [authError, setAuthError] = useState('');
            const [teacherPass, setTeacherPass] = useState('');
            
            // Modal States
            const [confirmation, setConfirmation] = useState({ isOpen: false, message: '', onConfirm: null });
            const [showDownloadModal, setShowDownloadModal] = useState(false);
            const [studentName, setStudentName] = useState('');
            
            // Instructor Tools State
            const [verifyHash, setVerifyHash] = useState('');
            const [verifyResult, setVerifyResult] = useState(null);
            const [genName, setGenName] = useState('');
            const [genScore, setGenScore] = useState('');
            const [generatedHash, setGeneratedHash] = useState('');

            // --- COMPUTED TOTALS ---
            const totals = useMemo(() => {
                const sums = { cash: 0, noncash: 0, liab: 0, cc: 0, ec: 0, rev: 0, exp: 0, ni: 0 };
                transactions.forEach(t => {
                    const rRev = parseFloat(t.userValues.rev) || 0;
                    const rExp = parseFloat(t.userValues.exp) || 0;
                    const rNI = rRev - rExp;
                    
                    sums.cash += parseFloat(t.userValues.cash) || 0;
                    sums.noncash += parseFloat(t.userValues.noncash) || 0;
                    sums.liab += parseFloat(t.userValues.liab) || 0;
                    sums.cc += parseFloat(t.userValues.cc) || 0;
                    const directEC = parseFloat(t.userValues.ec) || 0;
                    sums.ec += directEC + rNI; 
                    sums.rev += rRev;
                    sums.exp += rExp;
                    sums.ni += rNI;
                });
                return sums;
            }, [transactions]);

            const isBalanced = useMemo(() => {
                const assets = totals.cash + totals.noncash;
                const claims = totals.liab + totals.cc + totals.ec;
                return Math.abs(assets - claims) < 0.05 && assets !== 0;
            }, [totals]);

            // --- BALANCE SHEET DETAILS ---
            const balanceSheetDetails = useMemo(() => {
                const assets = { "Cash": totals.cash };
                const liabilities = {};

                transactions.forEach(t => {
                    // Aggregate Non-Cash Assets
                    const valNC = parseFloat(t.userValues.noncash);
                    if (valNC && valNC !== 0) {
                        const accountName = t.userAccounts.noncash || "Uncategorized Assets";
                        assets[accountName] = (assets[accountName] || 0) + valNC;
                    }

                    // Aggregate Liabilities
                    const valLiab = parseFloat(t.userValues.liab);
                    if (valLiab && valLiab !== 0) {
                        const accountName = t.userAccounts.liab || "Uncategorized Liabilities";
                        liabilities[accountName] = (liabilities[accountName] || 0) + valLiab;
                    }
                });

                return { assets, liabilities };
            }, [transactions, totals.cash]);

            // --- CASH FLOW DETAILS ---
            const cashFlowDetails = useMemo(() => {
                let operating = { receipts: 0, payments: 0, total: 0 };
                let investing = { total: 0 };
                let financing = { total: 0 };

                transactions.forEach(t => {
                    const valCash = parseFloat(t.userValues.cash) || 0;
                    if (valCash === 0) return;

                    // Categorization based on IDs
                    if (t.id === 1) {
                        // Financing: Stock
                        financing.total += valCash;
                    } else if (t.id === 2 || t.id === 3) {
                        // Investing: Truck, Equip
                        investing.total += valCash;
                    } else {
                        // Operating: Everything else
                        if (valCash > 0) operating.receipts += valCash;
                        else operating.payments += valCash;
                        operating.total += valCash;
                    }
                });

                return { operating, investing, financing };
            }, [transactions]);

            // --- HANDLERS ---
            const handleTransactionChange = (id, field, value) => {
                setTransactions(prev => prev.map(t => t.id === id ? {
                    ...t,
                    userValues: { ...t.userValues, [field]: value }
                } : t));
            };

            const handleAccountChange = (id, field, value) => {
                setTransactions(prev => prev.map(t => t.id === id ? {
                    ...t,
                    userAccounts: { ...t.userAccounts, [field]: value }
                } : t));
            };

            const handleErrorSelect = (id, field, value) => {
                setErrorScenarios(prev => prev.map(e => e.id === id ? {
                    ...e,
                    userSelects: { ...e.userSelects, [field]: value }
                } : e));
            };

            const handleQuizAnswer = (id, val) => {
                setQuizAnswers(prev => ({ ...prev, [id]: val }));
            };

            const handleTracingChange = (field, val) => {
                setQuizTracing(prev => ({ ...prev, [field]: val }));
            };

            // --- INSTRUCTOR ACTIONS ---
            const attemptLogin = () => {
                if (teacherPass.toLowerCase() === 'teacher') {
                    setIsInstructor(true);
                    setShowAuthModal(false);
                    setAuthError('');
                    setTeacherPass('');
                } else {
                    setAuthError('Incorrect Password');
                }
            };

            const autoFill = () => {
                const filled = transactions.map(t => {
                    let accts = { ...t.userAccounts };
                    
                    if(t.correct.noncash !== 0) {
                        if(t.text.includes("truck")) accts.noncash = "Truck";
                        else if(t.text.includes("equipment") || t.text.includes("Equipment")) accts.noncash = "Equipment";
                        else if(t.text.includes("supplies") || t.text.includes("Supplies")) accts.noncash = "Supplies";
                        else if(t.text.includes("insurance") || t.text.includes("Insurance")) accts.noncash = "Prepaid Insurance";
                        else if(t.text.includes("Billed")) accts.noncash = "Accounts Receivable";
                        else if(t.text.includes("Depreciation")) {
                             if(t.text.includes("Truck")) accts.noncash = "Accum. Depr: Truck";
                             else accts.noncash = "Accum. Depr: Equipment";
                        }
                    }
                    if(t.correct.liab !== 0) {
                        if(t.text.includes("AP") || t.text.includes("supplies") || t.text.includes("equipment")) accts.liab = "Accounts Payable";
                        else if(t.text.includes("advance") || t.text.includes("Fees earned")) accts.liab = "Unearned Revenue";
                    }

                    return {
                        ...t,
                        userValues: { 
                            cash: t.correct.cash || '', 
                            noncash: t.correct.noncash || '',
                            liab: t.correct.liab || '',
                            cc: t.correct.cc || '',
                            ec: t.correct.ec || '',
                            rev: t.correct.rev || '',
                            exp: t.correct.exp || ''
                        },
                        userAccounts: accts
                    }
                });
                setTransactions(filled);
                const filledErrors = errorScenarios.map(e => ({
                    ...e,
                    userSelects: { ...e.correct }
                }));
                setErrorScenarios(filledErrors);

                // Fill Quiz
                const filledQuiz = {};
                QUIZ_CONCEPTS_CONFIG.forEach(q => filledQuiz[q.id] = q.correct);
                setQuizAnswers(filledQuiz);
            };

            const performClear = () => {
                setTransactions(getInitialTransactions());
                setErrorScenarios(getInitialErrors());
                setQuizAnswers({});
                setQuizTracing({ ni: '', assets: '', re: '', cash_op: '' });
                setIsInstructor(false);
                setConfirmation({ isOpen: false, message: '', onConfirm: null });
            };

            const clearAll = () => {
                setConfirmation({
                    isOpen: true,
                    message: "Are you sure you want to clear all student work and exit Instructor Mode?",
                    onConfirm: performClear
                });
            };

            // --- DOWNLOAD REPORT LOGIC ---
            const handleDownloadClick = () => {
                setShowDownloadModal(true);
            };

            const executeDownload = () => {
                try {
                    const name = studentName || "Student";
                    const score = isBalanced ? "Balanced" : "Unbalanced";
                    const payload = JSON.stringify({
                        name: name,
                        score: score,
                        ni: totals.ni,
                        timestamp: new Date().toLocaleString()
                    });
                    
                    const hash = btoa(payload);

                    let quizReport = "";
                    QUIZ_CONCEPTS_CONFIG.forEach(q => {
                        quizReport += `Q: ${q.question}\nA: ${quizAnswers[q.id] || "No Answer"}\n\n`;
                    });
                    quizReport += `Trace NI: ${quizTracing.ni}\nTrace Assets: ${quizTracing.assets}\nTrace RE: ${quizTracing.re}\nTrace Cash Op: ${quizTracing.cash_op}`;

                    const reportContent = `
ACCOUNTING SIMULATION REPORT
Student: ${name}
Date: ${new Date().toLocaleString()}
Status: ${score}

-- TRANSACTION TOTALS --
Cash: ${totals.cash}
Non-Cash Assets: ${totals.noncash}
Liabilities: ${totals.liab}
Contributed Capital: ${totals.cc}
Earned Capital: ${totals.ec}
Revenue: ${totals.rev}
Expenses: ${totals.exp}
Net Income: ${totals.ni}

-- FINANCIAL STATEMENTS SUMMARY --
Total Assets: ${totals.cash + totals.noncash}
Total Liabilities: ${totals.liab}
Total Equity: ${totals.cc + totals.ec}
Net Cash Flow: ${totals.cash}

-- QUIZ RESULTS --
${quizReport}

-- ERROR ANALYSIS SECTION --
${errorScenarios.map(e => `${e.company}: Assets[${e.userSelects.asset}], Liab[${e.userSelects.liab}], Eq[${e.userSelects.eq}], NI[${e.userSelects.ni}]`).join('\n')}

-- VERIFICATION CODE --
${hash}
                    `.trim();

                    const blob = new Blob([reportContent], {type: 'text/plain'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${name.replace(/[^a-z0-9]/gi, '_')}_Accounting_Report.txt`;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        setShowDownloadModal(false);
                        setStudentName('');
                    }, 100);
                } catch(e) {
                    alert("Error downloading report: " + e.message);
                }
            };

            // --- VERIFICATION TOOLS ---
            const verifyCode = () => {
                try {
                    const decoded = atob(verifyHash);
                    const json = JSON.parse(decoded);
                    setVerifyResult(json);
                } catch (e) {
                    setVerifyResult({ error: "Invalid Hash Code" });
                }
            };
            
            const generateHash = () => {
                if(!genName || !genScore) return;
                const payload = JSON.stringify({
                    name: genName,
                    score: genScore,
                    timestamp: new Date().toLocaleString(),
                    verified: true
                });
                setGeneratedHash(btoa(payload));
            };

            // Helpers for formatting
            const formatCurrency = (val) => {
                return (val || 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            };

            return (
                <div className="min-h-screen pb-20 relative">
                    {/* Header */}
                    <div className="bg-slate-900 border-b border-slate-700 p-4">
                        <div className="max-w-7xl mx-auto flex justify-between items-center">
                            <h1 className="text-2xl font-bold text-blue-400">Accounting Simulator <span className="text-slate-500 text-sm font-normal">v2.4</span></h1>
                            <button 
                                onClick={() => setShowAuthModal(true)}
                                className="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded text-slate-300 transition-colors border border-slate-600"
                            >
                                <Icon name="lock" size={16} />
                                <span className="font-semibold">Instructor Access</span>
                            </button>
                        </div>
                    </div>

                    {/* INSTRUCTOR STICKY TOOLBAR */}
                    {isInstructor && (
                        <div className="sticky-toolbar bg-purple-900/95 text-white p-3 backdrop-blur-md border-b-4 border-purple-500 fade-in">
                            <div className="max-w-7xl mx-auto flex flex-wrap justify-between items-center gap-4">
                                <div className="flex items-center gap-2">
                                    <Icon name="shield-check" className="text-green-400" />
                                    <span className="font-bold text-lg">Instructor Mode Active</span>
                                </div>
                                <div className="flex gap-3">
                                    <button onClick={autoFill} className="bg-blue-600 hover:bg-blue-500 px-4 py-1.5 rounded font-bold shadow-lg flex items-center gap-2">
                                        <Icon name="wand-2" size={16} /> Auto-Fill All
                                    </button>
                                    <button onClick={clearAll} className="bg-red-600 hover:bg-red-500 px-4 py-1.5 rounded font-bold shadow-lg flex items-center gap-2">
                                        <Icon name="trash-2" size={16} /> Clear & Exit
                                    </button>
                                </div>
                            </div>
                            
                            {/* Verification Tools Panel */}
                            <div className="max-w-7xl mx-auto mt-3 pt-3 border-t border-purple-700 grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                                {/* Verifier */}
                                <div className="flex gap-2 items-center bg-purple-950/50 p-2 rounded">
                                    <input 
                                        value={verifyHash} 
                                        onChange={e => setVerifyHash(e.target.value)} 
                                        placeholder="Paste Student Verification Hash..." 
                                        className="bg-purple-900 text-white px-2 py-1 rounded border border-purple-600 flex-1 outline-none"
                                    />
                                    <button onClick={verifyCode} className="bg-green-600 px-3 py-1 rounded text-white">Verify</button>
                                    {verifyResult && (
                                        <div className="ml-2 text-xs">
                                            {verifyResult.error ? <span className="text-red-300">{verifyResult.error}</span> : 
                                                <span className="text-green-300 font-bold">
                                                    {verifyResult.name} | Score: {verifyResult.score} | {verifyResult.timestamp}
                                                </span>
                                            }
                                        </div>
                                    )}
                                </div>
                                {/* Generator */}
                                <div className="flex gap-2 items-center bg-purple-950/50 p-2 rounded">
                                    <input value={genName} onChange={e => setGenName(e.target.value)} placeholder="Name" className="w-20 bg-purple-900 px-2 py-1 rounded border border-purple-600" />
                                    <input value={genScore} onChange={e => setGenScore(e.target.value)} placeholder="Score" className="w-16 bg-purple-900 px-2 py-1 rounded border border-purple-600" />
                                    <button onClick={generateHash} className="bg-blue-600 px-3 py-1 rounded text-white text-xs">Gen Hash</button>
                                    {generatedHash && <span className="ml-2 font-mono text-xs bg-black px-2 py-1 rounded select-all cursor-pointer" onClick={() => navigator.clipboard.writeText(generatedHash)} title="Click to copy">{generatedHash.substring(0,10)}...</span>}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Main Content */}
                    <div className="max-w-[1600px] mx-auto p-6">
                        {/* Tabs */}
                        <div className="flex justify-center gap-4 mb-8">
                            <button 
                                onClick={() => setActiveTab('transactions')}
                                className={`px-6 py-3 rounded-lg font-bold text-lg transition-all ${activeTab === 'transactions' ? 'bg-blue-600 text-white shadow-lg scale-105' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
                            >
                                1. Transaction Analysis
                            </button>
                            <button 
                                onClick={() => setActiveTab('errors')}
                                className={`px-6 py-3 rounded-lg font-bold text-lg transition-all ${activeTab === 'errors' ? 'bg-blue-600 text-white shadow-lg scale-105' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
                            >
                                2. Impact of Errors
                            </button>
                            <button 
                                onClick={() => setActiveTab('statements')}
                                className={`px-6 py-3 rounded-lg font-bold text-lg transition-all ${activeTab === 'statements' ? 'bg-blue-600 text-white shadow-lg scale-105' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
                            >
                                3. Financial Statements
                            </button>
                            <button 
                                onClick={() => setActiveTab('quiz')}
                                className={`px-6 py-3 rounded-lg font-bold text-lg transition-all ${activeTab === 'quiz' ? 'bg-blue-600 text-white shadow-lg scale-105' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
                            >
                                4. Articulation Quiz
                            </button>
                        </div>

                        {/* TRANSACTION TAB */}
                        {activeTab === 'transactions' && (
                            <div className="overflow-x-auto bg-[#252540] rounded-xl shadow-2xl border border-slate-700 p-4 animate-fade-in">
                                <table className="w-full border-collapse min-w-[1200px]">
                                    <thead>
                                        <tr className="bg-[#0f172a] text-blue-200">
                                            <th className="p-3 text-left border border-slate-700 sticky left-0 z-10 bg-[#0f172a]" rowSpan="2">Transaction</th>
                                            <th className="border border-slate-700 text-center" colSpan="2">ASSETS</th>
                                            <th className="w-8 text-center font-bold text-slate-500">=</th>
                                            <th className="border border-slate-700 text-center">LIAB</th>
                                            <th className="w-8 text-center font-bold text-slate-500">+</th>
                                            <th className="border border-slate-700 text-center" colSpan="2">EQUITY</th>
                                            <th className="w-1 bg-slate-600 p-0"></th>
                                            <th className="border border-slate-700 text-center" colSpan="3">INCOME STATEMENT</th>
                                        </tr>
                                        <tr className="bg-[#1e293b] text-xs text-slate-400">
                                            <th className="p-2 border border-slate-700 w-28">Cash</th>
                                            <th className="p-2 border border-slate-700 w-28">Non-Cash</th>
                                            <th></th>
                                            <th className="p-2 border border-slate-700 w-28">Liabilities</th>
                                            <th></th>
                                            <th className="p-2 border border-slate-700 w-28">Cont. Cap</th>
                                            <th className="p-2 border border-slate-700 w-28">Earn. Cap</th>
                                            <th className="w-1 bg-slate-600 p-0"></th>
                                            <th className="p-2 border border-slate-700 w-28">Revenue</th>
                                            <th className="p-2 border border-slate-700 w-28">Expense</th>
                                            <th className="p-2 border border-slate-700 w-24">Net Inc</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {transactions.map((t, idx) => (
                                            <tr key={t.id} className="hover:bg-slate-800/50 transition-colors border-b border-slate-700/50">
                                                <td className="p-3 text-sm text-slate-300 border-r border-slate-700 sticky left-0 bg-[#252540] z-10 w-64">
                                                    <span className="font-bold text-blue-400 mr-2">{t.id}.</span>{t.text}
                                                </td>
                                                
                                                {/* Input Columns */}
                                                {['cash', 'noncash', 'liab', 'cc', 'ec'].map(field => (
                                                    <React.Fragment key={field}>
                                                        {field === 'liab' && <td className="text-center text-slate-600 font-bold">=</td>}
                                                        {field === 'cc' && <td className="text-center text-slate-600 font-bold">+</td>}
                                                        
                                                        <td className="p-2 border-r border-slate-700/50">
                                                            <SmartInput 
                                                                value={t.userValues[field]} 
                                                                onChange={(val) => handleTransactionChange(t.id, field, val)}
                                                                correctValue={t.correct[field]}
                                                                instructorMode={isInstructor}
                                                            />
                                                            <select 
                                                                className="w-full mt-1 bg-slate-900 text-xs text-slate-400 rounded border border-slate-700 p-1"
                                                                value={t.userAccounts[field]}
                                                                onChange={(e) => handleAccountChange(t.id, field, e.target.value)}
                                                            >
                                                                {ACCOUNT_OPTIONS.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                                            </select>
                                                        </td>
                                                    </React.Fragment>
                                                ))}

                                                <td className="w-1 bg-slate-600 p-0"></td>

                                                {/* Income Statement Columns */}
                                                {['rev', 'exp'].map(field => (
                                                    <td key={field} className="p-2 border-r border-slate-700/50">
                                                        <SmartInput 
                                                            value={t.userValues[field]} 
                                                            onChange={(val) => handleTransactionChange(t.id, field, val)}
                                                            correctValue={t.correct[field]}
                                                            instructorMode={isInstructor}
                                                        />
                                                        <select 
                                                            className="w-full mt-1 bg-slate-900 text-xs text-slate-400 rounded border border-slate-700 p-1"
                                                            value={t.userAccounts[field]}
                                                            onChange={(e) => handleAccountChange(t.id, field, e.target.value)}
                                                        >
                                                            {ACCOUNT_OPTIONS.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                                        </select>
                                                    </td>
                                                ))}

                                                {/* Computed NI */}
                                                <td className="p-2 text-center">
                                                    <div className={`py-1 px-2 rounded font-bold ${
                                                        (parseFloat(t.userValues.rev) || 0) - (parseFloat(t.userValues.exp) || 0) !== 0 ? 'bg-slate-700 text-white' : 'text-slate-600'
                                                    }`}>
                                                        {((parseFloat(t.userValues.rev) || 0) - (parseFloat(t.userValues.exp) || 0)) || '-'}
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                    <tfoot>
                                        <tr className={`font-bold text-lg ${isBalanced ? 'bg-green-900/30 text-green-400' : 'bg-red-900/30 text-orange-400'}`}>
                                            <td className="p-4 text-right border-t-2 border-slate-500 sticky left-0 z-10 bg-[#1e293b]">TOTALS:</td>
                                            <td className="p-4 border-t-2 border-slate-500 text-center">{totals.cash}</td>
                                            <td className="p-4 border-t-2 border-slate-500 text-center">{totals.noncash}</td>
                                            <td className="border-t-2 border-slate-500"></td>
                                            <td className="p-4 border-t-2 border-slate-500 text-center">{totals.liab}</td>
                                            <td className="border-t-2 border-slate-500"></td>
                                            <td className="p-4 border-t-2 border-slate-500 text-center">{totals.cc}</td>
                                            <td className="p-4 border-t-2 border-slate-500 text-center">{totals.ec}</td>
                                            <td className="w-1 bg-slate-600 p-0 border-t-2 border-slate-500"></td>
                                            <td className="p-4 border-t-2 border-slate-500 text-center">{totals.rev}</td>
                                            <td className="p-4 border-t-2 border-slate-500 text-center">{totals.exp}</td>
                                            <td className="p-4 border-t-2 border-slate-500 text-center">{totals.ni}</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        )}

                        {/* ERRORS TAB */}
                        {activeTab === 'errors' && (
                            <div className="space-y-6 animate-fade-in max-w-4xl mx-auto">
                                <p className="text-center text-slate-400 mb-6">Determine the impact (Overstated, Understated, or No Effect) if these transactions were <strong>NOT RECORDED</strong>.</p>
                                
                                {errorScenarios.map((scen, idx) => (
                                    <div key={scen.id} className="bg-[#252540] p-6 rounded-lg shadow-lg border border-slate-700 relative overflow-hidden">
                                        <div className="absolute top-0 left-0 w-1 h-full bg-orange-500"></div>
                                        <h3 className="text-xl font-bold text-white mb-1">{scen.company}</h3>
                                        <p className="text-slate-400 mb-4 text-sm">{scen.desc}</p>
                                        
                                        <div className="grid grid-cols-4 gap-4 bg-slate-900/50 p-4 rounded-lg">
                                            {['asset', 'liab', 'eq', 'ni'].map((field, i) => {
                                                const label = ['Assets', 'Liabilities', 'Equity', 'Net Income'][i];
                                                const val = scen.userSelects[field];
                                                const correct = scen.correct[field];
                                                const isCorrect = val === correct;
                                                
                                                return (
                                                    <div key={field} className="flex flex-col gap-2">
                                                        <label className="text-xs text-slate-500 font-bold uppercase tracking-wider">{label}</label>
                                                        <select 
                                                            className={`bg-slate-800 border ${val && isCorrect ? 'border-green-500 text-green-400' : val ? 'border-red-500 text-red-400' : 'border-slate-600'} rounded p-2 outline-none focus:border-blue-500 transition-colors`}
                                                            value={val}
                                                            onChange={(e) => handleErrorSelect(scen.id, field, e.target.value)}
                                                        >
                                                            <option value="">-- Select --</option>
                                                            <option value="No Effect">No Effect</option>
                                                            <option value="Overstated">Overstated</option>
                                                            <option value="Understated">Understated</option>
                                                        </select>
                                                        {isInstructor && (
                                                            <div className="text-xs text-purple-400 text-center bg-purple-900/30 rounded py-1">
                                                                Key: {correct}
                                                            </div>
                                                        )}
                                                    </div>
                                                )
                                            })}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* FINANCIAL STATEMENTS TAB */}
                        {activeTab === 'statements' && (
                            <div className="space-y-12 animate-fade-in">
                                <div className="text-center text-slate-300 mb-8 max-w-2xl mx-auto">
                                    <p>These financial statements are automatically generated based on the totals and account classifications entered in the <strong>Transaction Analysis</strong> tab. Ensure you have selected the correct account names for items to appear properly below.</p>
                                </div>

                                {/* Income Statement */}
                                <div className="statement-paper">
                                    <div className="statement-header">
                                        <h2>{COMPANY_NAME}</h2>
                                        <h3>Income Statement</h3>
                                        <p>For the Month Ended April 30</p>
                                    </div>
                                    <div className="statement-row">
                                        <span>Service Revenue</span>
                                        <span>{formatCurrency(totals.rev)}</span>
                                    </div>
                                    <div className="statement-row">
                                        <span>Expenses</span>
                                        <span>{formatCurrency(totals.exp)}</span>
                                    </div>
                                    <div className="statement-row total">
                                        <span>Net Income</span>
                                        <span>{formatCurrency(totals.ni)}</span>
                                    </div>
                                </div>

                                {/* Statement of Stockholders' Equity */}
                                <div className="statement-paper">
                                    <div className="statement-header">
                                        <h2>{COMPANY_NAME}</h2>
                                        <h3>Statement of Stockholders' Equity</h3>
                                        <p>For the Month Ended April 30</p>
                                    </div>
                                    <table className="w-full text-right">
                                        <thead className="border-b-2 border-slate-700 text-slate-700 text-sm">
                                            <tr>
                                                <th className="text-left py-2"></th>
                                                <th className="py-2 px-4">Common Stock</th>
                                                <th className="py-2 px-4">Retained Earnings</th>
                                                <th className="py-2 px-4">Total Equity</th>
                                            </tr>
                                        </thead>
                                        <tbody className="text-slate-800">
                                            <tr className="border-b border-dashed border-slate-200">
                                                <td className="text-left py-2">Beginning Balance, Apr 1</td>
                                                <td className="py-2 px-4">$0.00</td>
                                                <td className="py-2 px-4">$0.00</td>
                                                <td className="py-2 px-4">$0.00</td>
                                            </tr>
                                            <tr className="border-b border-dashed border-slate-200">
                                                <td className="text-left py-2">Issuance of Stock</td>
                                                <td className="py-2 px-4">{formatCurrency(totals.cc)}</td>
                                                <td className="py-2 px-4">-</td>
                                                <td className="py-2 px-4">{formatCurrency(totals.cc)}</td>
                                            </tr>
                                            <tr className="border-b border-dashed border-slate-200">
                                                <td className="text-left py-2">Net Income</td>
                                                <td className="py-2 px-4">-</td>
                                                <td className="py-2 px-4">{formatCurrency(totals.ni)}</td>
                                                <td className="py-2 px-4">{formatCurrency(totals.ni)}</td>
                                            </tr>
                                            <tr className="border-b border-dashed border-slate-200">
                                                <td className="text-left py-2">Dividends</td>
                                                <td className="py-2 px-4">-</td>
                                                <td className="py-2 px-4">$0.00</td>
                                                <td className="py-2 px-4">$0.00</td>
                                            </tr>
                                            <tr className="font-bold border-t-2 border-slate-900 border-b-4 double">
                                                <td className="text-left py-3">Ending Balance, Apr 30</td>
                                                <td className="py-3 px-4">{formatCurrency(totals.cc)}</td>
                                                <td className="py-3 px-4">{formatCurrency(totals.ni)}</td>
                                                <td className="py-3 px-4">{formatCurrency(totals.cc + totals.ni)}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                {/* Balance Sheet */}
                                <div className="statement-paper">
                                    <div className="statement-header">
                                        <h2>{COMPANY_NAME}</h2>
                                        <h3>Balance Sheet</h3>
                                        <p>As of April 30</p>
                                    </div>
                                    <div className="grid grid-cols-2 gap-12">
                                        {/* Assets Side */}
                                        <div>
                                            <h4 className="font-bold text-lg mb-2 text-slate-800 border-b border-slate-400">Assets</h4>
                                            
                                            <div className="statement-sub-header">Current Assets</div>
                                            <div className="statement-row">
                                                <span>Cash</span>
                                                <span>{formatCurrency(balanceSheetDetails.assets['Cash'])}</span>
                                            </div>
                                            {/* Dynamically list other assets based on user input */}
                                            {Object.entries(balanceSheetDetails.assets).map(([name, val]) => {
                                                if(name === 'Cash') return null; // Already shown
                                                // Assuming items with "Accum" are contra-assets but usually listed in property section.
                                                // For simplicity, we list everything non-cash here unless we want complex categorization logic.
                                                // Let's filter out "Accum" for a second section if present, or just list all.
                                                return (
                                                    <div key={name} className="statement-row">
                                                        <span>{name}</span>
                                                        <span>{formatCurrency(val)}</span>
                                                    </div>
                                                );
                                            })}

                                            <div className="statement-row total">
                                                <span>Total Assets</span>
                                                <span>{formatCurrency(totals.cash + totals.noncash)}</span>
                                            </div>
                                        </div>

                                        {/* Liab + Equity Side */}
                                        <div>
                                            <h4 className="font-bold text-lg mb-2 text-slate-800 border-b border-slate-400">Liabilities</h4>
                                            <div className="statement-sub-header">Current Liabilities</div>
                                            
                                            {Object.keys(balanceSheetDetails.liabilities).length === 0 && (
                                                <div className="statement-row italic text-gray-400">No liabilities recorded</div>
                                            )}

                                            {Object.entries(balanceSheetDetails.liabilities).map(([name, val]) => (
                                                <div key={name} className="statement-row">
                                                    <span>{name}</span>
                                                    <span>{formatCurrency(val)}</span>
                                                </div>
                                            ))}

                                            <div className="statement-row subtotal">
                                                <span>Total Liabilities</span>
                                                <span>{formatCurrency(totals.liab)}</span>
                                            </div>

                                            <h4 className="font-bold text-lg mt-6 mb-2 text-slate-800 border-b border-slate-400">Stockholders' Equity</h4>
                                            <div className="statement-row">
                                                <span>Common Stock</span>
                                                <span>{formatCurrency(totals.cc)}</span>
                                            </div>
                                            <div className="statement-row">
                                                <span>Retained Earnings</span>
                                                <span>{formatCurrency(totals.ec)}</span>
                                            </div>
                                            <div className="statement-row subtotal">
                                                <span>Total Equity</span>
                                                <span>{formatCurrency(totals.cc + totals.ec)}</span>
                                            </div>

                                            <div className="statement-row total">
                                                <span>Total Liab. & Equity</span>
                                                <span>{formatCurrency(totals.liab + totals.cc + totals.ec)}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Statement of Cash Flows */}
                                <div className="statement-paper">
                                    <div className="statement-header">
                                        <h2>{COMPANY_NAME}</h2>
                                        <h3>Statement of Cash Flows</h3>
                                        <p>For the Month Ended April 30</p>
                                    </div>
                                    
                                    {/* Operating */}
                                    <div className="statement-sub-header">Cash Flows from Operating Activities</div>
                                    <div className="statement-row">
                                        <span>Cash receipts from customers</span>
                                        <span>{formatCurrency(cashFlowDetails.operating.receipts)}</span>
                                    </div>
                                    <div className="statement-row">
                                        <span>Cash payments for expenses</span>
                                        <span>{formatCurrency(cashFlowDetails.operating.payments)}</span>
                                    </div>
                                    <div className="statement-row subtotal">
                                        <span>Net cash provided by operating activities</span>
                                        <span>{formatCurrency(cashFlowDetails.operating.total)}</span>
                                    </div>

                                    {/* Investing */}
                                    <div className="statement-sub-header mt-4">Cash Flows from Investing Activities</div>
                                    <div className="statement-row">
                                        <span>Purchase of property and equipment</span>
                                        <span>{formatCurrency(cashFlowDetails.investing.total)}</span>
                                    </div>
                                    <div className="statement-row subtotal">
                                        <span>Net cash used in investing activities</span>
                                        <span>{formatCurrency(cashFlowDetails.investing.total)}</span>
                                    </div>

                                    {/* Financing */}
                                    <div className="statement-sub-header mt-4">Cash Flows from Financing Activities</div>
                                    <div className="statement-row">
                                        <span>Issuance of common stock</span>
                                        <span>{formatCurrency(cashFlowDetails.financing.total)}</span>
                                    </div>
                                    <div className="statement-row subtotal">
                                        <span>Net cash provided by financing activities</span>
                                        <span>{formatCurrency(cashFlowDetails.financing.total)}</span>
                                    </div>

                                    {/* Summary */}
                                    <div className="mt-6 border-t-2 border-slate-800 pt-2">
                                        <div className="statement-row font-bold">
                                            <span>Net Increase in Cash</span>
                                            <span>{formatCurrency(totals.cash)}</span>
                                        </div>
                                        <div className="statement-row">
                                            <span>Cash Balance, Beginning</span>
                                            <span>$0.00</span>
                                        </div>
                                        <div className="statement-row total">
                                            <span>Cash Balance, Ending</span>
                                            <span>{formatCurrency(totals.cash)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* QUIZ TAB */}
                        {activeTab === 'quiz' && (
                            <div className="space-y-12 animate-fade-in max-w-4xl mx-auto">
                                <div className="text-center text-slate-300 mb-8">
                                    <h2 className="text-2xl font-bold text-white mb-2">Articulation Quiz</h2>
                                    <p>Demonstrate your understanding of how the financial statements link together by answering the questions below.</p>
                                </div>

                                {/* Part 1: Trace the Numbers */}
                                <div className="bg-[#252540] p-6 rounded-lg shadow-lg border border-slate-700">
                                    <h3 className="text-xl font-bold text-blue-400 mb-4 border-b border-slate-600 pb-2 flex items-center gap-2">
                                        <Icon name="search" size={20} /> Part 1: Trace the Numbers
                                    </h3>
                                    <p className="text-sm text-slate-400 mb-4">Find these values in your financial statements and enter them below to prove they articulate correctly.</p>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label className="block text-sm font-bold text-slate-300 mb-1">1. Net Income (from Income Statement)</label>
                                            <SmartInput 
                                                value={quizTracing.ni}
                                                onChange={(val) => handleTracingChange('ni', val)}
                                                correctValue={totals.ni}
                                                instructorMode={isInstructor}
                                                placeholder="Enter Net Income"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-slate-300 mb-1">2. Total Assets (from Balance Sheet)</label>
                                            <SmartInput 
                                                value={quizTracing.assets}
                                                onChange={(val) => handleTracingChange('assets', val)}
                                                correctValue={totals.cash + totals.noncash}
                                                instructorMode={isInstructor}
                                                placeholder="Enter Total Assets"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-slate-300 mb-1">3. Ending Retained Earnings (from Equity Stmt)</label>
                                            <SmartInput 
                                                value={quizTracing.re}
                                                onChange={(val) => handleTracingChange('re', val)}
                                                correctValue={totals.ec + totals.ni}
                                                instructorMode={isInstructor}
                                                placeholder="Enter Ending R.E."
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-slate-300 mb-1">4. Net Cash from Operating Activities</label>
                                            <SmartInput 
                                                value={quizTracing.cash_op}
                                                onChange={(val) => handleTracingChange('cash_op', val)}
                                                correctValue={cashFlowDetails.operating.total}
                                                instructorMode={isInstructor}
                                                placeholder="Enter Operating Cash Flow"
                                            />
                                        </div>
                                    </div>
                                </div>

                                {/* Part 2: Concepts */}
                                <div className="bg-[#252540] p-6 rounded-lg shadow-lg border border-slate-700">
                                    <h3 className="text-xl font-bold text-purple-400 mb-4 border-b border-slate-600 pb-2 flex items-center gap-2">
                                        <Icon name="brain-circuit" size={20} /> Part 2: Concept Checks
                                    </h3>
                                    
                                    <div className="space-y-6">
                                        {QUIZ_CONCEPTS_CONFIG.map((q, idx) => {
                                            const val = quizAnswers[q.id] || "";
                                            const isCorrect = val === q.correct;
                                            
                                            return (
                                                <div key={q.id} className="flex flex-col gap-2">
                                                    <label className="text-sm font-bold text-slate-300">{idx + 1}. {q.question}</label>
                                                    <select 
                                                        className={`bg-slate-800 border ${val && isCorrect ? 'border-green-500 text-green-400' : val ? 'border-red-500 text-red-400' : 'border-slate-600'} rounded p-3 outline-none focus:border-blue-500 transition-colors w-full`}
                                                        value={val}
                                                        onChange={(e) => handleQuizAnswer(q.id, e.target.value)}
                                                    >
                                                        <option value="">-- Select Answer --</option>
                                                        {q.options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                                    </select>
                                                    {isInstructor && (
                                                        <div className="text-xs text-purple-400 text-left bg-purple-900/30 rounded py-1 px-2">
                                                            Key: {q.correct}
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Floating Action Button */}
                    <div className="fixed bottom-6 right-6 z-[60]">
                        <button 
                            onClick={handleDownloadClick}
                            className="flex items-center gap-2 bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-transform hover:scale-105 active:scale-95"
                        >
                            <Icon name="download" /> Download Report
                        </button>
                    </div>

                    {/* Confirmation Modal (Clear & Exit) */}
                    {confirmation.isOpen && (
                        <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[110] fade-in">
                            <div className="bg-white p-6 rounded-lg shadow-xl w-80 text-black">
                                <h3 className="font-bold text-lg mb-4 text-gray-800">Confirm Action</h3>
                                <p className="text-sm text-gray-600 mb-6">{confirmation.message}</p>
                                <div className="flex justify-end gap-2">
                                    <button 
                                        onClick={() => setConfirmation({ isOpen: false, message: '', onConfirm: null })} 
                                        className="px-3 py-1 text-sm text-gray-600 hover:bg-gray-100 rounded"
                                    >
                                        Cancel
                                    </button>
                                    <button 
                                        onClick={confirmation.onConfirm} 
                                        className="px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-sm font-medium"
                                    >
                                        Confirm
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Download Modal (New) */}
                    {showDownloadModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[110] fade-in">
                            <div className="bg-white p-6 rounded-lg shadow-xl w-80 text-black">
                                <h3 className="font-bold text-lg mb-4 text-gray-800 flex items-center gap-2">
                                    <Icon name="file-text" className="text-blue-500" /> Save Report
                                </h3>
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Student Name</label>
                                    <input 
                                        type="text" 
                                        value={studentName}
                                        onChange={(e) => setStudentName(e.target.value)}
                                        className="w-full border p-2 rounded outline-none focus:border-blue-500 text-black bg-white"
                                        placeholder="Enter name..."
                                        autoFocus
                                    />
                                </div>
                                <div className="flex justify-end gap-2">
                                    <button 
                                        onClick={() => setShowDownloadModal(false)} 
                                        className="px-3 py-1 text-sm text-gray-600 hover:bg-gray-100 rounded"
                                    >
                                        Cancel
                                    </button>
                                    <button 
                                        onClick={executeDownload} 
                                        className="px-4 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-sm font-medium flex items-center gap-1"
                                    >
                                        <Icon name="download" size={14} /> Save
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Auth Modal */}
                    {showAuthModal && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4 backdrop-blur-sm animate-fade-in">
                            <div className="bg-white text-slate-900 p-8 rounded-xl shadow-2xl max-w-sm w-full relative">
                                <button onClick={() => setShowAuthModal(false)} className="absolute top-2 right-3 text-2xl text-slate-400 hover:text-slate-600">&times;</button>
                                <div className="text-center mb-6">
                                    <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <Icon name="lock" size={32} className="text-slate-700" />
                                    </div>
                                    <h2 className="text-2xl font-bold">Instructor Access</h2>
                                    <p className="text-slate-500 text-sm">Enter password to unlock teacher tools.</p>
                                </div>
                                <input 
                                    type="password" 
                                    className="w-full border border-slate-300 rounded p-3 mb-4 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all"
                                    placeholder="Password"
                                    value={teacherPass}
                                    onChange={e => setTeacherPass(e.target.value)}
                                    onKeyDown={e => e.key === 'Enter' && attemptLogin()}
                                    autoFocus
                                />
                                {authError && <p className="text-red-500 text-sm mb-4 text-center bg-red-50 p-2 rounded">{authError}</p>}
                                <button 
                                    onClick={attemptLogin}
                                    className="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 rounded transition-colors"
                                >
                                    Unlock Dashboard
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>