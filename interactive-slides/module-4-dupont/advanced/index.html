<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced ROE Masterclass</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Space+Grotesk:wght@500;700&family=Fira+Code:wght@400&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #6366f1;
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --secondary: #0ea5e9;
            --accent: #f43f5e;
            --accent-gradient: linear-gradient(135deg, #f43f5e 0%, #fb7185 100%);
            --success: #10b981;
            --success-gradient: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            --error: #ef4444;
            --dark-box: #1e1b4b;
            --dark-gradient: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            --formula-bg: #fff9db; 
            --bg-color: #f8fafc;
            --text-color: #334155;
            --text-light: #94a3b8;
            --white: #ffffff;
            --glass: rgba(255, 255, 255, 0.95);
            --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 25px -5px rgba(99, 102, 241, 0.15);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #app-container {
            width: 100%;
            max-width: 1400px;
            height: 95vh;
            background-color: var(--glass);
            backdrop-filter: blur(10px);
            position: relative;
            box-shadow: var(--shadow-lg);
            border-radius: 24px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255,255,255,0.6);
        }

        .slide {
            display: none;
            flex: 1;
            padding: 2.5rem 3.5rem;
            overflow-y: auto;
            flex-direction: column;
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .slide.active { display: flex; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse-soft {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        h1, h2, h3, h4 { font-family: 'Space Grotesk', sans-serif; color: var(--dark-box); line-height: 1.2; }
        h1 { font-size: 3.5rem; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 1.5rem; }
        h2 { font-size: 2.6rem; margin-bottom: 1.5rem; position: relative; display: inline-block; }
        h2::after { content: ''; position: absolute; bottom: -5px; left: 0; width: 60px; height: 6px; background: var(--accent-gradient); border-radius: 3px; }
        
        p, li { font-size: 1.2rem; line-height: 1.6; margin-bottom: 1rem; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; align-items: start; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; }

        .card { background: var(--white); padding: 2rem; border-radius: 20px; box-shadow: var(--shadow-sm); border: 1px solid #e2e8f0; height: 100%; transition: transform 0.2s; }
        .card-dark { background: var(--dark-gradient); color: var(--white); padding: 2.5rem; border-radius: 20px; position: relative; overflow: hidden; box-shadow: var(--shadow-lg); }
        .card-highlight { border-left: 8px solid var(--accent); background: white; padding: 2.2rem; border-radius: 20px; box-shadow: var(--shadow-sm); }

        .eq-box { background: #f1f5f9; padding: 20px; border-radius: 12px; font-family: 'Fira Code', monospace; margin: 15px 0; border-left: 6px solid var(--secondary); color: var(--dark-box); font-size: 1.2rem; }
        .card-dark .eq-box { background: rgba(0, 0, 0, 0.3); border-color: var(--white); color: var(--white); }

        .formula-card-styled { background: var(--formula-bg); border: 1px solid #e9ecef; padding: 25px; border-radius: 16px; color: #333; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }

        .btn { background: var(--primary-gradient); color: white; border: none; padding: 14px 28px; border-radius: 50px; cursor: pointer; font-weight: 600; transition: all 0.2s; font-family: 'Space Grotesk'; text-transform: uppercase; letter-spacing: 0.5px; font-size: 1rem; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(99, 102, 241, 0.3); }
        .btn-success { background: var(--success-gradient); }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: var(--primary); color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        #curriculum-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--glass); backdrop-filter: blur(15px); z-index: 1000; display: none; padding: 4rem; overflow-y: auto; }
        .toc-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .toc-btn { background: white; border: 1px solid #e2e8f0; padding: 15px; border-radius: 12px; text-align: left; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; font-size: 1rem; font-weight: 600; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .toc-btn:hover { background: #f0f9ff; border-color: var(--secondary); transform: translateX(5px); }
        .toc-num { background: var(--primary-gradient); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 0.8rem; flex-shrink: 0; }

        .bs-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: white; padding: 25px; border-radius: 20px; box-shadow: var(--shadow-sm); }
        .bs-column h3 { text-align: center; font-size: 1rem; text-transform: uppercase; color: var(--text-light); margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .bs-item { padding: 12px 16px; margin: 6px 0; border: 2px solid #f1f5f9; border-radius: 12px; cursor: pointer; display: flex; justify-content: space-between; font-weight: 600; transition: 0.2s; font-size: 1rem; }
        .bs-item.selected { background: #e0f2fe; border-color: var(--secondary); color: var(--secondary); }
        .bs-item.correct { background: #d1fae5; border-color: var(--success); color: #065f46; }
        .bs-item.wrong { background: #fee2e2; border-color: var(--error); color: #991b1b; }

        .is-table { width: 100%; border-collapse: separate; border-spacing: 0 4px; }
        .is-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 1.1rem; }
        .is-total { font-weight: 800; background: #f8fafc; color: var(--primary); }

        .tax-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; font-family: 'Space Grotesk', sans-serif; }
        .tax-table td { padding: 6px 8px; border-bottom: 1px solid #eee; }
        .tax-table tr:last-child td { border-top: 2px solid #333; border-bottom: 4px double #333; font-weight: bold; background: #f8fafc; }
        .tax-table .val { text-align: right; font-family: 'Fira Code', monospace; }

        #nav-bar { background: rgba(255,255,255,0.9); padding: 1rem 2.5rem; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #e2e8f0; z-index: 100; position: relative; }
        .progress-bar { flex: 1; height: 8px; background: #e2e8f0; margin: 0 25px; border-radius: 10px; overflow: hidden; }
        #progress-fill { height: 100%; background: var(--accent-gradient); width: 0%; transition: width 0.4s; }

        .flip-container { perspective: 1000px; cursor: pointer; height: 320px; }
        .flip-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .flip-container.flipped .flip-inner { transform: rotateY(180deg); }
        .flip-front, .flip-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 20px; padding: 25px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; box-shadow: var(--shadow-sm); }
        .flip-front { background: var(--dark-gradient); color: white; border: 1px solid rgba(255,255,255,0.1); }
        .flip-back { transform: rotateY(180deg); background: white; border: 4px solid var(--primary); color: var(--text-color); }

        .strategy-chart { position: relative; height: 400px; border-left: 3px solid #334155; border-bottom: 3px solid #334155; margin: 30px; margin-top: 30px; }
        
        .lever-viz { display:flex; align-items:flex-end; height: 200px; justify-content:center; gap: 25px; margin-top: 15px; }
        .lever-bar { width:70px; display:flex; flex-direction:column; justify-content:flex-end; transition: height 0.3s; border-radius: 8px 8px 0 0; position:relative; }

        .bullet-point { opacity: 0 !important; transition: 0.5s; transform: translateX(-15px); list-style: none; margin-bottom: 12px; padding: 15px; border-left: 5px solid var(--success); background: rgba(255,255,255,0.1); display: flex; align-items: center; font-size: 1.1rem; }
        .bullet-point::before { content: '✨'; margin-right: 15px; }
        .bullet-visible { opacity: 1 !important; transform: translateX(0); }

        .text-center { text-align: center; }
        .text-white { color: white !important; -webkit-text-fill-color: white !important; }
        .text-success { color: var(--success); }
        .text-error { color: var(--error); }
        .text-accent { color: var(--accent); }
        .text-primary { color: var(--primary) !important; -webkit-text-fill-color: var(--primary) !important;}
        .text-secondary { color: var(--secondary) !important; -webkit-text-fill-color: var(--secondary) !important;}
        .font-bold { font-weight: 800; }
        .mt-4 { margin-top: 2rem; }

        .def-table { width: 100%; border-collapse: collapse; margin-top: 0.8rem; }
        .def-table td { padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 1rem; text-align: left; vertical-align: top; }
        .def-table .label { font-weight: 800; color: #a5b4fc; width: 90px; }
        .def-table .name { font-weight: 600; color: white; width: 220px; }
        .def-table .formula { font-family: 'Fira Code', monospace; color: #e2e8f0; font-size: 0.95rem; }

        .scenario-footer { margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 12px; border: 1px dashed rgba(255,255,255,0.2); display: flex; flex-direction: column; justify-content: center; position: relative; }
        .scenario-footer div { text-align: center; width: 100%; margin-bottom: 10px; }
        .scenario-footer p { font-size: 0.8rem; margin-bottom: 5px; font-family: 'Fira Code', monospace; color: #a5b4fc; }
        .scenario-footer h5 { font-size: 1rem; color: white; font-family: 'Fira Code', monospace; }
        
        .formula-highlight {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid var(--success);
            color: #064e3b; 
            padding: 10px;
            border-radius: 8px;
            margin-top: 8px;
            font-size: 0.95rem;
        }

        .quadrant-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 10px;
            background: #e2e8f0;
            padding: 2px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .quadrant {
            background: white;
            padding: 15px;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        .quadrant:hover { background: #f8fafc; }
        .q-title { font-weight: bold; font-size: 0.9rem; margin-bottom: 8px; text-transform: uppercase; color: var(--text-light); }
        .q-content { font-size: 1rem; color: var(--dark-box); opacity: 0.1; filter: blur(3px); transition: all 0.5s; }
        .q-content.revealed { opacity: 1; filter: blur(0); }
        .q-hint { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--primary); font-size: 0.8rem; font-weight: bold; opacity: 1; transition: 0.3s; pointer-events: none; }
        .quadrant.active .q-hint { opacity: 0; }
        
        .q-op { border-left: 4px solid var(--success); }
        .q-non { border-left: 4px solid var(--error); }
        
        .is-flow-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            justify-content: flex-start;
        }
        .is-box {
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            position: relative;
            cursor: pointer;
            transition: 0.3s;
        }
        .is-box:hover { transform: scale(1.02); }
        .is-box::after {
            content: '↓';
            position: absolute;
            bottom: -16px;
            left: 50%;
            transform: translateX(-50%);
            color: #cbd5e0;
            font-size: 1.2rem;
            z-index: 10;
        }
        .is-box:last-child::after { content: none; }

        .reveal-blur { filter: blur(5px); opacity: 0.5; transition: 0.4s; cursor: pointer; user-select: none; }
        .reveal-blur:hover { opacity: 0.8; }
        .reveal-blur.revealed { filter: blur(0); opacity: 1; cursor: default; }

        .click-box { border: 2px dashed #cbd5e0; border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; color: #94a3b8; font-weight: bold; }
        .click-box:hover { border-color: var(--primary); color: var(--primary); background: #f0f9ff; }
        .click-box.revealed { border: 2px solid var(--primary); background: white; color: var(--dark-box); cursor: default; }

        /* --- BRIDGE VIZ STYLES --- */
        .bridge-col {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 160px;
            position: relative;
        }

        .viz-bar-group {
            position: relative;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-end;
        }

        .bridge-bar {
            width: 100%;
            border-radius: 8px;
            transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .base-bar { background: var(--primary-gradient); opacity: 0.3; } /* Faded to show it is theoretical base */
        .result-bar { background: var(--dark-gradient); z-index: 2; }

        .bar-val {
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
        }
        .viz-label { font-size: 0.9rem; margin-bottom: 15px; font-weight: bold; text-align: center; color: var(--text-color); }

        /* Tax Overlays */
        .tax-overlay-theoretical {
            position: absolute;
            bottom: 160px; /* 200px height - 40px tax */
            width: 110%;
            height: 40px;
            left: -5%;
            background: transparent;
            border: 2px dashed var(--primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 0.8rem;
            font-weight: bold;
        }

        .tax-overlay-actual {
            position: absolute;
            top: 0;
            width: 100%;
            background: #f43f5e; /* Default Red */
            border-radius: 8px 8px 0 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.85rem;
            font-weight: bold;
            transition: height 0.6s, background 0.6s;
            z-index: 10;
        }
        
        .tax-overlay-dashed-compare {
            position: absolute;
            top: 0;
            width: 110%;
            left: -5%;
            height: 0; /* Dynamic */
            border: 3px dotted #1e293b; /* Dark Dotted Line for Tax on Op Inc */
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            z-index: 11;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.4s, height 0.6s, top 0.6s;
        }

        /* Bridge Arrow - FIXED WIDTH */
        .bridge-connector {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 160px; /* Increased from 80px */
        }

        .bridge-arrow {
            width: 140px; /* Increased from 40px */
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            border-radius: 6px;
            position: relative;
            transition: all 0.5s;
            padding: 0 10px;
        }
        
        .bridge-arrow::after {
            content: '';
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
        }

        .arrow-down {
            height: 60px; /* Represents $20 scale */
            background: #ef4444;
            margin-top: 40px; /* Visual offset */
        }
        .arrow-down::after {
            bottom: -10px;
            border-top: 10px solid #ef4444;
        }

        .arrow-up {
            height: 60px;
            background: #10b981;
            margin-bottom: 40px;
        }
        .arrow-up::after {
            top: -10px;
            border-bottom: 10px solid #10b981;
        }

        .analysis-box {
            margin-top: 25px;
            padding: 20px;
            border-radius: 12px;
            background: white;
            border-left: 6px solid #ccc;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        
        .math-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .math-row:last-child { border-bottom: none; font-weight: bold; font-size: 1.1rem; }

        /* Quiz Check Styles */
        .quiz-option {
            background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 15px; cursor: pointer; transition: 0.2s; text-align: left; display: flex; align-items: center; margin-bottom: 10px;
        }
        .quiz-option:hover { border-color: var(--primary); background: #f0f9ff; }
        .quiz-option.correct { border-color: var(--success); background: #d1fae5; color: #065f46; }
        .quiz-option.wrong { border-color: var(--error); background: #fee2e2; color: #991b1b; }
        .quiz-circle { width: 24px; height: 24px; border: 2px solid #cbd5e0; border-radius: 50%; margin-right: 15px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; }
        .quiz-option.correct .quiz-circle { border-color: var(--success); background: var(--success); color: white; border: none; }
        .quiz-option.wrong .quiz-circle { border-color: var(--error); background: var(--error); color: white; border: none; }

        /* Final Quiz Specifics */
        .final-quiz-container { display: flex; flex-direction: column; height: 100%; }
        .quiz-nav-btn {
             width: 40px; height: 40px; border-radius: 50%; border: 2px solid #e2e8f0; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #94a3b8; cursor: pointer; margin-right: 10px; transition: all 0.2s;
        }
        .quiz-nav-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .quiz-nav-btn.answered { background: #e0f2fe; color: var(--secondary); border-color: var(--secondary); }
        .quiz-nav-bar { display: flex; justify-content: center; flex-wrap: wrap; margin-bottom: 20px; }
        .question-box { background: white; padding: 30px; border-radius: 20px; box-shadow: var(--shadow-sm); flex: 1; display: flex; flex-direction: column; justify-content: center; animation: fadeIn 0.3s; }
    </style>
</head>
<body>

<div id="app-container">

    <!-- Curriculum Overlay -->
    <div id="curriculum-overlay">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h2>Masterclass Curriculum</h2>
            <button class="btn" style="background: var(--error);" onclick="toggleCurriculum()">Close <i class="fas fa-times"></i></button>
        </div>
        <div id="toc-grid" class="toc-grid"></div>
    </div>

    <!-- Slide 1: Hook Story -->
    <div class="slide active" style="padding: 1.5rem;">
        <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%;">
            <div class="card-dark" style="padding: 2rem; text-align: center; max-width: 1100px; border-radius: 30px; animation: pulse-soft 3s infinite ease-in-out;">
                <h1 class="text-white" style="margin-bottom: 1rem; font-size: 3rem;">Drivers of Return on Equity</h1>
                <div class="grid-2 mt-4" style="gap: 1rem;">
                    <!-- The Software Sage (Operations) -->
                    <div class="flip-container" onclick="this.classList.toggle('flipped')" style="height: 250px;">
                        <div class="flip-inner" style="height:100%">
                            <div class="flip-front" style="background: rgba(255,255,255,0.1); border: 2px solid var(--success); padding: 1.5rem;">
                                <i class="fas fa-code fa-2x mb-3 text-success"></i>
                                <h3 class="text-white" style="font-size: 1.4rem;">The Software Sage</h3>
                                <p class="text-white" style="font-size: 0.9rem;">High Margin, Zero Debt.</p>
                                <p style="font-size: 0.8rem; opacity: 0.7; margin-top:5px;">(Click to Reveal Driver)</p>
                            </div>
                            <div class="flip-back">
                                <p style="font-size: 1rem;">Earns $4M on $10M Equity. Every cent of that 40% ROE comes from pure operational brilliance. This is <strong>Operating Return</strong>.</p>
                            </div>
                        </div>
                    </div>
                    <!-- The Debt Dealer (Leverage) -->
                    <div class="flip-container" onclick="this.classList.toggle('flipped')" style="height: 250px;">
                        <div class="flip-inner" style="height:100%">
                            <div class="flip-front" style="background: rgba(255,255,255,0.1); border: 2px solid var(--accent); padding: 1.5rem;">
                                <i class="fas fa-balance-scale-right fa-2x mb-3 text-accent"></i>
                                <h3 class="text-white" style="font-size: 1.4rem;">The Debt Dealer</h3>
                                <p class="text-white" style="font-size: 0.9rem;">Low Margin, Heavy Debt.</p>
                                <p style="font-size: 0.8rem; opacity: 0.7; margin-top:5px;">(Click to Reveal Driver)</p>
                            </div>
                            <div class="flip-back">
                                <p style="font-size: 1rem;">Has only $1M equity but borrowed $9M to control $10M in assets. The return is mostly <strong>Non-operating Return</strong>.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card mt-4" style="background: rgba(255,255,255,0.15); border: none; padding: 1.5rem; margin-top: 1rem;">
                    <p class="text-white" style="font-size: 1.1rem; margin: 0;"><strong>The Truth:</strong> Traditional ROE sees them as twins. Advanced Analysis reveals one is an artisan, the other is a risk-architect.</p>
                </div>
                <button class="btn mt-4" style="background: white; color: var(--primary); margin-top: 1.5rem;" onclick="nextSlide()">Analyze the Engines <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
    </div>

    <!-- Slide 2: Core Problem -->
    <div class="slide">
        <h2>The Conflation Problem</h2>
        <div class="grid-2">
            <div>
                <p>Advanced Analysis separates the firm into two distinct activity buckets:</p>
                <div class="card card-highlight" style="border-left-color: var(--secondary); margin-bottom: 20px;">
                    <h3 class="text-secondary">1. Operating Engine</h3>
                    <p>Creating products and services. Measures how well the core business generates cash.</p>
                </div>
                <div class="card card-highlight" style="border-left-color: var(--accent);">
                    <h3 class="text-accent">2. Financing Choices (NNO)</h3>
                    <p>Deciding how much debt to take vs. how much cash to hold. Measures risk and capital structure.</p>
                </div>
            </div>
            <div class="card-dark text-center" style="cursor: pointer;" onclick="this.querySelector('.hidden-overlay').style.opacity = '0';">
                <div class="hidden-overlay" style="position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(30, 27, 75, 0.9); display:flex; flex-direction:column; justify-content:center; align-items:center; transition:0.5s; z-index:10;">
                    <i class="fas fa-hand-pointer fa-2x mb-2 text-white"></i>
                    <h3 class="text-white">Click to Reveal Traditional View</h3>
                </div>
                <i class="fas fa-exclamation-circle fa-4x mb-4 opacity-50" style="margin-top: 40px;"></i>
                <h3 class="text-white">Traditional View</h3>
                <p class="eq-box" style="font-size: 2rem; background: rgba(0,0,0,0.2); border: none; color: white;">ROE = Net Income / Avg Equity</p>
                <p class="text-white">This hides whether a company is an artisan or a risk-architect.</p>
            </div>
        </div>
    </div>

    <!-- Slide 3: Concept: NOA -->
    <div class="slide">
        <h2>Concept: Net Operating Assets (NOA)</h2>
        <p>Before looking at financing, we must isolate the <strong>Operating Engine's</strong> capital base.</p>
        <div class="card-dark text-center" style="margin-bottom: 25px;">
            <h3 class="text-white" style="font-size: 2rem;">NOA = Operating Assets - Operating Liabilities</h3>
        </div>
        <div class="grid-2">
            <div class="card">
                <h4 class="text-primary">Operating Assets</h4>
                <p>Assets required to run the core business daily.</p>
                <ul class="reveal-blur" onclick="this.classList.add('revealed')" style="padding-left: 25px; font-size: 1.1rem;">
                    <li>Inventory & Accounts Receivable</li>
                    <li>Property, Plant & Equipment (Net)</li>
                    <li>Right of Use Assets</li>
                    <li>Intangible Assets & Goodwill</li>
                </ul>
                <p style="text-align:center; font-size:0.8rem; color:var(--text-light); margin-top:5px;">(Click to Reveal Items)</p>
            </div>
            <div class="card">
                <h4 class="text-secondary">Operating Liabilities</h4>
                <p><strong>Non-interest bearing</strong> obligations that arise from operations (not borrowing).</p>
                <ul class="reveal-blur" onclick="this.classList.add('revealed')" style="padding-left: 25px; font-size: 1.1rem;">
                    <li>Accounts Payable</li>
                    <li>Accrued Expenses & Wages</li>
                    <li>Unearned (Deferred) Revenue</li>
                </ul>
                <p style="text-align:center; font-size:0.8rem; color:var(--text-light); margin-top:5px;">(Click to Reveal Items)</p>
            </div>
        </div>
    </div>

    <!-- Slide 4: Concept: NNO -->
    <div class="slide">
        <h2>Concept: Net Nonoperating Obligations (NNO)</h2>
        <p>In Advanced DuPont, we look at our <strong>Net Financing Position</strong> by netting cash against debt.</p>
        <div class="card-dark text-center" style="margin-bottom: 25px;">
            <h3 class="text-white" style="font-size: 2rem;">NNO = Nonoperating Liabilities - Nonoperating Assets</h3>
        </div>
        <div class="grid-2">
            <div class="card">
                <h4 class="text-accent">Nonoperating Liabilities</h4>
                <p>Interest-bearing obligations used to fund the company.</p>
                <ul class="reveal-blur" onclick="this.classList.add('revealed')" style="padding-left: 25px; font-size: 1.1rem;">
                    <li>Short-term & Long-term Debt</li>
                    <li>Bonds Payable</li>
                    <li>Lease Obligation</li>
                </ul>
                <p style="text-align:center; font-size:0.8rem; color:var(--text-light); margin-top:5px;">(Click to Reveal Items)</p>
            </div>
            <div class="card">
                <h4 class="text-secondary">Nonoperating Assets</h4>
                <p>Cash and investments NOT needed for daily operations.</p>
                <ul class="reveal-blur" onclick="this.classList.add('revealed')" style="padding-left: 25px; font-size: 1.1rem;">
                    <li>Cash & Excess Cash</li>
                    <li>Marketable Securities</li>
                    <li>Short-term Investments</li>
                </ul>
                <p style="text-align:center; font-size:0.8rem; color:var(--text-light); margin-top:5px;">(Click to Reveal Items)</p>
            </div>
        </div>
    </div>

    <!-- Slide 5: Activity: Filter the Core -->
    <div class="slide">
        <h2>Activity: Filter the Core</h2>
        <p>Select items that belong to the <strong>Core Operating Engine</strong>. Leave NNO (Financing) items unselected.</p>
        <div class="bs-container">
            <div class="bs-column">
                <h3>Assets</h3>
                <div class="bs-item" onclick="toggleBS(this, 'op')"><span>Inventory</span> <span>$200</span></div>
                <div class="bs-item" onclick="toggleBS(this, 'non')"><span>Cash & Excess Cash</span> <span>$550</span></div>
                <div class="bs-item" onclick="toggleBS(this, 'op')"><span>PPE (Factories)</span> <span>$800</span></div>
                <div class="bs-item" onclick="toggleBS(this, 'op')"><span>Right of Use Asset</span> <span>$150</span></div>
                <div class="bs-item" onclick="toggleBS(this, 'op')"><span>Goodwill</span> <span>$150</span></div>
            </div>
            <div class="bs-column">
                <h3>Liabilities & Equity</h3>
                <div class="bs-item" onclick="toggleBS(this, 'op')"><span>Accounts Payable</span> <span>$80</span></div>
                <div class="bs-item" onclick="toggleBS(this, 'non')"><span>Long-term Bonds</span> <span>$400</span></div>
                <div class="bs-item" onclick="toggleBS(this, 'non')"><span>Lease Obligation</span> <span>$120</span></div>
                <div class="bs-item" onclick="toggleBS(this, 'op')"><span>Unearned Revenue</span> <span>$20</span></div>
            </div>
        </div>
        <div class="text-center mt-4">
            <button class="btn" onclick="checkBS()">Check Classification</button>
            <p id="bs-feedback" class="mt-2 font-bold"></p>
        </div>
    </div>

    <!-- Slide 6: Visualizing the Split -->
    <div class="slide">
        <h2>Visualizing the Split: Reclassified Statements</h2>
        <p>Explore the four quadrants to see how we reorganize the balance sheet.</p>
        <div class="grid-2">
            <!-- Balance Sheet -->
            <div class="card">
                <h3 class="text-center text-primary mb-3">Balance Sheet (Reclassified)</h3>
                <p style="text-align:center; font-size:0.8rem; margin-bottom:10px; color:var(--text-light);">(Click quadrants to populate)</p>
                <div class="quadrant-grid">
                    <div class="quadrant q-op" onclick="revealQuadrant(this)">
                        <div class="q-hint">Click to Reveal</div>
                        <div class="q-title">Operating Assets</div>
                        <div class="q-content">
                            <div>Assets required to run core business:</div>
                            <ul style="margin-left:15px; font-size:0.9rem; margin-top:5px;">
                                <li>Inventory</li>
                                <li>PP&E</li>
                                <li>Operating Cash</li>
                                <li>A/R</li>
                            </ul>
                        </div>
                    </div>
                    <div class="quadrant q-op" onclick="revealQuadrant(this)">
                        <div class="q-hint">Click to Reveal</div>
                        <div class="q-title">Operating Liabilities</div>
                        <div class="q-content">
                            <div>Spontaneous, non-interest obligations:</div>
                            <ul style="margin-left:15px; font-size:0.9rem; margin-top:5px;">
                                <li>A/P</li>
                                <li>Accrued Expenses</li>
                                <li>Deferred Revenue</li>
                            </ul>
                        </div>
                    </div>
                    <div class="quadrant q-non" onclick="revealQuadrant(this)">
                        <div class="q-hint">Click to Reveal</div>
                        <div class="q-title">Non-Operating Assets</div>
                        <div class="q-content">
                            <div>Assets not essential to operations:</div>
                            <ul style="margin-left:15px; font-size:0.9rem; margin-top:5px;">
                                <li>Excess Cash</li>
                                <li>Marketable Securities</li>
                                <li>Investments</li>
                            </ul>
                        </div>
                    </div>
                    <div class="quadrant q-non" onclick="revealQuadrant(this)">
                        <div class="q-hint">Click to Reveal</div>
                        <div class="q-title">Non-Operating Liabilities</div>
                        <div class="q-content">
                            <div>Financing-related obligations:</div>
                            <ul style="margin-left:15px; font-size:0.9rem; margin-top:5px;">
                                <li>Short-term Debt</li>
                                <li>Long-term Debt</li>
                                <li>Pension Liabilities</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between; margin-top:10px; gap:10px;">
                    <div style="font-size:0.8rem; background: #eff6ff; padding:8px; border-radius:8px; flex:1; color:var(--primary);">
                        <strong>Net Operating Assets (NOA)</strong><br> = Operating Assets − Operating Liabilities
                    </div>
                    <div style="font-size:0.8rem; background: #fff1f2; padding:8px; border-radius:8px; flex:1; color:var(--accent);">
                        <strong>Net Non-Operating Obligations (NNO)</strong><br> = Non-Op Liabilities − Non-Op Assets
                    </div>
                </div>
            </div>

            <!-- Income Statement -->
            <div class="card">
                <h3 class="text-center text-secondary mb-3">Income Statement (Reclassified)</h3>
                <div class="is-flow-container">
                    <div class="is-box" style="background: #f0fdf4; border: 2px solid var(--success);">
                        <div style="font-size:1.1rem; color:var(--success);">Operating Income</div>
                        <div style="font-weight:normal; margin-top:3px; font-size:0.75rem;">(Revenue - COGS - OPEX)<br>Profit generated purely from operations.<br>Independent of financing decisions.</div>
                    </div>
                    <div class="is-box" style="background: #fef2f2; border: 2px solid var(--error);">
                        <div style="font-size:1.1rem; color:var(--error);">Net Non-Operating Items</div>
                        <div style="font-weight:normal; margin-top:3px; font-size:0.75rem;">Interest Income / Expense<br>Gains/Losses from Investments</div>
                    </div>
                    <div class="is-box" style="background: #fff9db; border: 2px solid #eab308;">
                        <div style="font-size:1.1rem; color:#ca8a04;">Tax Expense</div>
                    </div>
                    <div class="is-box" style="background: var(--dark-box); color:white;">
                        <div style="font-size:1.1rem;">Net Income</div>
                        <div style="font-weight:normal; margin-top:3px; font-size:0.75rem; color:#cbd5e0;">Final bottom line.</div>
                    </div>
                </div>
                <div style="margin-top:15px; background: #f8fafc; padding:10px; border-radius:8px; font-size:0.85rem; border: 1px solid #e2e8f0;">
                      <strong>Definitions:</strong><br>
                      <span style="font-family:'Fira Code'">NOPBT = Operating income (or EBIT)</span><br>
                      <span style="font-family:'Fira Code'">NOPAT = NOPBT - tax on operating income</span><br>
                </div>
            </div>
        </div>
    </div>

    <!-- Slide 7: Pfizer NOA Case Study -->
    <div class="slide">
        <h2>Case Study: Pfizer's NOA (2022)</h2>
        <div class="grid-2">
            <div class="card">
                <h3>The Calculation ($M)</h3>
                <table class="is-table">
                    <tr><td>Total Operating Assets</td><td class="text-right click-box" onclick="revealNum(this, '$170,437')">?</td></tr>
                    <tr><td>(Less) Operating Liabilities</td><td class="text-right click-box" onclick="revealNum(this, '($59,939)')">?</td></tr>
                    <tr class="is-total"><td>Net Operating Assets (NOA)</td><td class="text-right">$110,498</td></tr>
                </table>
                <p class="mt-4" style="font-size: 1rem; color: var(--text-light);">*Interest-bearing Debt and Net Cash were removed to isolate the core capital base.</p>
            </div>
            <div class="card-dark text-center flex-center" style="display:flex; flex-direction:column; justify-content:center;">
                <i class="fas fa-calculator fa-4x mb-4 text-white"></i>
                <h3 class="text-white">Net Operating Assets</h3>
                <h1 style="color: white; -webkit-text-fill-color: white; font-size: 4rem;">$110.5B</h1>
                <p class="text-white" style="opacity: 0.8;">The "True" capital running the business.</p>
            </div>
        </div>
    </div>

    <!-- Slide 8: The Tax Bridge Visualizer (Refined) -->
    <div class="slide">
        <h2>The NOPAT Tax Logic</h2>
        <p style="margin-bottom: 1.5rem;">
            To calculate NOPAT, we need the <strong>Tax on Operating Income</strong>. However, the IRS charges us based on <strong>Income Before Tax</strong>. We must bridge the gap to find the "Tax Shield."
        </p>
        
        <div class="card" style="padding: 2rem; background: #f8fafc; border: 1px solid #e2e8f0;">
            <!-- Controls -->
            <div style="display:flex; justify-content:center; gap: 15px; margin-bottom: 30px;">
                <button class="btn btn-outline" id="btn-debt" onclick="updateTaxViz('debt')" style="width: 200px;">
                    <i class="fas fa-arrow-down mr-2"></i> High Debt Scenario<br><span style="font-size:0.7rem;">(positive NNO)</span>
                </button>
                <button class="btn btn-outline" id="btn-cash" onclick="updateTaxViz('cash')" style="width: 200px;">
                    <i class="fas fa-arrow-up mr-2"></i> Excess Cash Scenario<br><span style="font-size:0.7rem;">(Negative NNO)</span>
                </button>
            </div>

            <!-- Main Visualization Stage -->
            <div class="bridge-container" style="display: flex; align-items: flex-end; justify-content: center; height: 320px; gap: 40px; position: relative; padding-bottom: 20px;">
                
                <!-- 1. Operating Income Bar -->
                <div class="bridge-col">
                    <div class="viz-label">Operating Income</div>
                    <div class="viz-bar-group">
                        <div class="bridge-bar base-bar" style="height: 200px;">
                            <span class="bar-val">$100</span>
                        </div>
                        <!-- Theoretical Tax Overlay -->
                        <div class="tax-overlay-theoretical" style="height: 40px;">
                            <span>Tax on Op Inc ($20)</span>
                        </div>
                    </div>
                </div>

                <!-- 2. The Bridge (Adjustment) -->
                <div class="bridge-connector">
                    <div id="bridge-arrow" class="bridge-arrow arrow-down">
                        <span id="bridge-val"></span>
                    </div>
                </div>

                <!-- 3. Income Before Tax Bar -->
                <div class="bridge-col">
                    <div class="viz-label">Income Before Tax</div>
                    <div class="viz-bar-group">
                        <div id="taxable-bar" class="bridge-bar result-bar" style="height: 160px;">
                            <span id="taxable-val" class="bar-val">$80</span>
                        </div>
                        <!-- Solid Red Overlay: Now represents ACTUAL Tax -->
                        <div id="actual-tax-overlay" class="tax-overlay-actual" style="height: 32px;">
                            <span id="actual-tax-label">Actual Tax ($16)</span>
                        </div>
                        <!-- Dotted Box: Now represents Tax on Op Inc -->
                        <div id="tax-overlay-dashed-compare" class="tax-overlay-dashed-compare"></div>
                    </div>
                </div>

            </div>

            <!-- Analysis Box -->
            <div id="bridge-analysis" class="analysis-box">
                <!-- JS Populates this -->
            </div>
        </div>
    </div>

    <!-- Slide 9: Method 1: Top Down -->
    <div class="slide">
        <h2>Method 1: Top Down NOPAT</h2>
        <p>Start from the operating profit before tax and apply the true operating tax.</p>
        <div class="grid-2">
            <div style="display: flex; flex-direction: column; gap: 20px;">
                <div class="card-dark">
                    <h3 class="text-white">The Formula</h3>
                    <div class="eq-box" style="font-size: 1.4rem; text-align: center;">
                        NOPAT = NOPBT - Taxes on Operating Income
                    </div>
                </div>

                <div class="flip-container" onclick="this.classList.toggle('flipped')" style="height: 250px;">
                    <div class="flip-inner" style="height:100%">
                        <div class="flip-front" style="background: white; border: 2px solid var(--primary); color: var(--text-color); box-shadow: var(--shadow-sm);">
                            <h3 class="text-primary"><i class="fas fa-question-circle mr-2"></i>Critical Question</h3>
                            <p class="font-bold mt-2" style="font-size: 1.1rem; line-height: 1.3;"><strong>When calculating NOPAT</strong>, why can't we just do NOPBT * (1 - Tax Rate)?</p>
                            <p style="font-size: 0.8rem; opacity: 0.7; margin-top:5px;">(Click to Reveal Answer)</p>
                        </div>
                        <div class="flip-back" style="background: var(--primary); color: white; border: none; padding: 20px; text-align: left;">
                             <p style="font-size: 0.95rem;">Tax expense on the income statement is not taxable income × statutory tax rate due to a variety of deductions.</p>
                             <p style="font-size: 0.85rem; margin-top:15px; opacity: 0.9;"><em>Note: However, non-operating items (such as interest expense) typically carry a full tax benefit at the full statutory rate.</em></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3 class="text-primary" style="font-size: 1.3rem;">Pfizer Tax Analysis (2022)</h3>
                <table class="tax-table">
                    <tr><td>U.S. statutory income tax rate</td><td class="val">21.0%</td></tr>
                    <tr><td>Taxation of non-U.S. operations</td><td class="val reveal-blur" onclick="this.classList.add('revealed')">(5.0)</td></tr>
                    <tr><td>Tax settlements and resolution...</td><td class="val reveal-blur" onclick="this.classList.add('revealed')">(3.0)</td></tr>
                    <tr><td>Foreign-derived intangible income...</td><td class="val reveal-blur" onclick="this.classList.add('revealed')">(1.9)</td></tr>
                    <tr><td>U.S. R&D tax credit</td><td class="val reveal-blur" onclick="this.classList.add('revealed')">(0.6)</td></tr>
                    <tr><td>Interest</td><td class="val">0.2</td></tr>
                    <tr><td>All other, net</td><td class="val">(1.1)</td></tr>
                    <tr><td>Effective tax rate</td><td class="val">9.6%</td></tr>
                </table>
                <div style="margin-top: 15px; font-size: 0.85rem; color: var(--text-light); border-top: 1px solid #eee; padding-top:10px;">
                    <i class="fas fa-info-circle"></i> <strong>Note:</strong> Items reducing rate to 9.6% are Operating. Financing items use Statutory Rate (22% est).
                </div>
            </div>
        </div>
    </div>

    <!-- Slide 10: Method 2: Bottom Up -->
    <div class="slide">
        <h2>Method 2: Bottom Up NOPAT</h2>
        <p>Start from Net Income and "add back" the financing impact net of tax.</p>
        <div class="card-dark">
            <h3 class="text-white">Build The Equation</h3>
            
            <div class="eq-box" style="font-size: 1.8rem; text-align: center; margin: 2.5rem 0; min-height: 80px; transition: 0.3s; display:flex; flex-direction:column; justify-content:center;">
                <div>NOPAT = Net Income + NNE</div>
                <div style="font-size: 1rem; margin-top: 10px; color: var(--secondary);">where NNE = Net Non-Op Exp × (1 - t)</div>
            </div>
            
            <p class="text-white">Because Net Income is an <strong>after-tax</strong> number, we must add back the <strong>after-tax</strong> cost of interest (NNE).</p>
            <div style="margin-top: 25px; padding: 25px; background: rgba(0,0,0,0.2); border-radius: 12px; min-height: 120px; display:flex; align-items:center;">
                <p class="text-white" style="font-size: 1.1rem; opacity: 0.9; margin: 0;">
                    <i class="fas fa-info-circle mr-2"></i> By adding this back, you are effectively <strong>removing the financing impact</strong> from Net Income to isolate the core engine.
                </p>
            </div>
        </div>
    </div>

    <!-- Slide 11: Scenario 1 -->
    <div class="slide">
        <h2>Scenario 1: Net Non-Op Expense Case (positive NNO) </h2>
        <div class="grid-2">
            <div class="card">
                <h3>Data: Debt Co.</h3>
                <div style="margin-top: 1rem; font-family: 'Fira Code', monospace;">
                    <div style="display:flex; justify-content:space-between; padding:5px 0;"><span>NOPBT</span><span>1,000</span></div>
                    <div style="display:flex; justify-content:space-between; padding:5px 0; color:var(--error);"><span>Interest Expense</span><span>(100)</span></div>
                    <div style="display:flex; justify-content:space-between; padding:5px 0; font-weight:bold; border-top:1px solid #ccc;"><span>Income Before Tax</span><span>900</span></div>
                    <div style="display:flex; justify-content:space-between; padding:5px 0; color:var(--accent);"><span>Tax Expense (20%)</span><span>(180)</span></div>
                    <div style="display:flex; justify-content:space-between; padding:8px 0; font-weight:800; border-top:2px solid #333; font-size:1.1rem;"><span>Net Income</span><span>720</span></div>
                </div>
                <p style="font-size: 0.8rem; margin-top: 15px; color: var(--text-light); line-height: 1.4;">
                    *Note: Here Reported tax is calculated as IBT x 20% but in real life due to a variety of deductions, this is not how tax expense is calculated.
                </p>
            </div>
            <div class="card-dark">
                <h3 class="text-white">Calculated Result</h3>
                <div style="margin: 20px 0;">
                    <h1 class="text-success" style="font-size: 4rem;">NOPAT = $800</h1>
                    <p class="text-white" style="opacity: 0.8;">Both methodologies converge here:</p>
                </div>

                <!-- Added Formula Block -->
                <div style="margin-bottom: 15px; font-size: 0.9rem; color: #a5b4fc; font-family: 'Fira Code', monospace; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
                    <div>Top Down: NOPAT = NOPBT - Taxes on Operating Income</div>
                    <div style="margin-top: 5px;">Bottom Up: NOPAT = Net Income + NNE</div>
                    <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 2px;">where NNE = Net Non-Op Exp × (1 - t)</div>
                </div>

                <div class="scenario-footer">
                    <div>
                        <p>Top Down Calculation</p>
                        <!-- Updated Summary Text with Darker Color -->
                         <div class="formula-highlight reveal-blur" onclick="this.classList.add('revealed')" style="color: #064e3b; font-weight: bold; background: white;">
                            Tax on Op Inc = Actual Tax + Tax Shield<br>
                            $200 = $180 + $20 (Positive Shield)
                         </div>
                    </div>
                    <div>
                        <p>Bottom Up Calculation</p>
                        <h5 class="reveal-blur" onclick="this.classList.add('revealed')">$720 + ($100 × (1-20%)))</h5>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Slide 12: Scenario 2 -->
    <div class="slide">
        <h2>Scenario 2: Net Non-Op Income Case (negative NNO) </h2>
        <div class="grid-2">
            <div class="card">
                <h3>Data: Cash Co.</h3>
                <div style="margin-top: 1rem; font-family: 'Fira Code', monospace;">
                    <div style="display:flex; justify-content:space-between; padding:5px 0;"><span>NOPBT</span><span>1,000</span></div>
                    <div style="display:flex; justify-content:space-between; padding:5px 0; color:var(--success);"><span>Interest Income</span><span>100</span></div>
                    <div style="display:flex; justify-content:space-between; padding:5px 0; font-weight:bold; border-top:1px solid #ccc;"><span>Income Before Tax</span><span>1,100</span></div>
                    <div style="display:flex; justify-content:space-between; padding:5px 0; color:var(--accent);"><span>Tax Expense (20%)</span><span>(220)</span></div>
                    <div style="display:flex; justify-content:space-between; padding:8px 0; font-weight:800; border-top:2px solid #333; font-size:1.1rem;"><span>Net Income</span><span>880</span></div>
                </div>
                <p style="font-size: 0.8rem; margin-top: 15px; color: var(--text-light); line-height: 1.4;">
                    *Note: Here Reported tax is calculated as IBT x 20% but in real life due to a variety of deductions, this is not how tax expense is calculated.
                </p>
            </div>
            <div class="card-dark">
                <h3 class="text-white">Calculated Result</h3>
                <div style="margin: 20px 0;">
                    <h1 class="text-success" style="font-size: 4rem;">NOPAT = $800</h1>
                    <p class="text-white" style="opacity: 0.8;">Non-op income is successfully removed:</p>
                </div>

                <!-- Added Formula Block -->
                <div style="margin-bottom: 15px; font-size: 0.9rem; color: #a5b4fc; font-family: 'Fira Code', monospace; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
                    <div>Top Down: NOPAT = NOPBT - Taxes on Operating Income</div>
                    <div style="margin-top: 5px;">Bottom Up: NOPAT = Net Income + NNE</div>
                    <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 2px;">where NNE = Net Non-Op Exp × (1 - t)</div>
                </div>

                <div class="scenario-footer">
                    <div>
                        <p>Top Down Calculation</p>
                        <!-- Updated Summary Text with Darker Color -->
                         <div class="formula-highlight reveal-blur" onclick="this.classList.add('revealed')" style="border-color: var(--error); color: #7f1d1d; font-weight: bold; background: white;">
                            Tax on Op Inc = Actual Tax + Tax Shield<br>
                            $200 = $220 + (-$20) (Negative Shield)
                         </div>
                    </div>
                    <div>
                        <p>Bottom Up Calculation</p>
                        <h5 class="reveal-blur" onclick="this.classList.add('revealed')">$880 - ($100 × (1-20%))</h5>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Slide 13: Pfizer NOPAT Study -->
    <div class="slide">
        <h2>Case Study: Pfizer's NOPAT (2022)</h2>
        <div class="card">
            <table class="is-table">
                <tr><td>Operating Profit (NOPBT)</td><td class="text-right">$34,719</td></tr>
                <tr><td>Reported Tax Expense</td><td class="text-right">$3,328</td></tr>
                <tr><td class="text-accent">Tax Shield Adjustment (from NNE)</td><td class="text-right click-box" onclick="revealNum(this, '($2)')">?</td></tr>
                <tr class="is-total"><td>= Taxes on Operating Income</td><td class="text-right">$3,326</td></tr>
                <tr style="background: var(--dark-gradient); color: white; font-weight: bold; font-size: 1.4rem;">
                    <td class="text-white">NOPAT (Net Operating Profit After Tax)</td><td class="text-right text-white">$31,393</td>
                </tr>
            </table>
            <p style="margin-top: 15px; font-size: 0.9rem; color: var(--text-light); text-align: center;">
                <em>Note: Pfizer had positive net non-operating income (negative NNE), resulting in a small negative tax shield adjustment.</em>
            </p>
        </div>
    </div>

    <!-- Slide 14: RNOA Reveal -->
    <div class="slide">
        <h2>The Result: RNOA</h2>
        <p>Combining NOPAT and NOA gives us the "Truth Teller" of performance.</p>
        <div class="eq-box" style="text-align: center; font-size: 2.2rem; border-color: var(--primary);">
            <span class="text-primary">R</span><span class="text-accent">N</span><span class="text-primary">OA</span> = NOPAT / Average NOA
        </div>
        <div class="grid-2 mt-4">
            <div class="card-dark text-center" style="border: 2px solid var(--accent); cursor: pointer;" onclick="this.querySelector('.content').style.opacity = 1; this.querySelector('.overlay').style.opacity = 0;">
                <div class="overlay" style="position: absolute; top:0; left:0; width:100%; height:100%; background: #1e1b4b; display:flex; justify-content:center; align-items:center; z-index:5; transition:0.5s;">
                    <h3 class="text-white">Reveal Traditional ROA</h3>
                </div>
                <div class="content" style="opacity:0; transition:0.5s;">
                    <h3 class="text-white">Traditional <span class="text-white">ROA</span></h3>
                    <h1 style="font-size: 4.5rem;" class="text-white">16.6%</h1>
                    <p class="text-white">Diluted by excess cash and debt.</p>
                </div>
            </div>
            <div class="card-dark text-center" style="border: 2px solid var(--success); cursor: pointer;" onclick="this.querySelector('.content').style.opacity = 1; this.querySelector('.overlay').style.opacity = 0;">
                <div class="overlay" style="position: absolute; top:0; left:0; width:100%; height:100%; background: #1e1b4b; display:flex; justify-content:center; align-items:center; z-index:5; transition:0.5s;">
                    <h3 class="text-success">Reveal RNOA</h3>
                </div>
                <div class="content" style="opacity:0; transition:0.5s;">
                    <h3 class="text-white">Operational <span class="text-primary">R</span><span class="text-accent">N</span><span class="text-primary">OA</span></h3>
                    <h1 class="text-success" style="-webkit-text-fill-color: var(--success); font-size: 4.5rem;">32.1%</h1>
                    <p class="text-white">Pure Operating Efficiency.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Slide 15: Drivers (NOPM & NOAT) -->
    <div class="slide">
        <h2>Decomposing RNOA</h2>
        <div class="grid-2" style="margin-bottom: 20px;">
            <div class="card-dark" style="border-left: 10px solid var(--primary); padding: 1.5rem;">
                <h3 class="text-white"><span class="text-accent">NO</span><span class="text-secondary">PM</span></h3>
                <p class="text-white">Net Operating Profit Margin</p>
                <div class="eq-box" style="margin: 10px 0; font-size: 1rem;">NOPAT / Sales</div>
            </div>
            <div class="card-dark" style="border-left: 10px solid var(--secondary); padding: 1.5rem;">
                <h3 class="text-white"><span class="text-accent">NO</span><span class="text-secondary">AT</span></h3>
                <p class="text-white">Net Operating Asset Turnover</p>
                <div class="eq-box" style="margin: 10px 0; font-size: 1rem;">Sales / Avg NOA</div>
            </div>
        </div>
        
        <!-- SVG Strategy Chart -->
        <div class="strategy-chart">
            <svg width="100%" height="100%" viewBox="0 0 800 400" preserveAspectRatio="none">
                <!-- Axes -->
                <line x1="50" y1="350" x2="750" y2="350" stroke="#334155" stroke-width="2" /> <!-- X -->
                <line x1="50" y1="350" x2="50" y2="50" stroke="#334155" stroke-width="2" /> <!-- Y -->
                
                <!-- Labels -->
                <text x="400" y="390" text-anchor="middle" font-weight="bold" fill="#334155">Net Operating Profit Margin</text>
                <text x="20" y="200" transform="rotate(-90 20,200)" text-anchor="middle" font-weight="bold" fill="#334155">Net Operating Asset Turnover</text>

                <!-- Iso-RNOA Curve (approximate hyperbola) -->
                <path d="M 120 50 Q 150 250 750 330" fill="none" stroke="#f97316" stroke-width="4" />
                
                <!-- Points -->
                <!-- Consumer Staples: High Turn (Top), Low Margin (Left) -->
                <g class="chart-point" style="cursor: pointer;">
                    <circle cx="120" cy="50" r="8" fill="#3b82f6" stroke="white" stroke-width="2">
                        <animate attributeName="r" values="8;10;8" dur="2s" repeatCount="indefinite" />
                    </circle>
                    <text x="135" y="55" font-size="12" font-weight="bold" fill="#334155">Consumer Staples</text>
                </g>

                <!-- Semiconductors: Low Turn (Bottom), High Margin (Right) -->
                <g class="chart-point" style="cursor: pointer;">
                    <circle cx="700" cy="310" r="8" fill="#3b82f6" stroke="white" stroke-width="2" />
                    <text x="680" y="315" font-size="12" font-weight="bold" fill="#334155" text-anchor="end">Semiconductors</text>
                </g>

                <!-- Pfizer: Low Turn (Bottom), High Margin (Right) -->
                <!-- 31% Margin, 0.89 Turn (moved higher to avoid X axis overlap) -->
                <g class="chart-point" style="cursor: pointer;">
                    <circle cx="740" cy="300" r="8" fill="#6366f1" stroke="white" stroke-width="3" />
                    <text x="740" y="290" font-size="12" font-weight="bold" fill="#6366f1" text-anchor="middle">Pfizer (31%, 0.89)</text>
                </g>
                
                <!-- Other Dots to simulate scatter -->
                <circle cx="200" cy="200" r="6" fill="#64748b" opacity="0.6" />
                <circle cx="300" cy="280" r="6" fill="#64748b" opacity="0.6" />
                <circle cx="450" cy="310" r="6" fill="#64748b" opacity="0.6" />
                <circle cx="550" cy="320" r="6" fill="#64748b" opacity="0.6" />
            </svg>
        </div>
    </div>

    <!-- Slide 16: ANALYSIS DECISION -->
    <div class="slide">
        <h2>ANALYSIS DECISION: You Are the CEO</h2>
        <div class="card card-highlight">
            <p style="font-size: 1.4rem; margin-bottom: 2rem;">
                You are analyzing the performance of your company. Your analysis of RNOA reveals the following (industry benchmarks in parentheses): 
                <strong>RNOA is 16% (10%)</strong>, <strong>NOPM is 18% (17%)</strong>, and <strong>NOAT is 0.89 (0.59)</strong>. 
                <br><br>
                What interpretations do you draw that are useful for managing your company?
            </p>
            <button class="btn btn-success" onclick="toggleCEOAnswer()">Reveal Strategy Analysis</button>
            <div id="ceo-answer" style="display: none; margin-top: 2rem; padding: 2rem; background: #f0fdf4; border-radius: 12px; border: 1px solid #bcf0da;">
                <ul style="font-size: 1.2rem; padding-left: 20px;">
                    <li style="margin-bottom: 1.2rem;">
                        <strong>Analysis:</strong> You beat competitors (16% vs 10% RNOA) purely on speed (0.89 vs 0.59 Turnover). Margins are identical (~18%).
                    </li>
                    <li>
                        <strong>Upshot:</strong> Your efficiency is maxed out. Stop chasing turnover. Pivot strategy to <strong>improving Margins</strong> to unlock next-level growth.
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Slide 17: Conceptual Decomposition (Simplified) -->
    <div class="slide">
        <h2>The Conceptual Framework</h2>
        <p>ROE is simply the sum of two return engines.</p>
        <div class="card-dark text-center" style="margin-bottom: 30px; padding: 4rem 2rem; height: auto; min-height: 200px; display: flex; align-items: center; justify-content: center;">
            <h1 class="text-white" style="font-size: 3rem; line-height: 1.4;">ROE = <span class="text-success">Operating Return</span> + <span class="text-accent">Non-Operating Return</span></h1>
        </div>
        
        <div class="grid-2">
            <div class="card card-highlight" style="border-left-color: var(--success);">
                <h3 class="text-success">1. Operating Return (RNOA)</h3>
                <p>This is the return generated by your core business assets (Inventory, Factories, IP).</p>
                <div style="background: #f0fdf4; padding: 15px; border-radius: 10px; margin-top: 15px;">
                    <strong>The Driver:</strong> Pure business efficiency. How well you sell products and manage costs.
                </div>
            </div>
            
            <div class="card card-highlight" style="border-left-color: var(--accent);">
                <h3 class="text-accent">2. Non-Operating Return</h3>
                <p>This is the extra return (or loss) generated by how you finance the business (Debt vs. Equity).</p>
                <div style="background: #fff1f2; padding: 15px; border-radius: 10px; margin-top: 15px;">
                    <strong>The Driver:</strong> Financial Engineering. Borrowing cheap money to boost shareholder returns.
                </div>
            </div>
        </div>
    </div>

    <!-- Slide 18: Leverage Simulator (Simplified) -->
    <div class="slide">
        <h2>The Leverage Effect</h2>
        <p>See how borrowing cheap money acts as a lever to boost shareholder returns.</p>
        
        <div class="card" style="margin-bottom: 1.5rem; background: #f8fafc; padding: 1.5rem;">
            <div class="grid-3">
                <div class="text-center">
                    <p style="font-size: 1rem; color: var(--text-light); margin-bottom: 5px;">Return on Assets (RNOA)</p>
                    <h3 class="text-primary" style="margin: 0; font-size: 1.8rem;">32.1%</h3>
                </div>
                <div class="text-center" style="border-left: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0;">
                     <p style="font-size: 1rem; color: var(--text-light); margin-bottom: 5px;">Cost of Debt (after tax)</p>
                    <h3 style="margin: 0; font-size: 1.8rem;">~0%</h3>
                </div>
                <div class="text-center">
                     <p style="font-size: 1rem; color: var(--text-light); margin-bottom: 5px;">The "Spread" (Gain)</p>
                    <h3 class="text-success" style="margin: 0; font-size: 1.8rem;">~32%</h3>
                </div>
            </div>
            <p style="text-align: center; margin-top: 15px; font-size: 0.9rem; color: #64748b;">
                <em>Since the business earns 32% but borrowing is free (0%), every dollar borrowed adds pure profit.</em>
            </p>
        </div>

        <div class="card">
            <div style="display:flex; align-items:center; gap:25px; margin-bottom: 20px;">
                <label class="font-bold" style="font-size: 1.1rem;">Adjust Debt Level (Leverage):</label>
                <input type="range" id="flev-slider" min="0" max="1.5" step="0.05" value="0.13" oninput="updateSim()" style="flex:1;">
                <span id="flev-val" class="font-bold text-primary" style="font-size: 1.2rem;">Low Debt</span>
            </div>
            <div class="lever-viz">
                <div style="text-align:center;">
                    <div class="lever-bar" style="height: 120px; background: var(--primary-gradient); width: 80px;">
                        <span style="position:absolute; top:-30px; left:0; width:100%; color: var(--primary); font-weight:bold; font-size:1rem;">32.1%</span>
                    </div>
                    <p style="margin-top:10px; font-weight:bold; font-size:1rem;">Operating Return</p>
                </div>
                <div style="font-size: 2rem; padding-bottom: 40px;">+</div>
                <div style="text-align:center;">
                    <div id="sim-boost-bar" class="lever-bar" style="height: 20px; background: var(--accent-gradient); width: 80px;">
                        <span id="sim-boost-text" style="position:absolute; top:-35px; left:0; width:100%; color: var(--accent); font-weight:bold; font-size:1rem;">4.2%</span>
                    </div>
                    <p style="margin-top:10px; font-weight:bold; font-size:1rem;">Benefit from Borrowing</p>
                </div>
                <div style="font-size: 2rem; padding-bottom: 40px;">=</div>
                <div style="text-align:center;">
                    <div id="sim-roe-bar" class="lever-bar" style="height: 140px; background: var(--success-gradient); width: 100px;">
                        <span id="sim-roe-text" style="position:absolute; top:-35px; left:0; width:100%; color: var(--success); font-size:1.4rem; font-weight:bold;">36.3%</span>
                    </div>
                    <p style="margin-top:10px; font-weight:bold; font-size:1rem;">Total ROE</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Slide 19: Apple Case Study (Simplified) -->
    <div class="slide">
        <h2>Case Study: Apple (The "Cash Drag")</h2>
        <div class="flex-center" style="height: 450px; display:flex; justify-content:center; align-items:center;">
            <div class="flip-container" onclick="this.classList.toggle('flipped')" style="width: 700px; height: 350px;">
                <div class="flip-inner" style="height:100%">
                    <div class="flip-front">
                        <i class="fab fa-apple fa-4x mb-4 text-white"></i>
                        <h3 class="text-white">Apple 2022</h3>
                        <div class="grid-2 mt-4" style="width: 100%;">
                            <div style="text-align:center;">
                                <h1 class="text-white" style="font-size: 4rem;">865%</h1>
                                <p class="text-white" style="font-size: 1rem;">Operating Return (RNOA)</p>
                            </div>
                            <div style="text-align:center;">
                                <h1 class="text-white" style="font-size: 4rem;">176%</h1>
                                <p class="text-white" style="font-size: 1rem;">Total ROE</p>
                            </div>
                        </div>
                        <p class="mt-4 text-white" style="opacity: 0.8;">(Click to see why ROE is lower than RNOA)</p>
                    </div>
                    <div class="flip-back" style="padding: 2.5rem; display:flex; flex-direction:column; justify-content:center;">
                        <h3 class="text-error">The Cash Drag</h3>
                        <div style="width: 100%; box-sizing: border-box; background: rgba(239, 68, 68, 0.1); padding: 15px; border-radius: 12px; margin: 15px 0;">
                            <p style="font-size: 1.1rem; color: var(--error);">
                                ROE = Operating Return (865%) - Cash Drag
                            </p>
                        </div>
                        <p style="font-size: 1rem; margin-bottom: 10px;">
                            <strong>What happened?</strong> Apple's core business is a rocket ship (865% return). But they hold hundreds of billions in cash that earns very little interest (e.g., 2%).
                        </p>
                        <p style="font-size: 1rem;">Mixing this "boring" cash with the high-performance business dilutes the overall return to shareholders.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Slide 20: Strategic Summary (Simplified) -->
    <div class="slide">
        <h2>Strategic Management Summary</h2>
        <div class="card-dark" style="min-height: 600px;">
            <ul style="padding: 0;">
                <li class="bullet-point text-white">
                    <strong>The Operational Truth:</strong> Always check if high returns are driven by raw business performance (RNOA) or just financial engineering (Debt).
                </li>
                <li class="bullet-point text-white">
                    <strong>Efficiency vs. Leverage:</strong> Superior managers generate ROE by improving margins and speed, rather than just borrowing more money.
                </li>
                <li class="bullet-point text-white">
                    <strong>The Debt Rule:</strong> Borrowing is good ONLY if your business earns more (RNOA) than the cost of the debt. If your business slumps, debt destroys value.
                </li>
                <li class="bullet-point text-white">
                    <strong>The Cash Cost:</strong> Holding too much cash is safe, but it drags down your overall returns. It's the opportunity cost of safety.
                </li>
                <li class="bullet-point text-white">
                    <strong>Diagnostic Benchmarking:</strong> Use this analysis to find where competitors are beating you—is it pricing power, speed, or just riskier financing?
                </li>
            </ul>
        </div>
        <div class="text-center mt-4">
            <button class="btn" style="background: white; color: var(--primary);" onclick="revealSummary()">Reveal Strategic Insights</button>
        </div>
    </div>

    <!-- NEW FINAL EXAM SLIDE -->
    <div class="slide">
        <h2>Final Knowledge Check</h2>
        <div class="final-quiz-container">
            <div id="final-quiz-nav" class="quiz-nav-bar"></div>
            <div id="final-quiz-content" style="flex: 1;"></div>
        </div>
    </div>

    <!-- Final Completion Slide -->
    <div class="slide">
        <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%;">
            <div class="card-dark text-center" style="padding: 6rem; border-radius: 40px;">
                <i class="fas fa-trophy fa-5x text-warning mb-4"></i>
                <h1 class="text-white">Masterclass Complete</h1>
                <p class="text-white mt-4" style="font-size: 1.4rem;">You've mastered Advanced DuPont Analysis.</p>
                <button class="btn mt-4" style="background: white; color: var(--primary);" onclick="location.reload()">Restart Course</button>
            </div>
        </div>
    </div>

    <!-- Nav Bar -->
    <div id="nav-bar">
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="font-weight: 800; color: var(--primary); font-size: 1rem;">ADVANCED ROE</div>
            <button class="btn" style="padding: 8px 14px; font-size: 0.8rem; border-radius: 6px;" onclick="toggleCurriculum()"><i class="fas fa-list mr-1"></i> Curriculum</button>
        </div>
        <div class="progress-bar"><div id="progress-fill"></div></div>
        <div>
            <button class="btn" style="padding: 10px 20px; background: white; color: black; border: 1px solid #ccc;" onclick="prevSlide()">Back</button>
            <button class="btn" style="padding: 10px 20px;" onclick="nextSlide()">Next</button>
        </div>
    </div>

</div>

<script>
    let currentSlide = 0;
    const slides = document.querySelectorAll('.slide');
    const totalSlides = slides.length;

    function updateNav() {
        slides.forEach((s, i) => s.classList.toggle('active', i === currentSlide));
        const progress = ((currentSlide + 1) / totalSlides) * 100;
        document.getElementById('progress-fill').style.width = `${progress}%`;
        window.scrollTo(0, 0);
    }

    function nextSlide() { if(currentSlide < totalSlides - 1) { currentSlide++; updateNav(); } }
    function prevSlide() { if(currentSlide > 0) { currentSlide--; updateNav(); } }
    function jumpToSlide(i) { currentSlide = i; if(document.getElementById('curriculum-overlay').style.display === 'block') toggleCurriculum(); updateNav(); }

    function toggleCurriculum() {
        const overlay = document.getElementById('curriculum-overlay');
        overlay.style.display = overlay.style.display === 'block' ? 'none' : 'block';
    }

    function toggleCEOAnswer() {
        const ans = document.getElementById('ceo-answer');
        ans.style.display = ans.style.display === 'none' ? 'block' : 'none';
    }

    function toggleBS(el, type) { el.classList.toggle('selected'); }

    function checkBS() {
        const items = document.querySelectorAll('.bs-item');
        let allCorrect = true;
        items.forEach(item => {
            const isOp = item.getAttribute('onclick').includes("'op'");
            const isSelected = item.classList.contains('selected');
            item.classList.remove('correct', 'wrong');
            if (isOp) {
                if (isSelected) item.classList.add('correct');
                else { item.classList.add('wrong'); allCorrect = false; }
            } else {
                if (!isSelected) item.classList.add('correct');
                else { item.classList.add('wrong'); allCorrect = false; }
            }
        });
        const fb = document.getElementById('bs-feedback');
        fb.innerText = allCorrect ? "Excellent Classification!" : "Re-evaluate financing vs operations (Debt, Lease Obligations, and Cash are non-operating).";
        fb.className = allCorrect ? "text-success mt-2 font-bold" : "text-error mt-2 font-bold";
    }

    function updateSim() {
        const flev = parseFloat(document.getElementById('flev-slider').value);
        let label = "Low Debt";
        if(flev > 0.5) label = "Medium Debt";
        if(flev > 1.0) label = "High Debt";
        
        document.getElementById('flev-val').innerText = label;
        
        const rnoa = 32.1, spread = 32.2;
        const impact = flev * spread;
        const roe = rnoa + impact;
        document.getElementById('sim-boost-text').innerText = impact.toFixed(1) + "%";
        document.getElementById('sim-roe-text').innerText = roe.toFixed(1) + "%";
        
        const scale = 3.5;
        document.getElementById('sim-boost-bar').style.height = (impact * scale) + "px";
        document.getElementById('sim-roe-bar').style.height = (roe * scale) + "px";
    }

    function revealSummary() {
        const bullets = document.querySelectorAll('.bullet-point');
        bullets.forEach((b, i) => {
            b.classList.remove('bullet-visible');
            setTimeout(() => b.classList.add('bullet-visible'), i * 350);
        });
    }

    function checkInterQuiz(btn, isCorrect) {
        const fb = btn.parentElement.querySelector('.inter-quiz-fb');
        btn.parentElement.querySelectorAll('.quiz-option').forEach(b => {
            b.style.pointerEvents = 'none';
            if(b.onclick.toString().includes('true')) {
                b.classList.add('correct');
            } else if(b === btn) {
                b.classList.add('wrong');
            }
        });

        if (isCorrect) {
            fb.innerText = "Correct! Well done.";
            fb.className = "inter-quiz-fb text-success mt-4 font-bold";
        } else {
            fb.innerText = "Incorrect. Review the answer above.";
            fb.className = "inter-quiz-fb text-error mt-4 font-bold";
        }
    }

    function revealNum(el, val) {
        el.innerText = val;
        el.classList.add('revealed');
    }

    function revealQuadrant(el) {
        el.classList.add('active');
        el.querySelector('.q-content').classList.add('revealed');
    }

    function generateTOC() {
        const container = document.getElementById('toc-grid');
        container.innerHTML = '';
        slides.forEach((slide, i) => {
            const h2 = slide.querySelector('h2') || slide.querySelector('h1');
            if (h2) {
                const item = document.createElement('div');
                item.className = "toc-btn"; item.onclick = () => jumpToSlide(i);
                item.innerHTML = `<div class="toc-num">${i + 1}</div><span>${h2.innerText}</span>`;
                container.appendChild(item);
            }
        });
    }

    // --- REPLACED LOGIC FOR SLIDE 8 BRIDGE VIZ ---
    function updateTaxViz(mode) {
        // Elements
        const btnDebt = document.getElementById('btn-debt');
        const btnCash = document.getElementById('btn-cash');
        
        const taxableBar = document.getElementById('taxable-bar');
        const taxableVal = document.getElementById('taxable-val');
        
        const arrow = document.getElementById('bridge-arrow');
        const bridgeVal = document.getElementById('bridge-val');
        
        const actualTaxOverlay = document.getElementById('actual-tax-overlay');
        const actualTaxLabel = document.getElementById('actual-tax-label');
        
        const dashedOverlay = document.getElementById('tax-overlay-dashed-compare');
        
        const analysisBox = document.getElementById('bridge-analysis');

        // Logic
        if (mode === 'debt') {
            // Button Styles
            btnDebt.style.background = 'var(--primary)'; btnDebt.style.color = 'white';
            btnCash.style.background = 'transparent'; btnCash.style.color = 'var(--primary)';

            // Visuals: Debt reduces Taxable Income
            // Op Income $100 -> Interest $20 -> Taxable $80
            // Scale: 2px per $1
            
            taxableBar.style.height = '160px'; // $80 * 2
            taxableVal.innerText = '$80';
            
            // Arrow (Interest Expense)
            arrow.className = 'bridge-arrow arrow-down';
            bridgeVal.innerText = '- $20 Int. Exp';
            
            // Solid Red Bar = Actual Tax ($16 -> 32px)
            actualTaxOverlay.style.height = '32px'; 
            actualTaxOverlay.style.background = '#f43f5e'; 
            actualTaxLabel.innerText = 'Actual Tax ($16)';
            
            // Dotted Box = Tax on Op Inc ($20 -> 40px)
            // Since 40px (dotted) > 32px (solid), the dotted box is taller.
            dashedOverlay.style.opacity = '1';
            dashedOverlay.style.height = '40px'; 
            dashedOverlay.style.top = '0px'; 

            // Analysis Content
            analysisBox.style.borderLeftColor = 'var(--success)';
            analysisBox.innerHTML = `
                <h4 style="color: var(--primary); margin-bottom: 10px;">Scenario: High Debt</h4>
                <div style="font-family: 'Fira Code', monospace; font-size: 0.9rem; margin-bottom: 15px;">
                    <div class="math-row"><span>Operating Income</span> <span>$100.00</span></div>
                    <div class="math-row" style="color: var(--error);"><span>(Less) Interest Expense</span> <span>($20.00)</span></div>
                    <div class="math-row" style="font-weight:bold; border-top: 1px solid #cbd5e0;"><span>= Income Before Tax</span> <span>$80.00</span></div>
                    <div class="math-row" style="color: var(--accent);"><span>(Less) Tax Expense (20%)</span> <span>($16.00)</span></div>
                    <div class="math-row" style="font-weight:800; border-top: 3px double #333; font-size: 1.1rem;"><span>= Net Income</span> <span>$64.00</span></div>
                </div>
                <div class="formula-highlight">
                    <strong>Tax on Op Income = Actual Tax + Tax Shield</strong><br>
                    $20 (Tax on Op Inc) = $16 (Actual) + $4 (Shield)
                </div>
                <div style="margin-top: 10px; font-size: 0.85rem; color: #64748b;">
                    The dashed outline ($20 Tax on Op Inc) is taller than the solid red bar ($16 Actual Tax). The gap is your tax savings (Tax Shield).
                </div>
            `;

        } else {
            // Button Styles
            btnCash.style.background = 'var(--primary)'; btnCash.style.color = 'white';
            btnDebt.style.background = 'transparent'; btnDebt.style.color = 'var(--primary)';

            // Visuals: Cash Increases Taxable Income
            // Op Income $100 -> Interest Inc $20 -> Taxable $120
            
            taxableBar.style.height = '240px'; // $120 * 2
            taxableVal.innerText = '$120';

            // Arrow (Interest Income)
            arrow.className = 'bridge-arrow arrow-up';
            bridgeVal.innerText = '+ $20 Int. Inc';

            // Solid Red Bar = Actual Tax ($24 -> 48px)
            actualTaxOverlay.style.height = '48px'; 
            actualTaxOverlay.style.background = '#f43f5e';
            actualTaxLabel.innerText = 'Actual Tax ($24)';
            
            // Dotted Box = Tax on Op Inc ($20 -> 40px)
            // Since 48px (solid) > 40px (dotted), the solid bar is taller.
            dashedOverlay.style.opacity = '1';
            dashedOverlay.style.height = '40px';
            dashedOverlay.style.top = '0px';

            // Analysis Content
            analysisBox.style.borderLeftColor = 'var(--error)';
            analysisBox.innerHTML = `
                <h4 style="color: var(--primary); margin-bottom: 10px;">Scenario: Excess Cash</h4>
                <div style="font-family: 'Fira Code', monospace; font-size: 0.9rem; margin-bottom: 15px;">
                    <div class="math-row"><span>Operating Income</span> <span>$100.00</span></div>
                    <div class="math-row" style="color: var(--success);"><span>(Plus) Interest Income</span> <span>$20.00</span></div>
                    <div class="math-row" style="font-weight:bold; border-top: 1px solid #cbd5e0;"><span>= Income Before Tax</span> <span>$120.00</span></div>
                    <div class="math-row" style="color: var(--accent);"><span>(Less) Tax Expense (20%)</span> <span>($24.00)</span></div>
                    <div class="math-row" style="font-weight:800; border-top: 3px double #333; font-size: 1.1rem;"><span>= Net Income</span> <span>$96.00</span></div>
                </div>
                <div class="formula-highlight" style="border-color: var(--error); color: #7f1d1d; background: rgba(239, 68, 68, 0.1);">
                    <strong>Tax on Op Income = Actual Tax + Tax Shield</strong><br>
                    $20 (Tax on Op Inc) = $24 (Actual) + (-$4) (Negative Shield)
                </div>
                <div style="margin-top: 10px; font-size: 0.85rem; color: #64748b;">
                    The solid red bar ($24 Actual Tax) is taller than the dashed outline ($20 Tax on Op Inc). You paid extra tax on the interest income.
                </div>
            `;
        }
    }

    // --- FINAL QUIZ LOGIC ---
    const quizData = [
        { q: "Which item is a Non-operating Asset?", options: ["Inventory", "Accounts Receivable", "Marketable Securities", "Goodwill"], a: 2 },
        { q: "How is Accounts Payable classified?", options: ["Operating Liability", "Non-operating Liability", "Operating Asset", "Equity"], a: 0 },
        { q: "If RNOA > Interest Rate, increasing leverage (debt) will:", options: ["Decrease ROE", "Increase ROE", "Have no impact", "Decrease NOPAT"], a: 1 },
        { q: "Why is Tax Shield added back in NOPAT calculation?", options: ["To account for depreciation", "To reverse interest tax benefits included in Net Income", "To increase reported earnings", "To adjust for foreign taxes"], a: 1 },
        { q: "What is Cash Drag?", options: ["Losing money on sales", "Holding excess cash that earns less than the business core", "Paying too much for inventory", "High fees on bank transfers"], a: 1 },
        { q: "Which ratio measures the 'Pricing Power' of the core business?", options: ["NOAT (Turnover)", "Leverage", "NOPM (Margin)", "Current Ratio"], a: 2 },
        { q: "If ROE is much lower than RNOA, it usually means:", options: ["The company is bankrupt", "The company has significant 'Cash Drag'", "The company has high debt", "The company has negative income"], a: 1 },
        { q: "When is borrowing money (Debt) 'Good' for ROE?", options: ["When RNOA is higher than the Cost of Debt", "Always", "Never", "When RNOA is lower than the Cost of Debt"], a: 0 },
        { q: "To calculate NOPAT starting from Net Income, you must:", options: ["Subtract Depreciation", "Add back After-tax Interest Expense", "Add back Dividends", "Subtract Cash"], a: 1 },
        { q: "Which is the 'Truth Teller' of pure operational performance?", options: ["ROE", "EPS", "RNOA", "Dividend Yield"], a: 2 }
    ];

    let currentQ = 0;

    function renderFinalQuiz() {
        const nav = document.getElementById('final-quiz-nav');
        const content = document.getElementById('final-quiz-content');
        
        nav.innerHTML = '';
        quizData.forEach((_, i) => {
            const btn = document.createElement('div');
            btn.className = `quiz-nav-btn ${i === currentQ ? 'active' : ''}`;
            btn.innerText = i + 1;
            btn.onclick = () => { currentQ = i; renderFinalQuiz(); };
            nav.appendChild(btn);
        });

        const q = quizData[currentQ];
        content.innerHTML = `
            <div class="question-box">
                <h3 style="margin-bottom: 20px;">Question ${currentQ + 1} of 10</h3>
                <p style="font-size: 1.2rem; margin-bottom: 20px; font-weight: bold;">${q.q}</p>
                <div id="q-options">
                    ${q.options.map((opt, i) => `
                        <div class="quiz-option" onclick="checkFinalAnswer(this, ${i})">
                            <div class="quiz-circle">${String.fromCharCode(65 + i)}</div>
                            <div>${opt}</div>
                        </div>
                    `).join('')}
                </div>
                <div id="q-feedback" style="margin-top: 15px; font-weight: bold; min-height: 25px;"></div>
            </div>
        `;
    }

    function checkFinalAnswer(el, idx) {
        const q = quizData[currentQ];
        const options = el.parentElement.children;
        const feedback = document.getElementById('q-feedback');
        const navBtn = document.querySelectorAll('.quiz-nav-btn')[currentQ];

        for(let opt of options) opt.style.pointerEvents = 'none';

        if(idx === q.a) {
            el.classList.add('correct');
            feedback.innerText = "Correct!";
            feedback.className = "text-success";
            navBtn.classList.add('answered');
            navBtn.style.borderColor = 'var(--success)';
            navBtn.style.color = 'var(--success)';
        } else {
            el.classList.add('wrong');
            options[q.a].classList.add('correct');
            feedback.innerText = "Incorrect.";
            feedback.className = "text-error";
            navBtn.classList.add('answered');
            navBtn.style.borderColor = 'var(--error)';
            navBtn.style.color = 'var(--error)';
        }
    }

    window.onload = () => { 
        generateTOC(); 
        updateNav(); 
        updateSim(); 
        updateTaxViz('debt'); 
        renderFinalQuiz();
    };
</script>
</body>
</html>
