<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mystery Cash Flow Simulation</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        
        /* Animation Classes */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .animate-slide-down { animation: slideDown 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const IconBase = ({ size = 24, className = "", children }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Download = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconBase>;
        const Lock = (props) => <IconBase {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>;
        const Unlock = (props) => <IconBase {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></IconBase>;
        const Clock = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>;
        const HelpCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>;
        const ChevronLeft = (props) => <IconBase {...props}><polyline points="15 18 9 12 15 6"/></IconBase>;
        const ChevronRight = (props) => <IconBase {...props}><polyline points="9 18 15 12 9 6"/></IconBase>;
        const CheckCircle = (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>;
        const Check = (props) => <IconBase {...props}><polyline points="20 6 9 17 4 12"/></IconBase>;
        const Search = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></IconBase>;
        const Folder = (props) => <IconBase {...props}><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></IconBase>;
        const X = (props) => <IconBase {...props}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconBase>;
        const AlertCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></IconBase>;
        const Activity = (props) => <IconBase {...props}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></IconBase>;
        const BarChart2 = (props) => <IconBase {...props}><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></IconBase>;
        const Grid = (props) => <IconBase {...props}><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></IconBase>;
        const LayoutList = (props) => <IconBase {...props}><rect x="3" y="14" width="7" height="7"/><rect x="3" y="3" width="7" height="7"/><line x1="14" y1="4" x2="21" y2="4"/><line x1="14" y1="9" x2="21" y2="9"/><line x1="14" y1="15" x2="21" y2="15"/><line x1="14" y1="20" x2="21" y2="20"/></IconBase>;
        const ShieldCheck = (props) => <IconBase {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></IconBase>;
        const Key = (props) => <IconBase {...props}><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconBase>;

        // --- DATA ---
        const PATTERNS = [
          { id: "STARTUP", label: "Startup / Early Growth", signs: ["-", "-", "+"], desc: "Burning cash (CFO -) to build assets (CFI -). Survives on financing (CFF +)." },
          { id: "MATURE", label: "Mature / Cash Cow", signs: ["+", "-", "-"], desc: "Generating huge cash (CFO +). Investing moderately (CFI -). Returning capital (CFF -)." },
          { id: "GROWTH", label: "Aggressive Growth", signs: ["+", "-", "+"], desc: "Profitable (CFO +), but investing so heavily (CFI -) they still raise cash (CFF +)." },
          { id: "TURNAROUND", label: "Turnaround / Mixed", signs: ["+/-", "+/-", "+/-"], desc: "Volatile patterns. Often selling assets (CFI +) or liquidating inventory to fix cash burn." },
          { id: "DECLINE", label: "Decline / Distress", signs: ["-", "+", "-"], desc: "Losing money (CFO -). Selling off parts of business (CFI +) to survive." }
        ];

        // REORDERED DATA: Oldest -> Newest (Left to Right)
        const CASES = [
          {
            id: "A", title: "Mystery Company A", category: "NVIDIA", period: "FY 2022-2024", multiYear: true, years: ["2022", "2023", "2024"],
            stats: {
              netIncome: ["9,752", "4,368", "29,760"],
              adjustments: [{ label: "Depreciation & Amortization", val: ["1,174", "1,544", "1,516"] }, { label: "Stock-Based Compensation", val: ["2,006", "2,709", "3,506"] }, { label: "Deferred Income Tax Benefit", val: ["(523)", "(1,698)", "(2,780)"] }],
              workingCapital: [{ label: "Accounts Receivable", val: ["(2,311)", "(1,374)", "(2,987)"] }, { label: "Inventories", val: ["(650)", "(2,348)", "(1,283)"] }, { label: "Accounts Payable", val: ["448", "291", "420"] }, { label: "Accrued Liabilities", val: ["1,312", "732", "3,755"] }, { label: "Other Operating Assets/Liab", val: ["(2,100)", "1,417", "(3,817)"] }],
              operatingCashFlow: ["9,108", "5,641", "28,090"],
              investing: [{ label: "Purchases of Property & Equipment", val: ["(976)", "(1,833)", "(1,128)"] }, { label: "Purchases of Marketable Securities", val: ["(15,773)", "(14,792)", "(23,490)"] }, { label: "Sales/Maturities of Securities", val: ["16,428", "9,678", "8,500"] }],
              investingCashFlow: ["(9,824)", "(7,344)", "(16,100)"], 
              financing: [{ label: "Repurchases of Common Stock", val: ["(2,028)", "(10,043)", "(9,500)"] }, { label: "Dividends Paid", val: ["(399)", "(398)", "(395)"] }, { label: "Tax on RSU Vesting", val: ["(1,623)", "(998)", "(2,367)"] }, { label: "Other Financing Activities", val: ["143", "(53)", "367"] }],
              financingCashFlow: ["(5,190)", "(11,385)", "(11,895)"],
            },
            description: "IDENTITY: NVIDIA (FY22-24). AI Boom. Asset Light. Cash Cow + Buybacks.",
            hint: "Net Income exploded, but CapEx barely changed. Huge buybacks.",
            correctPatternId: "MATURE",
            lifecycleFeedback: "Correct! NVIDIA is a fascinating hybrid. Asset-Light model allows them to generate cash like a Mature Cash Cow (+ - -)."
          },
          {
            id: "B", title: "Mystery Company B", category: "RIVIAN", period: "FY 2021-2023", multiYear: true, years: ["2021", "2022", "2023"],
            stats: {
              netIncome: ["(4,688)", "(6,752)", "(5,432)"],
              adjustments: [{ label: "Depreciation & Amortization", val: ["233", "650", "924"] }, { label: "Stock-Based Compensation", val: ["420", "600", "799"] }, { label: "Inventory LCNRV Write-downs", val: ["0", "920", "509"] }, { label: "Amortization of Debt Discount", val: ["5", "10", "145"] }],
              workingCapital: [{ label: "Accounts Receivable", val: ["(100)", "(250)", "(120)"] }, { label: "Inventories", val: ["(350)", "(1,200)", "(509)"] }, { label: "Accounts Payable", val: ["200", "400", "300"] }, { label: "Other Operating Activities", val: ["1,659", "570", "(1,523)"] } ],
              operatingCashFlow: ["(2,621)", "(5,052)", "(4,907)"],
              investing: [{ label: "Capital Expenditures (CapEx)", val: ["(1,794)", "(1,369)", "(1,025)"] }, { label: "Purchase of Intangible Assets", val: ["(10)", "(15)", "(20)"] }],
              investingCashFlow: ["(1,804)", "(1,384)", "(1,045)"],
              financing: [{ label: "Proceeds from Debt/Notes", val: ["0", "0", "1,500"] }, { label: "Proceeds from Public Offering", val: ["11,933", "0", "0"] }, { label: "Repayment of Debt", val: ["(15)", "(20)", "(34)"] }],
              financingCashFlow: ["11,918", "(20)", "1,466"],
            },
            description: "IDENTITY: RIVIAN (FY21-23). Classic Startup. Huge Burn. IPO funded.",
            hint: "Negative Operating Cash Flow every year. Huge Financing inflow in 2021 (IPO).",
            correctPatternId: "STARTUP",
            lifecycleFeedback: "Correct! Rivian fits the classic Startup profile (- - +)."
          },
          {
            id: "C", title: "Mystery Company C", category: "COCA-COLA", period: "FY 2021-2023", multiYear: true, years: ["2021", "2022", "2023"],
            stats: {
              netIncome: ["9,771", "9,542", "10,714"],
              adjustments: [{ label: "Depreciation & Amortization", val: ["1,452", "1,260", "1,260"] }, { label: "Stock-Based Compensation", val: ["305", "255", "245"] }, { label: "Equity Income (Net)", val: ["(745)", "(905)", "(850)"] }],
              workingCapital: [{ label: "Accounts Receivable", val: ["(100)", "(250)", "(300)"] }, { label: "Inventories", val: ["(50)", "(350)", "(100)"] }, { label: "Other Operating Assets/Liab", val: ["1,992", "1,466", "630"] }],
              operatingCashFlow: ["12,625", "11,018", "11,599"],
              investing: [{ label: "Purchases of PP&E (CapEx)", val: ["(1,367)", "(1,484)", "(1,847)"] }, { label: "Acquisitions/Investments", val: ["(1,400)", "(5)", "(50)"] }],
              investingCashFlow: ["(2,773)", "(2,300)", "(1,900)"], 
              financing: [{ label: "Dividends Paid", val: ["(7,327)", "(7,616)", "(7,952)"] }, { label: "Issuance of Debt", val: ["8,000", "3,500", "4,000"] }, { label: "Payments of Debt", val: ["(5,000)", "(4,000)", "(2,500)"] }],
              financingCashFlow: ["(6,326)", "(8,500)", "(6,500)"],
            },
            description: "IDENTITY: COCA-COLA (FY21-23). Dividend King. Stable Cash.",
            hint: "Dividends Paid line is massive and grows every year. Returns 70% of profit to shareholders.",
            correctPatternId: "MATURE",
            lifecycleFeedback: "Correct! Coca-Cola is the quintessential Mature / Cash Cow."
          },
          {
            id: "D", title: "Mystery Company D", category: "PELOTON", period: "FY 2022-2024", multiYear: true, years: ["2022", "2023", "2024"],
            stats: {
              netIncome: ["(2,828)", "(1,262)", "(158)"],
              adjustments: [{ label: "Depreciation & Amortization", val: ["169", "226", "188"] }, { label: "Impairment & Restructuring", val: ["366", "300", "42"] }, { label: "Stock-Based Compensation", val: ["345", "260", "190"] }],
              workingCapital: [{ label: "Accounts Receivable", val: ["37", "20", "(13)"] }, { label: "Inventories", val: ["(197)", "470", "123"] }, { label: "Accounts Payable", val: ["52", "(150)", "(25)"] }, { label: "Accrued Expenses", val: ["163", "(251)", "(65)"] }],
              operatingCashFlow: ["(2,393)", "(387)", "112"],
              investing: [{ label: "Capital Expenditures", val: ["(265)", "(58)", "(44)"] }, { label: "Sale/Purchase of Marketable Sec.", val: ["22", "20", "25"] }],
              investingCashFlow: ["(243)", "(48)", "(19)"],
              financing: [{ label: "Repayment of Debt", val: ["(15)", "(20)", "(33)"] }, { label: "Term Loan/Debt Proceeds", val: ["1,200", "750", "0"] }, { label: "Stock Option Exercises", val: ["10", "5", "2"] }],
              financingCashFlow: ["1,180", "730", "(37)"],
            },
            description: "IDENTITY: PELOTON (FY22-24). Turnaround. Inventory liquidation.",
            hint: "2022 was a crash (Net Loss $2.8B). 2024 shows slight positive Operating Cash Flow.",
            correctPatternId: "TURNAROUND",
            lifecycleFeedback: "Correct! Peloton represents a Turnaround story."
          },
          {
            id: "E", title: "Mystery Company E", category: "BEYOND INC", period: "FY 2021-2023", multiYear: true, years: ["2021", "2022", "2023"],
            stats: {
              netIncome: ["389", "(35)", "(308)"],
              adjustments: [{ label: "Depreciation & Amortization", val: ["22", "23", "25"] }, { label: "Stock-Based Compensation", val: ["15", "18", "20"] }, { label: "Loss (Gain) on Equity Inv", val: ["(200)", "5", "10"] }],
              workingCapital: [{ label: "Accounts Receivable", val: ["(5)", "2", "5"] }, { label: "Inventories", val: ["(15)", "10", "4"] }, { label: "Accounts Payable", val: ["30", "(20)", "(50)"] }, { label: "Accrued Liabilities", val: ["40", "15", "30"] }, { label: "Other Operating Changes", val: ["(10)", "10", "44"] }],
              operatingCashFlow: ["210", "(15)", "(220)"],
              investing: [{ label: "Capital Expenditures", val: ["(10)", "(12)", "(15)"] }, { label: "Purchase of Intangible Assets", val: ["0", "0", "(21)"] } ],
              investingCashFlow: ["(10)", "(12)", "(36)"],
              financing: [{ label: "Issuance of Common Stock", val: ["0", "0", "50"] }, { label: "Taxes paid on stock", val: ["(5)", "(5)", "(5)"] }, { label: "Repurchase of Stock", val: ["(50)", "(80)", "0"] }],
              financingCashFlow: ["(55)", "(85)", "45"],
            },
            description: "IDENTITY: BEYOND INC (Bed Bath & Beyond). Decline. Suppliers pulling back.",
            hint: "Accounts Payable is negative in 2023, meaning suppliers are demanding payment or cutting them off.",
            correctPatternId: "DECLINE",
            lifecycleFeedback: "Correct. This is a Typical Decline pattern."
          },
        ];

        const SUSPECTS = ["NVIDIA", "Rivian", "Coca-Cola", "Peloton", "Beyond Inc. (Bed Bath & Beyond)"];

        // --- HELPERS ---

        const parseFinancialValue = (valStr) => {
          if (typeof valStr !== 'string') return 0;
          const isNegative = valStr.includes('(');
          const cleanStr = valStr.replace(/[^0-9.]/g, '');
          const num = parseFloat(cleanStr);
          return isNegative ? -num : num;
        };

        const getSignsForCase = (c) => {
          // Check most recent year (last index) for pattern matching
          const idx = c.years.length - 1;
          const ocf = parseFinancialValue(c.stats.operatingCashFlow[idx]);
          const icf = parseFinancialValue(c.stats.investingCashFlow[idx]);
          const fcf = parseFinancialValue(c.stats.financingCashFlow[idx]);
          return {
            ops: ocf > 0 ? '+' : '-',
            inv: icf > 0 ? '+' : '-',
            fin: fcf > 0 ? '+' : '-'
          };
        };

        const generateHash = (data) => {
            const jsonStr = JSON.stringify(data);
            return btoa(jsonStr); 
        };

        const verifyHash = (hash) => {
            try {
                return JSON.parse(atob(hash));
            } catch (e) {
                return null;
            }
        };

        // --- COMPONENTS ---

        const SmartInput = ({ id, value, correctValue, isPct, onChange, instructorMode }) => {
            const [localVal, setLocalVal] = useState(value || "");
            const [status, setStatus] = useState("neutral");

            useEffect(() => {
                setLocalVal(value || "");
                if (value) validate(value);
                else setStatus("neutral");
            }, [value]);

            const evaluateExpression = (expression) => {
                if (!expression) return "";
                let cleanExp = expression.toString().replace(/,/g, ''); 
                cleanExp = cleanExp.replace(/(\d+)%/g, '($1/100)');
                try {
                    if (!/^[\d+\-*/().\s]+$/.test(cleanExp)) return expression;
                    const result = Function('"use strict";return (' + cleanExp + ')')();
                    return result;
                } catch (e) {
                    return expression;
                }
            };

            const validate = (valToTest) => {
                const calculated = evaluateExpression(valToTest);
                if (calculated === "" || isNaN(calculated)) {
                    setStatus("neutral");
                    return;
                }
                let numericVal = parseFloat(calculated);
                let target = parseFloat(correctValue);

                if (isPct) {
                    if (Math.abs(target) < 1 && Math.abs(numericVal) > 1) {
                         numericVal = numericVal / 100;
                    }
                }
                const diff = Math.abs(numericVal - target);
                const tolerance = Math.abs(target * 0.02); 

                if (target === 0) {
                     setStatus(Math.abs(numericVal) < 0.01 ? "correct" : "incorrect");
                } else {
                     setStatus(diff <= tolerance ? "correct" : "incorrect");
                }
            };

            const handleBlur = () => {
                const finalVal = evaluateExpression(localVal);
                setLocalVal(finalVal);
                validate(finalVal);
                onChange(finalVal);
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') e.target.blur();
            };

            let borderClass = "border-slate-300 focus:border-blue-500 focus:ring-blue-500";
            if (status === "correct") borderClass = "border-emerald-500 bg-emerald-50 text-emerald-700 ring-1 ring-emerald-500";
            if (status === "incorrect") borderClass = "border-red-500 bg-red-50 text-red-700 ring-1 ring-red-500";

            return (
                <div className="relative w-full">
                    <input
                        type="text"
                        value={localVal}
                        onChange={(e) => setLocalVal(e.target.value)}
                        onBlur={handleBlur}
                        onKeyDown={handleKeyDown}
                        className={`w-full p-1.5 text-right font-mono text-sm border rounded shadow-sm outline-none transition-all ${borderClass}`}
                        placeholder={status === "neutral" ? "?" : ""}
                    />
                    {status === "correct" && <div className="absolute left-2 top-1/2 -translate-y-1/2 text-emerald-600 pointer-events-none"><Check size={14} strokeWidth={3} /></div>}
                    {instructorMode && <div className="absolute top-full left-0 w-full text-[10px] text-purple-600 font-bold bg-purple-50 border border-purple-100 px-1 z-10 text-center">Key: {correctValue}</div>}
                </div>
            );
        };

        const TrendChart = ({ data, years, title, onClose }) => {
            // Data is now OLD -> NEW. No need to reverse.
            const chartData = years.map((y, i) => ({ year: y, val: parseFinancialValue(data[i]) })); 
            const values = chartData.map(d => d.val);
            const minVal = Math.min(...values, 0); 
            const maxVal = Math.max(...values, 0);
            const range = (maxVal - minVal) || 100;
            const height = 200;
            const width = 350;
            const padding = 40;
            const plotHeight = height - padding * 2;
            const plotWidth = width - padding * 2;
            const getY = (val) => padding + plotHeight - ((val - minVal) / range) * plotHeight;
            const getX = (index) => padding + (index / (chartData.length - 1)) * plotWidth;

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 animate-fade-in">
                <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-md relative">
                    <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><X size={20} /></button>
                    <h3 className="font-bold text-slate-800 mb-1 pr-8">{title}</h3>
                    <div className="flex justify-center mt-4">
                        <svg width={width} height={height} className="overflow-visible">
                            {minVal < 0 && maxVal > 0 && <line x1={padding} y1={getY(0)} x2={width - padding} y2={getY(0)} stroke="#94a3b8" strokeWidth="1.5" strokeDasharray="4 2" />}
                            <polyline fill="none" stroke="#3b82f6" strokeWidth="3" points={chartData.map((d, i) => `${getX(i)},${getY(d.val)}`).join(' ')} />
                            {chartData.map((d, i) => (
                            <g key={d.year}>
                                <circle cx={getX(i)} cy={getY(d.val)} r="5" fill="white" stroke="#2563eb" strokeWidth="2" />
                                <text x={getX(i)} y={height - 10} textAnchor="middle" fontSize="12" fill="#64748b" fontWeight="500">{d.year}</text>
                                <text x={getX(i)} y={getY(d.val) - 12} textAnchor="middle" fontSize="12" fontWeight="bold" fill="#1e293b">{d.val.toLocaleString()}</text>
                            </g>
                            ))}
                        </svg>
                    </div>
                </div>
                </div>
            );
        };

        const Card = ({ children, className = "" }) => <div className={`bg-white rounded-xl shadow-sm border border-slate-200 ${className}`}>{children}</div>;
        const Button = ({ onClick, children, variant = "primary", className = "", disabled = false }) => {
            const base = "px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 active:scale-95";
            const variants = {
                primary: "bg-blue-600 text-white hover:bg-blue-700 disabled:bg-slate-300 disabled:cursor-not-allowed",
                secondary: "bg-slate-100 text-slate-700 hover:bg-slate-200 border border-slate-300",
                danger: "bg-red-500 text-white hover:bg-red-600",
                purple: "bg-purple-600 text-white hover:bg-purple-700 border border-purple-800 shadow-md",
                ghost: "text-slate-500 hover:text-slate-800 hover:bg-slate-50"
            };
            return <button onClick={onClick} className={`${base} ${variants[variant]} ${className}`} disabled={disabled}>{children}</button>;
        };
        const Modal = ({ title, children, onClose }) => (
            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[60] animate-fade-in">
                <div className="bg-white p-6 rounded-lg w-full max-w-sm shadow-2xl relative animate-slide-down">
                    <h3 className="font-bold mb-4 text-lg">{title}</h3>
                    {children}
                    <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><X size={20}/></button>
                </div>
            </div>
        );

        // --- INSTRUCTOR TOOLBAR ---
        const InstructorToolbar = ({ onAutoFill, onClear, onVerify }) => {
            const [showHashGen, setShowHashGen] = useState(false);
            const [genName, setGenName] = useState("");
            const [genScore, setGenScore] = useState("");
            const [generatedHash, setGeneratedHash] = useState("");
            const [showVerifier, setShowVerifier] = useState(false);
            const [verifyInput, setVerifyInput] = useState("");
            const [verifyResult, setVerifyResult] = useState(null);

            const handleGen = () => {
                const hash = generateHash({
                    studentName: genName, score: parseInt(genScore), timestamp: new Date().toISOString(), salt: "INSTRUCTOR_GENERATED"
                });
                setGeneratedHash(hash);
            };
            const handleVerify = () => {
                const res = verifyHash(verifyInput);
                setVerifyResult(res);
            };

            return (
                <div className="fixed top-0 left-0 w-full bg-purple-700 text-white z-40 shadow-lg animate-slide-down">
                    <div className="max-w-6xl mx-auto px-4 py-3 flex flex-wrap items-center justify-between gap-4">
                        <div className="flex items-center gap-2 font-bold text-lg"><Unlock size={20} className="text-purple-200"/> Instructor Mode</div>
                        <div className="flex items-center gap-3">
                            <button onClick={onAutoFill} className="px-3 py-1.5 bg-purple-600 hover:bg-purple-500 rounded border border-purple-400 text-xs font-bold flex items-center gap-2"><Check size={14}/> Auto-Fill All</button>
                            <button onClick={onClear} className="px-3 py-1.5 bg-purple-600 hover:bg-red-500 rounded border border-purple-400 text-xs font-bold flex items-center gap-2 transition-colors"><Trash2 size={14}/> Clear All</button>
                            <div className="h-6 w-px bg-purple-500 mx-2"></div>
                            <button onClick={() => setShowHashGen(true)} className="px-3 py-1.5 bg-purple-800 hover:bg-purple-900 rounded text-xs font-bold flex items-center gap-2"><Key size={14}/> Hash Generator</button>
                            <button onClick={() => setShowVerifier(true)} className="px-3 py-1.5 bg-purple-800 hover:bg-purple-900 rounded text-xs font-bold flex items-center gap-2"><ShieldCheck size={14}/> Verification Tool</button>
                        </div>
                    </div>
                    {/* Modals omitted for brevity, functionality remains same */}
                    {showHashGen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 text-slate-900">
                             <div className="bg-white p-6 rounded-lg shadow-2xl w-full max-w-md">
                                <div className="flex justify-between items-center mb-4"><h3 className="font-bold flex items-center gap-2"><Key size={18}/> Generate Admin Hash</h3><button onClick={() => setShowHashGen(false)}><X size={20}/></button></div>
                                <div className="space-y-3"><input placeholder="Student Name" className="w-full p-2 border rounded" value={genName} onChange={e=>setGenName(e.target.value)} /><input placeholder="Score (0-100)" type="number" className="w-full p-2 border rounded" value={genScore} onChange={e=>setGenScore(e.target.value)} /><Button onClick={handleGen} className="w-full justify-center">Generate</Button>{generatedHash && <div className="bg-slate-100 p-3 rounded mt-2 break-all text-xs font-mono border border-slate-200">{generatedHash}</div>}</div>
                             </div>
                        </div>
                    )}
                    {showVerifier && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 text-slate-900">
                             <div className="bg-white p-6 rounded-lg shadow-2xl w-full max-w-md">
                                <div className="flex justify-between items-center mb-4"><h3 className="font-bold flex items-center gap-2"><ShieldCheck size={18}/> Verify Hash</h3><button onClick={() => setShowVerifier(false)}><X size={20}/></button></div>
                                <div className="space-y-3"><textarea placeholder="Paste Verification Hash here..." className="w-full p-2 border rounded h-24 font-mono text-xs" value={verifyInput} onChange={e=>setVerifyInput(e.target.value)} /><Button onClick={handleVerify} className="w-full justify-center">Verify Integrity</Button>{verifyResult ? <div className="bg-emerald-50 border border-emerald-200 p-4 rounded text-sm space-y-1"><div className="flex items-center gap-2 font-bold text-emerald-700"><CheckCircle size={16}/> Valid Signature</div><div><span className="font-semibold">Student:</span> {verifyResult.studentName}</div><div><span className="font-semibold">Score:</span> {verifyResult.score}</div><div><span className="font-semibold">Date:</span> {new Date(verifyResult.timestamp).toLocaleString()}</div></div> : verifyInput && <div className="bg-red-50 text-red-600 p-3 rounded text-sm font-bold flex items-center gap-2"><AlertCircle size={16}/> Invalid or Corrupted Hash</div>}</div>
                             </div>
                        </div>
                    )}
                </div>
            );
        };

        const CashFlowDoc = ({ data, onChartRequest, inputState, onInputChange, instructorMode }) => {
            const isMulti = data.multiYear;
            const cols = isMulti ? data.years.length : 1;
            
            const renderCell = (val, key, correctValRaw, isPct = false) => {
                const isInteractive = key.startsWith('total-');
                if (isInteractive) {
                    const cleanCorrect = parseFinancialValue(correctValRaw);
                    return <SmartInput id={key} value={inputState[key]} correctValue={cleanCorrect} isPct={isPct} onChange={(v) => onInputChange(key, v)} instructorMode={instructorMode} />;
                }
                return val;
            };

            const renderRow = (label, val, bold = false, rowKeyPrefix) => (
                <tr key={rowKeyPrefix} className="hover:bg-slate-50 group">
                <td className={`px-2 py-1 ${bold ? 'font-semibold' : 'pl-6 text-slate-600 text-xs'} flex items-center justify-between`}>
                    <span>{label}</span>
                    {isMulti && (
                    <button onClick={() => onChartRequest(label, val, data.years)} className="ml-2 text-blue-500 hover:text-blue-700 transition-all p-1 rounded hover:bg-slate-100" title="View Trend"><BarChart2 size={16} /></button>
                    )}
                </td>
                {isMulti ? data.years.map((y, i) => <td key={`${rowKeyPrefix}-${y}`} className="text-right px-2 align-middle">{renderCell(val[i], `${rowKeyPrefix}-${i}`, val[i])}</td>) : <td className="px-2 py-1 text-right align-middle">{renderCell(val, `${rowKeyPrefix}-0`, val)}</td>}
                </tr>
            );

            const renderTotalRow = (label, values, colorClass, prefix) => (
                <tr className={`${colorClass} border-t font-bold group`}>
                    <td className="px-2 py-2 flex items-center justify-between">
                        <span>{label}</span>
                        {isMulti && <button onClick={()=>onChartRequest(label, values, data.years)} className="p-1 text-blue-700 hover:text-blue-900 hover:bg-white/50 rounded transition-all" title="Visualize Trend"><BarChart2 size={16}/></button>}
                    </td>
                    {isMulti ? data.years.map((y, i) => <td key={y} className="px-2 py-2 w-32 text-right">{values[i]}</td>) : <td className="px-2 py-2 w-32 text-right">{values}</td>}
                </tr>
            );

            return (
                <div className="bg-white text-sm font-mono text-slate-700 border border-slate-200 shadow-sm mx-auto max-w-4xl animate-fade-in relative">
                    <div className="bg-slate-100 p-4 border-b border-slate-200 flex justify-between items-center">
                        <div>
                        <h2 className="font-bold text-slate-900 text-lg uppercase tracking-wider">{data.title}</h2>
                        <div className="flex items-center gap-2 mt-1">
                            <span className="text-xs bg-slate-200 px-2 py-0.5 rounded text-slate-600 font-semibold">{data.period}</span>
                            <span className="text-xs text-slate-400 uppercase">Values in USD Millions</span>
                        </div>
                        </div>
                    </div>
                    <div className="p-6 overflow-x-auto">
                        <table className="w-full text-left border-collapse">
                        {isMulti && <thead className="bg-slate-50 text-xs text-slate-500 uppercase"><tr><th className="py-2 px-2">Line Item</th>{data.years.map(y => <th key={y} className="py-2 px-2 text-right">{y}</th>)}</tr></thead>}
                        <tbody className="divide-y divide-slate-100/50">
                            <tr className="bg-blue-50/50"><td colSpan={cols + 1} className="px-2 py-3 font-bold text-blue-900 text-xs uppercase tracking-wide">Operating Activities</td></tr>
                            {renderRow("Net Income (Loss)", data.stats.netIncome, true, "ni")}
                            {data.stats.adjustments.map((row, i) => renderRow(row.label, row.val, false, `adj-${i}`))}
                            <tr className="bg-slate-50/50"><td colSpan={cols + 1} className="px-2 py-1 pl-6 text-slate-400 text-[10px] italic pt-2">Changes in Working Capital:</td></tr>
                            {data.stats.workingCapital.map((row, i) => renderRow(row.label, row.val, false, `wc-${i}`))}
                            {renderTotalRow("Net Cash from Operations", data.stats.operatingCashFlow, "bg-blue-100/30 border-blue-200 text-blue-900", "ocf")}

                            <tr><td className="py-2"></td></tr>
                            <tr className="bg-purple-50/50"><td colSpan={cols + 1} className="px-2 py-3 font-bold text-purple-900 text-xs uppercase tracking-wide">Investing Activities</td></tr>
                            {data.stats.investing.map((row, i) => renderRow(row.label, row.val, false, `inv-${i}`))}
                            {renderTotalRow("Net Cash from Investing", data.stats.investingCashFlow, "bg-purple-100/30 border-purple-200 text-purple-900", "icf")}

                            <tr><td className="py-2"></td></tr>
                            <tr className="bg-emerald-50/50"><td colSpan={cols + 1} className="px-2 py-3 font-bold text-emerald-900 text-xs uppercase tracking-wide">Financing Activities</td></tr>
                            {data.stats.financing.map((row, i) => renderRow(row.label, row.val, false, `fin-${i}`))}
                            {renderTotalRow("Net Cash from Financing", data.stats.financingCashFlow, "bg-emerald-100/30 border-emerald-200 text-emerald-900", "fcf")}
                        </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        function App() {
            const [gameState, setGameState] = useState('welcome'); 
            const [studentName, setStudentName] = useState('');
            const [timeLeft, setTimeLeft] = useState(900); 
            const [selectedCaseId, setSelectedCaseId] = useState(null);
            const [answers, setAnswers] = useState({});
            const [lifecycleAnswers, setLifecycleAnswers] = useState({});
            const [hintsRevealed, setHintsRevealed] = useState({});
            const [activeChart, setActiveChart] = useState(null);
            const [teacherMode, setTeacherMode] = useState(false);
            const [showTeacherAuth, setShowTeacherAuth] = useState(false);
            const [teacherPassInput, setTeacherPassInput] = useState('');
            const [sheetInputs, setSheetInputs] = useState({}); 
            const [showClearConfirm, setShowClearConfirm] = useState(false);

            useEffect(() => {
                let interval;
                if (gameState === 'playing' && timeLeft > 0) {
                interval = setInterval(() => setTimeLeft(t => t - 1), 1000);
                }
                return () => clearInterval(interval);
            }, [gameState, timeLeft]);

            const formatTime = (s) => `${Math.floor(s / 60)}:${(s % 60).toString().padStart(2, '0')}`;

            const handleStart = () => {
                if (!studentName.trim()) return alert("Enter name.");
                setGameState('playing');
            };

            const handleSheetInput = (key, val) => {
                setSheetInputs(prev => ({ ...prev, [key]: val }));
            };

            const handleAutoFill = () => {
                // Auto-fill is redundant now that calculation inputs are removed, 
                // but keeping function structure to prevent breaking instructor toolbar prop
            };

            const confirmClear = () => {
                setSheetInputs({});
                setAnswers({});
                setLifecycleAnswers({});
                setTeacherMode(false);
                setShowClearConfirm(false);
            };

            const downloadReport = () => {
                let score = 0;
                CASES.forEach(c => {
                    if (answers[c.id]) score += 10;
                    if (lifecycleAnswers[c.id] === c.correctPatternId) score += 10;
                });

                const hashData = { studentName, score, timestamp: new Date().toISOString(), salt: "MYSTERY_CF_v1" };
                const verificationHash = generateHash(hashData);
                const lines = [
                    `MYSTERY CASH FLOWS - ANALYST REPORT`, `Student: ${studentName}`, `Date: ${new Date().toLocaleDateString()}`,
                    `Time Remaining: ${formatTime(timeLeft)}`, `Calculated Score: ${score}`, `--------------------------------------------------`,
                    `PHASE 1: COMPANY IDENTIFICATION`
                ];
                CASES.forEach(c => {
                    lines.push(`\nFILE ${c.id}: ${c.title}`);
                    lines.push(`Student Guess: ${answers[c.id] || "UNIDENTIFIED"}`);
                    lines.push(`Hint Used: ${hintsRevealed[c.id] ? "YES" : "NO"}`);
                });
                lines.push(`\n--------------------------------------------------`, `PHASE 2: LIFECYCLE ANALYSIS`);
                CASES.forEach(c => {
                    const selectedPatternId = lifecycleAnswers[c.id];
                    const patternLabel = PATTERNS.find(p => p.id === selectedPatternId)?.label || "Not Selected";
                    lines.push(`\nFILE ${c.id}: ${patternLabel}`);
                });
                lines.push(`\n--------------------------------------------------`, `VERIFICATION HASH (For Instructor Use Only):`, verificationHash);

                const blob = new Blob([lines.join('\n')], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${studentName.replace(/\s+/g, '_')}_submission.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };

            if (gameState === 'welcome') {
                return (
                    <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4">
                        <Card className="max-w-xl w-full p-8 text-center space-y-6">
                            <div className="mx-auto w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-200"><Activity size={32} /></div>
                            <div><h1 className="text-2xl font-bold text-slate-900">Financial Forensics Lab</h1><p className="text-slate-500 mt-2">Recover 5 unlabelled cash flow statements. Identify the companies, analyze trends, and determine lifecycles.</p></div>
                            <div className="space-y-3"><input type="text" className="w-full p-3 border border-slate-300 rounded-lg text-center outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter Analyst Name" value={studentName} onChange={e => setStudentName(e.target.value)} /><Button onClick={handleStart} className="w-full py-3 justify-center text-lg">Start Investigation</Button></div>
                            <div className="pt-6"><button onClick={() => setShowTeacherAuth(true)} className="text-xs text-slate-400 hover:text-blue-600 flex items-center justify-center gap-1 mx-auto transition-colors"><Lock size={12} /> Instructor Access</button></div>
                        </Card>
                        {showTeacherAuth && (
                            <Modal title="Instructor Key" onClose={() => setShowTeacherAuth(false)}>
                                <form onSubmit={(e) => { e.preventDefault(); if(teacherPassInput==='teacher'){setTeacherMode(true);setShowTeacherAuth(false);setTeacherPassInput('')} else alert("Invalid"); }} className="space-y-4">
                                    <input type="password" autoFocus placeholder="Password" className="w-full p-2 border rounded" value={teacherPassInput} onChange={e=>setTeacherPassInput(e.target.value)} />
                                    <div className="flex justify-end gap-2"><Button variant="secondary" onClick={()=>setShowTeacherAuth(false)}>Cancel</Button><Button onClick={() => {if(teacherPassInput==='teacher'){setTeacherMode(true);setShowTeacherAuth(false);setTeacherPassInput('')} else alert("Invalid");}}>Unlock</Button></div>
                                </form>
                            </Modal>
                        )}
                    </div>
                );
            }

            const LifecycleView = () => {
                const [selections, setSelections] = useState(lifecycleAnswers);
                const [feedback, setFeedback] = useState({});
                const handleSelect = (caseId, patternId) => {
                    const newSelections = { ...selections, [caseId]: patternId };
                    setSelections(newSelections);
                    setLifecycleAnswers(newSelections);
                    const correctPattern = CASES.find(c => c.id === caseId).correctPatternId;
                    const feedbackText = CASES.find(c => c.id === caseId).lifecycleFeedback;
                    if (patternId === correctPattern) setFeedback(prev => ({ ...prev, [caseId]: feedbackText }));
                    else setFeedback(prev => ({ ...prev, [caseId]: "Incorrect pattern match. Check the Matrix signs (+/-) again." }));
                };
                return (
                    <div className="max-w-6xl mx-auto p-6 space-y-8 animate-fade-in pt-16">
                         <div className="bg-white p-6 rounded-lg shadow-sm border border-slate-200 flex justify-between items-center"><div><h1 className="text-2xl font-bold text-slate-900">Phase 2: Lifecycle Analysis</h1><p className="text-slate-500">Map each mystery company to its financial lifecycle stage.</p></div></div>
                         <div className="grid lg:grid-cols-3 gap-6">
                            <div className="space-y-4">
                                <h3 className="font-bold text-slate-700 flex items-center gap-2"><Grid size={18}/> Reference: The Matrix</h3>
                                {PATTERNS.map((p) => (
                                    <div key={p.id} className="bg-white p-4 rounded-lg border border-slate-200 shadow-sm text-sm">
                                        <div className="font-bold text-slate-800 mb-2">{p.label}</div>
                                        <div className="flex gap-2 font-mono text-xs font-bold mb-2">{p.signs.map((s,i) => <span key={i} className={`px-2 py-0.5 rounded bg-slate-100`}>{['Ops','Inv','Fin'][i]}: {s}</span>)}</div>
                                        <p className="text-xs text-slate-500">{p.desc}</p>
                                    </div>
                                ))}
                            </div>
                            <div className="lg:col-span-2 space-y-4">
                                {CASES.map(c => (
                                    <div key={c.id} className="bg-white p-5 rounded-lg border border-slate-200 shadow-sm">
                                        <div className="flex justify-between items-center gap-4 mb-4">
                                            <div><h4 className="font-bold text-lg">{c.title}</h4><p className="text-sm text-blue-600 font-medium">Identified as: {answers[c.id] || "Unknown"}</p></div>
                                            <select className="w-1/2 p-2 border rounded text-sm" onChange={(e) => handleSelect(c.id, e.target.value)} value={selections[c.id] || ""}><option value="" disabled>Select Lifecycle Pattern...</option>{PATTERNS.map(p => <option key={p.id} value={p.id}>{p.label}</option>)}</select>
                                        </div>
                                        {selections[c.id] && <div className={`mt-3 text-sm p-3 rounded border-l-4 ${feedback[c.id]?.includes("Correct") ? 'bg-green-50 border-green-500 text-green-800' : 'bg-red-50 border-red-500 text-red-800'}`}>{feedback[c.id]}</div>}
                                    </div>
                                ))}
                                <div className="flex justify-end pt-4"><Button onClick={downloadReport} className="shadow-lg shadow-blue-100"><Download size={18} /> Download Final Submission</Button></div>
                            </div>
                         </div>
                    </div>
                );
            };

            const allPhase1Done = Object.keys(answers).length === CASES.length;
            const isPhase2 = gameState === 'analysis';

            return (
                <div className={`min-h-screen bg-slate-50 flex flex-col font-sans text-slate-800 ${teacherMode ? 'pt-12' : ''}`}>
                    {teacherMode && <InstructorToolbar onAutoFill={handleAutoFill} onClear={() => setShowClearConfirm(true)} />}
                    {showClearConfirm && (
                        <Modal title="Clear All Data?" onClose={() => setShowClearConfirm(false)}>
                            <div className="space-y-4"><p className="text-slate-600 text-sm">This will clear all student inputs, answers, and reset the simulation. This action cannot be undone.</p><div className="flex gap-3 justify-end"><Button variant="secondary" onClick={() => setShowClearConfirm(false)}>Cancel</Button><Button variant="danger" onClick={confirmClear}>Yes, Clear & Exit</Button></div></div>
                        </Modal>
                    )}
                    <div className="bg-slate-900 text-slate-200 p-4 sticky top-0 z-30 shadow-md">
                        <div className="max-w-6xl mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-6">
                                <div className="flex items-center gap-2 font-bold text-white"><Folder size={18} /> Case Files: {studentName}</div>
                                <div className="flex bg-slate-800 rounded-lg p-1 text-xs font-medium">
                                    <button onClick={() => setGameState('playing')} className={`px-4 py-1.5 rounded-md transition-all ${!isPhase2 ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:text-slate-200'}`}>Phase 1: Investigate</button>
                                    <button onClick={() => allPhase1Done && setGameState('analysis')} disabled={!allPhase1Done} className={`px-4 py-1.5 rounded-md transition-all flex items-center gap-2 ${isPhase2 ? 'bg-blue-600 text-white shadow' : 'text-slate-400'} ${!allPhase1Done ? 'opacity-50' : 'hover:text-slate-200'}`}>Phase 2: The Matrix {allPhase1Done && <CheckCircle size={12} className="text-emerald-400" />}</button>
                                </div>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className={`font-mono text-xl font-bold flex items-center gap-2 ${timeLeft < 60 ? 'text-red-400 animate-pulse' : 'text-emerald-400'}`}><Clock size={20} /> {formatTime(timeLeft)}</div>
                                <button onClick={downloadReport} className="hidden sm:flex items-center gap-2 px-3 py-1.5 rounded text-xs font-bold bg-emerald-600 text-white hover:bg-emerald-700 transition-colors"><Download size={14}/> Submit</button>
                            </div>
                        </div>
                    </div>
                    <div className="flex-grow overflow-y-auto">
                        {isPhase2 ? <LifecycleView /> : (
                            <div className="max-w-6xl mx-auto p-6 pt-8">
                                {!selectedCaseId ? (
                                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 animate-fade-in">
                                        {CASES.map((c) => (
                                            <button key={c.id} onClick={() => setSelectedCaseId(c.id)} className={`group relative p-6 rounded-xl border-2 transition-all duration-200 text-left flex flex-col gap-4 shadow-sm hover:shadow-md hover:-translate-y-1 ${answers[c.id] ? 'bg-emerald-50 border-emerald-200' : 'bg-white border-slate-200 hover:border-blue-400'}`}>
                                                <div className={`w-12 h-12 rounded-lg flex items-center justify-center text-xl font-bold ${answers[c.id] ? 'bg-emerald-100 text-emerald-600' : 'bg-blue-50 text-blue-600'}`}>{c.id}</div>
                                                <div><h3 className="font-bold text-slate-700 group-hover:text-blue-700">Mystery File {c.id}</h3><p className="text-xs text-slate-400 mt-1">{answers[c.id] || "Unidentified"}</p></div>
                                                {answers[c.id] && <div className="absolute top-4 right-4 text-emerald-500"><CheckCircle size={20}/></div>}
                                            </button>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="space-y-6 animate-fade-in">
                                        <button onClick={() => setSelectedCaseId(null)} className="flex items-center gap-2 text-slate-500 hover:text-blue-600 font-medium transition-colors"><ChevronLeft size={20} /> Back to Desk</button>
                                        <div className="grid lg:grid-cols-3 gap-6">
                                            <div className="lg:col-span-2">
                                                <CashFlowDoc data={CASES.find(c => c.id === selectedCaseId)} onChartRequest={(t,d,y) => setActiveChart({title:t, data:d, years:y})} inputState={sheetInputs} onInputChange={handleSheetInput} instructorMode={teacherMode} />
                                            </div>
                                            <div className="space-y-4">
                                                <Card className="p-5 sticky top-24">
                                                    <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><Search size={18} /> Identify Subject</h3>
                                                    <div className="space-y-2">
                                                        {SUSPECTS.map(company => (
                                                            <button key={company} onClick={() => setAnswers({...answers, [selectedCaseId]: company})} className={`w-full text-left p-3 rounded-lg text-sm border transition-all ${answers[selectedCaseId] === company ? 'bg-blue-600 text-white border-blue-600 shadow-md transform scale-105' : 'bg-white border-slate-200 hover:bg-slate-50 text-slate-700'}`}>{company}</button>
                                                        ))}
                                                    </div>
                                                    <div className="mt-6 pt-6 border-t border-slate-100">
                                                        {!hintsRevealed[selectedCaseId] ? (
                                                            <button onClick={() => setHintsRevealed({...hintsRevealed, [selectedCaseId]: true})} className="w-full py-2 text-xs text-amber-600 hover:bg-amber-50 rounded border border-dashed border-amber-300 flex items-center justify-center gap-2"><HelpCircle size={14} /> Request Hint</button>
                                                        ) : (
                                                            <div className="bg-amber-50 p-3 rounded text-xs text-amber-800 border border-amber-200"><strong>Hint:</strong> {CASES.find(c => c.id === selectedCaseId).hint}</div>
                                                        )}
                                                    </div>
                                                </Card>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                {!selectedCaseId && allPhase1Done && (
                                    <div className="mt-8 bg-blue-600 text-white p-6 rounded-xl shadow-lg flex items-center justify-between animate-slide-down">
                                        <div><h3 className="font-bold text-lg">Phase 1 Complete</h3><p className="text-blue-100 text-sm">Proceed to Lifecycle Analysis.</p></div>
                                        <Button onClick={() => setGameState('analysis')} className="bg-white text-blue-600 hover:bg-blue-50 border-none">Next Phase <ChevronRight size={18} /></Button>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                    {activeChart && <TrendChart title={activeChart.title} data={activeChart.data} years={activeChart.years} onClose={() => setActiveChart(null)} />}
                    <div className="bg-white border-t border-slate-200 p-4 sticky bottom-0 z-20 flex justify-between items-center shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                        <div className="text-xs text-slate-400 hidden sm:block">CONFIDENTIAL RECORDS  DO NOT DISTRIBUTE</div>
                        <div className="flex gap-3 items-center">
                            {!teacherMode && (<button onClick={() => setShowTeacherAuth(true)} className="flex items-center gap-1 text-xs text-slate-400 hover:text-blue-600 transition-colors px-2 py-1 rounded hover:bg-slate-50"><Lock size={14}/> Instructor Access</button>)}
                        </div>
                    </div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>